var appInfoService=angular.module("appInfoService",[]);appInfoService.factory("appInfo",["$http","$localStorage","user","$rootScope","$location","app","$timeout",function(t,e,n,a,i,o){var r;return{asDesktop:function(){return"function"==typeof require?!0:!1},commands:function(n,i){t.get(server_url+"/api/"+n+"/menu").success(function(t){t.crm.input.forEach(function(t){t.visible&&(a.crm_input_visible=!0)}),t.sale.input.forEach(function(t){t.visible&&(a.sale_input_visible=!0)}),t.acc.forEach(function(t){t.visible&&(a.acc_visible=!0)}),t.report.forEach(function(t){t.visible&&(a.report_visible=!0)}),a.commands=t,e.setObject(n+"_menu_"+a.user.email,t),i&&i(null,t)}).error(function(t){console.error("Can't get menu of user",t),a.commands=e.getObject(n+"_menu_"+a.user.email),i&&i(t)})},get:function(e,n){if(r)n(null,r);else{var a=server_url+"/api/apps/"+e;t.get(a).success(function(t){r=t,n(null,r)}).error(function(t){n(t)})}},info:function(t,r){return id_app||(id_app=e.get("id_app"),id_app&&(a.id_app=id_app)),id_app||_.contains(paths_not_require_id_app,t)?(a.user?a.app_info||!id_app||_.contains(paths_not_require_id_app,t)?r&&r(null,a.user,a.app_info):o.get(id_app,id_app).success(function(t){a.app_info=t,r&&r(null,a.user,t)}).error(function(t){r&&r(t)}):n.getInfo(function(t,e){return t?void(r&&r(t)):void(!a.app_info&&id_app?o.get(id_app,id_app).success(function(t){a.app_info=t,r&&r(null,e,t)}).error(function(t){r&&r(t)}):r&&r(null,e,a.app_info))}),!0):(r&&r("Lỗi: bạn phải chọn một công ty"),i.url("/app"),!1)}}}]),appInfoService.factory("$localStorage",["$window","$cookies","$rootScope",function(t,e){return{remove:function(n){t.localStorage?t.localStorage[n]="":e[n]=""},set:function(n,a){t.localStorage?t.localStorage[n]=a:e[n]=a},get:function(n){return t.localStorage?t.localStorage[n]:e[n]},setObject:function(e,n){t.localStorage&&(t.localStorage[e]=JSON.stringify(n))},getObject:function(e){if(t.localStorage){var n=t.localStorage[e]||"[]";return JSON.parse(n)}return[]}}}]),appInfoService.factory("nodeWebkit",["$rootScope","$timeout",function(t,e){return{notification:function(n,a){if(Notification){var i={body:n};a||(a=t.program_name);var o=new Notification(a,i);o.onclick=function(){},o.onshow=function(){t.$apply(function(){e(function(){o.close()},5e3)})}}}}}]),appInfoService.factory("socket",["$rootScope",function(t){var e=server_url;e&&e.split(":").length<3&&(e+=":80");var n=io.connect(e);return{on:function(e,a){n.on(e,function(){var e=arguments;t.$apply(function(){a.apply(n,e)})})},once:function(e,a){n.once(e,function(){var e=arguments;t.$apply(function(){a.apply(n,e)})})},emit:function(e,a,i){n.emit(e,a,function(){var e=arguments;t.$apply(function(){i&&i.apply(n,e)})})}}}]),appInfoService.factory("Base64",function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(e){var n,a,i,o,r,c="",d="",l="",u=0;do n=e.charCodeAt(u++),a=e.charCodeAt(u++),d=e.charCodeAt(u++),i=n>>2,o=(3&n)<<4|a>>4,r=(15&a)<<2|d>>6,l=63&d,isNaN(a)?r=l=64:isNaN(d)&&(l=64),c=c+t.charAt(i)+t.charAt(o)+t.charAt(r)+t.charAt(l),n=a=d="",i=o=r=l="";while(u<e.length);return c},decode:function(e){var n,a,i,o,r,c="",d="",l="",u=0,s=/[^A-Za-z0-9\+\/\=]/g;s.exec(e)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do i=t.indexOf(e.charAt(u++)),o=t.indexOf(e.charAt(u++)),r=t.indexOf(e.charAt(u++)),l=t.indexOf(e.charAt(u++)),n=i<<2|o>>4,a=(15&o)<<4|r>>2,d=(3&r)<<6|l,c+=String.fromCharCode(n),64!=r&&(c+=String.fromCharCode(a)),64!=l&&(c+=String.fromCharCode(d)),n=a=d="",i=o=r=l="";while(u<e.length);return c}}});var viewProfile=function(t,e){t.open({templateUrl:"templates/sys/profile.html",controller:["$scope","$modalInstance","user","$location","$rootScope",function(t,n,a,i,o){a.getProfile(e,function(e,n){t.profile=n}),t.cancel=function(){n.dismiss("cancel")},t.gotoChat=function(t){n.dismiss("cancel"),i.path("/message/chat/"+t)},t.currentUser=o.user}],size:"lg"})},baseInput=function(t,e,n,a,i){this.code=t,this.server_path=e,this.fields_find=n,this.title=a,i||(i={}),this.options=i,this.group=i.group,this.group||(this.group="lists"),this.defaultConditions=i.defaultConditions,this.defaultValues=i.defaultValues,this.loading=i.onLoading,this.initHomeController=i.onInitHomeController,this.initAddController=i.onInitAddController,this.initEditController=i.onInitEditController,this.init=i.onInit,this.setDataSource2Print=i.onSetDataSource2Print,this.loadItem=i.onLoadItem,this.initImport=i.onImport;var o=t+"Module";_.contains(modulesD,o)||modulesD.push(o),this.module=angular.module(o,["ngRoute"]);var r=this;this.module.factory(t+"Config",function(){return{title:a,path:t}}),this.module.factory(t,["$http",function(t){var a=function(){var t;return t=_.contains(paths_not_require_id_app,e)?server_url+"/api/"+e:server_url+"/api/"+id_app+"/"+e};return baseService(t,a,n,i.services)}]),this.module.controller(t+"JsonController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$window","$interval","$modal","$filter","appInfo","$localStorage",function(e,n,a,o,c,d,l,u,s,p,h,f){n.list=[],n.condition="",r.defaultConditions&&(n.condition={},_.extend(n.condition,r.defaultConditions)),angular.extend(n,d),n.limit=3e4;var g=c.search();f.info(t,function(t){t||(n.list=[],o.load(id_app,{condition:n.condition,filter:n.filter,page:1,limit:n.limit,queryParams:g,onCondition:i.onCondition}).success(function(t){n.list=t}).error(function(t){t&&alert(t)}))})}]),this.module.controller(t+"HomeController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$window","$interval","$modal","$filter","appInfo","$localStorage",function(e,n,a,o,c,d,l,u,s,p,h,f,g){n.list=[],n.condition="",r.defaultConditions&&(n.condition={},_.extend(n.condition,r.defaultConditions)),angular.extend(n,d),n.total_page=1,n.current_page=1,n.pages=[1],n.limit=30,n.$modal=p,n.$http=a,n.config=d;var m=c.search();r.init&&r.init(n,e),f.info(t,function(f,v){if(!f){var $=(id_app||"")+v.email+t+"data";r.loading&&l.nextTick(function(){r.loading(n,{$controller:e,$http:a,service:o,$location:c,config:d,$rootScope:l,$window:u,$interval:s,$modal:p})}),n.current_user=l.user,n.goToPage=function(t,e,r){l.nextTick(function(){if(n.$emit("$dataChangeStart"),n.list=[],e||void 0!=e||(e=n.condition),n.findBy&&!_.isObject(e)){var c=e;e={},e[n.findBy]={$regex:c,$options:"i"}}o.load(id_app,{condition:e,filter:n.filter,count:1,queryParams:m,onCondition:i.onCondition}).success(function(t){n.total_page=Math.round(t.rows_number/n.limit,0),n.total_page<t.rows_number/n.limit&&(n.total_page+=1),0==n.total_page&&(n.total_page=1),n.pages=[];for(var e=1;e<=n.total_page;e++)n.pages.push(e)}),o.load(id_app,{condition:e,filter:n.filter,page:t,limit:n.limit,queryParams:m,onCondition:i.onCondition}).success(function(i){async.map(i,function(t,e){id_app?a.get(server_url+"/api/"+id_app+"/follow?q={id_object:'"+t._id+"',user_created:'"+n.current_user.email+"'}").success(function(n){n&&n.length>0?(t.followObject=n[0],t.follow_yn=1):t.follow_yn=0,e()}).error(function(n){t.follow_yn=0,e(n)}):e()},function(a){a&&console.log(a),d.list=i,g.setObject($,i),d.id_app=id_app,d.current_page=t,d.condition=e,d.filter=n.filter,d.filter_title=n.filter_title,n.current_page=t,n.list=i,n.renderCompleted=!0,r&&r(null,n.list),n.$emit("$dataChangeSuccess")})}).error(function(t){console.log(t),n.$emit("$dataChangeError"),r&&r(t)})})},d.list&&0!=d.list.length&&id_app&&d.id_app==id_app?(n.list=[],l.nextTick(function(){n.$emit("$dataChangeStart"),condition=d.condition,n.filter=d.filter,n.list=d.list,n.current_page=d.current_page,n.current_page||(n.current_page=1),o.load(id_app,{condition:condition,filter:n.filter,count:1,queryParams:m,onCondition:i.onCondition}).success(function(t){n.total_page=Math.round(t.rows_number/n.limit,0),n.total_page<t.rows_number/n.limit&&(n.total_page+=1),0==n.total_page&&(n.total_page=1),n.pages=[];for(var e=1;e<=n.total_page;e++)n.pages.push(e);n.$emit("$dataChangeSuccess"),n.renderCompleted=!0}).error(function(){n.$emit("$dataChangeError"),n.renderCompleted=!0})})):n.goToPage(1,null,function(t){t&&l.nextTick(function(){var t=g.getObject($);n.list&&0!=n.list.length||(n.list=t,n.current_page=1,n.total_page=1),n.renderCompleted=!0})}),n.update=function(t){n.$emit("$dataSaveStart"),o.update(id_app,t._id,t).success(function(){t.updated=!0,n.$emit("$dataSaveSuccess"),alert("Đã cập nhật thành công")}).error(function(t){n.$emit("$dataSaveError");var e=JSON.stringify(t);if(e.indexOf("Lỗi")<0){if(e.indexOf("duplicate")>=0)return e="Lỗi: Đã tồn tại",alert(e);if(e.indexOf("Not allowed")>=0)return e="Lỗi: Bạn không có quyền thực hiện thao tác này",alert(e)}e=JSON.parse(e),alert(angular.isArray(e)?e.join("\n"):e)})},n.add=function(){var t="/"+n.path+"/add";c.path(t)},n.edit=function(t){c.path("/"+n.path+"/edit/"+t)},n.view=function(t){c.path("/"+n.path+"/view/"+t)},n.openProfile=function(t){viewProfile(p,t)},n.searchKeyup=function(t){13==t.keyCode&&n.search()},n.search=function(t){n.renderCompleted&&n.goToPage(1,t)},n.changeFilter=function(t){n.findBy=null,n.filter=t.filter,n.filter_title=t.title,n.search()},n.changeFindBy=function(t){n.filter=null,n.findBy=t.findBy,n.filter_title=t.title,n.search()},n.location=c.url(),n.reverse=!0,n.order=function(t,e){n.list=h("orderBy")(n.list,t,e)},n.selectionAll=!1,n.$watch("selectionAll",function(t){n.list&&n.list.forEach(function(e){e.sel=t})}),n.isUnSelected=function(){if(!n.list)return!0;for(var t=0;t<n.list.length;t++){var e=n.list[t];if(e.sel&&1==e.sel)return!1}return!0},n.delete=function(t){t?confirm("Có chắc chắn xóa không?")&&o.delete(id_app,t).success(function(){n.list=_.reject(n.list,function(e){return e._id==t}),d.list=n.list}).error(function(t){var e;e=_.isObject(t)?JSON.stringify(t):t,alert(e.indexOf("Lỗi:")>=0?e:"Không thể xóa")}):confirm("Có chắc chắn xóa những dòng đã chọn không?")&&async.map(n.list,function(t,e){if(t.sel&&1==t.sel){var a=t._id;o.delete(id_app,a).success(function(){n.list=_.reject(n.list,function(t){return t._id==a}),e(null,a)}).error(function(t){e(t)})}else e()},function(t){if(t){var e;e=_.isObject(t)?JSON.stringify(t):t,alert(e.indexOf("Lỗi:")>=0?e:"Không thể xóa")}else d.list=n.list})},r.initHomeController&&r.initHomeController(e,n,a,o,c,d),id_app&&l.nextTick(function(){var e=server_url+"/api/"+id_app+"/rpt?q={ma_cn:'"+t.toUpperCase()+"'}";a.get(e).success(function(t){n.rpts=t}).error(function(t){console.log(t)})}),n.rptManagement=function(){var e="rpt?ma_cn="+t.toUpperCase();c.url(e)},n.print=function(e){n.list.forEach(function(n){if(n.sel){var a=server_url+"/api/"+id_app+"/"+t+"/excel/"+e+"?_id="+n._id+"&access_token="+l.token;u.open(a)}})},n.import=function(){var e="#"+t+"/import?t=1";if(r.initImport)r.initImport(n,e,function(t,e){if(t)return u.alert(t);var a=0,i=u.open(e,"Import","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=200");stop=s(function(){return"OK"==i.document.title?(n.search(),s.cancel(stop),stop=void 0,void i.close()):"ERROR"==i.document.title?(s.cancel(stop),void(stop=void 0)):(a+=500,void(a>3e5&&stop&&(s.cancel(stop),stop=void 0)))},500)});else{var a=0,i=u.open(e,"Import","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=200");stop=s(function(){return"OK"==i.document.title?(n.search(),s.cancel(stop),stop=void 0,void i.close()):"ERROR"==i.document.title?(s.cancel(stop),void(stop=void 0)):(a+=500,void(a>3e5&&stop&&(s.cancel(stop),stop=void 0)))},500)}},n.follow=function(e){1==e.follow_yn?a.delete(server_url+"/api/"+id_app+"/follow/"+e.followObject._id).success(function(){e.follow_yn=0}).error(function(t){t&&u.alert(t)}):(followObject={id_object:e._id,collection_name:t,id_app:id_app},a.post(server_url+"/api/"+id_app+"/follow",followObject).success(function(t){e.followObject=t,e.follow_yn=1}).error(function(t){t&&u.alert(t)}))},n.isLike=!1,id_app&&(a.get(server_url+"/api/"+id_app+"/like_module?q={module:'"+t+"',user_created:'"+v.email+"'}").success(function(t){t&&1==t.length&&(n.isLike=t[0].like)}).error(function(t){console.log(t)}),n.like=function(){var e=server_url+"/api/"+id_app+"/like_module";a.post(e,{id_app:id_app,module:t,like:!0}).success(function(t){t&&(n.isLike=!0)}).error(function(t){console.log(t)})},n.unlike=function(){var e=server_url+"/api/"+id_app+"/like_module";a.post(e,{id_app:id_app,module:t,like:!1}).success(function(t){t&&(n.isLike=!1)}).error(function(t){console.log(t)})}),n.$on("keydown",function(t,e){return 116==e.which?void n.search():e.ctrlKey&&77==e.which?void n.add():e.ctrlKey&&68==e.which?void n.delete():(e.ctrlKey&&65==e.which&&n.list&&n.list.forEach(function(t){t.sel=!0}),void(e.ctrlKey&&85==e.which&&n.list&&n.list.forEach(function(t){t.sel=!1})))}),n.options=function(){token=l.token,p.open({templateUrl:"templates/"+r.group+"/"+t+"/templates/options.html",controller:["$scope","$controller","$http","$modalInstance","$window",function(e,n,a,i){var o=server_url+"/api/"+id_app+"/options",r={};a.get(o+"?access_token="+token+"&q={id_func:'"+t+"'}").success(function(n){1==n.length?(r=n[0],e.options=r.option):(r.id_app=id_app,r.id_func=t)}).error(function(){console.log(o)}),e.save=function(){r.option=e.options,r._id?a.put(o+"/"+r._id+"?access_token="+token,r).success(function(){i.close()}).error(function(t){alert("Không thể cập nhật tùy chọn\n"+t.toString())}):a.post(o+"?access_token="+token,r).success(function(){i.close()}).error(function(t){alert("Không thể lưu tùy chọn\n"+t.toString())})},e.cancel=function(){i.dismiss("cancel")}}],size:"lg",resolve:{}})}}})}]),this.module.directive(t+"Form",[function(){return{restrict:"E",templateUrl:"templates/"+r.group+"/"+t+"/templates/form.html"}}]),this.module.controller(t+"ImportController",["$scope","$rootScope","$location","$routeParams",t+"Config","appInfo",function(e,n,a,i,o,c){c.info(t,function(t){if(!t){var i=n.token;n.hide_nav=!0,e.action=server_url+"/api/"+id_app+"/"+r.server_path+"/import/excel?access_token="+i,e.template="templates/templates/"+r.code+".xlsx";var o=a.search();o.values&&(e.action=e.action+"&values="+o.values),o.update&&(e.action=e.action+"&update="+o.update)}})}]),this.module.controller(t+"AddController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$modal","$window","appInfo",function(e,n,a,o,c,d,l,u,s,p){n.masterData={status:!0},n.data={status:!0,visible_to:0},n.$modal=u,n.$http=a,n.$window=s,r.defaultValues&&(_.extend(n.data,r.defaultValues),_.extend(n.masterData,r.defaultValues));var h=c.search();h&&(_.extend(n.data,h),_.extend(n.masterData,h)),r.init&&r.init(n,e),n.action="Thêm mới",p.info(t,function(t){if(!t){n.current_user=l.user,n.isDataLoaded=!0,angular.extend(n,d),i.onAdd&&l.nextTick(function(){i.onAdd(n,{$controller:e,$rootScope:l,$http:a,service:o,$location:c,config:d,$window:s,$modal:u})}),n.reset=function(){n.data=angular.copy(n.masterData)},n.cancel=function(){var t=c.search().redirect;t?"back"==t?s.history.back():c.url(t):c.url("/"+n.path)},n.isUnchanged=function(){return angular.equals(n.data,n.masterData)};var _=function(){n.$emit("$dataSaveStart"),o.create(id_app,n.data).success(function(t){n.masterData=t,d.list||(d.list=[]),d.list.push(n.masterData);var e=c.search().redirect;e?"back"==e?s.history.back():c.url(e):i.has_view?c.url("/"+n.path+"/view/"+t._id):c.path("/"+n.path),n.$emit("$dataSaveSuccess")}).error(function(t){n.$emit("$dataSaveError");var e=t;e.indexOf("Lỗi")<0&&(e.indexOf("duplicate")>=0?e="Lỗi: Đã tồn tại":e.indexOf("Not allowed")>=0&&(e="Lỗi: Bạn không có quyền thực hiện thao tác này")),alert(angular.isArray(e)?e.join("\n"):e)})};n.create=function(){i.onSave?i.onSave(n,n.data,{action:"CREATE",$controller:e,$rootScope:l,$http:a,service:o,$location:c,config:d,$window:s,$modal:u},function(t,e){return t?s.alert(t):void(e&&_())}):_()},n.$on("keydown",function(t,e){e.ctrlKey&&83==e.which&&n.create()}),r.initAddController&&r.initAddController(e,n,a,o,c,d)}})}]),this.quickadd=function(e,n,a){e.open({templateUrl:"templates/"+r.group+"/"+t+"/templates/dialog-quickadd.html",controller:["$scope","$controller","$http",t,"$location",t+"Config","$modalInstance","$window","$rootScope",function(t,o,c,d,l,u,s,p,h){if(t.masterData={status:!0},t.data={status:!0,visible_to:0},t.isDataLoaded=!0,t.$modal=e,t.$http=c,t.$window=p,t.action="Thêm mới",r.init&&r.init(t,o),r.defaultValues&&_.extend(t.data,r.defaultValues),a)for(var f in a)t.data[f]=a[f];var g=l.search();g&&(_.extend(t.data,g),_.extend(t.masterData,g)),angular.extend(t,u),r.initAddController&&r.initAddController(o,t,c,d,l,u),t.isUnchanged=function(){return angular.equals(t.data,t.masterData)},i.onAdd&&h.nextTick(function(){i.onAdd(t,{$controller:o,$rootScope:h,$http:c,service:d,$location:l,config:u,$window:p,$modal:e})});var m=function(){t.$emit("$dataSaveStart"),d.create(id_app,t.data).success(function(e){t.masterData=e,u.list||(u.list=[]),u.list.push(t.masterData),n&&n(t.masterData),s.close(),t.$emit("$dataSaveSuccess")}).error(function(e){t.$emit("$dataSaveError");var n=e;n.indexOf("Lỗi")<0&&(n.indexOf("duplicate")>=0?n="Lỗi: Đã tồn tại":n.indexOf("Not allowed")>=0&&(n="Lỗi: Bạn không có quyền thực hiện thao tác này")),alert(angular.isArray(n)?n.join("\n"):n)})};t.create=function(){i.onSave?i.onSave(t,t.data,{action:"CREATE",$controller:o,$rootScope:h,$http:c,service:d,$location:l,config:u,$window:p,$modal:e},function(t,e){return t?p.alert(t):void(e&&m())}):m()},t.cancel=function(){s.dismiss("cancel")}}],size:"lg",backdrop:"static",resolve:{}})},this.quickedit=function(e,n,a){e.open({templateUrl:"templates/"+r.group+"/"+t+"/templates/dialog-quickadd.html",controller:["$scope","$controller","$http",t,"$location",t+"Config","$modalInstance","$window","$routeParams","$timeout","$rootScope",function(t,o,c,d,l,u,s,p,h,f,g){t.data={},r.init&&r.init(t,o),g.nextTick(function(){d.get(id_app,n).success(function(m){if(!m)return p.alert("Đối tượng này không tồn tại\nid:"+n),void s.dismiss("cancel");t.masterData=m,_.extend(t.data,m),t.$modal=e,t.$http=c,t.$window=p,t.action="Sửa",r.loadItem&&r.loadItem(t,t.data),f(function(){t.isDataLoaded=!0},100),angular.extend(t,u),t.isUnchanged=function(){return angular.equals(t.data,t.masterData)},i.onEdit&&g.nextTick(function(){i.onEdit(t,{$controller:o,$rootScope:g,$http:c,service:d,$location:l,config:u,$window:p,$modal:e})});var v=function(){t.$emit("$dataSaveStart"),d.update(id_app,n,t.data).success(function(e){for(var n in e)t.masterData[n]=e[n];a&&a(t.masterData),s.close(),t.$emit("$dataSaveSuccess")}).error(function(e){t.$emit("$dataSaveError");var n=JSON.stringify(e);if(n.indexOf("Lỗi")<0){if(n.indexOf("duplicate")>=0)return n="Lỗi: Đã tồn tại",alert(n);if(n.indexOf("Not allowed")>=0)return n="Lỗi: Bạn không có quyền thực hiện thao tác này",alert(n)}n=JSON.parse(n),alert(angular.isArray(n)?n.join("\n"):n)})};t.create=function(){i.onSave?i.onSave(t,t.data,{action:"UPDATE",$controller:o,$rootScope:g,$http:c,service:d,$location:l,config:u,$window:p,$modal:e},function(t,e){return t?p.alert(t):void(e&&v())}):v()},t.cancel=function(){s.dismiss("cancel")},r.initEditController&&r.initEditController(o,t,c,d,l,h,u,f)}).error(function(t){alert(t.indexOf("Lỗi")>=0?t:"Không thể tìm thấy đối tượng này"),s.dismiss("cancel")})})}],size:"lg",backdrop:"static",resolve:{}})},this.module.controller(t+"EditController",["$controller","$scope","$http",t,"$location","$routeParams",t+"Config","$timeout","$rootScope","$modal","$window","appInfo",function(e,n,a,o,c,d,l,u,s,p,h,f){n.masterData=null,n.data={},n.$modal=p,n.$http=a,n.$window=h,n.action="Sửa",angular.extend(n,l),r.init&&r.init(n,e),f.info(t,function(t){if(!t){n.current_user=s.user,l.list&&(n.masterData=_.find(l.list,function(t){return t._id==d.id})),n.openProfile=function(t){viewProfile(p,t)},n.masterData?(n.data=angular.copy(n.masterData),r.loadItem&&r.loadItem(n,n.data),i.onEdit&&s.nextTick(function(){i.onEdit(n,{$controller:e,$http:a,service:o,$location:c,config:l,$window:h,$modal:p})}),u(function(){n.isDataLoaded=!0},100)):(n.masterData={},s.nextTick(function(){n.$emit("$dataChangeStart"),o.get(id_app,d.id).success(function(t){n.masterData=t,n.data=angular.copy(n.masterData),l.list||(l.list=[]),l.list.push(n.masterData),r.loadItem&&r.loadItem(n,n.data),i.onEdit&&s.nextTick(function(){i.onEdit(n,{$controller:e,$rootScope:s,$http:a,service:o,$location:c,config:l,$window:h,$modal:p})}),u(function(){n.isDataLoaded=!0,n.$emit("$dataChangeSuccess")},100)}).error(function(t){n.$emit("$dataChangeError"),alert(t.indexOf("Lỗi")>=0?t:"Không thể tìm thấy đối tượng này")})})),n.isUnchanged=function(){return angular.equals(n.data,n.masterData)},n.reset=function(){n.data=angular.copy(n.masterData)},n.cancel=function(){var t=c.search().redirect;t?"back"==t?h.history.back():c.url(t):c.url(i.has_view?"/"+n.path+"/view/"+n.data._id:"/"+n.path)},n.$on("keydown",function(t,e){e.ctrlKey&&83==e.which&&n.create()});var f=function(){n.$emit("$dataSaveStart"),o.update(id_app,d.id,n.data).success(function(t){for(var e in t)n.masterData[e]=t[e];var a=c.search().redirect;a?"back"==a?h.history.back():c.url(a):i.has_view?c.url("/"+n.path+"/view/"+t._id):c.path("/"+n.path),n.$emit("$dataSaveSuccess")}).error(function(t){n.$emit("$dataSaveError");var e=JSON.stringify(t);if(e.indexOf("Lỗi")<0){if(e.indexOf("duplicate")>=0)return e="Lỗi: Đã tồn tại",alert(e);if(e.indexOf("Not allowed")>=0)return e="Lỗi: Bạn không có quyền thực hiện thao tác này",alert(e)}e=JSON.parse(e),alert(angular.isArray(e)?e.join("\n"):e)})};n.create=function(){i.onSave?i.onSave(n,n.data,{action:"UPDATE",$controller:e,$rootScope:s,$http:a,service:o,$location:c,config:l,$window:h,$modal:p},function(t,e){return t?h.alert(t):void(e&&f())}):f()},r.initEditController&&r.initEditController(e,n,a,o,c,d,l,u)}})}]),this.module.controller(t+"ViewController",["$controller","$scope","$routeParams",t+"Config",t,"$rootScope","$location","$window","$http","$modal","appInfo","$localStorage","$interval",function(e,n,a,o,r,c,d,l,u,s,p,h,f){p.info(t,function(p){if(!p){n.code=t,n.location=d.url(),n.current_user=c.user,n.action="Xem",n.current_record=0,n.total_records=0,angular.extend(n,o);var g=function(){c.nextTick(function(){n.$emit("$dataChangeStart"),r.get(id_app,a.id).success(function(t){n.data=t,n.data.links=[],id_app&&u.get(server_url+"/api/"+id_app+"/follow?q={id_object:'"+t._id+"',user_created:'"+n.current_user.email+"'}").success(function(e){e&&e.length>0?(t.followObject=e[0],t.follow_yn=1):t.follow_yn=0}).error(function(){t.follow_yn=0}),i.onView&&i.onView(n,{$controller:e,$http:u,service:r,$location:d,config:o,$window:l,$modal:s,$rootScope:c,$localStorage:h,$interval:f}),n.$emit("$dataChangeSuccess")}).error(function(t){t&&alert(t),n.$emit("$dataChangeError"),d.url("/"+n.path)})})};if(n.list)for(var m=0;m<n.list.length;m++)if(n.list[m]._id==a.id){n.current_record=m,n.total_records=n.list.length-1,n.data=n.list[n.current_record],n.data.links=[],i.onView&&i.onView(n,{$controller:e,$http:u,service:r,$location:d,config:o,$window:l,$modal:s,$rootScope:c,$localStorage:h,$interval:f});break}n.data||g(),n.back=function(){var t=d.search().redirect;t?"back"==t?l.history.back():d.url(t):d.url("/"+n.path)},n.update=function(t,e){var a={};_.extend(a,n.data),t&&_.extend(a,t),r.update(id_app,n.data._id,a).success(function(t){_.extend(n.data,t),e&&e(null,t)}).error(function(t){e?e(t):t&&l.alert(t)})},n.edit=function(){d.url("/"+t+"/edit/"+a.id)},n.add=function(){var t="/"+n.path+"/add";d.path(t)},n.backRecord=function(){if(n.current_record>0){n.current_record=n.current_record-1;var e=n.list[n.current_record]._id;d.path(t+"/view/"+e)}},n.nextRecord=function(){if(n.list&&n.current_record<n.total_records){n.current_record=n.current_record+1;var e=n.list[n.current_record]._id;d.path(t+"/view/"+e)}},n.delete=function(t){confirm("Có chắc chắn xóa không?")&&r.delete(id_app,t).success(function(){o.list=_.reject(o.list,function(e){return e._id==t});var e=d.search().redirect;e?"back"==e?l.history.back():d.url(e):d.url("/"+n.path)}).error(function(t){var e;e=_.isObject(t)?JSON.stringify(t):t,alert(e.indexOf("Lỗi:")>=0?e:"Không thể xóa")})},n.openProfile=function(t){viewProfile(s,t)},n.follow=function(){1==n.data.follow_yn?u.delete(server_url+"/api/"+id_app+"/follow/"+n.data.followObject._id).success(function(){n.data.follow_yn=0}).error(function(t){t&&l.alert(t)}):(followObject={id_object:n.data._id,collection_name:t,id_app:id_app},u.post(server_url+"/api/"+id_app+"/follow",followObject).success(function(t){n.data.followObject=t,n.data.follow_yn=1}).error(function(t){t&&l.alert(t)}))},n.$on("keydown",function(t,e){if(116==e.which)return void g();if(e.ctrlKey){if(69==e.which)return void n.edit();if(77==e.which)return void n.add()}}),n.addLink=function(e,a){var i={};i.id_a=n.data._id,i.collection_a=t,i.collection_b=e.collection_name,i.id_b=e._id;var o=server_url+"/api/"+id_app+"/link";u.post(o,i).success(function(t){_.extend(i,t),i.obj=e,i.collection_obj=e.collection_name,i.title=e[a],n.data.links.push(i)}).error(function(t){console.log(t);var o={id_a:i.id_a,id_b:i.id_b};u.get(server_url+"/api/"+id_app+"/link?q="+JSON.stringify(o)).success(function(t){t.length>0&&(_.extend(i,t[0]),i.obj=e,i.collection_obj=e.collection_name,i.title=e[a],n.data.links.push(i))}).error(function(t){console.error(t)})})}}})}]),this.module.config(["$routeProvider","$locationProvider",function(e){e.when("/"+t,{templateUrl:"templates/"+r.group+"/"+t+"/templates/list.html",controller:t+"HomeController"}).when("/"+t+"/add",{templateUrl:"templates/"+r.group+"/"+t+"/templates/edit.html",controller:t+"AddController"}).when("/"+t+"/json",{templateUrl:"templates/sys/json.html",controller:t+"JsonController"}).when("/"+t+"/import",{templateUrl:"templates/sys/import.html",controller:t+"ImportController"}).when("/"+t+"/edit/:id",{templateUrl:"templates/"+r.group+"/"+t+"/templates/edit.html",controller:t+"EditController"}).when("/"+t+"/view/:id",{templateUrl:"templates/"+r.group+"/"+t+"/templates/view.html",controller:t+"ViewController"})}]),this.initModule&&this.initModule(this.module)},baseRpt=function(t,e,n,a){this.rptId=t;var i=t+"Module";_.contains(modulesD,i)||modulesD.push(i),this.rptModuleName=i,this.module=angular.module(this.rptModuleName,["ngRoute"]);var o=this;a||(a={}),a.onInit&&(o.init=a.onInit),a.onAfterLoadData&&(o.afterLoadData=a.onAfterLoadData),a.onDefaultCondition&&(o.defaultCondition=a.onDefaultCondition),a.onPrepareCondition&&(o.prepareCondition=a.onPrepareCondition),this.getUrl=function(){var t;return t=0==a.require_id_app?server_url+"/public/"+e:server_url+"/api/"+id_app+"/"+e},this.module.factory(t+"Config",function(){return{}}),this.getData=function(t,e,n,a,i){var r=o.getUrl()+"?t=1";i&&i.$emit("$dataChangeStart"),n&&angular.forEach(n,function(t,e){angular.isDate(t)?t=JSON.stringify(t).replace(/\"/g,""):angular.isObject(t)&&(t=JSON.stringify(t)),r=r+"&"+e+"="+encodeURI(t)}),t.get(r).success(function(t){a(null,t),i&&i.$emit("$dataChangeSuccess")}).error(function(t){console.log(t),a(t),i&&i.$emit("$dataChangeError")})},this.module.controller(t+"Controller",["$scope","$http","$filter","$location",t+"Config","$controller","$rootScope","$window","appInfo",function(e,i,r,c,d,l,u,s,p){var h=c.search();if(!e.condition){if(e.condition={},o.defaultCondition&&o.defaultCondition(e.condition),_.isEqual(h,{})&&d.condition)for(var f in d.condition)c.search(f,d.condition[f]),h[f]=d.condition[f];_.extend(e.condition,h)}o.init&&o.init(e,i,r,c,d,l),(0==a.require_id_app||1==p.info(t))&&(e.title=n,d.id_app==id_app&&_.isEqual(h,d.condition)&&(e.data=d.data),e.data?(e.condition_show=!1,o.afterLoadData&&o.afterLoadData(e,e.data)):e.condition_show=!0,e.hideCondition=function(){e.condition_show=!e.condition_show},e.viewVoucher=function(t,e){if(t&&e){var n=t.toLowerCase()+"/edit/"+e+"?redirect=back";c.url(n)}},e.order=function(t,n){e.data=r("orderBy")(e.data,t,n)},e.getData=function(){a.onStartGetData?a.onStartGetData(e,function(t){t?alert(t):e.getDataFromServer()}):e.getDataFromServer()},e.getDataFromServer=function(){e.data=[];for(var t in e.condition){var n=e.condition[t];angular.isDate(n)&&(n=r("date")(n,"yyyy-MM-dd")),n&&""!=n&&c.search(t,n)}o.prepareCondition?o.prepareCondition(e.condition,r,function(t,n){t?e.error=t:o.getData(i,r,n,function(t,n){e.data=n,e.error=t,t||(e.condition_show=!1,d.condition=c.search(),d.data=n,d.id_app=id_app,o.afterLoadData&&o.afterLoadData(e,n))},e)}):o.getData(i,r,e.condition,function(t,n){e.data=n,e.error=t,t||(e.condition_show=!1,d.condition=c.search(),d.data=n,d.id_app=id_app,o.afterLoadData&&o.afterLoadData(e,n))},e)},e.print=function(){c.path("/"+t+"/print")},e.exportExcel=function(){var t=o.getUrl()+"/excel?access_token="+access_token;o.prepareCondition?o.prepareCondition(e.condition,r,function(n,a){n?e.error=n:(angular.forEach(a,function(e,n){angular.isDate(e)&&(e=r("date")(e,"yyyy-MM-dd")),angular.isObject(e)&&(e=JSON.stringify(e)),e&&(t=t+"&"+n+"="+encodeURI(e))}),s.open(t))}):(angular.forEach(e.condition,function(e,n){angular.isDate(e)&&(e=r("date")(e,"yyyy-MM-dd")),angular.isObject(e)&&(e=JSON.stringify(e)),e&&(t=t+"&"+n+"="+encodeURI(e))}),s.open(t))},a.onLoading&&a.onLoading(e,{$http:i,$filter:r,$location:c,$config:d,$controller:l}),e.condition.isDrillDown&&(delete e.condition.isDrillDown,e.getData()),e.isLike=!1,id_app&&(i.get(server_url+"/api/"+id_app+"/like_module?q={module:'"+t+"'}").success(function(t){t&&1==t.length&&(e.isLike=t[0].like)}).error(function(t){console.log(t)}),e.like=function(){var n=server_url+"/api/"+id_app+"/like_module";i.post(n,{id_app:id_app,module:t,like:!0}).success(function(t){t&&(e.isLike=!0)}).error(function(t){console.log(t)})},e.unlike=function(){var n=server_url+"/api/"+id_app+"/like_module";i.post(n,{id_app:id_app,module:t,like:!1}).success(function(t){t&&(e.isLike=!1)}).error(function(t){console.log(t)})}),e.$on("keydown",function(t,n){if(116==n.which)return void e.getData();if(n.ctrlKey){if(69==n.which)return void e.exportExcel();if(80==n.which)return void e.print()}}))}]),this.module.controller(t+"PrintController",["$controller","appInfo","$scope",t+"Config","$timeout","$location","$rootScope",function(e,a,i,r,c,d,l){a.info(t,function(a,u,s){a||(i.parameters={},i.condition=r.condition,i.title=n,i.data=r.data,i.appInfo=s,o.setParameters&&o.setParameters(i,e),i.print=function(){i.printing=!0,l.printing=!0,c(function(){window.print(),i.printing=!1,l.printing=!1},100)},i.back=function(){d.url("/"+t)},i.$on("keydown",function(t,e){return e.ctrlKey&&80==e.which?void i.print():void 0}))})}]),this.module.config(["$routeProvider","$locationProvider",function(e){e.when("/"+t,{templateUrl:"templates/reports/"+t+"/templates/browser.html",controller:t+"Controller",reloadOnSearch:!1}).when("/"+t+"/print",{templateUrl:"templates/reports/"+t+"/templates/print.html",controller:t+"PrintController",reloadOnSearch:!1})}])},dateTime2Date=function(t){return new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()))},baseVoucher=function(t,e,n,a,i){var o=this;i||(i={}),i.group="vouchers",o.defaultCondition4Search=i.defaultCondition4Search,o.prepareCondition4Search=i.onPrepareCondition4Search,o.watchMaster=i.onWatchMaster,o.defaultValues4Detail=i.onDefaultValues4Detail,o.watchDetail=i.onWatchDetail;var r=i.onLoading;i.onLoading=function(e,n){r&&r(e,n),e.find=function(){n.$modal.open({templateUrl:"templates/vouchers/"+t+"/templates/find.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.vcondition={},o.defaultCondition4Search&&(t.vcondition=o.defaultCondition4Search),t.list=n.list,t.search=n.search,t.okFind=function(){o.defaultCondition4Search=t.vcondition,o.prepareCondition4Search?n.condition=o.prepareCondition4Search(t,t.vcondition):(n.condition={},_.extend(n.condition,t.vcondition)),t.search(),e.close()},t.cancelFind=function(){e.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return e
}}})}};var c=i.onEdit;i.onEdit=function(t,e){c&&c(t,e),t.data.details||(t.data.details=[]),t.round=0,t.$watch("data.ma_nt",function(e){e&&"VND"!=e&&(t.round=2)}),o.watchMaster&&o.watchMaster(t)};var d=i.onAdd;i.onAdd=function(t,e){d&&d(t,e),t.data.ty_gia=1,t.data.ma_nt="VND",t.data.ngay_ct=new Date,t.data.details=[],e.service.next(id_app,"so_ct").success(function(e){t.data.so_ct=e.so_ct}).error(function(t){console.log(t)}),t.round=0,t.$watch("data.ma_nt",function(e){e&&"VND"!=e&&(t.round=2)}),o.watchMaster&&o.watchMaster(t)},baseInput.call(this,t,e,n,a,i),o.module.directive(t+"DetailTable",function(){return{restrict:"E",scope:{ngMasterData:"="},templateUrl:"templates/vouchers/"+t+"/templates/detail-table.html",controller:["$scope","$modal","$timeout","$http","$window",function(e,n,a,i,r){e.status={isOpened:!1},e.$modal=n,e.$http=i,e.$window=r,e.isNotRowSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},e.deleteRow=function(t){var e=_.reject(t,function(t){return 1==t.sel});t.length=0;var n=0;e.forEach(function(e){e.line=n,t.push(e),n++})},e.addDetail=function(){var t=e.ngMasterData.details.length;e.dt_master=null,e.dt_current={line:t},o.defaultValues4Detail&&_.extend(e.dt_current,o.defaultValues4Detail),e.ngMasterData.details||(e.ngMasterData.details=[]),e.openDetail("lg")},e.editDetail=function(t){e.dt_master=_.find(e.ngMasterData.details,function(e){return e.line==t}),e.dt_current={},_.extend(e.dt_current,e.dt_master),e.openDetail("lg")},e.openDetail=function(i){var o=n.open({templateUrl:"templates/vouchers/"+t+"/templates/detail-edit.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.data=n.ngMasterData,t.status=n.status,t.dt_master=n.dt_master,t.dt_current=n.dt_current,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.data.details.push(t.dt_master));for(var n in t.dt_current)t.dt_master[n]=t.dt_current[n];e.close()},t.cancelDetail=function(){e.dismiss("cancel")}}],size:i,resolve:{parentScope:function(){return e}}});o.opened.then(function(){a(function(){e.status.isOpened=!0},100)}),o.result.then(function(){e.status.isOpened=!1})}}],link:function(t){o.watchDetail&&o.watchDetail(t)}}})};baseVoucher.prototype=new baseInput;var baseService=function(t,e,n,a){var i={list:function(a,i,o,r,c,d,l,u,s){var p=e()+"?t=1";if(1==r&&(p+="&count=1"),c&&(p=p+"&page="+c.toString()),d&&(p=p+"&limit="+d.toString()),angular.isObject(i)){var h={};_.extend(h,i),l&&_.extend(h,l),s&&_.extend(h,s),u&&u(h,i);var f=JSON.stringify(h);p=p+"&q="+encodeURI(f)}else{var h={};i&&n&&0!=n.length?(h.$or=[],n.forEach(function(t){var e={};e[t]={$regex:i,$options:"i"},h.$or.push(e)})):l&&_.extend(h,l),s&&_.extend(h,s),u&&u(h,i),p=p+"&q="+encodeURI(JSON.stringify(h))}return o&&(p=p+"&fields="+o),t.get(p)},next:function(n,a){return t.get(e()+"/next/"+a)},get:function(n,a){return t.get(e()+"/"+a)},create:function(n,a){return t.post(e(),a)},update:function(n,a,i){return t.put(e()+"/"+a,i)},"delete":function(n,a){return t.delete(e()+"/"+a)},getSocai:function(n,a){return t.get(e()+"/socai/"+a)},getVsocai:function(n,a){return t.get(e()+"/vsocai/"+a)}};return i.load=function(t,e){return e?i.list(t,e.condition,e.fields,e.count,e.page,e.limit,e.queryParams,e.onCondition,e.filter):i.list(t)},a&&_.extend(i,a(t)),i},loginModule=angular.module("loginModule",["ngRoute"]);loginModule.controller("loginController",["$scope","$rootScope","api","$http","$location","user","Base64","$window","$interval","$localStorage",function(t,e,n,a,i,o,r,c,d,l){l.set("token",""),l.set("id_app",""),e.app_info=void 0,e.isLogined=!1,id_app=void 0,e.id_app=void 0,e.user=void 0,n.init(),t.data={},t.auth_google=function(){var t=c.open(server_url+"/auth/google","Google authentication","height=400,width=400"),a=d(function(){try{if(t.location.href&&t.location.href.indexOf("/auth/google/callback")&&t.document.body.innerHTML&&t.document.body.innerHTML.indexOf("access_token")>=0){var r=t.document.title;d.cancel(a),t.close(),l.set("token",r),n.init(r),o.getInfo(function(t){e.user=t,i.url("/app")})}}catch(c){console.log(c)}},500)},t.auth_facebook=function(){var t=c.open(server_url+"/auth/facebook","Facebook authentication","height=400,width=400"),a=d(function(){try{if(t.location.href&&t.location.href.indexOf("/auth/facebook/callback")&&t.document.body.innerHTML&&t.document.body.innerHTML.indexOf("access_token")>=0){var r=t.document.title;d.cancel(a),t.close(),l.set("token",r),n.init(r),o.getInfo(function(t){e.user=t,i.url("/app")})}}catch(c){}},500)},t.auth_local=function(){var c=server_url+"/auth/local",d="Basic "+r.encode(t.data.username+":"+t.data.password);a.get(c,{headers:{Authorization:d}}).success(function(t){l.set("token",t),n.init(t),o.getInfo(function(t){e.user=t,i.url("/app")})}).error(function(e){t.messageError=e})},t.signup=function(){i.url("/signup")}}]),loginModule.controller("signupController",["$scope","$rootScope","api","$http","$location","$localStorage",function(t,e,n,a,i,o){o.remove("token"),o.remove("id_app"),e.app_info=void 0,id_app=void 0,e.id_app=void 0,e.isLogined=!1,n.init(),t.data={},t.signup=function(){var e=server_url+"/signup";a.post(e,t.data).success(function(e){t.alertType="alert alert-success",t.messageError=e,t.data={}}).error(function(e){t.alertType="alert alert-danger",t.messageError=e})}}]),loginModule.factory("user",["$http","$localStorage","$rootScope","$location","socket","nodeWebkit",function(t,e,n,a,i,o){return{getInfo:function(e){n.user?e(null,n.user):t.get(server_url+"/api/user").success(function(t){var a=t.name.split(" ");t.last_name=a[a.length-1],n.error=void 0,n.user=t,i.on("connect",function(){i.emit("login",{token:t.token,email:t.email})}),i.emit("login",{token:t.token,email:t.email}),i.on("notify:count",function(t){n.notifies_count=t,t&&o.notification("Bạn có thông báo mới")}),i.on("message:count",function(t){n.messages_count=t,t&&o.notification("Bạn có tin nhắn mới")}),i.on("disconnect",function(){}),e(null,t)}).error(function(t){t||(t="Không thể kết nối với máy chủ"),n.error=t,n.user=void 0,e(t),a.url("login")})},getProfile:function(e,n){var a=server_url+"/api/profile?email="+e;t.get(a).success(function(t){n(null,t)}).error(function(t){n(t)})},getProfileByToken:function(e){var n=server_url+"/api/profile";t.get(n).success(function(t){e(null,t)}).error(function(t){e(t)})},updateProfile:function(e,n){var a=server_url+"/api/updateprofile";t.post(a,e).success(function(t){n(null,t)}).error(function(t){n(t)})},updatePassword:function(e,n){var a=server_url+"/api/changepassword";t.post(a,e).success(function(t){n(null,t)}).error(function(t){n(t)})},resetPassword:function(e,n){var a=server_url+"/resetpassword?email="+e;t.get(a).success(function(t){n(null,t)}).error(function(t){n(t)})},getNotifies:function(e){var n=server_url+"/api/notifies";t.get(n).success(function(t){e(null,t)}).error(function(t){e(t)})},getMessagesColleagues:function(e){var n=server_url+"/api/message/colleague/latest";t.get(n).success(function(t){e(null,t)}).error(function(t){e(t)})},logout:function(n){return e.get("token")?void t.get(server_url+"/api/user/logout").success(function(t){n(t)}).error(function(){n()}):n}}}]),loginModule.controller("uploadController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams",function(t,e,n,a,i,o,r,c){var d=c.folder;t.action=server_url+"/api/uploadfile?access_token="+n.get("token")+"&folder="+d}]),loginModule.controller("uploadExcelController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams",function(t,e,n){t.action=server_url+"/api/uploadexcel?access_token="+n.get("token")}]),loginModule.controller("profileController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$interval","appInfo",function(t,e,n,a,i,o,r,c,d){d.info("profile",function(a){a||(t.access_token=n.get("token"),e.getProfileByToken(function(e,n){return e?(t.alertType="danger",t.messageError=e):(t.alertType="success",void(t.data=n))}),t.updateProfile=function(){e.updateProfile(t.data,function(e){return e?(t.alertType="danger",t.messageError=e):(t.alertType="success",void(t.messageError="Bạn đã cập nhật thành công!"))})},t.updatePassword=function(){e.updatePassword({oldPassword:t.oldPassword,newPassword:t.newPassword,reNewPassword:t.reNewPassword},function(e){return e?(t.alertTypeChangePass="danger",t.messageErrorChangePass=e):(t.alertTypeChangePass="success",void(t.messageErrorChangePass="Bạn đã thay đổi mật khẩu thành công!"))})})})}]),loginModule.controller("resetPasswordController",["$scope","user","$rootScope","$location","app",function(t,e){t.resetPassword=function(){e.resetPassword(t.email,function(e,n){e?(t.alertType="alert alert-danger",t.messageError=e):(t.alertType="alert alert-success",t.messageError=n)})}}]),loginModule.controller("logoutController",["$scope","$localStorage","api","$location","$rootScope","user","$window","$timeout",function(t,e,n,a,i,o,r,c){o.logout(function(){if(i.token=null,e.remove("token"),e.remove("id_app"),i.app_info=void 0,i.isLogined=!1,id_app=null,i.id_app=void 0,n.init(),a.url("/login"),i.user){var t;if("google"==i.user.server&&(t="https://mail.google.com/mail/u/0/?logout&hl=en"),"facebook"==i.user.server,i.user=void 0,t){var o=r.open(t,"Logout","height=400,width=400");c(function(){o.close()},3e3)}}})}]),loginModule.controller("downloadController",["$scope","$http",function(t,e){e.get(server_url+"/public/versioninfo").success(function(e){t.downloads=e})}]),loginModule.config(["$routeProvider","$locationProvider",function(t){t.when("/signup",{templateUrl:"templates/login/templates/signup.html",controller:"signupController"}).when("/resetpassword",{templateUrl:"templates/login/templates/resetpassword.html",controller:"resetPasswordController"}).when("/profile",{templateUrl:"templates/login/templates/profile.html",controller:"profileController"}).when("/login",{templateUrl:"templates/login/templates/login.html",controller:"loginController"}).when("/logout",{templateUrl:"templates/login/templates/callback.html",controller:"logoutController"}).when("/download",{templateUrl:"templates/login/templates/download.html",controller:"downloadController"}).when("/uploadfile/:folder",{templateUrl:"templates/login/templates/upload.html",controller:"uploadController"}).when("/uploadexcel",{templateUrl:"templates/login/templates/upload.html",controller:"uploadExcelController"})}]);var dashboardModule=angular.module("dashboardModule",["ngRoute"]);dashboardModule.controller("homeController",["$scope","$localStorage","user","$rootScope","$location","$timeout","$http","api","$window","$interval","appInfo",function(t,e,n,a,i,o,r,c,d,l,u){if("/download"!=i.url().toLowerCase()){if(i.url().indexOf("/~lg/")>=0){var s,_,p=i.url().split("/"),h="dashboard";if(p.length>=4&&(_=p[2],s=p[3],p.length>4&&(h=p[4])),_)return e.set("token",_),e.set("id_app",s),c.init(_),void n.getInfo(function(){i.url("/"+h)})}return e.get("token")?void(("/dashboard"==i.url()||"/"==i.url())&&u.info("/dashboard",function(t){return t?void i.url("/login"):void 0})):(i.url().toLowerCase().indexOf("/login")<0&&i.url().toLowerCase().indexOf("/logout")<0&&(a.w_redirect=i.url()),void i.url("/login"))}}]),dashboardModule.controller("dxdController",["$scope",function(){}]),dashboardModule.controller("adminController",["appInfo","$location",function(t,e){t.info("admin",function(t){return t?void e.url("/login"):void 0})}]),dashboardModule.config(["$routeProvider","$locationProvider","$httpProvider",function(t){t.when("/",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"}).when("/lg/:id_app",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"}).when("/dxd",{templateUrl:"templates/dashboard/templates/dxd.html",controller:"dxdController"}).when("/admin",{templateUrl:"templates/dashboard/templates/admin.html",controller:"adminController"}).when("/dashboard",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"})}]);var appModule=new baseInput("app","app",["name"],"Thông tin đơn vị, doanh nghiệp",{services:function(t){var e={active:function(e){return t.get(server_url+"/api/app/active/"+e)},notaccept:function(e){return t.get(server_url+"/api/app/notaccept/"+e)}};return e},onCondition:function(t){t.$or={create_db_sql:!1,create_db_sql:null}},onView:function(t,e){t.open=function(n){var a=n._id,i=n.active;i||e.service.active(a).success(function(){}).error(function(t){console.error("Không thể kích hoạt: ",t)}),id_app=a,e.$rootScope.app_info=_.find(t.list,function(t){return t._id==a}),e.$rootScope.id_app=a,e.$localStorage.set("id_app",a),e.$rootScope.w_redirect?(w_redirect=e.$rootScope.w_redirect,delete e.$rootScope.w_redirect,e.$location.url(w_redirect)):e.$location.url("/dashboard")},t.auth_google=function(){var n=e.$window.open(server_url+"/auth/google_drive","Google authentication","height=400,width=400"),a=e.$interval(function(){try{if(n.location.href&&n.location.href.indexOf("/auth/google/callback")&&n.document.body.innerHTML&&n.document.body.innerHTML.indexOf("access_token")>=0){var i=JSON.parse(n.document.title);t.update({google_drive_email:i.email,google_drive_token:i.access_token,google_drive_refresh_token:i.refresh_token},function(e){return e?alert(e):void(t.data.google_drive_refresh_token=access_token)}),e.$interval.cancel(a),n.close()}}catch(o){console.log(o)}},500)},t.delete_google_drive=function(){t.update({google_drive_email:"",google_drive_token:"",google_drive_refresh_token:""},function(e){return e?alert(e):void(t.data.google_drive_refresh_token="")})}},has_view:!0});appModule.defaultValues={ngay_dn:new Date(2015,0,1),ngay_ks:new Date(2015,0,1),ngay_ky1:new Date(2015,0,1)},appModule.module.controller("initApp",["$scope","$window","$interval","$http",function(t,e,n,a){a.get(server_url+"/public/province").success(function(e){t.province=e})}]),appModule.init=function(t,e){e("initApp",{$scope:t})},appModule.module.controller("baseAppHomeController",["$scope","$location","$localStorage","$rootScope","app","$window",function(t,e,n,a,i){t.open=function(o,r){r||i.active(o).success(function(){}).error(function(t){console.error("Không thể kích hoạt: ",t)}),id_app=o,a.app_info=_.find(t.list,function(t){return t._id==o}),a.id_app=o,n.set("id_app",o),a.w_redirect?(w_redirect=a.w_redirect,delete a.w_redirect,e.url(w_redirect)):e.url("/dashboard")}}]),appModule.initHomeController=function(t,e){t("baseAppHomeController",{$scope:e})};var initAddEditController=function(t,e){e.addParticipant=function(t){e.participant=void 0,e.data.participants||(e.data.participants=[]);var n=_.find(e.data.participants,function(e){return e.email==t.email_coll});return n?void alert(t.name+" đã tồn tại"):void e.data.participants.push({email:t.email_coll,name:t.name_coll,picture:t.picture_coll,admin:!1})},e.deleteParticipant=function(t){e.data.participants||(e.data.participants=[]),e.data.participants=_.reject(e.data.participants,function(e){return e.email==t})}};appModule.initAddController=function(t,e){initAddEditController(t,e)},appModule.initEditController=function(t,e){initAddEditController(t,e)},appModule.module.controller("appsController",["$scope","$rootScope","$routeParams","$http","user","$location","$modal","app","appInfo",function(t,e,n,a,i,o,r,c,d){d.info("app",function(e){if(!e){var i=n.email,o=server_url+"/api/app/apps/"+i;a.get(o).success(function(e){t.list=e}),t.email=i,t.openProfile=function(t){viewProfile(r,t)},t.addDays=function(t){r.open({templateUrl:"templates/lists/app/templates/add-days.html",controller:["$scope","$modalInstance","user","$location","$rootScope","app","$window",function(e,n,a,i,o,r,c){e.so_ngay=30,e.cancel=function(){n.dismiss("cancel")},e.save=function(){var a={};_.extend(a,t);var i=a.expire_date;i=!i||a.so_ngay_con_lai<=0?new Date:new Date(i),i.setDate(i.getDate()+e.so_ngay),a.expire_date=i,r.update(a._id,a._id,a).success(function(e){_.extend(t,e),n.dismiss("cancel")}).error(function(){c.alert("Không thể thêm ngày sử dụng cho công ty này")})}}],size:"lg"})}}})}]),appModule.module.controller("assignController",["$scope","$rootScope","$routeParams","$http","user","$location","app","appInfo",function(t,e,n,a,i,o,r,c){c.info("app",function(e){if(!e){var i=n.id_app,o=n.email;t.email=o,c.commands(i,function(e,n){if(e)return console.log(e);var r={email:o},c=server_url+"/api/"+i+"/right?q="+JSON.stringify(r);a.get(c).success(function(e){n.crm.input.forEach(function(t){t.module=t.module?t.module:t.path;var n=_.find(e,function(e){return e.module==t.module});if(n)for(var a in n)t[a]=n[a];t.id_app=i,t.email=o}),n.acc.forEach(function(t){var n=t.items;n.forEach(function(t){var n=t.items;n.forEach(function(t){t.module=t.module?t.module:t.path;var n=_.find(e,function(e){return e.module==t.module});if(n)for(var a in n)t[a]=n[a];t.id_app=i,t.email=o})})}),n.report.forEach(function(t){var n=t.items;n.forEach(function(t){t.module=t.module?t.module:t.path;var n=_.find(e,function(e){return e.module==t.module});if(n)for(var a in n)t[a]=n[a];t.id_app=i,t.email=o})}),t.commands=n,t.change=function(t){c=server_url+"/api/"+i+"/right";var e;t._id?(c=c+"/"+t._id,e=a.put(c,t)):e=a.post(c,t),e.success(function(e){for(var n in e)t[n]=e[n]}).error(function(e){console.log(t),alert(JSON.stringify(e))})},t.selectAllRight=function(e){e.add=e.sel,e.update=e.sel,e.delete=e.sel,e.view=e.sel,t.change(e)}}).error(function(){console.log(c)})})}})}]),appModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/assign/:id_app/:email",{templateUrl:"templates/lists/app/templates/assign.html",controller:"assignController"}).when("/apps/:email",{templateUrl:"templates/lists/app/templates/apps.html",controller:"appsController"})}]);var colleagueModule=new baseInput("colleague","colleague",["email","email_owner"],"Danh sách đồng nghiệp",{services:function(t){return{active:function(e){return t.get(server_url+"/api/colleague/active/"+e)},notaccept:function(e){return t.get(server_url+"/api/colleague/notaccept/"+e)}}}});colleagueModule.module.controller("basecolleagueHomeController",["$scope","$window","$rootScope","colleague","$modal",function(t,e,n,a,i){t.unLink=function(t){a.notaccept(t).success(function(){e.location.reload()}).error(function(){alert("Error")})},t.active=function(t){a.active(t).success(function(){e.location.reload()}).error(function(){alert("Error")})},t.sendMessage=function(t){messageModule.quickadd(i,function(){},{email_receiver:t})},t.openProfile=function(t){viewProfile(i,t)}}]),colleagueModule.initHomeController=function(t,e){t("basecolleagueHomeController",{$scope:e})},colleagueModule.initAddController=function(t,e){e.data.content="Hãy chấp nhận lời mời tham gia vào mạng lưới của tôi"};var notificationModule=new baseInput("notification","notification",["email_owner","email_sender","email_receiver","content","title"],"Thông báo",{onView:function(t,e){var n=t.data.content.split("#");n.length>1&&(t.data.content="#"+n[1]),t.data.read||e.service.update(id_app,t.data._id,{_id:t.data._id,read:!0}).success(function(){t.data.read=!0}).error(function(t){console.log(t)}),t.condition={read:!1},t.filter=function(){e.$rootScope.nextTick(function(){t.$emit("$dataChangeStart"),e.service.load(id_app,{condition:t.condition,limit:50}).success(function(e){t.notifications=e,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.filter(),t.viewNotification=function(e){t.data=e,t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})},t.delete=function(n){confirm("Bạn có chắc chắn xóa ghi chú này không?")&&e.service.delete(id_app,n._id).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==n._id})}).error(function(t){alert(t)})},t.markRead=function(n){n.read=!0,e.service.update(id_app,n._id,{_id:n._id,read:!0}).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==n._id})}).error(function(t){alert(t)})}}});notificationModule.module.factory("notification",["$http",function(t){fields_find=["email_receiver","email_owner","email_sender","content","title"];var e={list:function(e,n,a,i,o,r){var c=server_url+"/api/notification?t=1";if(1==i&&(c+="&count=1"),o&&(c=c+"&page="+o.toString()),r&&(c=c+"&limit="+r.toString()),angular.isObject(n)){var d=JSON.stringify(n);c=c+"&q="+d}else if(n&&""!=n.trim()&&fields_find&&0!=fields_find.length){var l="";fields_find.forEach(function(t){l=""==l?t+"="+n:l+"&"+t+"="+n}),""!=l&&(c=c+"&"+l)}return a&&(c=c+"&fields="+a),t.get(c)},get:function(e,n){return t.get(server_url+"/api/notification/"+n)},create:function(e,n){return t.post(server_url+"/api/notification",n)},update:function(e,n,a){return t.put(server_url+"/api/notification/"+n,a)},"delete":function(e,n){return t.delete(server_url+"/api/notification/"+n)},active:function(e){return t.get(server_url+"/api/notification/active/"+e)},notaccept:function(e){return t.get(server_url+"/api/notification/notaccept/"+e)}};return e.load=function(t,n){return n?e.list(t,n.condition,n.fields,n.count,n.page,n.limit):e.list(t)},e}]),notificationModule.module.directive("dbNotify",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/notification/templates/db.html",controller:["$scope","notification","$rootScope","$location","$modal","socket","appInfo","nodeWebkit",function(t,e,n,a,i,o,r){r.info("notification",function(i){i||(t.notifications=[],t.now=new Date,t.token=n.token,t.server_url=server_url,t.app_info=n.app_info,t.condition={read:!1},t.filter=function(){n.nextTick(function(){t.$emit("$dataChangeStart"),e.load(id_app,{condition:t.condition,limit:10}).success(function(e){t.notifications=e,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.viewNotification=function(t){a.url("notification/view/"+t._id+"?redirect=dashboard")},t.delete=function(n){confirm("Bạn có chắc chắn xóa ghi chú này không?")&&e.delete(id_app,n._id).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==n._id})}).error(function(t){alert(t)})},t.markRead=function(n){n.read=!0,e.update(id_app,n._id,n).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==n._id})}).error(function(t){alert(t)})},o.on("notify:new",function(n){e.get(id_app,n).success(function(e){var a=_.find(t.notifications,function(t){return t._id==n});a||(e.is_new=!0,t.notifications.push(e))}).error(function(t){console.error("Can't get notification\n"+t)})}),t.filter({}))})}],link:function(){}}});var messageModule=new baseInput("message","message",["email_owner","email_receiver","email_sender","content"],"Tin nhắn",{services:function(t){var e={list:function(e,n,a,i,o,r){var c=["email_owner","email_receiver","email_sender","content"],d=server_url+"/api/message/colleague/list?t=1";if(1==i&&(d+="&count=1"),o&&(d=d+"&page="+o.toString()),r&&(d=d+"&limit="+r.toString()),angular.isObject(n)){var l=JSON.stringify(n);d=d+"&q="+l}else if(n&&""!=n.trim()&&c&&0!=c.length){var u="";c.forEach(function(t){u=""==u?t+"="+n:u+"&"+t+"="+n}),""!=u&&(d=d+"&"+u)}return a&&(d=d+"&fields="+a),t.get(d)},chat:function(e,n){return t.get(server_url+"/api/message/chat/"+n)},get:function(e,n){return t.get(server_url+"/api/message/"+n)},create:function(e,n){return t.post(server_url+"/api/message",n)},update:function(e,n,a){return t.put(server_url+"/api/message/"+n,a)},"delete":function(e,n){return t.delete(server_url+"/api/message/"+n)}};return e.load=function(t,n){return n?e.list(t,n.condition,n.fields,n.count,n.page,n.limit):e.list(t)},e}});messageModule.module.controller("baseMessageChatController",["$scope","$location","$routeParams","$rootScope","message","$window","$modal","socket","user","appInfo",function(t,e,n,a,i,o,r,c,d,l){l.info("message",function(e){if(!e){var o=(a.user.email,n.email);d.getProfile(o,function(e,n){return e?alert(e):void(t.profile=n)}),c.on("message",function(e){t.profile&&(e.picture_sender=t.profile.picture,e.name_sender=t.profile.name),t.msgs.push(e)}),t.data={},t.data.email_receiver=o,i.chat(void 0,o).success(function(e){t.msgs=e}),t.send=function(){i.create(void 0,t.data).success(function(e){t.data.content="",t.msgs.push(e)}).error(function(t){alert(t)})},t.enter2send=function(e){13==e.keyCode&&t.send()},t.deleteMsg=function(e){confirm("Có chắc chắn xóa tin nhắn này không?")&&i.delete(null,e).success(function(){t.msgs=_.reject(t.msgs,function(t){return t._id==e})}).error(function(){alert("Không thể xóa tin  nhắn này")})},t.openProfile=function(t){messageModule.viewProfile(r,t)}}})}]),messageModule.module.controller("baseMessageHomeController",["$scope","$location","$routeParams","$rootScope","message","$window",function(t,e){t.chat=function(t){var n=t.email_coll;e.url("message/chat/"+n)}}]),messageModule.initHomeController=function(t,e){t("baseMessageHomeController",{$scope:e})},messageModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/message/chat/:email",{templateUrl:"templates/lists/message/templates/edit.html",controller:"baseMessageChatController"})}]);var usersmanagementModule=new baseInput("users","users",["email","name"],"Quản lý người dùng"),rptModule=new baseInput("rpt","rpt",["ma_cn","ten_mau_in"],"Quản lý mẫu in",{onAdd:function(t,e){var n=e.$location.search(),a=n.ma_cn;!n.redirect&&a&&e.$location.search("redirect","/rpt?ma_cn="+a)},onEdit:function(t,e){var n=t.data.ma_cn;e.$location.search().redirect||e.$location.search("redirect","/rpt?ma_cn="+n)}});rptModule.module.controller("initrpt",["$scope","$window","$interval",function(t,e,n){t.changeFile=function(){var a=e.open("#uploadexcel","Upload file","width=600,height=300"),i=n(function(){"success"==a.document.body.innerHTML&&(t.data.file_mau_in=a.document.title,a.close(),n.cancel(i))},100)}}]),rptModule.init=function(t,e){e("initrpt",{$scope:t})};var parameterModule=new baseInput("parameter","parameter",["name"],"Tham số mẫu in",{onAdd:function(t,e){var n=e.$location.search(),a=n.id_rpt;!n.redirect&&a&&e.$location.search("redirect","/parameter?id_rpt="+a),t.data.type="S"},onEdit:function(t,e){var n=t.data.id_rpt;e.$location.search().redirect||e.$location.search("redirect","/parameter?id_rpt="+n)},onLoading:function(t,e){var n=e.$location.search(),a=n.id_rpt;e.$http.get(server_url+"/api/"+id_app+"/rpt/"+a).success(function(e){e&&(t.sub_title=e.ten_mau_in)}).error(function(){})}}),commentModule=new baseInput("comment","comment",["content","title"],"Nhận xét, góp ý",{has_view:!0,onCondition:function(t){t.is_reply=!1,t.id_product=null},onView:function(t,e){var n=t.data;t.replies=[n];var a={is_reply:!0,id_topic:n._id};e.service.load(id_app,{condition:a}).success(function(e){e.forEach(function(e){t.replies.push(e)})}).error(function(t){console.log(t)}),t.reply=function(){var a={content:t.content,is_reply:!0,id_topic:n._id,title:n.title};e.service.create(id_app,a).success(function(e){t.replies.push(e),t.content=""}).error(function(t){console.log(t)})},t.quickedit=function(t){commentModule.quickedit(e.$modal,t._id,function(e){_.extend(t,e)})},t.deleteReply=function(n){confirm("Có chắc chắn xóa không?")&&e.service.delete(id_app,n._id).success(function(){t.replies=_.reject(t.replies,function(t){return n._id==t._id})}).error(function(t){var e;e=_.isObject(t)?JSON.stringify(t):t,alert(e.indexOf("Lỗi:")>=0?e:"Không thể xóa")})}}});commentModule.module.directive("comment",function(){return{restrict:"E",scope:{link:"=",user:"=",title:"@"},templateUrl:"templates/lists/comment/templates/directive.html",link:function(t,e,n){n.user||console.error("comment directive require 'user' attribute"),n.link||console.error("comment directive require 'link' attribute")},controller:["$scope","$http","$window","$modal","$rootScope","$location","appInfo",function(t,e,n,a,i,o,r){r.info("comment",function(r,c,d){r||(t.token=i.token,t.server_url=server_url,t.openProfile=function(t){viewProfile(a,t)},t.getMembers=function(){i.app_info&&i.app_info.participants&&(members=[],d=i.app_info,d.participants&&(members=_.pluck(d.participants,"email")),members.push(d.user_created),t.members=members)},t.deleteComment=function(a){n.confirm("Bạn có chắc chắn xóa nhận xét này không?")&&e.delete(server_url+"/api/comment/"+a._id).success(function(){t.comments=_.reject(t.comments,function(t){return t._id==a._id})}).error(function(t){t&&n.alert(t)})},t.editComment=function(t){commentModule.quickedit(a,t._id,function(e){_.extend(t,e)})},t.sendComment=function(a){t.title||(t.title="Comment");var i={id_product:t.idLink,title:t.title,content:a,user_created_obj:t.link.user_created,is_reply:!0};i.url_topic=o.absUrl(),t.link.attends&&(i.attends=t.link.attends),e.post(server_url+"/api/comment",i).success(function(e){t.content="",e&&(t.comments||(t.comments=[]),t.comments.push(e))}).error(function(t){t&&n.alert(t)})},t.load=function(){e.get(server_url+"/api/comment?q={id_product:'"+t.idLink+"'}").success(function(e){t.comments=e}).error(function(){})},t.$watch("link",function(e){e&&(t.idLink=t.link._id,t.load(),t.getMembers())},!0))})}]}});var versioninfoModule=new baseInput("versioninfo","versioninfo",["os","app","title"],"Quản lý phiên bản các chương trình"),dmkhModule=new baseInput("dmkh","customer",["ma_kh","ten_kh","dia_chi","dien_thoai","fax","email"],"Khách hàng",{has_view:!0,onView:function(t,e){t.addContact=function(){lienheModule.quickadd(e.$modal,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")},{id_kh:t.data._id,ten_kh:t.data.ten_kh})}},onLoading:function(t,e){t.advCondition={},e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'CUSTOMER'}").success(function(e){t.groups=e})}),t.btn3_click=function(){var n=[];t.list.forEach(function(t){t.email&&t.sel&&n.push({name:t.ten_kh,address:t.email})}),n.length>0?e.$location.url("mailschedule/add?to="+JSON.stringify(n)+"&redirect="+e.$location.url()):alert("Bạn phải chọn ít nhất một liên lạc")},t.searchAVR=function(){if(t.renderCompleted){t.filter={};var e,n,a=new Date;if("d"==t.time&&(e=new Date,n=new Date),"w"==t.time)var i=a.getDate()-a.getDay()+1,e=new Date(a.setDate(i)),n=new Date(a.setDate(e.getDate()+6));if("m"==t.time&&(e=a,e.setDate(1),n=new Date(e.getFullYear(),e.getMonth()+1,0)),"3m"==t.time){var o=a.getMonth(),r=1;r=3>o?0:6>o?3:6>o?6:9,e=new Date(a.getFullYear(),r,1),n=new Date(a.getFullYear(),r+3,0)}"y"==t.time&&(e=new Date(a.getFullYear(),0,1),n=new Date(a.getFullYear(),11,31)),e&&n&&(e.setHours(0),e.setMinutes(0),e.setSeconds(0),n.setHours(23),n.setMinutes(59),n.setSeconds(0),t.filter.date_created={$gte:e,$lte:n}),t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_kh?t.filter.nh_kh=t.nh_kh:delete t.filter.nh_kh,t.advCondition.ten_kh?t.filter.$or=[{ten_kh:{$regex:t.advCondition.ten_kh,$options:"i"}},{ma_kh:{$regex:t.advCondition.ten_kh,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_kh,$options:"i"}},{email:{$regex:t.advCondition.ten_kh,$options:"i"}}]:delete t.filter.$or,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.advCondition.ma_so_thue?t.filter.ma_so_thue={$regex:t.advCondition.ma_so_thue,$options:"i"}:delete t.filter.ma_so_thue,t.search()}},t.enter=function(e){13==e.keyCode&&t.searchAVR()},t.searchPhuTrach=function(e){t.phu_trach=e.email,t.searchAVR()},t.searchGroup=function(e){t.nh_kh=e._id,t.searchAVR()},t.reportByTime=function(e){t.time=e,t.searchAVR()}}}),lienheModule=new baseInput("lienhe","lienhe",["ten_lien_he","dia_chi","dien_thoai","fax","email"],"Danh bạ",{has_view:!0,onLoading:function(t,e){e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'CONTACT'}").success(function(e){t.groups=e})}),t.advCondition={},t.searchAVR=function(){t.renderCompleted&&(t.filter={},t.nh_lh?t.filter.nh_lh=t.nh_lh:delete t.filter.nh_lh,t.advCondition.ten_lien_he?t.filter.$or=[{ten_lien_he:{$regex:t.advCondition.ten_lien_he,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_lien_he,$options:"i"}},{email:{$regex:t.advCondition.ten_lien_he,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.search())
},t.searchGroup=function(e){t.nh_lh=e._id,t.searchAVR()},t.enter=function(e){13==e.keyCode&&t.searchAVR()},t.btn3_click=function(){var n=[];t.list.forEach(function(t){t.email&&t.sel&&n.push({name:t.ten_lien_he,address:t.email})}),n.length>0?e.$location.url("mailschedule/add?to="+JSON.stringify(n)+"&redirect="+e.$location.url()):alert("Bạn phải chọn ít nhất một liên lạc")}},onView:function(t,e){t.addCustomer=function(){dmkhModule.quickadd(e.$modal,function(n){n.collection_name="dmkh",t.addLink(n,"ten_kh"),t.data.id_kh||(t.data.id_kh=n._id,e.service.update(id_app,t.data._id,t.data).success(function(e){_.extend(t.data,e)}))})}}}),noteModule=new baseInput("note","note",["title"],"Ghi chú",{has_view:!0});noteModule.module.directive("note",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/note/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","note","appInfo","$rootScope",function(t,e,n,a,i,o,r,c){r.info("note",function(e){e||(t.server_url=server_url,t.token=c.token,t.addNote=function(){noteModule.quickadd(i,function(e){t.notes.push(e)},{id_link:t.idLink})},t.saveNote=function(e){t.$emit("$dataSaveStart");var n={content:e,id_link:t.idLink};o.create(id_app,n).success(function(e){t.notes.push(e),t.content="",t.$emit("$dataSaveSuccess")}).error(function(e){console.log(e),t.$emit("$dataSaveError")})},t.viewNote=function(t){n.url("/note/view/"+t._id+"?redirect="+n.url())},t.deleteNote=function(e){a.confirm("Bạn có chắc chắn xóa ghi chú này không?")&&o.delete(id_app,e._id).success(function(){t.notes=_.reject(t.notes,function(t){return t._id==e._id})}).error(function(t){t&&a.alert(t)})},t.editNote=function(t){noteModule.quickedit(i,t._id,function(e){_.extend(t,e)})},t.load=function(){o.load(id_app,{condition:{id_link:t.idLink}}).success(function(e){t.notes=e}).error(function(t){t&&a.alert(t)})},t.openProfile=function(t){viewProfile(i,t)},t.$watch("link",function(e){e&&(t.idLink=t.link._id,t.load())},!0))})}],link:function(t,e,n){n.link||console.error("note directive require 'link' attribute")}}});var taskModule=new baseInput("task","task",["ten_cv","mieu_ta"],"Công việc",{has_view:!0,onAdd:function(t,e){t.data.phu_trach=e.$rootScope.user.email,t.data.attends=[t.data.phu_trach],t.data.start_date=new Date,t.data.repeat=0,t.data.priority=1,t.data.progress=0},onEdit:function(){},onView:function(t,e){t.data.attendInfos=[],t.data.attends&&t.data.attends.forEach(function(n){var a=_.find(e.$rootScope.members,function(t){return t.email==n});a&&t.data.attendInfos.push(a)}),t.complete=function(){t.data.progress=2,e.service.update(id_app,t.data._id,t.data).success(function(){}).error(function(t){t&&e.$window.alert(t)})},t.addContact=function(){lienheModule.quickadd(e.$modal,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(e.$modal,function(n){n.collection_name="dmkh",t.addLink(n,"ten_kh"),t.data.id_kh||(t.data.id_kh=n._id,e.service.update(id_app,t.data._id,t.data).success(function(e){_.extend(t.data,e)}))})},t.addProject=function(){dmdtModule.quickadd(e.$modal,function(n){n.collection_name="dmdt",t.addLink(n,"ten_dt"),t.data.id_dt||(t.data.id_dt=n._id,e.service.update(id_app,t.data._id,t.data).success(function(e){_.extend(t.data,e)}))})}},onLoading:function(t,e){t.advCondition={},e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'TASK'}").success(function(e){t.groups=e})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.priorities=[{value:1,text:"Ưu tiên cao",sel:!0},{value:2,text:"Ưu tiên trung bình",sel:!0},{value:3,text:"Ưu tiên thấp",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var e=[],n=[];t.progresses.forEach(function(t){t.sel&&e.push(t.value)}),t.priorities.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.progress={$in:e},t.filter.priority={$in:n},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_cv?t.filter.nh_cv=t.nh_cv:delete t.filter.nh_cv;var a,i,o=new Date,r=t.time;if("d"==r&&(a=new Date,i=new Date),"w"==r)var c=o.getDate()-o.getDay()+1,a=new Date(o.setDate(c)),i=new Date(o.setDate(a.getDate()+6));if("m"==r&&(a=o,a.setDate(1),i=new Date(a.getFullYear(),a.getMonth()+1,0)),"3m"==r){var d=o.getMonth(),l=1;l=3>d?0:6>d?3:6>d?6:9,a=new Date(o.getFullYear(),l,1),i=new Date(o.getFullYear(),l+3,0)}"y"==r&&(a=new Date(o.getFullYear(),0,1),i=new Date(o.getFullYear(),11,31)),a&&i?(a.setHours(0),a.setMinutes(0),a.setSeconds(0),i.setHours(23),i.setMinutes(59),i.setSeconds(0),t.filter.start_date={$gte:a,$lte:i}):delete t.filter.start_date,t.advCondition.ten_cv?t.filter.$or=[{ten_cv:{$regex:t.advCondition.ten_cv,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_cv,$options:"i"}},{location:{$regex:t.advCondition.ten_cv,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.ten_dt?t.filter.ten_dt=t.advCondition.ten_dt:delete t.filter.ten_dt,t.advCondition.priority&&(t.filter.priority=t.advCondition.priority),t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.advCondition.start_date&&(t.filter.start_date={$gte:t.advCondition.start_date}),t.advCondition.due_date?t.filter.due_date={$lte:t.advCondition.due_date}:delete t.filter.due_date,t.search()}},t.reportByTime=function(e){t.time=e,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.searchPhuTrach=function(e){t.phu_trach=e.email,t.searchAVG()},t.searchGroup=function(e){t.nh_cv=e._id,t.searchAVG()},t.$watch("priorities",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,n){var a={};_.extend(a,t),a.progress=n,e.service.update(id_app,a._id,a).success(function(e){_.extend(t,e)}).error(function(t){t&&alert(t)})},t.enter=function(e){13==e.keyCode&&t.searchAVG()}}});taskModule.module.directive("task",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/task/templates/directive.html",controller:["$scope","$http","$window","$location","$modal","appInfo",function($scope,$http,$window,$location,$modal,appInfo){appInfo.info("task",function(e,u,a){if(!e){$scope.server_url=server_url,$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="task:'ten_cv'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.list=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var e=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(e).then(function(t){var e=t.data;return e})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var e=_.find($scope.list,function(e){return e.obj._id==t._id});if(!e){var n={};n.id_a=$scope.link._id,n.collection_a=$scope.collection,n.collection_b=t.collection_name,n.collection_obj=t.collection_name,n.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,n).success(function(e){_.extend(n,e),n.obj=t,n.title=t.title,$scope.list.push(n)}).error(function(){})}},$scope.unLink=function(t){var e=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(e).success(function(){$scope.list=_.reject($scope.list,function(e){return e._id==t._id})}).error(function(){})},$scope.getItem=function(t,e,n){$scope.addLink(t,n)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),taskModule.quickadd($modal,function(t){t.collection_name="task",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var e="task/view/"+t._id+"?redirect="+$location.url();$location.url(e)},$scope.delete=function(t){$window.confirm("Bạn có chắc chắn xóa không?")&&$http.delete(server_url+"/api/"+id_app+"/task/"+t._id).success(function(){$scope.list=_.reject($scope.list,function(e){return e._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.edit=function(t){taskModule.quickedit($modal,t._id,function(e){_.extend(t,e)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,e,n){n.link&&n.collection||console.error("task directive require attributes:link,collection")}}}),taskModule.module.directive("dbTask",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/task/templates/db.html",controller:["$scope","task","$rootScope","$location","appInfo","socket","nodeWebkit",function(t,e,n,a,i,o,r){i.info("task",function(i){i||(t.token=n.token,t.server_url=server_url,t.now=new Date,t.options={my_job:!0,overdue:!1,progress_0:!0,progress_1:!0,progress_2:!1,progress_3:!0,progress_4:!0},t.getCondition=function(){if(t.condition={status:!0},t.options.my_job&&(t.condition.$or=[{phu_trach:n.user.email},{attends:n.user.email}]),t.options.overdue){var e=new Date;t.condition.due_date={$lt:e}}t.condition.progress={$in:[]},t.options.progress_0&&t.condition.progress.$in.push(0),t.options.progress_1&&t.condition.progress.$in.push(1),t.options.progress_2&&t.condition.progress.$in.push(2),t.options.progress_3&&t.condition.progress.$in.push(3),t.options.progress_4&&t.condition.progress.$in.push(4)},t.app_info=n.app_info,t.filter=function(n){async.nextTick(function(){t.$emit("$dataChangeStart"),t.getCondition(),n&&_.extend(t.condition,n),e.load(id_app,{condition:t.condition,limit:10}).success(function(e){t.dscv=e,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.complete=function(t){e.update(id_app,t._id,{progress:2}).success(function(e){_.extend(t,e)}).error(function(t){t&&alert(t)})},t.cancel=function(n){e.update(id_app,n._id,{status:!1}).success(function(){t.dscv&&(t.dscv=_.reject(t.dscv,function(t){return t._id==n._id}))}).error(function(t){t&&alert(t)})},t.viewTask=function(t){a.url("task/view/"+t._id)},t.$watch("options",function(e){e&&t.app_info&&t.filter({})},!0),o.on("task:new",function(n){t.dscv||(t.dscv=[]),e.get(id_app,n).success(function(e){var a=_.find(t.dscv,function(t){return t._id==n});a||(e.is_new=!0,r.notification("Bạn có công việc mới"),t.dscv.push(e))})}),t.filter({}))})}],link:function(){}}});var groupModule=new baseInput("group","group",["group_name"],"Nhóm"),fileModule=new baseInput("file","file",["mieu_ta","ten_file_goc"],"Quản lý tệp dữ liệu",{onLoading:function(t,e){addFile=function(){var n=e.$window.open("#file/addfile","Add File","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=300"),a=0;stop=e.$interval(function(){if("OK"==n.document.title){e.$interval.cancel(stop),stop=void 0;var i=JSON.parse(n.document.body.innerText);return t.list.push(i),void n.close()}return"ERROR"==n.document.title?(e.$interval.cancel(stop),stop=void 0,alert(n.document.body.innerText),void n.close()):(a+=500,void(a>3e5&&stop&&(e.$interval.cancel(stop),stop=void 0)))},500)}}});fileModule.module.controller("addFileController",["$scope","$localStorage","user","$rootScope","$location","app",function(t,e,n,a,i){a.hide_nav=!0,t.data={},_.extend(t.data,i.search()),t.action=server_url+"/api/"+e.get("id_app")+"/file?access_token="+e.get("token")}]),fileModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/file/addfile",{templateUrl:"templates/lists/file/templates/form-add-file.html",controller:"addFileController"})}]),fileModule.module.directive("fileUpload",function(){return{restrict:"A",scope:{list:"=",json:"="},controller:["$scope","$http","$localStorage","$rootScope",function(t,e,n){t.upload=function(a,i,o){t.$emit("$fileUploadStart"),o||(o={}),o.return="JSON",e({method:"POST",url:server_url+"/api/"+n.get("id_app")+"/file",headers:{"Content-Type":void 0},transformRequest:function(t){var e=new FormData;if(t.data)for(var n in t.data)e.append(n,t.data[n]);return e.append("file",t.fileRaw),e},data:{data:o,fileRaw:a}}).success(function(e){t.$emit("$fileUploadSuccess"),i(null,e)}).error(function(e){t.$emit("$fileUploadError"),i(e)})}}],link:function(t,e){e.bind("change",function(n){var a=n.target.files;async.map(a,function(e,n){t.upload(e,function(e,a){return e?n(e):(t.list||(t.list=[]),t.list.push(a),void n())},t.json)},function(t){return t?alert(t):void e.val("")})})}}}),fileModule.module.directive("imageUpload",function(){return{restrict:"A",scope:{model:"=",modelThumb:"=",json:"=",ngUploaded:"&",folder:"@"},controller:["$scope","$http","$localStorage",function(t,e){t.upload=function(n,a,i){t.$emit("$fileUploadStart"),i||(i={}),i.return="JSON",t.folder||(t.folder="products"),e({method:"POST",url:server_url+"/api/uploadfile?json=1&folder="+t.folder,headers:{"Content-Type":void 0},transformRequest:function(t){var e=new FormData;if(t.data)for(var n in t.data)e.append(n,t.data[n]);return e.append("file",t.fileRaw),e},data:{data:i,fileRaw:n}}).success(function(e){t.$emit("$fileUploadSuccess"),a(null,e)}).error(function(e){t.$emit("$fileUploadError"),a(e)})}}],link:function(t,e){e.bind("change",function(n){var a=n.target.files;async.map(a,function(e,n){t.upload(e,function(e,a){return e?n(e):(t.model=a.image,t.modelThumb=a.thumb,t.onUploaded&&t.onUploaded({$image:a.image,$thumb:a.thumb}),void n())},t.json)},function(t){return t?alert(t):void e.val("")})})}}}),fileModule.module.directive("file",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/file/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","$interval","appInfo","$rootScope",function(t,e,n,a,i,o,r,c){r.info("file",function(r){r||(t.token=c.token,t.id_app=id_app,t.server_url=server_url,t.addfile=function(){var e=a.open("#file/addfile?id_link="+t.link._id,"Add File","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=300"),n=0;stop=o(function(){if("OK"==e.document.title){o.cancel(stop),stop=void 0;var a=JSON.parse(e.document.body.innerText);return t.files.push(a),void e.close()}return"ERROR"==e.document.title?(o.cancel(stop),stop=void 0,alert(e.document.body.innerText),void e.close()):(n+=500,void(n>3e5&&stop&&(o.cancel(stop),stop=void 0)))},500)},t.deletefile=function(n){a.confirm("Bạn có chắc chắn xóa file này không?")&&e.delete(server_url+"/api/"+id_app+"/file/"+n._id).success(function(){t.files=_.reject(t.files,function(t){return t._id==n._id})}).error(function(t){t&&a.alert(t)})},t.load=function(){e.get(server_url+"/api/"+id_app+"/file?q={id_link:'"+t.idLink+"'}").success(function(e){t.files=e}).error(function(t){t&&a.alert(t)})},t.$watch("link",function(e){e&&(t.idLink=t.link._id,t.load(),t.dataLink={id_link:t.idLink,collection_link:t.link.collection_name},t.dataLink.url_topic=server_url+"/#"+n.url(),t.dataLink.title_topic=c.title_view)},!0),t.openProfile=function(t){viewProfile(i,t)})})}],link:function(t,e,n){n.link||console.error("comment directive require 'link' attribute")}}});var mailaccountModule=new baseInput("mailaccount","mailaccount",["username","fullname"],"Tài khoản email",{has_view:!1,onAdd:function(t){t.data.smtp={ssl:!0,port:465},t.data.imap={tls:!0,port:993},t.$watch("data.username",function(e){if(e&&e.indexOf("@")>0&&e.indexOf(".")>0){var n=e.split("@")[1];t.data.smtp.host="smtp."+n,t.data.imap.host="imap."+n}})}});mailaccountModule.module.directive("mailAccount",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailaccount/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","mailaccount","appInfo","socket",function(t,e,n,a,i,o,r,c){r.info("mailbox",function(e){e||(t.server_url=server_url,t.addmailaccount=function(){mailaccountModule.quickadd(i,function(e){t.mailaccounts.push(e)},{id_link:t.idLink})},t.viewmailaccount=function(t){n.url("/mailaccount/view/"+t._id+"?redirect="+n.url())},t.connect=function(t){t.status_code=9,t.status_string="Đang xử lý",t.status=!0,o.update(id_app,t._id,t).success(function(){})},t.disconnect=function(t){t.status_code=9,t.status_string="Đang xử lý",t.status=!1,o.update(id_app,t._id,{status:!1,status_code:0,status_string:"Không kết nối"}).success(function(){})},t.deletemailaccount=function(e){a.confirm("Bạn có chắc chắn xóa tài khoản này không?")&&o.delete(id_app,e._id).success(function(){t.mailaccounts=_.reject(t.mailaccounts,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})},t.editmailaccount=function(t){mailaccountModule.quickedit(i,t._id,function(e){_.extend(t,e)})},t.load=function(){o.load(id_app,{condition:{id_link:t.idLink}}).success(function(e){t.mailaccounts=e}).error(function(t){a.alert(t)})},t.$watch("link",function(e){e&&(t.idLink=t.link.email,t.load())},!0),c.on("email:disconnected",function(e){if(console.log("ngat ket noi"),t.mailaccounts){var n=_.find(t.mailaccounts,function(t){return t._id==e});n&&(n.error=null,n.status_code=0,n.status_string="Đã ngắt kết nối")}}),c.on("email:connected",function(e){if(console.log("ket noi"),t.mailaccounts){var n=_.find(t.mailaccounts,function(t){return t._id==e});n&&(n.error=null,n.status_code=1,n.status_string="Đang kết nối")}}),c.on("email:error",function(e){if(t.mailaccounts){var n=_.find(t.mailaccounts,function(t){return t._id==e});n&&(n.error=null,n.status_code=-1,n.status_string="Không thể kết nối với máy chủ mail")}}))})}],link:function(t,e,n){n.link||console.error("mail-account directive require 'link' attribute")}}});var mailbox_tab_current="received";mailaccountModule.module.controller("mailboxController",["$scope","$rootScope","$location","$modal","appInfo",function(t,e,n,a,i){i.info("mailbox",function(e,n){e||(t.current_user=n,t.add=function(){mailscheduleModule.quickadd(a,function(e){t.mailScheduleAdded=e,t.selectTab("schedule")})},t.selectTab=function(e){mailbox_tab_current=e,t.tab_active_schedule="schedule"==mailbox_tab_current,t.tab_active_account="account"==mailbox_tab_current,t.tab_active_template="template"==mailbox_tab_current,t.tab_active_received="received"==mailbox_tab_current,t.tab_active_sent="sent"==mailbox_tab_current,t.tab_active_schedule||t.tab_active_account||t.tab_active_template||t.tab_active_sent||(t.tab_active_received=!0)},t.selectTab(mailbox_tab_current))})}]),mailaccountModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/mailbox",{templateUrl:"templates/lists/mailaccount/templates/mailbox.html",controller:"mailboxController"})}]);var mailreceivedModule=new baseInput("mailreceived","mailreceived",["subject","small_text"],"Email đã nhận",{has_view:!0,onView:function(t,e){var n={_id:t.data._id,read:!0};e.service.update(id_app,t.data._id,n).success(function(e){_.extend(t.data,e)}).error(function(t){e.$window.alert(t)}),t.createTask=function(){taskModule.quickadd(e.$modal,function(e){e.collection_name="task",t.addLink(e,"ten_cv")},{ten_cv:t.data.subject,mieu_ta:t.data.mail.html})},t.createContact=function(){lienheModule.quickadd(e.$modal,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")},{ten_lien_he:t.data.from[0].name,email:t.data.from[0].address})},t.createCustomer=function(){dmkhModule.quickadd(e.$modal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh")},{ten_kh:t.data.from[0].name,email:t.data.from[0].address})},t.reply=function(){var n=t.data.from,a=(t.data.to,"Trả lời: "+t.data.subject),i=t.data.mail.html.toString(),o="<div><br/>--lúc "+t.data.date_created.toLocaleString()+" <b>"+t.data.from[0].name+"&lt;"+t.data.from[0].address+"&gt; </b> đã viết--<br/></div><blockquote>"+i+"</blockquote>";mailscheduleModule.quickadd(e.$modal,function(){},{to:n,subject:a,use_template:!1,mail:{html:o},send_type:0,repeat:0})}}}),mailreceived_current_page=1;mailreceivedModule.module.directive("mailReceived",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailreceived/templates/directive.html",controller:["$scope","$rootScope","$http","$location","$window","$modal","mailreceived","socket","appInfo",function(t,e,n,a,i,o,r,c,d){d.info("mailreceived",function(e){e||(t.server_url=server_url,t.location=a.url(),t.current_page=mailreceived_current_page,t.pageChanged=function(e){t.current_page=e,mailreceived_current_page=e},t.condition={txtsearch:"",account_id:""},t.viewmailreceived=function(t){a.url("/mailreceived/view/"+t._id+"?redirect="+a.url())},t.deletemailreceived=function(e){i.confirm("Bạn có chắc chắn xóa email này không?")&&r.delete(id_app,e._id).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==e._id})}).error(function(t){i.alert(t)})},t.service=r,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,read,account_id,attachments",t.search=function(){var e={};t.condition.account_id&&(e.account_id=t.condition.account_id),t.condition.txtsearch&&(e.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],e.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),e.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=e,t.start=!0},t.searchKeyup=function(e){13==e.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailreceiveds){t.isSelectAll=!t.isSelectAll;for(var e=0;e<t.mailreceiveds.length;e++){var n=t.mailreceiveds[e];n.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailreceiveds)return!1;for(var e=0;e<t.mailreceiveds.length;e++){var n=t.mailreceiveds[e];if(n.sel&&1==n.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailreceiveds&&i.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var e=_.filter(t.mailreceiveds,function(t){return t.sel});e.forEach(function(e){r.delete(id_app,e._id).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==e._id})}).error(function(t){i.alert(t)})})}},t.linkSelected=function(){i.alert("Chức năng này đang được xây dựng")},t.$watch("link",function(e){e&&(t.idLink=t.link.email,t.search())},!0))})}],link:function(t,e,n){n.link||console.error("mail-received directive require 'link' attribute")}}}),mailreceivedModule.module.directive("dbInbox",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/mailreceived/templates/db.html",controller:["$scope","mailreceived","$rootScope","$location","$modal","socket","appInfo","nodeWebkit",function(t,e,n,a,i,o,r,c){r.info("mailreceived",function(r){r||(t.now=new Date,t.app_info=n.app_info,t.condition={read:null},t.filter=function(){n.nextTick(function(){t.$emit("$dataChangeStart"),e.load(id_app,{condition:t.condition,limit:10}).success(function(e){t.mailreceiveds=e,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.viewMail=function(t){a.url("mailreceived/view/"+t._id+"?redirect=dashboard")},t.delete=function(n){confirm("Bạn có chắc chắn xóa email này không?")&&e.delete(id_app,n._id).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==n._id})}).error(function(t){alert(t)})},t.markRead=function(n){e.update(id_app,n._id,{_id:n._id,read:!0}).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==n._id})}).error(function(t){alert(t)})},t.createTask=function(e){taskModule.quickadd(i,function(e){e.collection_name="task",t.addLink(e,"ten_cv")},{ten_cv:e.subject,mieu_ta:e.mail.html})},t.createContact=function(e){lienheModule.quickadd(i,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")},{ten_lien_he:e.from[0].name,email:e.from[0].address})},t.getEmail=function(n){t.mailreceiveds||(t.mailreceiveds=[]),e.load(id_app,{condition:{_id:n}}).success(function(e){if(1==e.length){e[0].is_new=!0;var a=_.find(t.mailreceiveds,function(t){return t._id==n});a||(t.mailreceiveds.push(e[0]),c.notification("Bạn có email mới"))}}).error(function(t){$window.alert(t)})},o.on("email",function(e){t.getEmail(e)}),t.filter({}))})}],link:function(){}}});var mailsentModule=new baseInput("mailsent","mailsent",["subject","small_text"],"Email đã gửi",{has_view:!0,onAdd:function($scope,options){$scope.data.to=$scope.data.to?eval($scope.data.to):[],$scope.data.html="",$scope.selectContact=function(t){var e={id:t._id,name:t.ten_lien_he,address:t.email},n=_.find($scope.data.to,function(t){return t.id==e.id});n||$scope.data.to.push(e),$scope.ten_lien_he="",$scope.email=""},$scope.removeContact=function(t){$scope.data.to=_.reject($scope.data.to,function(e){return _.isEqual(t,e)})},$scope.selectTemplate=function(t){t&&t.mail&&($scope.data.subject=t.subject,$scope.data.mail.html=t.mail.html)},$scope.title="Soạn email"},onEdit:function(t){t.data.to||(t.data.to=[]),t.selectContact=function(e){var n={id:e._id,name:e.ten_lien_he,address:e.email},a=_.find(t.data.to,function(t){return t.id==n.id});a||t.data.to.push(n),t.ten_lien_he="",t.email=""},t.removeContact=function(e){t.data.to=_.reject(t.data.to,function(t){return _.isEqual(e,t)})},t.selectTemplate=function(e){e&&e.mail&&(t.data.subject=e.subject,t.data.mail.html=e.mail.html)},t.title="Soạn email"},onSave:function(t,e,n,a){n.$modal.open({templateUrl:"templates/lists/mailsent/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailsent","$location","mailsentConfig","$modalInstance","$window","$routeParams","$timeout","$rootScope",function(t,n,i,o,r,c,d){t.data=e,t.save=function(){a(null,e),d.close()},t.cancel=function(){a(),d.dismiss("cancel")}}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}});mailsentModule.defaultValues={mail:{text:"",html:""},repeat:0,schedule:new Date,send_type:0};var mailsent_current_page=1;mailsentModule.module.directive("mailSent",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailsent/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","mailsent","socket","appInfo",function(t,e,n,a,i,o,r,c){c.info("mailSent",function(e){e||(t.server_url=server_url,t.location=n.url(),t.condition={txtsearch:"",account_id:""},t.current_page=mailsent_current_page,t.pageChanged=function(e){t.current_page=e,mailsent_current_page=e},t.viewmailsent=function(t){n.url("/mailsent/view/"+t._id+"?redirect="+n.url())},t.deletemailsent=function(e){a.confirm("Bạn có chắc chắn xóa email này không?")&&o.delete(id_app,e._id).success(function(){t.mailsents=_.reject(t.mailsents,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})},t.service=o,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,sent,schedule,account_id,repeat,attachments",t.getEmail=function(e,n){o.load(id_app,{condition:{_id:e},fields:t.fields}).success(function(t){1==t.length&&n(t[0])}).error(function(t){a.alert(t)})},t.search=function(){var e={};t.condition.account_id&&(e.account_id=t.condition.account_id),t.condition.txtsearch&&(e.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],e.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),e.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=e,t.start=!0},t.searchKeyup=function(e){13==e.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailsents){t.isSelectAll=!t.isSelectAll;for(var e=0;e<t.mailsents.length;e++){var n=t.mailsents[e];n.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailsents)return!1;for(var e=0;e<t.mailsents.length;e++){var n=t.mailsents[e];if(n.sel&&1==n.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailsents&&a.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var e=_.filter(t.mailsents,function(t){return t.sel});e.forEach(function(e){o.delete(id_app,e._id).success(function(){t.mailsents=_.reject(t.mailsents,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})})}},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.$watch("link",function(e){e&&(t.idLink=t.link.email,t.search(),r.on("email_sent",function(e){t.condition.txtsearch||t.getEmail(e,function(e){t.mailsents||(t.mailsents=[]),t.condition.account_id&&t.condition.account_id!=e.account_id||t.mailsents.push(e)})}))},!0))})}],link:function(t,e,n){n.link||console.error("mail-sent directive require 'link' attribute")}}});var mailscheduleModule=new baseInput("mailschedule","mailschedule",["subject","small_text"],"Email chờ gửi",{has_view:!0,onAdd:function($scope,options){$scope.data.to=$scope.data.to?eval($scope.data.to):[],$scope.data.html="",$scope.selectContact=function(t){var e={id:t._id,name:t.ten_lien_he,address:t.email},n=_.find($scope.data.to,function(t){return t.id==e.id});n||$scope.data.to.push(e),$scope.ten_lien_he="",$scope.email=""},$scope.removeContact=function(t){$scope.data.to=_.reject($scope.data.to,function(e){return _.isEqual(t,e)})},$scope.selectTemplate=function(t){t&&t.mail&&($scope.data.subject=t.subject,$scope.data.mail.html=t.mail.html)},$scope.title="Soạn email"},onEdit:function(t){t.data.to||(t.data.to=[]),t.selectContact=function(e){var n={id:e._id,name:e.ten_lien_he,address:e.email},a=_.find(t.data.to,function(t){return t.id==n.id});a||t.data.to.push(n),t.ten_lien_he="",t.email=""},t.removeContact=function(e){t.data.to=_.reject(t.data.to,function(t){return _.isEqual(e,t)})},t.selectTemplate=function(e){e&&e.mail&&(t.data.subject=e.subject,t.data.mail.html=e.mail.html)},t.title="Soạn email"},onSave:function(t,e,n,a){n.$modal.open({templateUrl:"templates/lists/mailschedule/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailschedule","$location","mailscheduleConfig","$modalInstance","$window","$routeParams","$timeout","$rootScope",function(t,n,i,o,r,c,d){t.data=e,t.save=function(){a(null,e),d.close()},t.cancel=function(){a(),d.dismiss("cancel")},t.send_types=[{id:0,name:"Ngay bây giờ"},{id:1,name:"Chọn một thời gian cụ thể"}],t.repeats=[{id:0,name:"Không lặp lại"},{id:1,name:"Hàng ngày"},{id:2,name:"Hàng tháng"},{id:3,name:"Hàng quý"},{id:4,name:"Hàng năm"}]}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}});mailscheduleModule.defaultValues={mail:{text:"",html:""},repeat:0,schedule:new Date,send_type:0},mailscheduleModule.module.directive("mailSchedule",function(){return{restrict:"E",scope:{link:"=",mailScheduleAdded:"="},templateUrl:"templates/lists/mailschedule/templates/schedule.html",controller:["$scope","$http","$location","$window","$modal","mailschedule","socket","appInfo",function(t,e,n,a,i,o,r,c){c.info("mailSchedule",function(e){e||(t.server_url=server_url,t.condition={txtsearch:"",account_id:""},t.viewmailschedule=function(t){n.url("/mailschedule/view/"+t._id+"?redirect="+n.url())},t.deletemailschedule=function(e){a.confirm("Bạn có chắc chắn xóa email này không?")&&o.delete(id_app,e._id).success(function(){t.mailschedules=_.reject(t.mailschedules,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})},t.service=o,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,sent,schedule,account_id,repeat,error,nextRunAt",t.getEmail=function(e,n){o.load(id_app,{condition:{_id:e},fields:t.fields}).success(function(t){1==t.length&&n(t[0])}).error(function(t){a.alert(t)})},t.search=function(){var e={};t.condition.account_id&&(e.account_id=t.condition.account_id),t.condition.txtsearch&&(e.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],e.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),e.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=e,t.start=!0},t.searchKeyup=function(e){13==e.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailschedules){t.isSelectAll=!t.isSelectAll;for(var e=0;e<t.mailschedules.length;e++){var n=t.mailschedules[e];n.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailschedules)return!1;for(var e=0;e<t.mailschedules.length;e++){var n=t.mailschedules[e];
if(n.sel&&1==n.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailschedules&&a.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var e=_.filter(t.mailschedules,function(t){return t.sel});e.forEach(function(e){o.delete(id_app,e._id).success(function(){t.mailschedules=_.reject(t.mailschedules,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})})}},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.editmailschedule=function(t){mailscheduleModule.quickedit(i,t._id,function(e){_.extend(t,e)})},t.$watch("link",function(e){e&&(t.idLink=t.link.email,t.search(),r.on("email_schedule",function(e){t.condition.txtsearch||t.getEmail(e,function(e){t.mailschedules||(t.mailschedules=[]),t.condition.account_id&&t.condition.account_id!=e.account_id||t.mailschedules.push(e)})}))},!0))})}],link:function(t,e,n){n.link||console.error("mail-schedule directive require 'link' attribute"),t.$watch("mailScheduleAdded",function(e){e&&(t.mailschedules||(t.mailschedules=[]),t.mailschedules.push(e))},!0)}}});var mailtemplateModule=new baseInput("mailtemplate","mailtemplate",["subject","name","small_text"],"Email mẫu",{onAdd:function(t){t.data.html=""}});mailtemplateModule.defaultValues={mail:{text:"",html:""}},mailtemplateModule.module.directive("mailTemplate",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailtemplate/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","mailtemplate","appInfo",function(t,e,n,a,i,o,r){r.info("mailTemplate",function(e){e||(t.server_url=server_url,t.condition={txtsearch:"",nhom:""},t.viewmailtemplate=function(t){n.url("/mailtemplate/view/"+t._id+"?redirect="+n.url())},t.deletemailtemplate=function(e){a.confirm("Bạn có chắc chắn xóa email này không?")&&o.delete(id_app,e._id).success(function(){t.mailtemplates=_.reject(t.mailtemplates,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})},t.service=o,t.limit=20,t.fields="name,subject,user_created,date_created,small_text,nhom",t.search=function(){var e={};t.condition.nhom&&(e.nhom=t.condition.nhom),t.condition.txtsearch&&(e.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],e.$or.push({name:{$regex:t.condition.txtsearch,$options:"i"}}),e.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=e,t.start=!0},t.searchKeyup=function(e){13==e.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailtemplates){t.isSelectAll=!t.isSelectAll;for(var e=0;e<t.mailtemplates.length;e++){var n=t.mailtemplates[e];n.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailtemplates)return!1;for(var e=0;e<t.mailtemplates.length;e++){var n=t.mailtemplates[e];if(n.sel&&1==n.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailtemplates&&a.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var e=_.filter(t.mailtemplates,function(t){return t.sel});e.forEach(function(e){o.delete(id_app,e._id).success(function(){t.mailtemplates=_.reject(t.mailtemplates,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})})}},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.editmailtemplate=function(t){mailtemplateModule.quickedit(i,t._id,function(e){_.extend(t,e)})},t.add=function(){mailtemplateModule.quickadd(i,function(e){t.mailtemplates||(t.mailtemplates=[]),t.mailtemplates.push(e)})},t.$watch("link",function(e){e&&(t.idLink=t.link.email,t.search())},!0))})}],link:function(t,e,n){n.link||console.error("mail-template directive require 'link' attribute")}}});var contractModule=new baseInput("contract","contract",["so_hd","ten_hd"],"Hợp đồng",{has_view:!0,onAdd:function(t,e){t.data.phu_trach=e.$rootScope.user.email,t.data.progress=0},onLoading:function(t,e){t.advCondition={},e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'CONTRACT'}").success(function(e){t.groups=e})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var e=[];t.progresses.forEach(function(t){t.sel&&e.push(t.value)}),t.filter.progress={$in:e},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_hd?t.filter.nh_hd=t.nh_hd:delete t.filter.nh_hd;var n,a,i=new Date,o=t.time;if("d"==o&&(n=new Date,a=new Date),"w"==o)var r=i.getDate()-i.getDay()+1,n=new Date(i.setDate(r)),a=new Date(i.setDate(n.getDate()+6));if("m"==o&&(n=i,n.setDate(1),a=new Date(n.getFullYear(),n.getMonth()+1,0)),"3m"==o){var c=i.getMonth(),d=1;d=3>c?0:6>c?3:6>c?6:9,n=new Date(i.getFullYear(),d,1),a=new Date(i.getFullYear(),d+3,0)}"y"==o&&(n=new Date(i.getFullYear(),0,1),a=new Date(i.getFullYear(),11,31)),n&&a?(n.setHours(0),n.setMinutes(0),n.setSeconds(0),a.setHours(23),a.setMinutes(59),a.setSeconds(0),t.filter.ngay_hd={$gte:n,$lte:a}):delete t.filter.ngay_hd,t.advCondition.ten_hd?t.filter.$or=[{ten_hd:{$regex:t.advCondition.ten_hd,$options:"i"}},{so_hd:{$regex:t.advCondition.ten_hd,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.advCondition.ngay_hd&&(t.filter.ngay_hd=t.advCondition.ngay_hd),t.advCondition.ngay_nt&&(t.filter.ngay_nt=t.advCondition.ngay_nt),t.search()}},t.enter=function(e){13==e.keyCode&&t.searchAVG()},t.reportByTime=function(e){t.time=e,t.searchAVG()},t.searchPhuTrach=function(e){t.phu_trach=e.email,t.searchAVG()},t.searchGroup=function(e){t.nh_hd=e._id,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,n){var a={};_.extend(a,t),a.progress=n,e.service.update(id_app,a._id,a).success(function(e){_.extend(t,e)}).error(function(t){t&&alert(t)})}},onView:function(t,e){t.addContact=function(){lienheModule.quickadd(e.$modal,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(e.$modal,function(n){n.collection_name="dmkh",t.addLink(n,"ten_kh"),t.data.id_kh||(t.data.id_kh=n._id,e.service.update(id_app,t.data._id,t.data).success(function(e){_.extend(t.data,e)}))})}}});contractModule.defaultValues={ngay_hd:new Date,ma_nt:"VND"},contractModule.module.directive("contract",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/contract/templates/directive.html",controller:["$scope","$http","$window","$location","$modal","appInfo",function($scope,$http,$window,$location,$modal,appInfo){appInfo.info("contract",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="contract:'ten_hd'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.list=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var e=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(e).then(function(t){var e=t.data;return e})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var e=_.find($scope.list,function(e){return e.obj._id==t._id});if(!e){var n={};n.id_a=$scope.link._id,n.collection_a=$scope.collection,n.collection_b=t.collection_name,n.collection_obj=t.collection_name,n.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,n).success(function(e){_.extend(n,e),n.obj=t,n.title=t.title,$scope.list.push(n)}).error(function(){})}},$scope.unLink=function(t){var e=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(e).success(function(){$scope.list=_.reject($scope.list,function(e){return e._id==t._id})}).error(function(){})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),contractModule.quickadd($modal,function(t){t.collection_name="contract",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var e="contract/view/"+t._id+"?redirect="+$location.url();$location.url(e)},$scope.delete=function(t){$window.confirm("Bạn có chắc chắn xóa không?")&&$http.delete(server_url+"/api/"+id_app+"/contract/"+t._id).success(function(){$scope.list=_.reject($scope.list,function(e){return e._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.edit=function(t){contractModule.quickedit($modal,t._id,function(e){_.extend(t,e)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,e,n){n.link&&n.collection||console.error("contract directive require attributes:link,collection")}}});var warrantyModule=new baseInput("warranty","warranty",["mieu_ta"],"Bảo hành",{has_view:!1});warrantyModule.defaultValues={unit_time:2,ma_nt:"VND",reminder_yn:!0,start_date:new Date},warrantyModule.module.directive("warranty",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/warranty/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","warranty","appInfo",function(t,e,n,a,i,o,r){r.info("warranty",function(e){e||(t.addwarranty=function(){warrantyModule.quickadd(i,function(e){t.warrantys.push(e)},{id_hd:t.idLink})},t.viewwarranty=function(t){n.url("/warranty/view/"+t._id+"?redirect="+n.url())},t.deletewarranty=function(e){a.confirm("Bạn có chắc chắn xóa bảo hành này không?")&&o.delete(id_app,e._id).success(function(){t.warrantys=_.reject(t.warrantys,function(t){return t._id==e._id})}).error(function(t){a.alert(t)})},t.editwarranty=function(t){warrantyModule.quickedit(i,t._id,function(e){_.extend(t,e)})},t.load=function(){o.load(id_app,{condition:{id_hd:t.idLink}}).success(function(e){t.warrantys=e}).error(function(t){a.alert(t)})},t.$watch("link",function(e){e&&(t.idLink=t.link._id,t.load())},!0))})}],link:function(t,e,n){n.link||console.error("warranty directive require 'link' attribute")}}});var dmnvModule=new baseInput("dmnv","dmnv",["ma_nv","ten_nv","dia_chi","dien_thoai","fax","email"],"Nhân viên",{has_view:!0,onView:function(t,e){t.addContact=function(){lienheModule.quickadd(e.$modal,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")},{id_nv:t.data._id,ten_nv:t.data.ten_nv})}},onLoading:function(t,e){t.advCondition={},e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'DMNV'}").success(function(e){t.groups=e})}),t.btn3_click=function(){var n=[];t.list.forEach(function(t){t.email&&t.sel&&n.push({name:t.ten_nv,address:t.email})}),n.length>0?e.$location.url("mailschedule/add?to="+JSON.stringify(n)+"&redirect="+e.$location.url()):alert("Bạn phải chọn ít nhất một nhân viên")},t.searchAVR=function(){t.renderCompleted&&(t.filter={},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_nv?t.filter.nh_nv=t.nh_nv:delete t.filter.nh_nv,t.advCondition.ten_nv?t.filter.$or=[{ten_nv:{$regex:t.advCondition.ten_nv,$options:"i"}},{ma_nv:{$regex:t.advCondition.ten_nv,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_nv,$options:"i"}},{email:{$regex:t.advCondition.ten_nv,$options:"i"}}]:delete t.filter.$or,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.search())},t.enter=function(e){13==e.keyCode&&t.searchAVR()},t.searchPhuTrach=function(e){t.phu_trach=e.email,t.searchAVR()},t.searchGroup=function(e){t.nh_nv=e._id,t.searchAVR()},t.reportByTime=function(e){t.time=e,t.searchAVR()}}}),dvcsModule=new baseInput("dvcs","dvcs",["ten_dvcs"],"Danh mục đơn vị cơ sở"),dmtcModule=new baseInput("dmtc","tc",["ma_tc","ten_tc"],"Danh mục tính chất thuế"),dmdvtModule=new baseInput("dmdvt","dmdvt",["ma_dvt","ten_dvt"],"Danh mục đơn vị tính"),dmvtModule=new baseInput("dmvt","dmvt",["ma_vt","ten_vt"],"Danh mục vật tư, hàng hóa",{has_view:!0,onLoading:function(t,e){e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/dmnvt").success(function(e){t.groups=e})}),t.searchGroup=function(e){t.ma_nvt=e._id;var n=t.filter;n||(n={}),t.ma_nvt?n.ma_nvt=t.ma_nvt:delete n.ma_nvt,t.changeFilter({filter:n})},t.searchType=function(e){t.type_filter=e;var n=t.filter;n||(n={}),delete n.hot,delete n.bestseller,delete n.banner_small,delete n.banner_large,e&&(n[e]=!0),t.changeFilter({filter:n})}}});dmvtModule.defaultValues={gia_xuat:"1",tk_vt:"1561"},dmvtModule.init=function(t){t.updatePrice=function(e){e.gia_ban_le&&e.ty_le_ck&&(e.tien_ck=Math.round(e.gia_ban_le*e.ty_le_ck,0)),t.update(e)},t.$watch("data.ty_le_ck",function(){t.isDataLoaded&&t.data.gia_ban_le&&t.data.ty_le_ck&&(t.data.tien_ck=Math.round(t.data.ty_le_ck*t.data.gia_ban_le/100,0))}),t.$watch("data.gia_ban_le",function(){t.isDataLoaded&&t.data.gia_ban_le&&t.data.ty_le_ck&&(t.data.tien_ck=Math.round(t.data.ty_le_ck*t.data.gia_ban_le/100,0))})};var dmnvtModule=new baseInput("dmnvt","dmnvt",["ten_nvt"],"Danh mục nhóm sản phẩm"),dmkhoModule=new baseInput("dmkho","dmkho",["ma_kho","ten_kho"],"Danh mục kho"),dmvatModule=new baseInput("dmvat","vat",["ma_thue","ten_thue","tk_thue_no","tk_thue_co"],"Danh mục thuế GTGT");dmvatModule.defaultValues={thue_suat:0};var dmntModule=new baseInput("dmnt","currency",["ma_nt","ten_nt"],"Danh mục ngoại tệ"),dmtkModule=new baseInput("dmtk","account",["tk","ten_tk","tk_me","ma_nt"],"Danh mục tài khoản",{has_view:!0});dmtkModule.defaultValues={ma_nt:"VND"};var dmkcModule=new baseInput("dmkc","dmkc",["tk_no","tk_co","ten_bt"],"Khai báo bút toán kết chuyển cuối kỳ");dmkcModule.defaultValues={loai_kc:"1",stt:1};var dmcpmhModule=new baseInput("dmcpmh","dmcpmh",["ma_cp","ten_cp"],"Danh mục chi phí mua hàng"),cdtkModule=new baseInput("cdtk","cdtk",["tk","ma_dvcs"],"Số dư đầu kỳ tài khoản");cdtkModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_no1=t.data.du_no00,t.data.du_co00=0,t.data.du_co1=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_co1=t.data.du_co00,t.data.du_no00=0,t.data.du_no1=0)})},cdtkModule.defaultValues={du_no00:0,du_no1:0,du_co00:0,du_co1:0};var cdkhModule=new baseInput("cdkh","cdkh",["tk","ma_kh","ma_dvcs"],"Số dư đầu kỳ công nợ khách hàng");cdkhModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_no1=t.data.du_no00,t.data.du_co00=0,t.data.du_co1=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_co1=t.data.du_co00,t.data.du_no00=0,t.data.du_no1=0)})},cdkhModule.defaultValues={du_no00:0,du_no1:0,du_co00:0,du_co1:0};var cdvtModule=new baseInput("cdvt","cdvt",["ma_vt","ma_kho","ma_dvcs"],"Số dư đầu kỳ vật tư");cdvtModule.defaultValues={ton00:0,du00:0,du_nt00:0};var cddtModule=new baseInput("cddt","cddt",["tk","ma_dvcs","ma_dt"],"Số dư đầu kỳ vụ việc");cddtModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_co00=0,t.data.du_co_nt00=0)}),t.$watch("data.du_no_nt00",function(){t.isDataLoaded&&(t.data.du_co00=0,t.data.du_co_nt00=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_no00=0,t.data.du_no_nt00=0)}),t.$watch("data.du_co_nt00",function(){t.isDataLoaded&&(t.data.du_no00=0,t.data.du_no_nt00=0)})},cddtModule.defaultValues={du_no00:0,du_co00:0,du_no_nt00:0,du_co_nt:0};var dmphiModule=new baseInput("dmphi","dmphi",["ma_phi","ten_phi"],"Danh mục phí"),dmqct_input=function(t,e){t.modules=[],e.$http.get(server_url+"/api/modules").then(function(e){e.data.forEach(function(e){!e.type||"V"!=e.type&&"L"!=e.type||t.modules.push(e)})})},dmqctModule=new baseInput("dmqct","dmqct",["ma_ct","ten_qct"],"Danh mục quyển chứng từ",{onAdd:function(t,e){dmqct_input(t,e),t.data.field="so_ct",t.data.den_so=999999},onEdit:dmqct_input}),ptthanhtoanModule=new baseInput("ptthanhtoan","ptthanhtoan",["ten"],"Danh mục phương thức thanh toán");angular.module("vatvaoModule",[]).directive("ngVatvao",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",tkDuThue:"=",tTienNt:"=",tTien:"=",tenVt:"=",maKh:"="},templateUrl:"templates/vouchers/vatvao/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout",function(t,e,n,a,i){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var e=_.reject(t,function(t){return 1==t.sel});t.length=0;var n=0;e.forEach(function(e){e.line=n,t.push(e),n++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var e=t.ngData.length;t.dt_master=null,t.dt_current={line:e},t.ngData||(t.ngData=[]),t.ngMasterData&&(t.dt_current.ngay_hd=t.ngMasterData.ngay_ct,t.tkDuThue&&(t.dt_current.tk_du_thue=t.tkDuThue),t.tTienNt&&(t.dt_current.t_tien_nt=t.tTienNt),t.tTien&&(t.dt_current.t_tien=t.tTien),t.tenVt&&(t.dt_current.ten_vt=t.tenVt),t.maKh&&(t.dt_current.ma_kh=t.maKh,n.list(id_app,{ma_kh:t.maKh}).success(function(e){1==e.length&&(t.dt_current.ten_kh=e[0].ten_kh,t.dt_current.dia_chi=e[0].dia_chi,t.dt_current.ma_so_thue=e[0].ma_so_thue)}))),t.openDetail("lg")},t.editDetail=function(e){t.dt_master=_.find(t.ngData,function(t){return t.line==e}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(n){var a=e.open({templateUrl:"templates/vouchers/vatvao/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.ngData=n.ngData,t.dt_master=n.dt_master,t.dt_current=n.dt_current,t.ngMasterData=n.ngMasterData,t.status=n.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var n in t.dt_current)t.dt_master[n]=t.dt_current[n];e.close()},t.cancelDetail=function(){e.dismiss("cancel")}}],size:n,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.thue_suat",function(){t.status.isOpened&&(t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_thue_nt",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien_nt",function(){t.status.isOpened&&(t.dt_current.t_tien=t.dt_current.t_tien_nt*t.ngMasterData.ty_gia,t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_tien*t.dt_current.thue_suat/100)})}}}]),angular.module("vatraModule",[]).directive("ngVatra",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",tkDuThue:"=",tTienNt:"=",tTien:"=",tenVt:"=",maKh:"="},templateUrl:"templates/vouchers/vatra/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout",function(t,e,n,a,i){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var e=_.reject(t,function(t){return 1==t.sel});t.length=0;var n=0;e.forEach(function(e){e.line=n,t.push(e),n++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var e=t.ngData.length;t.dt_master=null,t.dt_current={line:e},t.ngData||(t.ngData=[]),t.ngMasterData&&(t.dt_current.ngay_hd=t.ngMasterData.ngay_ct,t.tkDuThue&&(t.dt_current.tk_du_thue=t.tkDuThue),t.tTienNt&&(t.dt_current.t_tien_nt=t.tTienNt),t.tTien&&(t.dt_current.t_tien=t.tTien),t.tenVt&&(t.dt_current.ten_vt=t.tenVt),t.maKh&&(t.dt_current.ma_kh=t.maKh,n.list(id_app,{ma_kh:t.maKh}).success(function(e){1==e.length&&(t.dt_current.ten_kh=e[0].ten_kh,t.dt_current.dia_chi=e[0].dia_chi,t.dt_current.ma_so_thue=e[0].ma_so_thue)}))),t.openDetail("lg")},t.editDetail=function(e){t.dt_master=_.find(t.ngData,function(t){return t.line==e}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(n){var a=e.open({templateUrl:"templates/vouchers/vatra/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.ngData=n.ngData,t.dt_master=n.dt_master,t.dt_current=n.dt_current,t.ngMasterData=n.ngMasterData,t.status=n.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var n in t.dt_current)t.dt_master[n]=t.dt_current[n];e.close()},t.cancelDetail=function(){e.dismiss("cancel")}}],size:n,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.thue_suat",function(){t.status.isOpened&&(t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_thue_nt",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien_nt",function(){t.status.isOpened&&(t.dt_current.t_tien=t.dt_current.t_tien_nt*t.ngMasterData.ty_gia,t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_tien*t.dt_current.thue_suat/100)})}}}]),angular.module("tdttcoModule",[]).directive("ngTdttco",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"="},templateUrl:"templates/vouchers/tdttco/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout","$http",function(t,e,n,a,i,o){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var e=_.reject(t,function(t){return 1==t.sel});t.length=0;var n=0;e.forEach(function(e){e.line=n,t.push(e),n++})},t.getInvoice=function(){if(!t.ngMasterData.ma_kh)return alert("Phải nhập một khách hàng trước khi lấy hóa đơn");var e=server_url+"/api/"+id_app+"/getinvoice2pay?ma_kh="+t.ngMasterData.ma_kh;t.ngMasterData._id&&(e=e+"&id_ct="+t.ngMasterData._id),o.get(e).success(function(e){t.ngData=e,0==t.ngData.length&&alert("Không có hóa đơn nào cần chi cho khách hàng này")}).error(function(t){alert("Không thể lấy được thông tin hóa đơn"),console.log(t)})},t.addDetail=function(){t.ngData||(t.ngData=[]);var e=t.ngData.length;t.dt_master=null,t.dt_current={line:e},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(e){t.dt_master=e,t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(n){var a=e.open({templateUrl:"templates/vouchers/tdttco/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.ngData=n.ngData,t.dt_master=n.dt_master,t.dt_current=n.dt_current,t.ngMasterData=n.ngMasterData,t.status=n.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var n in t.dt_current)t.dt_master[n]=t.dt_current[n];e.close()},t.cancelDetail=function(){e.dismiss("cancel")}}],size:n,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_nt",function(){t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2)))}),t.$watch("dt_current.tien",function(){t.status.isOpened&&0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2))})}}}]),angular.module("tdttnoModule",[]).directive("ngTdttno",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"="},templateUrl:"templates/vouchers/tdttno/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout","$http",function(t,e,n,a,i,o){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var e=_.reject(t,function(t){return 1==t.sel});t.length=0;var n=0;e.forEach(function(e){e.line=n,t.push(e),n++})},t.getInvoice=function(){if(!t.ngMasterData.ma_kh)return alert("Phải nhập một khách hàng trước khi lấy hóa đơn");var e=server_url+"/api/"+id_app+"/getinvoice2receive?ma_kh="+t.ngMasterData.ma_kh;t.ngMasterData._id&&(e=e+"&id_ct="+t.ngMasterData._id),o.get(e).success(function(e){t.ngData=e,0==t.ngData.length&&alert("Không có hóa đơn nào cần thu cho khách hàng này")}).error(function(t){alert("Không thể lấy được thông tin hóa đơn"),console.log(t)})},t.addDetail=function(){t.ngData||(t.ngData=[]);var e=t.ngData.length;t.dt_master=null,t.dt_current={line:e},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(e){t.dt_master=e,t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(n){var a=e.open({templateUrl:"templates/vouchers/tdttno/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.ngData=n.ngData,t.dt_master=n.dt_master,t.dt_current=n.dt_current,t.ngMasterData=n.ngMasterData,t.status=n.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var n in t.dt_current)t.dt_master[n]=t.dt_current[n];e.close()},t.cancelDetail=function(){e.dismiss("cancel")}}],size:n,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_nt",function(){t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2)))}),t.$watch("dt_current.tien",function(){t.status.isOpened&&0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2))})}}}]),angular.module("ctcpmhModule",[]).directive("ngCtcpmh",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",allocate:"&"},templateUrl:"templates/vouchers/ctcpmh/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout",function(t,e,n,a,i){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var e=_.reject(t,function(t){return 1==t.sel});t.length=0;var n=0;e.forEach(function(e){e.line=n,t.push(e),n++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var e=t.ngData.length;t.dt_master=null,t.dt_current={line:e},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(e){t.dt_master=_.find(t.ngData,function(t){return t.line==e}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(n){var a=e.open({templateUrl:"templates/vouchers/ctcpmh/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.ngData=n.ngData,t.dt_master=n.dt_master,t.dt_current=n.dt_current,t.ngMasterData=n.ngMasterData,t.status=n.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var n in t.dt_current)t.dt_master[n]=t.dt_current[n];e.close()},t.cancelDetail=function(){e.dismiss("cancel")}}],size:n,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_cp_nt",function(){t.status.isOpened&&(t.dt_current.tien_cp=t.dt_current.tien_cp_nt*t.ngMasterData.ty_gia)})}}}]);var pktModule=new baseVoucher("pkt","pkt",[],"Phiếu kế toán");pktModule.defaultValues={vatvaos:[],vatras:[]},pktModule.defaultValues4Detail={tien_nt:0,tien:0},pktModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pktModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pktModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(e*t.ngMasterData.ty_gia,0))})},pktModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}),angular.forEach(t.data.vatras,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}))})};var pkcModule=new baseVoucher("pkc","pkc",[],"Phiếu kết chuyển cuối kỳ");pkcModule.defaultValues={},pkcModule.defaultValues4Detail={tien_nt:0,tien:0},pkcModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkcModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkcModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(e*t.ngMasterData.ty_gia,0))}),t.dmkc=function(){t.$window.open("#dmkc","Khai báo kết chuyển cuối kỳ","width=800,height=400")},t.createKC=function(){_.isDate(t.ngMasterData.ngay_ct)||(t.ngMasterData.ngay_ct=new Date(t.ngMasterData.ngay_ct)),t.ngMasterData.details=[];var e=server_url+"/api/"+id_app+"/rp-getdk4pkc?id_ct="+t.ngMasterData._id;e+="&thang="+t.ngMasterData.ngay_ct.getMonth().toString(),e+="&nam="+t.ngMasterData.ngay_ct.getFullYear().toString(),t.ngMasterData.kc_dvcs&&(e=e+"&ma_dvcs="+t.ngMasterData.ma_dvcs),t.$http.get(e).success(function(e){t.messageError=void 0,t.ngMasterData.details=e}).error(function(e){t.alertType="alert alert-danger",t.messageError=e})}},pkcModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0)})})};var pn1Module=new baseVoucher("pn1","pn1",[],"Phiếu nhập mua hàng trong nước");pn1Module.defaultValues={vatvaos:[],tk_co:"1111",ten_tk_co:"Tiền mặt"},pn1Module.defaultValues4Detail={sl_nhap:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,tien_phi_nt:0,tien_phi:0,tien_nhap_nt:0,tien_nhap:0},pn1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn1Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nt=Math.round(t.dt_current.gia_von_nt*t.dt_current.sl_nhap,t.round))
}),t.$watch("dt_current.gia_von",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_von*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.tien_hang_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_hang",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.tien_phi_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_phi=Math.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_phi",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)})},pn1Module.watchMaster=function(t){t.allocate=function(e){for(var n=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][e];if(0!=i)for(var o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=Math.round(t.data.details[o][e]/i*n,t.round),t.data.details[o].tien_phi=Math.round(t.data.details[o][e]/i*a,0),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi;alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*e,0),t.tien_hang=Math.round(t.tien_hang_nt*e,0),t.tien_phi=Math.round(t.tien_phi_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_nhap=Math.round(t.tien_nhap_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}),angular.forEach(t.data.ctcpmhs,function(t){t.tien_cp=Math.round(t.tien_cp_nt*e,0)}))})};var pn2Module=new baseVoucher("pn2","pn2",[],"Phiếu mua dịch vụ");pn2Module.defaultValues={vatvaos:[]},pn2Module.defaultValues4Detail={tien_nt:0,tien:0},pn2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn2Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0))})},pn2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0)})})};var pn3Module=new baseVoucher("pn3","pn3",[],"Phiếu nhập chi phí mua hàng");pn3Module.defaultValues={vatvaos:[]},pn3Module.defaultValues4Detail={tien_ck_nt:0,tien_ck:0},pn3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn3Module.watchDetail=function(t){t.$watch("dt_current.tien_phi_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_phi=Math.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0))}),t.getPN=function(){t.$modal.open({templateUrl:"templates/vouchers/pn3/templates/form-select-invoice.html",controller:["$scope","$modalInstance","parentScope","$filter",function(e,n,a,i){e.condition={tu_ngay:new Date,den_ngay:new Date},e.ngData=a.ngData,e.dt_current=a.dt_current,e.ngMasterData=a.ngMasterData,e.masters=[],e.details=[],e.invoiceClick=function(t){e.details=[];var n=_.find(e.masters,function(e){return e._id=t});e.details=n.details},e.loadInvoice=function(){e.masters=[],e.details=[];var n=server_url+"/api/"+id_app+"/getpn2fee?";n=n+"tu_ngay="+i("date")(e.condition.tu_ngay,"yyyy-MM-dd"),n=n+"&den_ngay="+i("date")(e.condition.den_ngay,"yyyy-MM-dd"),e.condition.so_ct&&(n=n+"&so_ct="+e.condition.so_ct),t.$http.get(n).success(function(t){e.masters=t}).error(function(t){e.masters=[],alert(t)})},e.ok=function(){a.ngMasterData.details=[];var t=0;e.masters.forEach(function(e){e.sel&&e.details.forEach(function(e){e.sel&&(e.line=t,a.ngMasterData.details.push(e),t++)})}),n.close()},e.cancel=function(){n.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return t}}})}},pn3Module.watchMaster=function(t){t.allocate=function(e){for(var n=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][e];if(0!=i)for(var o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=Math.round(t.data.details[o][e]/i*n,t.round),t.data.details[o].tien_phi=Math.round(t.data.details[o][e]/i*a,0),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi;alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_phi=Math.round(t.tien_phi_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}),angular.forEach(t.data.ctcpmhs,function(t){t.tien_cp=Math.round(t.tien_cp_nt*e,0)}))})};var pn5Module=new baseVoucher("pn5","pn5",[],"Phiếu xuất trả lại nhà cung cấp");pn5Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},pn5Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},pn5Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn5Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn5Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.tien_hang_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_xuat_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_hang",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.tien_xuat_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))}),t.getInvoice=function(){t.$modal.open({templateUrl:"templates/vouchers/pn5/templates/form-select-invoice.html",controller:["$scope","$modalInstance","parentScope","$filter",function(e,n,a,i){e.condition={tu_ngay:new Date,den_ngay:new Date},e.ngData=a.ngData,e.dt_current=a.dt_current,e.ngMasterData=a.ngMasterData,e.masters=[],e.details=[],e.invoiceClick=function(t){e.details=[];var n=_.find(e.masters,function(e){return e._id=t});e.details=n.details},e.loadInvoice=function(){e.masters=[],e.details=[];var n=server_url+"/api/"+id_app+"/getpn2return?ma_kh="+e.ngMasterData.ma_kh;n=n+"&tu_ngay="+i("date")(e.condition.tu_ngay,"yyyy-MM-dd"),n=n+"&den_ngay="+i("date")(e.condition.den_ngay,"yyyy-MM-dd"),e.condition.so_ct&&(n=n+"&so_ct="+e.condition.so_ct),e.ngMasterData._id&&(n=n+"&id_ct="+e.ngMasterData._id),t.$http.get(n).success(function(t){e.masters=t}).error(function(t){e.masters=[],alert(t)})},e.ok=function(){a.ngMasterData.details=[];var t=0;e.masters.forEach(function(e){e.sel&&e.details.forEach(function(e){e.sel&&(e.line=t,a.ngMasterData.details.push(e),t++)})}),n.close()},e.cancel=function(){n.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return t}}})}},pn5Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_hang=Math.round(t.tien_hang_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_xuat=Math.round(t.tien_xuat_nt*e,0)}),t.data.t_thue=Math.round(t.data.t_thue_nt*e,0))}),t.$watch("data.thue_suat",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_hang_nt",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_hang",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien_hang-t.data.t_ck)*t.data.thue_suat/100,0))})};var pn9Module=new baseVoucher("pn9","pn9",[],"Phiếu nhập khẩu");pn9Module.defaultValues={vatvaos:[]},pn9Module.defaultValues4Detail={sl_nhap:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,tien_von_nk_nt:0,tien_von_nk:0,tien_hang_nk_nt:0,tien_hang_nk:0,thue_suat_nk:0,tien_thue_nk_nt:0,tien_thue_nk:0,tien_phi_nt:0,tien_phi:0,tien_nhap_nt:0,tien_nhap:0},pn9Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn9Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn9Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nk_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nk_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nt=Math.round(t.dt_current.gia_von_nt*t.dt_current.sl_nhap,t.round),t.dt_current.gia_von_nk_nt=t.dt_current.gia_von_nt)}),t.$watch("dt_current.gia_von",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_von*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.gia_von_nk_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von_nk=Math.round(t.dt_current.gia_von_nk_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nk_nt=Math.round(t.dt_current.gia_von_nk_nt*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.gia_von_nk",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nk=Math.round(t.dt_current.gia_von_nk*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.tien_hang_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt+t.dt_current.tien_thue_nk_nt)}),t.$watch("dt_current.tien_hang",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi+t.dt_current.tien_thue_nk)}),t.$watch("dt_current.tien_hang_nk_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nk=Math.round(t.dt_current.tien_hang_nk_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_thue_nk_nt=Math.round(t.dt_current.tien_hang_nk_nt*t.dt_current.thue_suat_nk/100,t.round))}),t.$watch("dt_current.tien_hang_nk",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_thue_nk=Math.round(t.dt_current.tien_hang_nk*t.dt_current.thue_suat_nk/100,0))}),t.$watch("dt_current.thue_suat_nk",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_thue_nk_nt=Math.round(t.dt_current.tien_hang_nk*t.dt_current.thue_suat_nk/100,t.round))}),t.$watch("dt_current.tien_thue_nk_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_thue_nk=Math.round(t.dt_current.tien_thue_nk_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt+t.dt_current.tien_thue_nk_nt)}),t.$watch("dt_current.tien_thue_nk",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi+t.dt_current.tien_thue_nk)}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.tien_phi_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_phi=Math.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_phi",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)})},pn9Module.watchMaster=function(t){t.allocate=function(e){for(var n=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][e];if(0!=i)for(var o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=Math.round(t.data.details[o][e]/i*n,t.round),t.data.details[o].tien_phi=Math.round(t.data.details[o][e]/i*a,0),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi;alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*e,0),t.tien_hang=Math.round(t.tien_hang_nt*e,0),t.tien_phi=Math.round(t.tien_phi_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_nhap=Math.round(t.tien_nhap_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}),angular.forEach(t.data.ctcpmhs,function(t){t.tien_cp=Math.round(t.tien_cp_nt*e,0)}))})};var pnkModule=new baseVoucher("pnk","pnk",[],"Phiếu nhập kho nội bộ");pnkModule.defaultValues={},pnkModule.defaultValues4Detail={sl_nhap:0,pn_gia_tb:!0,gia_von_nt:0,gia_von:0,tien_nhap_nt:0,tien_nhap:0},pnkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pnkModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pnkModule.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_nhap_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=Math.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,0))})},pnkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*e,0),t.tien_nhap=Math.round(t.tien_nhap_nt*e,0)})})};var pxkModule=new baseVoucher("pxk","pxk",[],"Phiếu xuất kho nội bộ");pxkModule.defaultValues={},pxkModule.defaultValues4Detail={sl_xuat:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pxkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pxkModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pxkModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_xuat_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))})},pxkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*e,0),t.tien_xuat=Math.round(t.tien_xuat_nt*e,0)})})};var pxcModule=new baseVoucher("pxc","pxc",[],"Phiếu xuất điều chuyển kho");pxcModule.defaultValues={},pxcModule.defaultValues4Detail={sl_xuat:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pxcModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pxcModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pxcModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_xuat_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))})},pxcModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*e,0),t.tien_xuat=Math.round(t.tien_xuat_nt*e,0)})})};var pc1Module=new baseVoucher("pc1","pc1",[],"Phiếu chi tiền",{onEdit:function(t){t.select(t.data.tdttcos&&t.data.tdttcos.length>0?"chi_hd":"chi_kh")},onInit:function(t){t.select_chi_kh=!0,t.select_chi_hd=!1,t.select_vat_vao=!1,t.select=function(e){t.select_chi_kh="chi_kh"==e,t.select_chi_hd="chi_hd"==e,t.select_vat_vao="vat_vao"==e}}});pc1Module.defaultValues={vatvaos:[],ma_gd:"1"},pc1Module.defaultValues4Detail={tien_nt:0,tien:0},pc1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pc1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pc1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(e*t.ngMasterData.ty_gia,0))})},pc1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}),angular.forEach(t.data.vatras,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}))})};var pt1Module=new baseVoucher("pt1","pt1",[],"Phiếu thu tiền",{onEdit:function(t){t.select(t.data.tdttnos&&t.data.tdttnos.length>0?"thu_hd":"thu_kh")},onInit:function(t){t.select_thu_kh=!0,t.select_thu_hd=!1,t.select=function(e){t.select_thu_kh="thu_kh"==e,t.select_thu_hd="thu_hd"==e}}});pt1Module.defaultValues={ma_gd:"1"},pt1Module.defaultValues4Detail={tien_nt:0,tien:0},pt1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pt1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pt1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(e*t.ngMasterData.ty_gia,0))})},pt1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}),angular.forEach(t.data.vatras,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}))})};var hd2Module=new baseVoucher("hd2","hd2",[],"Hóa đơn bán hàng");hd2Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},hd2Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},hd2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd2Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.gia_ban",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))})},hd2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_hang_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_xuat=t.tien_xuat_nt}),t.data.t_thue=Math.round(t.data.t_thue_nt*e,0))}),t.$watch("data.thue_suat",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_nt",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))})};var hd1Module=new baseVoucher("hd1","hd1",[],"Hóa đơn bán dịch vụ");hd1Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},hd1Module.defaultValues4Detail={ty_le_ck:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0},hd1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))})},hd1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_hang_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0)}),t.data.t_thue=Math.round(t.data.t_thue_nt*e,0))}),t.$watch("data.thue_suat",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_nt",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))})};var hd3Module=new baseVoucher("hd3","hd3",[],"Phiếu nhập hàng bán bị trả lại");hd3Module.defaultValues={vatvaos:[]},hd3Module.defaultValues4Detail={sl_nhap:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_nhap_nt:0,tien_nhap:0},hd3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd3Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,0))
}),t.$watch("dt_current.gia_ban_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_ban=Math.round(t.dt_current.gia_ban_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.gia_ban",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_ban,0))}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt,0),t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,0))}),t.$watch("dt_current.tien_nhap_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_nhap=Math.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.getInvoice=function(){t.$modal.open({templateUrl:"templates/vouchers/hd3/templates/form-select-invoice.html",controller:["$scope","$modalInstance","parentScope","$filter",function(e,n,a,i){e.condition={tu_ngay:new Date,den_ngay:new Date},e.ngData=a.ngData,e.dt_current=a.dt_current,e.ngMasterData=a.ngMasterData,e.masters=[],e.details=[],e.invoiceClick=function(t){e.details=[];var n=_.find(e.masters,function(e){return e._id=t});e.details=n.details},e.loadInvoice=function(){e.masters=[],e.details=[];var n=server_url+"/api/"+id_app+"/getinvoice2return?ma_kh="+e.ngMasterData.ma_kh;e.ngMasterData._id&&(n=n+"&id_ct="+e.ngMasterData._id),n=n+"&tu_ngay="+i("date")(e.condition.tu_ngay,"yyyy-MM-dd"),n=n+"&den_ngay="+i("date")(e.condition.den_ngay,"yyyy-MM-dd"),e.condition.so_ct&&(n=n+"&so_ct="+e.condition.so_ct),e.condition.so_hd&&(n=n+"&so_hd="+e.condition.so_hd),t.$http.get(n).success(function(t){e.masters=t}).error(function(t){e.masters=[],alert(t)})},e.ok=function(){a.ngMasterData.details=[];var t=0;e.masters.forEach(function(e){e.sel&&e.details.forEach(function(e){e.sel&&(e.line=t,a.ngMasterData.details.push(e),t++)})}),n.close()},e.cancel=function(){n.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return t}}})}},hd3Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_nhap=Math.round(t.tien_nhap_nt*e,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*e,0),t.t_thue=Math.round(t.t_thue_nt*e,0)}))})};var pblModule=new baseVoucher("pbl","pbl",[],"Phiếu bán lẻ");pblModule.defaultValues={ty_le_ck_hd:0,tien_ck_hd:0},pblModule.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},pblModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pblModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pblModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round))}),t.$watch("dt_current.gia_ban",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,0))}),t.$watch("dt_current.tien_hang_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_hang",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)})},pblModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_hang=Math.round(t.tien_hang_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_xuat=t.tien_xuat_nt}),t.data.t_thue=Math.round(t.data.t_thue_nt*e,0))}),t.$watch("data.t_tien_nt",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.ty_le_ck_hd",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.tien_ck_hd=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.ty_le_ck_hd/100,0))}),t.$watch("data.t_tien",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))}),t.$watch("data.tien_thu",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.con_no=t.data.t_tt-t.data.tien_thu)})};var so1Module=new baseVoucher("so1","so1",[],"Đơn đặt hàng");so1Module.defaultValues={ty_le_ck_hd:0,tien_ck_hd:0,trang_thai:"1"},so1Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_xuat_nt:0,tien_xuat:0,gia_von_nt:0,gia_von:0,px_gia_dd:!1},so1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:"",trang_thai:""},so1Module.prepareCondition4Search=function(t){var e={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return""!=t.vcondition.trang_thai&&(e.trang_thai=t.vcondition.trang_thai),e},so1Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round))}),t.$watch("dt_current.gia_ban",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,0))}),t.$watch("dt_current.tien_hang_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_hang",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.gia_von_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)})},so1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_hang=Math.round(t.tien_hang_nt*e,0),t.tien_ck=Math.round(t.tien_ck_nt*e,0),t.tien_xuat=t.tien_xuat_nt}),t.data.t_thue=Math.round(t.data.t_thue_nt*e,0))}),t.$watch("data.t_tien_hang_nt",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.ty_le_ck_hd",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.tien_ck_hd=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.ty_le_ck_hd/100,0))}),t.$watch("data.t_tien",function(e){t.data&&void 0!=e&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))})},so1Module.module.directive("saleOrder",function(){return{restrict:"E",scope:{},templateUrl:"templates/vouchers/so1/templates/db.html",controller:["$scope","so1","$rootScope","$interval","$location","appInfo",function(t,e,n,a,i,o){o.info("so1",function(o){o||(t.now=new Date,t.app_info=n.app_info,t.editOrder=function(t){i.url("/so1/edit/"+t)},t.condition={trang_thai:{$in:["1","2"]}},t.filter=function(a){n.nextTick(function(){a&&_.extend(t.condition,a),e.load(id_app,{condition:t.condition,limit:10}).success(function(e){t.orders=e})})},t.filter(),t.intv&&(a.cancel(t.intv),t.intv=void 0),t.intv=a(t.filter,3e5))})}],link:function(){}}});var module=angular.module("searchModule",["ngRoute"]);module.controller("searchController",["$scope","$rootScope","$location","$http","$routeParams","dmkh","dmvt","dmtk","lienhe","task","contract","dmdt","$window","$localStorage","appInfo",function(t,e,n,a,i,o,r,c,d,l,u,s,_,p,h){h.info("SEARCH",function(h){if(!h){t.viewProduct=function(t){_.open("#dmvt/view/"+t+"?redirect="+n.url())},t.viewCustomer=function(t){_.open("#dmkh/view/"+t+"?redirect="+n.url())},t.viewAccount=function(t){_.open("#dmtk/view/"+t+"?redirect="+n.url())},t.viewContact=function(t){_.open("#lienhe/view/"+t+"?redirect="+n.url())},t.viewTask=function(t){_.open("#task/view/"+t+"?redirect="+n.url())},t.viewContract=function(t){_.open("#contract/view/"+t+"?redirect="+n.url())},t.viewProject=function(t){_.open("#dmdt/view/"+t+"?redirect="+n.url())},t.viewVoucher=function(t,e){if(t&&e){var n="#/"+t.toLowerCase()+"/edit/"+e;_.open(n)}},t.word=i.word,e.searchword=t.word,t.functions=[];var f=t.word.toLowerCase();e.commands&&(e.commands.acc.forEach(function(e){e.items.forEach(function(e){e.items.forEach(function(e){e.visiable&&"dxd"!=e.path&&e.header.toLowerCase().indexOf(f)>=0&&t.functions.push(e)})})}),e.commands.crm.input.forEach(function(e){e.visiable&&"dxd"!=e.path&&e.header.toLowerCase().indexOf(f)>=0&&t.functions.push(e)})),o.list(id_app,t.word,null,null,1,50).success(function(e){t.customers=e;var n=[];e.forEach(function(t){n.push(t.ma_kh)}),c.list(id_app,t.word,null,null,1,50).success(function(e){t.accounts=e;var i=[];e.forEach(function(t){i.push(t.tk)});var o=p.get("token"),r={$or:[]};r.$or.push({dien_giai:{$regex:t.word,$options:"i"}}),r.$or.push({so_ct:{$regex:t.word,$options:"i"}}),r.$or.push({ma_ct:{$regex:t.word,$options:"i"}}),r.$or.push({ma_kh:{$regex:t.word,$options:"i"}}),r.$or.push({tk_no:{$regex:t.word,$options:"i"}}),r.$or.push({tk_co:{$regex:t.word,$options:"i"}}),n.length>0&&(r.$or.push({ma_kh_no:{$in:n}}),r.$or.push({ma_kh_co:{$in:n}})),i.length>0&&(r.$or.push({tk_no:{$in:i}}),r.$or.push({tk_co:{$in:i}}));var c=server_url+"/api/"+id_app+"/bkct?access_token="+o+"&q="+JSON.stringify(r);a.get(c).success(function(e){t.vouchers=e})})}).error(function(){}),r.list(id_app,t.word,null,null,1,50).success(function(e){t.products=e}).error(function(){}),d.list(id_app,t.word,null,null,1,50).success(function(e){t.contacts=e}).error(function(){}),u.list(id_app,t.word,null,null,1,50).success(function(e){t.contracts=e}).error(function(){}),s.list(id_app,t.word,null,null,1,50).success(function(e){t.projects=e}).error(function(){}),l.list(id_app,t.word,null,null,1,50).success(function(e){t.dscv=e}).error(function(){})}})}]),module.config(["$routeProvider","$locationProvider",function(t){t.when("/search/:word",{templateUrl:"templates/reports/search/templates/browser.html",controller:"searchController"})}]);var rptBkct=new baseRpt("bkct","bkct","Bảng kê chứng từ");rptBkct.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptBkct.module.directive("bkctView",function(){return{restrict:"E",templateUrl:"templates/reports/bkct/templates/view.html"}}),rptBkct.module.directive("bkct",function(){return{restrict:"E",scope:{condition:"@",run:"="},templateUrl:"templates/reports/bkct/templates/view.html",controller:["$scope","$http","$filter","$location",function($scope,$http,$filter,$location){$scope.getData=function(){$scope.data=[];var condition=eval("({"+$scope.condition+"})");rptBkct.getData($http,$filter,condition,function(t,e){t?console.log(t):$scope.data=e})},$scope.viewVoucher=function(t,e){if(t&&e){var n=t.toLowerCase()+"/edit/"+e+"?redirect=back";$location.url(n)}},$scope.order=function(t,e){$scope.data=$filter("orderBy")($scope.data,t,e)}}],link:function(t){t.$watch("run",function(){t.run&&t.getData()})}}});var rptScttk=new baseRpt("scttk","scttk","Sổ chi tiết tài khoản");rptScttk.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptScttk.afterLoadData=function(t){t.title="Sổ chi tiết tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptScttk=new baseRpt("socaitk","socaitk","Sổ cái tài khoản");rptScttk.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptScttk.afterLoadData=function(t){t.title="Sổ cái tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptsochut=new baseRpt("sochut","sochut","Sổ chữ T tài khoản",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.tk_du){var i="/bkct?tk="+t.condition.tk;i=i+"&tk_du="+e.tk_du,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptsochut.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptsochut.afterLoadData=function(t){t.title="Sổ chữ T tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptCdpstk=new baseRpt("cdpstk","cdpstk","Cân đối phát sinh tài khoản",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.tk&&""!=e.tk){var i="/scttk?tk="+e.tk;i=i+"&ten_tk="+e.ten_tk,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptCdpstk.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptCdpstk.useExcelTemplate=!0;var rptsonkc=new baseRpt("sonkc","sonkc","Sổ nhật ký chung");rptsonkc.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptsonktt=new baseRpt("sonktt","sonktt","Nhật ký thu tiền");rptsonktt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e,t.tk_no="111,112"};var rptsonkct=new baseRpt("sonkct","sonkct","Nhật ký chi tiền");rptsonkct.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e,t.tk_co="111,112"};var rptsonkmh=new baseRpt("sonkmh","sonkmh","Nhật ký mua hàng");rptsonkmh.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptsonkbh=new baseRpt("sonkbh","sonkbh","Nhật ký bán hàng");rptsonkbh.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptsctcnkh=new baseRpt("sctcnkh","sctcnkh","Sổ chi tiết công nợ khách hàng");rptsctcnkh.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptsctcnkh.afterLoadData=function(t){t.title="Sổ chi tiết công nợ khách hàng: "+t.condition.ma_kh+" - "+t.condition.ten_kh},rptsctcnkh.useExcelTemplate=!0;var rptcdpskh=new baseRpt("cdpskh","cdpskh","Cân đối phát sinh theo khách hàng",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_kh){var i="/sctcnkh?tk="+t.condition.tk;i=i+"&ten_tk="+t.condition.ten_tk,i=i+"&ma_kh="+e.ma_kh,i=i+"&ten_kh="+e.ten_kh,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptcdpskh.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptcdpskh.useExcelTemplate=!0;var rptsctdt=new baseRpt("sctdt","sctdt","Sổ chi tiết vụ việc, dự án");rptsctdt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptsctdt.afterLoadData=function(t){t.title="Sổ chi tiết vụ việc, dự án: "+t.condition.ma_dt+" - "+t.condition.ten_dt},rptsctdt.useExcelTemplate=!0;var rptcdpsdt=new baseRpt("cdpsdt","cdpsdt","Cân đối phát sinh theo vụ việc",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_dt){var i="/sctdt?tk="+t.condition.tk;i=i+"&ten_tk="+t.condition.ten_tk,i=i+"&ma_dt="+e.ma_dt,i=i+"&ten_dt="+e.ten_dt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptcdpsdt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptcdpsdt.useExcelTemplate=!0;var rptbkvatvao=new baseRpt("bkvatvao","bkvatvao","BẢNG KÊ HOÁ ĐƠN, CHỨNG TỪ HÀNG HOÁ, DỊCH VỤ MUA VÀO");rptbkvatvao.init=function(t){t.sorts=[{ma:"ngay_hd",text:"Ngày hóa đơn"},{ma:"ngay_ct",text:"Ngày chứng từ"}]},rptbkvatvao.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e,t.sort="ngay_hd"},rptbkvatvao.setParameters=function(t){t.tong_tien_nt=0,t.tong_thue_nt=0,t.data.forEach(function(e){e.t_tien_nt&&5==e.sysorder&&(t.tong_tien_nt+=e.t_tien_nt),e.t_thue_nt&&5==e.sysorder&&(t.tong_thue_nt+=e.t_thue_nt)})};var rptbkvatra=new baseRpt("bkvatra","bkvatra","BẢNG KÊ HOÁ ĐƠN, CHỨNG TỪ HÀNG HOÁ, DỊCH VỤ BÁN RA");rptbkvatra.init=function(t){t.sorts=[{ma:"ngay_hd",text:"Ngày hóa đơn"},{ma:"ngay_ct",text:"Ngày chứng từ"}]},rptbkvatra.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e,t.sort="ngay_hd"},rptbkvatra.setParameters=function(t){t.tong_tien_nt=0,t.tong_thue_nt=0,t.data.forEach(function(e){e.t_tien_nt&&5==e.sysorder&&(t.tong_tien_nt+=e.t_tien_nt),e.t_thue_nt&&5==e.sysorder&&(t.tong_thue_nt+=e.t_thue_nt)})};var kbmtkgtgtModule=new baseInput("kbmtkgtgt","kbmtkgtgt",["ma_so","chi_tieu"],"Khai báo mẫu tờ khai thuế GTGT");kbmtkgtgtModule.defaultValues={cach_tinh:"2",bang_du_lieu:"vatvao",phan_loai:"1",print:!0,kieu_gia_tri:"0"};var rpttkgtgt=new baseRpt("tkgtgt","tkgtgt","Tờ khai thuế GTGT");rpttkgtgt.defaultCondition=function(t){var e=new Date;t.tu_thang=e.getMonth()+1,t.den_thang=e.getMonth()+1,t.nam=e.getFullYear()};var rptBcdkt=new baseRpt("bcdkt","bcdkt","Bảng cân đối kế toán");rptBcdkt.defaultCondition=function(t){var e=new Date;t.den_ngay=e};var kbmbcdktModule=new baseInput("kbmbcdkt","kbmbcdkt",["ma_so","chi_tieu"],"Khai báo mẫu bảng cân đối kế toán");kbmbcdktModule.defaultValues={cach_tinh:"2",phan_loai:"1"};var kbmkqhdkdModule=new baseInput("kbmkqhdkd","kbmkqhdkd",["ma_so","chi_tieu"],"Khai báo mẫu kết quả hoạt động kinh doanh");kbmkqhdkdModule.defaultValues={cach_tinh:"2"};var rptkqhdkd=new baseRpt("kqhdkd","kqhdkd","Kết quả hoạt động kinh doanh");rptkqhdkd.defaultCondition=function(t){var e=new Date,n=e.getFullYear(),a=e.getMonth(),i=e.getDate();t.tu_ngay=new Date(n,a,1),t.den_ngay=e,t.tu_ngay_kt=new Date(n-1,a,1),t.den_ngay_kt=new Date(n-1,a,i)};var kbmlcttttModule=new baseInput("kbmlctttt","kbmlctttt",["ma_so","chi_tieu"],"Khai báo mẫu báo cáo lưu chuyển tiền tệ phương pháp trực tiếp");kbmlcttttModule.defaultValues={cach_tinh:"1",phan_loai:"1"};var rptlctttt=new baseRpt("lctttt","lctttt","Lưu chuyển tiền tệ phương pháp trực tiếp");rptlctttt.defaultCondition=function(t){var e=new Date,n=e.getFullYear(),a=e.getMonth(),i=e.getDate();t.tu_ngay=new Date(n,a,1),t.den_ngay=e,t.tu_ngay_kt=new Date(n-1,a,1),t.den_ngay_kt=new Date(n-1,a,i)};var kbmlcttgtModule=new baseInput("kbmlcttgt","kbmlcttgt",["ma_so","chi_tieu"],"Khai báo mẫu báo cáo lưu chuyển tiền tệ phương pháp gián tiếp");kbmlcttgtModule.defaultValues={cach_tinh:"1",phan_loai:"1"};var rptlcttgt=new baseRpt("lcttgt","lcttgt","Lưu chuyển tiền tệ phương pháp gián tiếp");rptlcttgt.defaultCondition=function(t){var e=new Date,n=e.getFullYear(),a=e.getMonth(),i=e.getDate();t.tu_ngay=new Date(n,a,1),t.den_ngay=e,t.tu_ngay_kt=new Date(n-1,a,1),t.den_ngay_kt=new Date(n-1,a,i)};var rptThnxt=new baseRpt("thnxt","thnxt","Tổng hợp nhập xuất tồn",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_vt){var i="/sctvt?ma_kho="+t.condition.ma_kho;i=i+"&ma_vt="+e.ma_vt,i=i+"&ten_vt="+e.ten_vt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptThnxt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e,t.ma_kho="",t.ma_vt=""};var rptsctvt=new baseRpt("sctvt","sctvt","Sổ chi tiết vật tư");rptsctvt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptsctvt.afterLoadData=function(t){t.title="Sổ chi tiết vật tư: "+t.condition.ma_vt+" - "+t.condition.ten_vt};var rpttinhgiatb=new baseRpt("tinhgiatb","tinhgiatb","Tính giá trung bình");rpttinhgiatb.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var e=(new Date).getFullYear()-10;e<(new Date).getFullYear()+10;e++)t.nams.push(e.toString())},rpttinhgiatb.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString(),t.tu_thang=(e.getMonth()+1).toString(),t.den_thang=(e.getMonth()+1).toString()};var rptpttct=new baseRpt("pttct","pttct","Phân tích theo chỉ tiêu");rptpttct.defaultCondition=function(t){var e=new Date,n=e.getFullYear(),a=e.getMonth(),i=e.getDate();t.tu_ngay=new Date(n,a,1),t.den_ngay=e,t.tu_ngay_kt=new Date(n-1,a,1),t.den_ngay_kt=new Date(n-1,a,i)};var rptformModule=new baseInput("rptform","rptform",["rptform_name","rptform_type"],"Mẫu báo cáo theo chỉ tiêu"),kbmpttctModule=new baseInput("kbmpttct","kbmpttct",["ma_so","chi_tieu"],"Khai báo mẫu phân tích theo chỉ tiêu");kbmpttctModule.defaultValues={cach_tinh:"2"};var rptdtbanletheongay=new baseRpt("dtbanletheongay","dtbanletheongay","Doanh thu bán lẻ theo ngày",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){var i=new Date(e.ngay_ct);if(_.isDate(i)){var o="/ctbanle?ma_ct=PBL,SO1&";o=o+"tu_ngay="+n("date")(i,"yyyy-MM-dd"),o=o+"&den_ngay="+n("date")(i,"yyyy-MM-dd"),o=o+"&ma_dvcs="+t.condition.ma_dvcs,o+="&isDrillDown=true",a.url(o)}}}});rptdtbanletheongay.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptdtbanletheothang=new baseRpt("dtbanletheothang","dtbanletheothang","Doanh thu bán lẻ theo tháng",{onLoading:function(t,e){for(var n=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)n.push(i.toString());t.nams=n;var o=e.$filter,r=e.$location;t.drilldown=function(e){var n=Number(e.thang),a=Number(t.condition.nam);if(n>0&&12>=n){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"tu_ngay="+o("date")(new Date(a,n-1,1),"yyyy-MM-dd"),i=i+"&den_ngay="+o("date")(new Date(a,n,0),"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",r.url(i)}}}});rptdtbanletheothang.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString()};var rptdtbanletheoquy=new baseRpt("dtbanletheoquy","dtbanletheoquy","Doanh thu bán lẻ theo quý",{onLoading:function(t,e){for(var n=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)n.push(i.toString());t.nams=n;var o=e.$filter,r=e.$location;t.drilldown=function(e){var n=Number(e.quy);if(n>0&&5>n){var a=3*n,i=a-2,c=Number(t.condition.nam),d="/ctbanle?ma_ct=PBL,SO1&";d=d+"tu_ngay="+o("date")(new Date(c,i-1,1),"yyyy-MM-dd"),d=d+"&den_ngay="+o("date")(new Date(c,a,0),"yyyy-MM-dd"),d=d+"&ma_dvcs="+t.condition.ma_dvcs,d+="&isDrillDown=true",r.url(d)}}}});rptdtbanletheoquy.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString()};var rptdtbanletheonam=new baseRpt("dtbanletheonam","dtbanletheonam","Doanh thu bán lẻ theo năm",{onLoading:function(t,e){for(var n=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)n.push(i.toString());t.nams=n;var o=e.$filter,r=e.$location;t.drilldown=function(e){var n=Number(e.nam);if(n>=t.condition.tu_nam&&n<=t.condition.den_nam){var a="/ctbanle?ma_ct=PBL,SO1&";a=a+"tu_ngay="+o("date")(new Date(n,0,1),"yyyy-MM-dd"),a=a+"&den_ngay="+o("date")(new Date(n,12,0),"yyyy-MM-dd"),a=a+"&ma_dvcs="+t.condition.ma_dvcs,a+="&isDrillDown=true",r.url(a)}}}});rptdtbanletheonam.defaultCondition=function(t){var e=new Date;t.tu_nam=(e.getFullYear()-1).toString(),t.den_nam=e.getFullYear().toString()};var rptdtbanletheovt=new baseRpt("dtbanletheovt","dtbanletheovt","Doanh thu bán lẻ theo sản phẩm",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_vt){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"ma_vt="+e.ma_vt,i=i+"&ten_vt="+e.ten_vt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptdtbanletheovt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptdtbanletheokh=new baseRpt("dtbanletheokh","dtbanletheokh","Doanh thu bán lẻ theo khách hàng",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_kh){var i="/ctbanle?ma_ct=PBL,SO1&ma_kh="+e.ma_kh;i=i+"&ten_kh="+e.ten_kh,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptdtbanletheokh.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptdtbanletheonv=new baseRpt("dtbanletheonv","dtbanletheonv","Doanh thu bán lẻ theo nhân viên",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.user_created){var i="/ctbanle?ma_ct=PBL,SO1&user_created="+e.user_created;i=i+"&name="+e.name,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptdtbanletheonv.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptctbanle=new baseRpt("ctbanle","ctbanle","Chi tiết bán hàng");rptctbanle.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(Date.UTC(e.getFullYear(),e.getMonth(),1)),t.den_ngay=e};var rpthangbanbitralai=new baseRpt("hangbanbitralai","hangbanbitralai","Tổng hợp hàng bán bị trả lại",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_vt){var i="/cthangbanbitralai?";i=i+"ma_vt="+e.ma_vt,i=i+"&ten_vt="+e.ten_vt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpthangbanbitralai.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptcthangbanbitralai=new baseRpt("cthangbanbitralai","cthangbanbitralai","Chi tiết hàng bán bị trả lại");rptcthangbanbitralai.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(Date.UTC(e.getFullYear(),e.getMonth(),1)),t.den_ngay=e};var rpttonghopbanhang=new baseRpt("tonghopbanhang","tonghopbanhang","Tổng hợp bán hàng",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_vt){var i="/ctbanle?";i=i+"ma_vt="+e.ma_vt,i=i+"&ten_vt="+e.ten_vt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpttonghopbanhang.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptchitietthutientheohoadon=new baseRpt("chitietthutientheohoadon","chitietthutientheohoadon","Chi tiết thu tiền theo hóa đơn",{onLoading:function(t,e){e.$filter,e.$location}});rptchitietthutientheohoadon.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptchitietthutientheohoadon.useExcelTemplate=!0;var rptchitietchitientheohoadon=new baseRpt("chitietchitientheohoadon","chitietchitientheohoadon","Chi tiết chi tiền theo hóa đơn",{onLoading:function(t,e){e.$filter,e.$location}});rptchitietchitientheohoadon.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rptchitietchitientheohoadon.useExcelTemplate=!0;var rpthoadonbanhantheohantt=new baseRpt("hoadonbanhangtheohantt","hoadonbanhangtheohantt","Hóa đơn bán hàng theo hạn thanh toan",{onLoading:function(t,e){e.$filter,e.$location
}});rpthoadonbanhantheohantt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rpthoadonbanhantheohantt.useExcelTemplate=!0;var rptphanbothutienchohoadon=new baseRpt("phanbothutienchohoadon","phanbothutienchohoadon","Phân bổ tiền thu cho các hóa đơn",{onLoading:function(t,e){e.$filter,e.$location;t.select=function(n){t.current_pt=n,t.data.forEach(function(t){t.selected=!1}),n.selected=!0,t.invoices=[];var a=server_url+"/api/"+id_app+"/phanbothutienchohoadon/invoices?id_ct="+n._id+"&ma_kh="+n.ma_kh;e.$http.get(a).success(function(e){t.invoices=e}).error(function(){alert("Không thể lấy hóa đơn của khách hàng này")})},t.tinhthanhtoanqd=function(e){e.thanh_toan_qd=Math.round(e.tien_nt_alloc*t.current_pt.ty_gia/e.ty_gia_hd,2)},t.phanbotudong=function(){var n=0,a=t.current_pt.t_tien_nt;t.invoices.forEach(function(e){e.tien_nt_bk=e.tien_nt,e.con_lai_nt<a?(e.tien_nt_alloc=e.con_lai_nt,e.tien_nt=e.con_lai_nt):(e.tien_nt_alloc=a,e.tien_nt=a),e.tien=e.tien_nt_alloc*t.current_pt.ty_gia,e.thanh_toan_qd=Math.round(e.tien/e.ty_gia_hd,2),n+=e.tien_nt_alloc,a-=e.tien_nt_alloc,e.id_ct=t.current_pt._id,e.ngay_ct=t.current_pt.ngay_ct,e.so_ct=t.current_pt.so_ct,e.ma_ct="PT1",e.ma_nt=t.current_pt.ma_nt,e.ty_gia=t.current_pt.ty_gia,e.status=t.current_pt.status,e.tk_no=t.current_pt.tk_no});var i=server_url+"/api/"+id_app+"/phanbothutienchohoadon/save";e.$http.post(i,t.invoices).success(function(){t.current_pt.da_phan_bo_nt=n,t.current_pt.con_lai_nt=a}).error(function(e){t.invoices.forEach(function(t){t.tien_nt=t.tien_nt_bk}),alert("Không thể lưu phân bổ này\n"+e)})},t.allocate4invoice=function(n){if(n.tien_nt_alloc>n.con_lai_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền còn phải thu");if(n.tien_nt_alloc>t.current_pt.con_lai_nt+n.tien_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền chưa phân bổ của phiếu thu hiện tại");n.id_ct=t.current_pt._id,n.ngay_ct=t.current_pt.ngay_ct,n.so_ct=t.current_pt.so_ct,n.ma_ct="PT1",n.ma_nt=t.current_pt.ma_nt,n.ty_gia=t.current_pt.ty_gia,n.status=t.current_pt.status,n.tk_no=t.current_pt.tk_no,n.tien_nt_bk=n.tien_nt,n.tien_nt=n.tien_nt_alloc,n.tien=n.tien_nt_alloc*n.ty_gia;var a=server_url+"/api/"+id_app+"/phanbothutienchohoadon/save";e.$http.post(a,[n]).success(function(){t.current_pt.da_phan_bo_nt=t.current_pt.da_phan_bo_nt+(n.tien_nt-n.tien_nt_bk),t.current_pt.con_lai_nt=t.current_pt.t_tien_nt-t.current_pt.da_phan_bo_nt}).error(function(t){n.tien_nt=n.tien_nt_bk,alert("Không thể lưu phân bổ này\n"+t)})}},onStartGetData:function(t,e){t.invoices=[],e()}});rptphanbothutienchohoadon.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptctmuahang=new baseRpt("ctmuahang","ctmuahang","Chi tiết mua hàng");rptctmuahang.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(Date.UTC(e.getFullYear(),e.getMonth(),1)),t.den_ngay=e};var rpttonghopmuahang=new baseRpt("tonghopmuahang","tonghopmuahang","Tổng hợp mua hàng",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_vt){var i="/ctmuahang?";i=i+"ma_vt="+e.ma_vt,i=i+"&ten_vt="+e.ten_vt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpttonghopmuahang.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rpttonghoptralaihang=new baseRpt("tonghoptralaihang","tonghoptralaihang","Tổng hợp trả lại nhà cung cấp",{onLoading:function(t,e){var n=e.$filter,a=e.$location;t.drilldown=function(e){if(e.ma_vt){var i="/cttralaihang?";i=i+"ma_vt="+e.ma_vt,i=i+"&ten_vt="+e.ten_vt,i=i+"&tu_ngay="+n("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+n("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpttonghoptralaihang.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var rptcttralaihang=new baseRpt("cttralaihang","cttralaihang","Chi tiết trả lại nhà cung cấp");rptcttralaihang.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(Date.UTC(e.getFullYear(),e.getMonth(),1)),t.den_ngay=e};var rpthoadonbanhantheohantt=new baseRpt("hoadonmuahangtheohantt","hoadonmuahangtheohantt","Hóa đơn mua hàng theo hạn thanh toan",{onLoading:function(t,e){e.$filter,e.$location}});rpthoadonbanhantheohantt.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e},rpthoadonbanhantheohantt.useExcelTemplate=!0;var rptphanbochitienchohoadon=new baseRpt("phanbochitienchohoadon","phanbochitienchohoadon","Phân bổ tiền chi cho các hóa đơn",{onLoading:function(t,e){e.$filter,e.$location;t.select=function(n){t.current_pt=n,t.data.forEach(function(t){t.selected=!1}),n.selected=!0,t.invoices=[];var a=server_url+"/api/"+id_app+"/phanbochitienchohoadon/invoices?id_ct="+n._id+"&ma_kh="+n.ma_kh;e.$http.get(a).success(function(e){t.invoices=e}).error(function(){alert("Không thể lấy hóa đơn của khách hàng này")})},t.tinhthanhtoanqd=function(e){e.thanh_toan_qd=Math.round(e.tien_nt_alloc*t.current_pt.ty_gia/e.ty_gia_hd,2)},t.phanbotudong=function(){var n=0,a=t.current_pt.t_tien_nt;t.invoices.forEach(function(e){e.tien_nt_bk=e.tien_nt,e.con_lai_nt<a?(e.tien_nt_alloc=e.con_lai_nt,e.tien_nt=e.con_lai_nt):(e.tien_nt_alloc=a,e.tien_nt=a),e.tien=e.tien_nt_alloc*t.current_pt.ty_gia,e.thanh_toan_qd=Math.round(e.tien/e.ty_gia_hd,2),n+=e.tien_nt_alloc,a-=e.tien_nt_alloc,e.id_ct=t.current_pt._id,e.ngay_ct=t.current_pt.ngay_ct,e.so_ct=t.current_pt.so_ct,e.ma_ct="PC1",e.ma_nt=t.current_pt.ma_nt,e.ty_gia=t.current_pt.ty_gia,e.status=t.current_pt.status,e.tk_co=t.current_pt.tk_co});var i=server_url+"/api/"+id_app+"/phanbochitienchohoadon/save";e.$http.post(i,t.invoices).success(function(){t.current_pt.da_phan_bo_nt=n,t.current_pt.con_lai_nt=a}).error(function(e){t.invoices.forEach(function(t){t.tien_nt=t.tien_nt_bk}),alert("Không thể lưu phân bổ này\n"+e)})},t.allocate4invoice=function(n){if(n.tien_nt_alloc>n.con_lai_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền còn phải chi");if(n.tien_nt_alloc>t.current_pt.con_lai_nt+n.tien_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền chưa phân bổ của phiếu chi hiện tại");n.id_ct=t.current_pt._id,n.ngay_ct=t.current_pt.ngay_ct,n.so_ct=t.current_pt.so_ct,n.ma_ct="PC1",n.ma_nt=t.current_pt.ma_nt,n.ty_gia=t.current_pt.ty_gia,n.status=t.current_pt.status,n.tk_co=t.current_pt.tk_co,n.tien_nt_bk=n.tien_nt,n.tien_nt=n.tien_nt_alloc,n.tien=n.tien_nt_alloc*n.ty_gia;var a=server_url+"/api/"+id_app+"/phanbochitienchohoadon/save";e.$http.post(a,[n]).success(function(){t.current_pt.da_phan_bo_nt=t.current_pt.da_phan_bo_nt+(n.tien_nt-n.tien_nt_bk),t.current_pt.con_lai_nt=t.current_pt.t_tien_nt-t.current_pt.da_phan_bo_nt}).error(function(t){n.tien_nt=n.tien_nt_bk,alert("Không thể lưu phân bổ này\n"+t)})}},onStartGetData:function(t,e){t.invoices=[],e()}});rptphanbochitienchohoadon.defaultCondition=function(t){var e=new Date;t.tu_ngay=new Date(e.getFullYear(),e.getMonth(),1),t.den_ngay=e};var dmbpModule=new baseInput("dmbp","dmbp",["ma_bp","ten_bp"],"Danh mục bộ phận"),dmdtModule=new baseInput("dmdt","dmdt",["ma_dt","ten_dt"],"Vụ việc, dự án, công trình",{has_view:!0,onAdd:function(t,e){t.data.phu_trach=e.$rootScope.user.email,t.data.progress=0},onLoading:function(t,e){t.advCondition={},e.$rootScope.nextTick(function(){e.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'PROJECT'}").success(function(e){t.groups=e})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var e=[];t.progresses.forEach(function(t){t.sel&&e.push(t.value)}),t.filter.progress={$in:e},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_dt?t.filter.nh_dt=t.nh_dt:delete t.filter.nh_dt;var n,a,i=new Date,o=t.time;if("d"==o&&(n=new Date,a=new Date),"w"==o)var r=i.getDate()-i.getDay()+1,n=new Date(i.setDate(r)),a=new Date(i.setDate(n.getDate()+6));if("m"==o&&(n=i,n.setDate(1),a=new Date(n.getFullYear(),n.getMonth()+1,0)),"3m"==o){var c=i.getMonth(),d=1;d=3>c?0:6>c?3:6>c?6:9,n=new Date(i.getFullYear(),d,1),a=new Date(i.getFullYear(),d+3,0)}"y"==o&&(n=new Date(i.getFullYear(),0,1),a=new Date(i.getFullYear(),11,31)),n&&a?(n.setHours(0),n.setMinutes(0),n.setSeconds(0),a.setHours(23),a.setMinutes(59),a.setSeconds(0),t.filter.date_created={$gte:n,$lte:a}):delete t.filter.date_created,t.advCondition.ten_dt?t.filter.$or=[{ten_dt:{$regex:t.advCondition.ten_dt,$options:"i"}},{ma_dt:{$regex:t.advCondition.ten_dt,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_dt,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.search()}},t.reportByTime=function(e){t.time=e,t.searchAVG()},t.searchPhuTrach=function(e){t.phu_trach=e.email,t.searchAVG()},t.searchGroup=function(e){t.nh_dt=e._id,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,n){var a={};_.extend(a,t),a.progress=n,e.service.update(id_app,a._id,a).success(function(e){_.extend(t,e)}).error(function(t){t&&alert(t)})},t.enter=function(e){13==e.keyCode&&t.searchAVG()}},onView:function(t,e){t.addContact=function(){lienheModule.quickadd(e.$modal,function(e){e.collection_name="lienhe",t.addLink(e,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(e.$modal,function(n){n.collection_name="dmkh",t.addLink(n,"ten_kh"),t.data.id_kh||(t.data.id_kh=n._id,e.service.update(id_app,t.data._id,t.data).success(function(e){_.extend(t.data,e)}))})}}});dmdtModule.module.directive("dmdt",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/dmdt/templates/directive.html",controller:["$scope","$http","$window","$location","$modal","appInfo",function($scope,$http,$window,$location,$modal,appInfo){appInfo.info("dmdt",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="dmdt:'ten_dt'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.list=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var e=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(e).then(function(t){var e=t.data;return e})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var e=_.find($scope.list,function(e){return e.obj._id==t._id});if(!e){var n={};n.id_a=$scope.link._id,n.collection_a=$scope.collection,n.collection_b=t.collection_name,n.collection_obj=t.collection_name,n.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,n).success(function(e){_.extend(n,e),n.obj=t,n.title=t.title,$scope.list.push(n)}).error(function(t){t&&$window.alert(t)})}},$scope.unLink=function(t){var e=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(e).success(function(){$scope.list=_.reject($scope.list,function(e){return e._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),dmdtModule.quickadd($modal,function(t){t.collection_name="dmdt",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var e="dmdt/view/"+t._id+"?redirect="+$location.url();$location.url(e)},$scope.delete=function(t){$window.confirm("Bạn có chắc chắn xóa không?")&&$http.delete(server_url+"/api/"+id_app+"/dmdt/"+t._id).success(function(){$scope.list=_.reject($scope.list,function(e){return e._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.edit=function(t){dmdtModule.quickedit($modal,t._id,function(e){_.extend(t,e)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,e,n){n.link&&n.collection||console.error("dmdt directive require attributes:link,collection")}}});var dmloaitsModule=new baseInput("dmloaits","dmloaits",["ma_loai_ts","ten_loai_ts"],"Danh mục loại tài sản"),dmtanggiamtsModule=new baseInput("dmtanggiamts","dmtanggiamts",["ma_tang_giam_ts","ten_tang_giam_ts"],"Danh mục tăng giảm tài sản");dmtanggiamtsModule.defaultValues={kieu:"1"};var dmnguonvonModule=new baseInput("dmnguonvon","dmnguonvon",["ma_nguon_von","ten_nguon_von"],"Danh mục nguồn vốn"),qtsModule=new baseVoucher("qts","qts",["so_the_ts","ten_ts"],"Khai báo tài sản cố định");qtsModule.defaultValues={so_ky_kh:0,lam_tron_kh:0,ngay_tang:new Date,pp_tinh_kh:"1",ma_gd:"1"},qtsModule.defaultValues4Detail={nguyen_gia:0,gia_tri_da_kh:0,gia_tri_con_lai:0,gia_tri_kh_ky:0,tinh_kh_gia_tri_con_lai:!0},qtsModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",ten_ts:"",so_the_ts:""},qtsModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},so_the_ts:{$regex:t.vcondition.so_the_ts,$options:"i"},ten_ts:{$regex:t.vcondition.ten_ts,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},qtsModule.watchDetail=function(t){t.$watch("dt_current.nguyen_gia",function(e,n){e&&e!=n&&(t.dt_current.gia_tri_con_lai=t.dt_current.nguyen_gia-t.dt_current.gia_tri_da_kh,t.ngMasterData.tinh_kh_gia_tri_con_lai||(t.dt_current.gia_tri_kh_ky=Math.round(t.dt_current.nguyen_gia/t.ngMasterData.so_ky_kh,0)))}),t.$watch("dt_current.gia_tri_da_kh",function(e,n){e&&e!=n&&(t.dt_current.gia_tri_con_lai=t.dt_current.nguyen_gia-t.dt_current.gia_tri_da_kh)}),t.$watch("dt_current.gia_tri_con_lai",function(e,n){e&&e!=n&&0!=t.ngMasterData.so_ky_kh&&t.ngMasterData.tinh_kh_gia_tri_con_lai&&(t.dt_current.gia_tri_kh_ky=Math.round(t.dt_current.gia_tri_con_lai/t.ngMasterData.so_ky_kh,0))})},qtsModule.watchMaster=function(t){t.$watch("data.tinh_kh_gia_tri_con_lai",function(e){t.data.details.forEach(e?function(e){0!=t.data.so_ky_kh&&(e.gia_tri_kh_ky=Math.round(e.gia_tri_con_lai/t.data.so_ky_kh,0))}:function(e){0!=t.data.so_ky_kh&&(e.gia_tri_kh_ky=Math.round(e.nguyen_gia/t.data.so_ky_kh,0))})}),t.$watch("data.so_ky_kh",function(e){e&&t.data.details.forEach(t.data.tinh_kh_gia_tri_con_lai?function(e){0!=t.data.so_ky_kh&&(e.gia_tri_kh_ky=Math.round(e.gia_tri_con_lai/t.data.so_ky_kh,0))}:function(e){0!=t.data.so_ky_kh&&(e.gia_tri_kh_ky=Math.round(e.nguyen_gia/t.data.so_ky_kh,0))})})};var calc_qtsdieuchinh=function(t){t.$watch("data.nguyen_gia",function(e){void 0!=e&&null!=e&&(t.data.gia_tri_con_lai=t.data.nguyen_gia-t.data.gia_tri_da_kh)}),t.$watch("data.gia_tri_da_kh",function(e){void 0!=e&&null!=e&&(t.data.gia_tri_con_lai=t.data.nguyen_gia-t.data.gia_tri_da_kh)}),t.$watch("data.gia_tri_con_lai",function(e){void 0!=e&&null!=e&&(t.data.gia_tri_kh_ky=0!=t.data.so_ky_kh?Math.round(t.data.gia_tri_con_lai/t.data.so_ky_kh,0):0)}),t.$watch("data.so_ky_kh",function(e){void 0!=e&&null!=e&&(t.data.gia_tri_kh_ky=0!=t.data.so_ky_kh?Math.round(t.data.gia_tri_con_lai/t.data.so_ky_kh,0):0)})},qtsdieuchinhModule=new baseInput("qtsdieuchinh","qtsdieuchinh",["so_the_ts","so_ct"],"Điều chỉnh giá trị tài sản",{onAdd:function(t){calc_qtsdieuchinh(t)},onEdit:function(t){calc_qtsdieuchinh(t)}});qtsdieuchinhModule.defaultValues={so_ky_kh:0,ky:(new Date).getMonth()+1,nam:(new Date).getFullYear(),ngay_ct:new Date,ngay_ct:new Date,nguyen_gia:0,gia_tri_da_kh:0,gia_tri_con_lai:0,gia_tri_kh_ky:0};var rpttinhkhauhaots=new baseRpt("tinhkhauhaots","tinhkhauhaots","Tính khấu hao tài sản");rpttinhkhauhaots.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var e=(new Date).getFullYear()-10;e<(new Date).getFullYear()+10;e++)t.nams.push(e.toString())},rpttinhkhauhaots.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString(),t.thang=(e.getMonth()+1).toString(),t.tinh_kh_theo_ngay=!0};var hspbtsModule=new baseInput("hspbts","hspbts",["so_the_ts","ma_bp"],"Khai báo hệ số phân bổ tài sản");hspbtsModule.loading=function(t){var e=(new Date).getFullYear();t.nams=[];for(var n=e-10;e+10>n;n++)t.nams.push(n);t.condition={nam:e,thang:(new Date).getMonth()+1}},hspbtsModule.defaultValues={he_so:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()},hspbtsModule.init=function(t){t.thangs=[1,2,3,4,5,6,7,8,9,10,11,12],t.nams=[];for(var e=new Date,n=e.getFullYear()-10;n<e.getFullYear()+10;n++)t.nams.push(n)};var dckhauhaotsModule=new baseInput("dckhauhaots","dckhauhaots",["so_the_ts"],"Điều chỉnh khấu hao tài sản");dckhauhaotsModule.loading=function(t){var e=(new Date).getFullYear();t.nams=[];for(var n=e-10;e+10>n;n++)t.nams.push(n);t.condition={nam:e,thang:(new Date).getMonth()+1}};var pkhModule=new baseVoucher("pkh","pkh",[],"Phiếu khấu hao tài sản");pkhModule.defaultValues={},pkhModule.defaultValues4Detail={tien_nt:0,tien:0},pkhModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkhModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkhModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(e){void 0!=e&&t.status.isOpened&&(t.dt_current.tien=Math.round(e*t.ngMasterData.ty_gia,0))}),t.createBT=function(){_.isDate(t.ngMasterData.ngay_ct)||(t.ngMasterData.ngay_ct=new Date(t.ngMasterData.ngay_ct)),t.ngMasterData.details=[];var e=server_url+"/api/"+id_app+"/getkhauhao?id_ct="+t.ngMasterData._id;e+="&thang="+t.ngMasterData.ngay_ct.getMonth().toString(),e+="&nam="+t.ngMasterData.ngay_ct.getFullYear().toString(),t.ngMasterData.kc_dvcs&&(e=e+"&ma_dvcs="+t.ngMasterData.ma_dvcs),t.$http.get(e).success(function(e){t.messageError=void 0,t.ngMasterData.details=e}).error(function(e){t.alertType="alert alert-danger",t.messageError=e})}},pkhModule.watchMaster=function(t){t.$watch("data.ty_gia",function(e){t.data&&void 0!=e&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*e,0)})})};var rptbangtinhkhauhao=new baseRpt("bangtinhkhauhao","bangtinhkhauhao","Bảng tính khấu hao");rptbangtinhkhauhao.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var e=(new Date).getFullYear()-10;e<(new Date).getFullYear()+10;e++)t.nams.push(e.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptbangtinhkhauhao.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString(),t.thang=(e.getMonth()+1).toString(),t.ma_gd="1"};var rptsotaisan=new baseRpt("sotaisan","sotaisan","Sổ tài sản");rptsotaisan.init=function(t){t.nams=[];for(var e=(new Date).getFullYear()-10;e<(new Date).getFullYear()+10;e++)t.nams.push(e.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptsotaisan.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString(),t.ma_gd="1"};var rptchitiettaisan=new baseRpt("chitiettaisan","chitiettaisan","Sổ Chi tiết tài sản");rptchitiettaisan.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var e=(new Date).getFullYear()-10;e<(new Date).getFullYear()+10;e++)t.nams.push(e.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptchitiettaisan.defaultCondition=function(t){var e=new Date;t.nam=e.getFullYear().toString(),t.ma_gd="1",t.thang=e.getMonth()+1};var id_app,access_token,paths_not_require_id_app=["code","app","colleague","notification","message","profile","users","comment","versioninfo","admin"],accApp=angular.module("accApp",modulesD);accApp.config(["$provide","$httpProvider",function(t,e){var n=function(t){var e,n;window.getSelection?(e=window.getSelection(),e.getRangeAt&&e.rangeCount&&(n=e.getRangeAt(0),n.deleteContents(),n.insertNode(document.createTextNode(t)))):document.selection&&document.selection.createRange&&(document.selection.createRange().text=t)};t.decorator("taOptions",["taRegisterTool","$delegate",function(t,e){return t("insertName",{buttontext:"Tên",action:function(){return n("{{receiver.name}}")}}),t("insertAddress",{buttontext:"Email",action:function(){return n("{{receiver.address}}")}}),e.toolbar[1].push("insertName"),e.toolbar[1].push("insertAddress"),e}]),t.factory("myHttpInterceptor",["$q","$rootScope","$location",function(t,e,n){return{request:function(t){return t},requestError:function(e){return t.reject(e)},response:function(t){return t},responseEror:function(a){return 401===a.status?(e.isLogined=!1,n.url("/login")):(0==a.status||500==a.status)&&e.error("Không kết nối được với máy chủ"),t.reject(a)}}}]),e.interceptors.push("myHttpInterceptor")}]),accApp.constant("_",window._),accApp.constant("async",window.async),accApp.factory("api",["$http","$localStorage","$rootScope",function(t,e,n){return{init:function(a){a||(a=e.get("token")),a?(n.isLogined=!0,n.token=a):n.isLogined=!1,access_token=a,t.defaults.headers.common["X-Access-Token"]=a}}}]),accApp.run(["$rootScope","api","$window","user","app","$location","$http","appInfo","$timeout",function(t,e,n,a,i,o,r,c,d){t.isLogined=!1;var l=1,u=4,s="WINDOWS";if(t.program_name="ỨNG DỤNG QUẢN LÝ",t.program_version=l+"."+u,c.asDesktop()){var p=server_url+"/public/versioninfo?q={os:'"+s+"',app:'UDQL'}";r.get(p).success(function(t){if(t.length>0){var e=t[0];(l<e.major||l===e.major&&u<e.minor)&&confirm("Có một bản cập nhật cho chương trình này. Bạn có muốn tải về không?")&&n.open(e.url)}})}t.online=!0,n.addEventListener("offline",function(){t.$apply(function(){t.online=!1})},!1),n.addEventListener("online",function(){t.$apply(function(){t.online=!0})},!1),t.nextTick=function(t){d(t,0)},t.server_url=server_url,t.$watch("app_info",function(e){e&&(t.getTask(),t.crm_input_visible=!1,t.crm_report_visible=!1,t.acc_visible=!1,t.commands={},c.commands(t.id_app),t.members=[{email:t.app_info.user_created,name:t.app_info.user_created.split("@")[0]}],t.app_info.participants.forEach(function(e){t.members.push({email:e.email,name:e.name})}))},!0),t.$watch(function(){return o.path()},function(e){if(e=e.toLowerCase().split("/"),e.length<=1||"dashboard"==e[1]||""==e[1])t.menuActive="DASHBOARD";else{if(t.commands){var n=_.find(t.commands.modules,function(t){return t.path==e[1]});n&&(t.menuActive=n.group)}("login"==e[1]||"logout"==e[1])&&(t.messages_count=0,t.notifies_count=0,t.task_count=0)}}),t.$watch("commands",function(e){if(e){var n=o.path().toLowerCase().split("/");if(n.length<=1)t.menuActive="DASHBOARD";else{var a=_.find(t.commands.modules,function(t){return t.path==n[1]});a&&(t.menuActive=a.group)}}},!0),t.openPath=function(e,n){t.menuActive=n,o.url(e)},t.searchword="",t.searchAllKeyup=function(t,e){13===t.keyCode&&e&&o.url("search/"+e)},e.init(),Metronic.init(),Layout.init()}]),accApp.directive("format",["$filter",function(t){return{require:"?ngModel",scope:{ngModel:"="},controller:["$scope",function(t){t.$watch("ngModel",function(e){void 0==e&&(t.ngModel=0)})}],link:function(e,n,a,i){i&&(i.$formatters.unshift(function(){return(void 0==i.$modelValue||""==i.$modelValue)&&(i.$modelValue=0),t(a.format)(i.$modelValue)}),i.$parsers.unshift(function(e){(void 0==e||""==e)&&(e="0");var a=e.replace(/[^\d|\-+|,+]/g,""),i=a.replace(/,/g,"."),o=t("number")(i);a.indexOf(",")==a.length-1&&(o+=","),n.val(o);var r=Number(i);return void 0==r&&(r=0),r}))}}}]),accApp.directive("ngData",function(){return{controller:["$scope",function(){}]}}),accApp.directive("ngSum",function(){return{scope:{ngSum:"@",ngData:"=",ngModel:"="},link:function(t){t.$watch("ngData",function(e){var n=0;e&&angular.forEach(e,function(e){var a=Number(e[t.ngSum]);n+=a}),t.ngModel=n},!0)}}}),accApp.directive("ngDatepicker",["$window",function(){return{restrict:"E",require:"^ngModel",scope:{ngModel:"=",ngChange:"&"},templateUrl:"templates/sys/ng-datepicker.html",controller:["$scope","$filter",function(t){t.$watch("ngModel",function(e,n){e&&!_.isDate(e)&&(t.ngModel=new Date(e)),t.ngChange&&e!=n&&t.ngChange()})}],link:function(){}}}]),accApp.directive("ngRequiredCn",["dmtk",function(t){var e=!1,n=function(t,n){1!=e||n.$viewValue&&""!=n.$viewValue?n.$setValidity("ngRequiredCn",!0):n.$setValidity("ngRequiredCn",!1)};return{restrict:"A",require:"?ngModel",link:function(a,i,o,r){a.$watch(o.ngRequiredCn,function(i){i?a.tks?(e=_.filter(a.tks,function(t){return t.tk==i&&t.tk_cn}).length>0,n(a,r)):t.list(id_app,{tk:i,tk_cn:!0},"tk_cn").success(function(t){e=0==t.length?!1:!0,n(a,r)}):(e=!1,n(a,r))}),a.$watch(o.ngModel,function(){n(a,r)})}}}]),accApp.directive("ngRequiredQ",[function(){return{restrict:"A",require:"?ngModel",link:function(t,e,n,a){t.$watch(n.ngRequiredQ,function(t){t?a.$setValidity("ngRequired",!1):a.$setValidity("ngRequired",!0)})}}}]),accApp.directive("topMenu",[function(){return{restrict:"E",templateUrl:"templates/sys/top-menu.html",controller:["$scope","$rootScope","colleague","$window","user","app","$location","$http","appInfo","$timeout",function(t,e,n,a,i,o,r,c){e.notifies_count=0,e.messages_count=0,e.task_count=0,e.getMessages=function(t){e.msgs=[{content:"Đang lấy dữ liệu..."}],i.getMessagesColleagues(function(n,a){n?(e.messages_count=0,e.msgs=[{content:"Không thể lấy dữ liệu từ server"}]):(e.msgs=a,e.messages_count=a.length,t&&t(a))})},e.getInvitations=function(t){e.notifies={notifications:[{content:"Đang lấy dữ liệu..."}]},i.getNotifies(function(n,a){n?(e.notifies_count=0,e.notifies={notifications:[{content:"Không thể lấy dữ liệu từ server"}]}):(e.notifies=a,e.notifies_count=a.colls.length+a.apps.length+a.notifications.length,t&&t(a))})},e.getTask=function(){e.tasks=[{ten_cv:"Đang lấy dữ liệu..."}];var t=new Date,n={progress:{$ne:2},start_date:{$lt:t},status:!0,phu_trach:e.user.email};c.get(server_url+"/api/"+id_app+"/task?fields=ten_cv,percent,progress,priority&q="+JSON.stringify(n)).success(function(t){e.tasks=t,e.task_count=t.length}).error(function(){e.tasks=[{ten_cv:"Không thể lấy dữ liệu từ server"}]})},e.acceptInvitor=function(t,e){"colleague"==t&&n.active(e).success(function(){(0==r.url().indexOf("/colleague")||0==r.url().indexOf("colleague"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")}),"app"==t&&o.active(e).success(function(){(0==r.url().indexOf("/app")||0==r.url().indexOf("app"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")})},e.notAcceptInvitor=function(t,e){"colleague"==t&&n.notaccept(e).success(function(){(0==r.url().indexOf("/colleague")||0==r.url().indexOf("colleague"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")}),"app"==t&&o.notaccept(e).success(function(){(0==r.url().indexOf("/app")||0==r.url().indexOf("app"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")})}}]}}]),accApp.directive("horizantalMenu",[function(){return{restrict:"E",templateUrl:"templates/sys/horizantal-menu.html"}}]),accApp.directive("appHeader",[function(){return{restrict:"E",templateUrl:"templates/sys/app-header.html"}}]),accApp.directive("ngPage",[function(){return{restrict:"E",templateUrl:"templates/sys/ng-page.html"}}]),accApp.directive("ngPageFx",[function(){return{restrict:"E",scope:{service:"=",list:"=",condition:"=",start:"=",pageChanged:"&"},templateUrl:"templates/sys/ng-page.html",controller:["$scope","$http","$rootScope",function(t,e,n){t.current_page=1,t.getPages=function(){t.service.load(id_app,{condition:t.condition,count:1}).success(function(e){t.total_page=Math.round(e.rows_number/t.limit,0),t.total_page<e.rows_number/t.limit&&(t.total_page+=1),0==t.total_page&&(t.total_page=1),t.pages=[];for(var n=1;n<=t.total_page;n++)t.pages.push(n)})},t.goToPage=function(a){a||(a=1),n.nextTick(function(){t.$emit("$dataChangeStart"),t.service.load(id_app,{condition:t.condition,page:a,limit:t.limit,fields:t.fields}).success(function(n){async.map(n,function(n,a){t.emailCurrentUser?e.get(server_url+"/api/follow?q={id_object:'"+n._id+"',user_created:'"+t.emailCurrentUser+"'}").success(function(t){t&&t.length>0?(n.followObject=t[0],n.follow_yn=1):n.follow_yn=0,a()}).error(function(t){n.follow_yn=0,a(t)}):a()},function(e){e&&console.log(e),t.$emit("$dataChangeSuccess"),t.current_page=a,t.pageChanged({$page:a}),t.list=n})}).error(function(){t.$emit("$dataChangeError")})})}}],link:function(t,e,n){t.total_page=1,t.pages=[1],n.hasOwnProperty("emailCurrentUser")&&(t.emailCurrentUser=n.emailCurrentUser),t.fields=n.hasOwnProperty("fields")?n.fields:"",n.hasOwnProperty("limit")&&(t.limit=n.limit),t.current_page=n.hasOwnProperty("currentPage")?Number(n.currentPage):1,t.limit||(t.limit=20),t.$watch("start",function(e){e&&(t.getPages(),t.goToPage(t.current_page),t.start=null)})}}}]),accApp.directive("stplistheader",["$location",function($location){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/list-header.html",link:function(scope,elem,attrs,contr){scope.boxSearch=attrs.hasOwnProperty("boxSearch")?attrs.boxSearch:!0,attrs.hasOwnProperty("btnadd")?(btnAdd=eval("({"+attrs.btnadd+"})"),void 0==btnAdd.show&&(btnAdd.show=!0),void 0==btnAdd.text&&(btnAdd.text="Mới"),scope.add_show=btnAdd.show,scope.add_text=btnAdd.text):(scope.add_show=!0,scope.add_text="Mới"),attrs.btndelete?(btnDelete=eval("({"+attrs.btndelete+"})"),void 0==btnDelete.show&&(btnDelete.show=!0),void 0==btnDelete.text&&(btnDelete.text="Xóa"),scope.delete_show=btnDelete.show,scope.delete_text=btnDelete.text):(scope.delete_text="Xóa",scope.delete_show=!0),attrs.btn1&&(btn1=eval("({"+attrs.btn1+"})"),scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn3_click=btn1.click)),attrs.btn2&&(btn2=eval("({"+attrs.btn2+"})"),scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)),attrs.btn3&&(btn3=eval("({"+attrs.btn3+"})"),scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)),attrs.btn4&&(btn4=eval("({"+attrs.btn4+"})"),scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)),attrs.btn5&&(btn5=eval("({"+attrs.btn5+"})"),scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)),attrs.btnimport&&(btnimport=eval("({"+attrs.btnimport+"})"),scope.import_show=!0,scope.import_text="Nhập từ Excel")}}}]),accApp.directive("listViewHeader",["$location",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/list-view-header.html",controller:["$scope","$rootScope",function(t,e){t.$watch("data",function(n){n&&(t.title_view=n[t.headerTitleField],e.title_view=t.title_view)})}],link:function(t,e,n){t.headerTitleField=n.headerTitle}}}]),accApp.directive("stpvoucherheader",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/voucher-header.html",link:function(scope,elem,attrs,control){attrs.btn1&&(btn1=eval("({"+attrs.btn1+"})"),scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)),attrs.btn2&&(btn2=eval("({"+attrs.btn2+"})"),scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)),attrs.btn3&&(btn3=eval("({"+attrs.btn3+"})"),scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)),attrs.btn4&&(btn4=eval("({"+attrs.btn4+"})"),scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)),attrs.btn5&&(btn5=eval("({"+attrs.btn5+"})"),scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)),attrs.options&&(options=eval("({"+attrs.options+"})"),scope.options_show=!0,scope.options_text=options.text)
}}}),accApp.directive("headerFormInput",function(){return{restrict:"E",templateUrl:"templates/sys/header-form-input.html",link:function(t,e,n){n.saveText&&(t.save_text=n.saveText),n.cancelText&&(t.cancel_text=n.cancelText)}}}),accApp.directive("headerDialogSelect",function(){return{restrict:"E",templateUrl:"templates/sys/header-dialog-select.html",link:function(t,e,n){t.title=n.hasOwnProperty("title")?n.title:"Danh sách",t.placeholder=n.hasOwnProperty("placeholder")?n.placeholder:"Gõ từ cần tìm..."}}}),accApp.directive("footerFormInput",function(){return{restrict:"E",templateUrl:"templates/sys/footer-form-input.html",link:function(t,e,n){n.saveText&&(t.save_text=n.saveText),n.cancelText&&(t.cancel_text=n.cancelText)}}}),accApp.directive("rptHeader",["$location",function($location){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/rpt-header.html",link:function(scope,elem,attrs,controller){attrs.kbm&&(scope.kbm_yn=!0,scope.openKbm=function(){$location.url(attrs.kbm)}),scope.btnok_text="Xem",scope.btnok_show=!0,attrs.btnok&&(btnok=eval("({"+attrs.btnok+"})"),btnok.text&&(scope.btnok_text=btnok.text),btnok.show&&(scope.btnok_show=btnok.show)),attrs.btn1&&(btn1=eval("({"+attrs.btn1+"})"),scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)),attrs.btn2&&(btn2=eval("({"+attrs.btn2+"})"),scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)),attrs.btn3&&(btn3=eval("({"+attrs.btn3+"})"),scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)),attrs.btn4&&(btn4=eval("({"+attrs.btn4+"})"),scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)),attrs.btn5&&(btn5=eval("({"+attrs.btn5+"})"),scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)),attrs.btnprint?(btnprint=eval("({"+attrs.btnprint+"})"),void 0==btnprint.show&&(btnprint.show=!0),scope.btnprint_show=btnprint.show):scope.btnprint_show=!0,attrs.btnexcel?(btnexcel=eval("({"+attrs.btnexcel+"})"),void 0==btnexcel.show&&(btnexcel.show=!0),scope.btnexcel_show=btnexcel.show):scope.btnexcel_show=!0}}}]),accApp.directive("navbarPrint",function(){return{restrict:"E",templateUrl:"templates/sys/navbar-print.html"}}),accApp.directive("ngTypeahead",["$http",function($http){return{restrict:"E",scope:{ngModel:"=",ngDisabled:"=",ngShow:"=",label:"=",onSelect:"&",fieldModel:"@",module:"@",conditionData:"="},template:function(t,e){var n="<span class='input-group'>";return n+="<input type='text'",n+=" ng-blur='blur()' ng-change='label=undefined' typeahead-on-select = 'getItem($item, $model, $label)'",e.hasOwnProperty("ngRequired")&&(n=n+" ng-required='"+e.ngRequired+"'"),e.hasOwnProperty("ngDisabled")&&(n+=" ng-disabled='ngDisabled'"),e.hasOwnProperty("ngShow")&&(n+=" ng-show='ngShow'"),n=e.hasOwnProperty("group")?n+"typeahead-min-length='3' typeahead-template-url='templates/"+e.group+"/"+e.module+"/templates/typeahead.html' ":n+"typeahead-min-length='3' typeahead-template-url='templates/lists/"+e.module+"/templates/typeahead.html' ",e.hasOwnProperty("placeholder")&&(n=n+" placeholder='"+e.placeholder+"' "),n+=" ng-model='ngModel'",n=n+" typeahead='item."+e.fieldModel+" as item."+e.fieldModel+" for item in getList($viewValue,10)' class='form-control'>",(void 0==e.showButtonList||1==e.showButtonList)&&(n+="<span class='btn input-group-addon'  ng-click='showList()'",e.hasOwnProperty("ngDisabled")&&(n+=" ng-disabled='ngDisabled'"),n+="><i class='fa fa-list'></i></span>"),n+="</span>"},controller:["$scope","$modal","$window","$interval",function($scope,$modal,$window,$interval){var module=eval("("+$scope.module+"Module)");$scope.pathService=module.server_path,$scope.fieldsSearch=module.fields_find;var list=function(t,e,n,a){if(_.contains(paths_not_require_id_app,$scope.pathService))var i=server_url+"/api/"+$scope.pathService+"?t=1";else var i=server_url+"/api/"+t+"/"+$scope.pathService+"?t=1";if(a&&(i=i+"&limit="+a),e)if(angular.isObject(e)){var o=JSON.stringify(e);i=i+"&q="+o}else i=i+"&"+e;return!n&&$scope.fields&&(n=$scope.fields),n&&(i=i+"&fields="+n),$http.get(i)};$scope.prepareCondition=function(value){var condition={};return $scope.condition&&_.extend(condition,$scope.condition),condition.$or=[],$scope.fieldsSearch.forEach(function(field){f=eval(0==field.toLowerCase().indexOf("tk")?"({"+field+":{$regex:'^"+value+"',$options:'i'}})":"({"+field+":{$regex:'"+value+"',$options:'i'}})"),condition.$or.push(f)}),condition},$scope.getList=function(t,e,n){var a=$scope.prepareCondition(t);return list(id_app,a,null,e).then(function(t){var e=t.data;return n&&n(e),e})},$scope.getItem=function(t){$scope.fieldLabel&&($scope.label=t[$scope.fieldLabel]),$scope.onSelect&&$scope.onSelect({$item:t})},$scope.blur=function(){if($scope.ngModel&&!$scope.label&&$scope.fieldLabel){var condition=eval("({"+$scope.fieldModel+":'"+$scope.ngModel+"'})");list(id_app,condition,$scope.fieldLabel).success(function(t){1==t.length?$scope.label=t[0][$scope.fieldLabel]:$scope.ngModel=void 0})}},$scope.showList=function(){$modal.open({templateUrl:"templates/"+$scope.group+"/"+$scope.module+"/templates/dialog-select.html",controller:["$scope","$modalInstance","parentScope",function(t,e,n){t.getList=function(e,a){n.getList(e,a,function(e){t.items=e})},t.keyup=function(e,n){13==e.keyCode&&n&&t.getList(n)},t.select=function(t){n.ngModel=t[n.fieldModel],n.fieldLabel&&(n.label=t[n.fieldLabel]),n.onSelect&&n.onSelect({$item:t}),e.close()},t.cancel=function(){e.dismiss("cancel")},t.openList=function(){var t="#/"+n.module;$window.open(t,"Danh mục","width="+$window.innerWidth.toString()+",height=400"),e.dismiss("cancel")},t.quickadd=function(){module.quickadd($modal,function(t){n.ngModel=t[n.fieldModel],n.fieldLabel&&(n.label=t[n.fieldLabel])},n.defaultValues),e.dismiss("cancel")},t.getList("",10)}],size:"lg",resolve:{parentScope:function(){return $scope}}})}}],link:function(scope,elem,attrs,controller){var conditionData={};scope.conditionData&&(conditionData=scope.conditionData),attrs.hasOwnProperty("condition")&&(scope.condition=eval("({"+attrs.condition+"})")),attrs.hasOwnProperty("fields")&&(scope.fields=attrs.fields),attrs.hasOwnProperty("fieldLabel")&&(scope.fieldLabel=attrs.fieldLabel),scope.defaultValues=attrs.hasOwnProperty("defaultValues")?eval("({"+attrs.defaultValues+"})"):{},scope.group=attrs.hasOwnProperty("group")?attrs.group:"lists",scope.$watch("ngModel",function(){scope.ngModel||(scope.label="")})}}}]),accApp.factory("$cache_lists",function(){return{}}),accApp.directive("ngSelector",["$http","$cache_lists",function($http,$cache){return{restrict:"E",scope:{ngModel:"=",ngChange:"&",onSelect:"&",ngDisabled:"=",module:"@",fields:"@",fieldModel:"@",fieldLabel:"@",conditionData:"="},template:function(elem,attrs){var html="";if(attrs.hasOwnProperty("button")){var button=eval("({"+attrs.button+"})");button.class||(button.class="btn btn-default"),button.text||(button.text="..."),html=html+"<a class='"+button.class+"'  ng-click='showList()'>"+button.text+"</a>"}else html="<span>",(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(html="<span class='input-group'>"),html+="<select ng-model='ngModel' ng-disabled ='ngDisabled'  ",html=attrs.hasOwnProperty("options")?html+' ng-options="'+attrs.options+'"':attrs.hasOwnProperty("showCode")?html+' ng-options="item.'+attrs.fieldModel+" as item."+attrs.fieldModel+" + ' - ' +  item."+attrs.fieldLabel+'  for item in items" ':html+' ng-options="item.'+attrs.fieldModel+" as item."+attrs.fieldLabel+'  for item in items" ',attrs.hasOwnProperty("multiple")&&(html+=" multiple"),html+=" class='form-control'></select>",(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(html+="<span class='btn input-group-addon'  ng-click='showList()'",attrs.hasOwnProperty("ngDisabled")&&(html+=" ng-disabled='ngDisabled'"),html+="><i class='fa fa-list'></i></span>"),html+="</span>";return html},controller:["$scope","$modal","$window","$interval",function($scope,$modal,$window,$interval){var module=eval("("+$scope.module+"Module)");$scope.pathService=module.server_path,$scope.fieldsSearch=module.fields_find,$scope.$watch("ngModel",function(t){if(t&&$scope.items){var e=_.find($scope.items,function(e){return e[$scope.fieldModel]==t});$scope.ngChange({$item:e}),$scope.onSelect&&$scope.onSelect({$item:e})}else $scope.ngChange({$item:null})}),$scope.list=function(t,e,n,a){if(_.contains(paths_not_require_id_app,$scope.pathService))var i=server_url+"/api/"+$scope.pathService+"?t=1";else var i=server_url+"/api/"+t+"/"+$scope.pathService+"?t=1";if(a&&(i=i+"&limit="+a),e)if(angular.isObject(e)){var o=JSON.stringify(e);i=i+"&q="+o}else i=i+"&"+e;return!n&&$scope.fields&&(n=$scope.fields),n&&(i=i+"&fields="+n),$http.get(i)},$scope.refresh=function(){var condition={status:!0};$scope.condition&&_.extend(condition,$scope.condition),$scope.list(id_app,condition).success(function(data){if(!$scope.condition){var key=$scope.module+"_"+id_app;$cache[key]=data}if($scope.items=[],$scope.emptyYn){var empty_item=eval("({"+$scope.fieldModel+":'',"+$scope.fieldLabel+":'"+$scope.headerText+"'})");$scope.items.push(empty_item)}angular.forEach(data,function(t){$scope.items.push(t)}),!$scope.ngModel&&$scope.items.length>0&&($scope.ngModel=$scope.items[0][$scope.fieldModel])})},$scope.showList=function(){var modalInstance=$modal.open({templateUrl:"templates/"+$scope.group+"/"+$scope.module+"/templates/dialog-select.html",controller:["$scope","$modalInstance","parentScope",function($scope,$modalInstance,parentScope){$scope.getList=function(value,limit){var condition={};parentScope.condition&&_.extend(condition,parentScope.condition),condition.$or=[],parentScope.fieldsSearch.forEach(function(field){var f=eval("({"+field+":{$regex:'"+value+"',$options:'i'}})");condition.$or.push(f)}),parentScope.list(id_app,condition,null,limit).then(function(t){$scope.items=t.data})},$scope.keyup=function(t,e){13==t.keyCode&&e&&$scope.getList(e)},$scope.getList("",10),$scope.select=function(t){parentScope.ngModel=parentScope.multiple?[t[parentScope.fieldModel]]:t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.onSelect&&parentScope.onSelect({$item:t}),$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.openList=function(){var t="#/"+parentScope.module,e=$window.open(t,"Danh mục","width="+$window.innerWidth.toString()+",height=400"),n=$interval(function(){e.closed&&(parentScope.refresh(),$interval.stop(n))},100);$modalInstance.dismiss("cancel")},$scope.quickadd=function(){module.quickadd($modal,function(t){parentScope.items.push(t),parentScope.ngModel=parentScope.multiple?[t[parentScope.fieldModel]]:t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.onSelect&&parentScope.onSelect({$item:t});var e=parentScope.module+"_"+id_app;$cache[e]&&$cache[e].push(t)},parentScope.defaultValues),$modalInstance.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return $scope}}})},$scope.getList=function(){var key=$scope.module+"_"+id_app;if($cache[key]&&!$scope.condition&&$scope.cache){var data=$cache[key];if($scope.items=[],$scope.emptyYn){var empty_item=eval("({"+$scope.fieldModel+":'',"+$scope.fieldLabel+":'"+$scope.headerText+"'})");$scope.items.push(empty_item)}angular.forEach(data,function(t){$scope.items.push(t)}),!$scope.ngModel&&$scope.items.length>0&&($scope.ngModel=$scope.items[0][$scope.fieldModel])}else $scope.refresh()}}],link:function(scope,elem,attrs){var conditionData={};scope.conditionData&&(conditionData=scope.conditionData),attrs.hasOwnProperty("condition")&&(scope.condition=eval("({"+attrs.condition+"})")),scope.cache=attrs.hasOwnProperty("cache")?attrs.cache:!1,scope.headerText=attrs.hasOwnProperty("headerText")?attrs.headerText:"--",attrs.hasOwnProperty("multiple")&&(scope.multiple=attrs.multiple),scope.defaultValues=attrs.hasOwnProperty("defaultValues")?eval("({"+attrs.defaultValues+"})"):{},scope.group=attrs.hasOwnProperty("group")?attrs.group:"lists",scope.emptyYn=attrs.hasOwnProperty("ngRequired")||attrs.hasOwnProperty("required")?!1:!0,scope.getList()}}}]),accApp.directive("stpLink",function(){return{restrict:"E",scope:{link:"=",collection:"@",collectionsLink:"@"},templateUrl:"templates/sys/link.html",controller:["$scope","$http","$window","$location",function($scope,$http,$window,$location){$scope.textSearch="",$scope.location=$location.url();var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink),collectionsTitle={};collections.forEach(function(c){var module_name=c+"Module",module=eval("("+module_name+")");collectionsTitle[c]=module.title}),$scope.collectionsTitleString=_.values(collectionsTitle).join(),$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.link.links=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(t){return collectionsTitle[t.collection_obj]},$scope.search=function(t){var e=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(e).then(function(t){var e=t.data;return e})},$scope.addLink=function(t){$scope.textSearch="";var e=_.find($scope.link.links,function(e){return e.obj._id==t._id});if(!e){var n={};n.id_a=$scope.link._id,n.collection_a=$scope.collection,n.collection_b=t.collection_name,n.collection_obj=t.collection_name,n.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,n).success(function(e){_.extend(n,e),n.obj=t,n.title=t.title,$scope.link.links.push(n)}).error(function(t){t&&$window.alert(t)})}},$scope.unLink=function(t){var e=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(e).success(function(){$scope.link.links=_.reject($scope.link.links,function(e){return e._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.getItem=function(t,e,n){$scope.addLink(t,n)}}],link:function(t,e,n){n.link&&n.collection&&n.collectionsLink||console.error("stp-link directive require attributes:link,collection,collection-link"),t.$watch("link",function(e){e&&(t.link.links||(t.link.links=[]),t.load())})}}}),accApp.directive("ngGetInfo",["$http",function($http){return{restrict:"A",scope:{conditionValue:"=",runWhenConditionChanged:"=",ngModel:"="},controller:["$scope",function(t){var e=function(e,n,a){var i=server_url+"/api/"+e+"/"+t.pathService+"?t=1";if(n)if(angular.isObject(n)){var o=JSON.stringify(n);i=i+"&q="+o}else i=i+"&"+n;return a&&(i=i+"&fields="+a),$http.get(i)};t.getValue=function(n){var a={};for(var i in t.condition){var o=t.condition[i];a[i]="???"==o?t.conditionValue:o}e(id_app,a,t.fieldInfo).success(function(e){1==e.length&&n(e[0][t.fieldInfo])})}}],link:function(scope,elem,attrs){var ngGetInfo=eval("({"+attrs.ngGetInfo+"})");scope.fieldInfo=ngGetInfo.fieldInfo;var module=eval("("+ngGetInfo.module+"Module)");scope.pathService=module.server_path,scope.condition=ngGetInfo.condition,attrs.hasOwnProperty("runWhenConditionChanged")||(scope.runWhenConditionChanged=!0),scope.$watch("conditionValue",function(t){return scope.runWhenConditionChanged?t?void(scope.fieldInfo&&scope.getValue(function(t){scope.ngModel=t})):void(scope.ngModel=null):void 0})}}}]),accApp.directive("history",function(){return{restrict:"E",scope:{link:"=",module:"@",actions:"@"},templateUrl:"templates/sys/history.html",controller:["$scope","$http","$modal",function($scope,$http,$modal){var module=eval("("+$scope.module+"Module)");$scope.getHistory=function(){var t=server_url+"/api/"+id_app+"/"+module.server_path+"/history/"+$scope.link._id;$scope.actions&&(t=t+"?actions="+$scope.actions),$http.get(t).success(function(t){t.forEach(function(t){t.action_text="GET"==t.action?"Đã xem":"UPDATE"==t.action?"Đã cập nhật":"ADD"==t.action?"Đã tạo":t.action}),$scope.history=t}).error(function(t){console.error(t)})},$scope.openProfile=function(t){viewProfile($modal,t)}}],link:function(t){t.$watch("link",function(e){e&&t.getHistory()})}}}),accApp.directive("parseHtml",function(){return{restrict:"A",scope:{parseHtml:"="},link:function(t,e){t.$watch("parseHtml",function(t){if(t){var n=/<[a-z][\s\S]*>/i.test(t);e.html(n?t:t.replace(/\n/g,"<br/>"))}})}}}),accApp.directive("parseText",function(){return{restrict:"A",scope:{parseText:"=",limit:"@"},link:function(t,e){t.$watch("parseText",function(n){if(n){var a,i=/<[a-z][\s\S]*>/i.test(n);i?(e.html(n),a=e.text()):a=n,t.limit&&a.length>Number(t.limit)&&(a=a.substring(0,t.limit)+"..."),e.text(a)}})}}}),accApp.directive("textcomplete",["Textcomplete",function(t){return{restrict:"EA",scope:{members:"=",message:"="},template:"<textarea class=\"form-control\" rows=\"5\" ng-model='message' type='text'></textarea>",link:function(e,n){e.$watch("members",function(a){if(a&&a.length>0){var i=e.members,o=n.find("textarea"),r=new t(o,[{match:/(^|\s)@(\w*)$/,search:function(t,e){e($.map(i,function(e){return 0===e.toLowerCase().indexOf(t.toLowerCase())?e:null}))},index:2,replace:function(t){return"$1@"+t+" "}}]);$(r).on({"textComplete:select":function(t,n){e.$apply(function(){e.message=n})},"textComplete:show":function(){$(this).data("autocompleting",!0)},"textComplete:hide":function(){$(this).data("autocompleting",!1)}})}})}}}]),accApp.directive("routeLoader",function(){return{restrict:"EA",link:function(t,e){function n(){e.css("display","none")}var a=e.css("display");t.$on("$routeChangeStart",function(){e.css("display",a)}),t.$on("$routeChangeSuccess",n),t.$on("$routeChangeError",n),n()}}}),accApp.directive("serverLoader",function(){return{restrict:"EA",link:function(t,e){function n(){e.css("display","none")}var a=e.css("display");t.$on("$dataChangeStart",function(){t.serverAction="Đang tải dữ liệu",e.css("display",a)}),t.$on("$dataSaveStart",function(){t.serverAction="Đang lưu dữ liệu",e.css("display",a)}),t.$on("$dataChangeSuccess",n),t.$on("$dataChangeError",n),t.$on("$dataSaveSuccess",n),t.$on("$dataSaveError",n),n()}}}),accApp.directive("fileUploadProgress",function(){return{restrict:"EA",link:function(t,e){function n(){e.css("display","none")}var a=e.css("display");t.$on("$fileUploadStart",function(){t.serverAction="Đang tải dữ liệu",e.css("display",a)}),t.$on("$fileUploadSuccess",n),t.$on("$fileUploadError",n),n()}}}),accApp.directive("follow",function(){return{restrict:"E",scope:{collectionsFollow:"@"},templateUrl:"templates/sys/follow.html",controller:["$scope","$rootScope","$http","appInfo",function(t,e,n,a){t.load=function(){a.info("follow",function(e,a,i){if(t.follows=[],!e&&i._id){if(!t.collectionsFollow||!i)return;var o=server_url+"/api/"+i._id+"/follow?q={user_created:'"+a.email+"'}&collections="+t.collectionsFollow;n.get(o).success(function(e){t.follows=e})}})}}],link:function(t){t.load()}}}),accApp.directive("like",function(){return{restrict:"E",scope:{},templateUrl:"templates/sys/like.html",controller:["$scope","$rootScope","$http","appInfo",function(t,e,n,a){t.load=function(){a.info("like_module",function(e,a,i){if(t.likes=[],!e&&i._id){var o=server_url+"/api/"+i._id+"/like_module?q={user_created:'"+a.email+"',like:true}";n.get(o).success(function(e){t.likes=e})}})}}],link:function(t){t.load()}}}),accApp.directive("shortcut",["$document","$rootScope",function(t,e){return{restrict:"A",link:function(){t.bind("keydown",function(t){(t.ctrlKey&&(65==t.which||77==t.which||78==t.which||68==t.which||69==t.which||80==t.which||85==t.which||83==t.which)||116==t.which)&&t.preventDefault(),e.$apply(function(){e.$broadcast("keydown",t)})})}}}]);