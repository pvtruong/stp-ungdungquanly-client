var appInfoService=angular.module("appInfoService",[]);appInfoService.factory("appInfo",["$http","$localStorage","user","$rootScope","$location","app","$timeout",function(t,n,e,a,i,o){var r;return{asDesktop:function(){return"function"==typeof require?!0:!1},commands:function(e,i){t.get(server_url+"/api/"+e+"/menu").success(function(t){t.crm.input.forEach(function(t){t.visible&&(a.crm_input_visible=!0)}),t.sale.input.forEach(function(t){t.visible&&(a.sale_input_visible=!0)}),t.acc.forEach(function(t){t.visible&&(a.acc_visible=!0)}),t.report.forEach(function(t){t.visible&&(a.report_visible=!0)}),a.commands=t,n.setObject(e+"_menu_"+a.user.email,t),i&&i(null,t)}).error(function(t){console.error("Can't get menu of user",t),a.commands=n.getObject(e+"_menu_"+a.user.email),i&&i(t)})},get:function(n,e){if(r)e(null,r);else{var a=server_url+"/api/apps/"+n;t.get(a).success(function(t){r=t,e(null,r)}).error(function(t){e(t)})}},info:function(t,r){return id_app||(id_app=n.get("id_app"),id_app&&(a.id_app=id_app)),id_app||_.contains(paths_not_require_id_app,t)?(a.user?a.app_info||!id_app||_.contains(paths_not_require_id_app,t)?r&&r(null,a.user,a.app_info):o.get(id_app,id_app).success(function(t){a.app_info=t,r&&r(null,a.user,t)}).error(function(t){r&&r(t)}):e.getInfo(function(t,n){return t?void(r&&r(t)):void(!a.app_info&&id_app?o.get(id_app,id_app).success(function(t){a.app_info=t,r&&r(null,n,t)}).error(function(t){r&&r(t)}):r&&r(null,n,a.app_info))}),!0):(r&&r("Lỗi: bạn phải chọn một công ty"),i.url("/app"),!1)}}}]),appInfoService.factory("$localStorage",["$window","$cookies","$rootScope",function(t,n){return{remove:function(e){t.localStorage?t.localStorage[e]="":n[e]=""},set:function(e,a){t.localStorage?t.localStorage[e]=a:n[e]=a},get:function(e){return t.localStorage?t.localStorage[e]:n[e]},setObject:function(n,e){t.localStorage&&(t.localStorage[n]=JSON.stringify(e))},getObject:function(n){if(t.localStorage){var e=t.localStorage[n]||"[]";return JSON.parse(e)}return[]}}}]),appInfoService.factory("nodeWebkit",["$rootScope","$timeout",function(t,n){return{notification:function(e,a){if(Notification){var i={body:e};a||(a=t.program_name);var o=new Notification(a,i);o.onclick=function(){},o.onshow=function(){t.$apply(function(){n(function(){o.close()},5e3)})}}}}}]),appInfoService.factory("socket",["$rootScope",function(t){var n=server_url;n&&n.split(":").length<3&&(n+=":80");var e=io.connect(n);return{on:function(n,a){e.on(n,function(){var n=arguments;t.$apply(function(){a.apply(e,n)})})},once:function(n,a){e.once(n,function(){var n=arguments;t.$apply(function(){a.apply(e,n)})})},emit:function(n,a,i){e.emit(n,a,function(){var n=arguments;t.$apply(function(){i&&i.apply(e,n)})})}}}]),appInfoService.factory("Base64",function(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(n){var e,a,i,o,r,c="",d="",l="",u=0;do e=n.charCodeAt(u++),a=n.charCodeAt(u++),d=n.charCodeAt(u++),i=e>>2,o=(3&e)<<4|a>>4,r=(15&a)<<2|d>>6,l=63&d,isNaN(a)?r=l=64:isNaN(d)&&(l=64),c=c+t.charAt(i)+t.charAt(o)+t.charAt(r)+t.charAt(l),e=a=d="",i=o=r=l="";while(u<n.length);return c},decode:function(n){var e,a,i,o,r,c="",d="",l="",u=0,s=/[^A-Za-z0-9\+\/\=]/g;s.exec(n)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),n=n.replace(/[^A-Za-z0-9\+\/\=]/g,"");do i=t.indexOf(n.charAt(u++)),o=t.indexOf(n.charAt(u++)),r=t.indexOf(n.charAt(u++)),l=t.indexOf(n.charAt(u++)),e=i<<2|o>>4,a=(15&o)<<4|r>>2,d=(3&r)<<6|l,c+=String.fromCharCode(e),64!=r&&(c+=String.fromCharCode(a)),64!=l&&(c+=String.fromCharCode(d)),e=a=d="",i=o=r=l="";while(u<n.length);return c}}});var viewProfile=function(t,n){t.open({templateUrl:"templates/sys/profile.html",controller:["$scope","$modalInstance","user","$location","$rootScope",function(t,e,a,i,o){a.getProfile(n,function(n,e){t.profile=e}),t.cancel=function(){e.dismiss("cancel")},t.gotoChat=function(t){e.dismiss("cancel"),i.path("/message/chat/"+t)},t.currentUser=o.user}],size:"lg"})},baseInput=function(t,n,e,a,i){this.code=t,this.server_path=n,this.fields_find=e,this.title=a,i||(i={}),this.options=i,this.group=i.group,this.group||(this.group="lists"),this.defaultConditions=i.defaultConditions,this.defaultValues=i.defaultValues,this.loading=i.onLoading,this.initHomeController=i.onInitHomeController,this.initAddController=i.onInitAddController,this.initEditController=i.onInitEditController,this.init=i.onInit,this.setDataSource2Print=i.onSetDataSource2Print,this.loadItem=i.onLoadItem,this.initImport=i.onImport;var o=t+"Module";_.contains(modulesD,o)||modulesD.push(o),this.module=angular.module(o,["ngRoute"]);var r=this;this.module.factory(t+"Config",function(){return{title:a,path:t}}),this.module.factory(t,["$http",function(t){var a=function(){var t;return t=_.contains(paths_not_require_id_app,n)?server_url+"/api/"+n:server_url+"/api/"+id_app+"/"+n};return baseService(t,a,e,i.services)}]),this.module.controller(t+"JsonController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$window","$interval","$modal","$filter","appInfo","$localStorage",function(n,e,a,o,c,d,l,u,s,p,h,f){e.list=[],e.condition="",r.defaultConditions&&(e.condition={},_.extend(e.condition,r.defaultConditions)),angular.extend(e,d),e.limit=3e4;var g=c.search();f.info(t,function(t){t||(e.list=[],o.load(id_app,{condition:e.condition,filter:e.filter,page:1,limit:e.limit,queryParams:g,onCondition:i.onCondition}).success(function(t){e.list=t}).error(function(t){t&&alert(t)}))})}]),this.module.controller(t+"HomeController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$window","$interval","$modal","$filter","appInfo","$localStorage",function(n,e,a,o,c,d,l,u,s,p,h,f,g){e.list=[],e.condition="",r.defaultConditions&&(e.condition={},_.extend(e.condition,r.defaultConditions)),angular.extend(e,d),e.total_page=1,e.current_page=1,e.pages=[1],e.limit=30,e.$modal=p,e.$http=a,e.config=d;var m=c.search();r.init&&r.init(e,n),f.info(t,function(f,v){if(!f){var $=(id_app||"")+v.email+t+"data";r.loading&&l.nextTick(function(){r.loading(e,{$controller:n,$http:a,service:o,$location:c,config:d,$rootScope:l,$window:u,$interval:s,$modal:p})}),e.current_user=l.user,e.goToPage=function(t,n,r){l.nextTick(function(){if(e.$emit("$dataChangeStart"),e.list=[],n||void 0!=n||(n=e.condition),e.findBy&&!_.isObject(n)){var c=n;n={},n[e.findBy]={$regex:c,$options:"i"}}o.load(id_app,{condition:n,filter:e.filter,count:1,queryParams:m,onCondition:i.onCondition}).success(function(t){e.total_page=Math.round(t.rows_number/e.limit,0),e.total_page<t.rows_number/e.limit&&(e.total_page+=1),0==e.total_page&&(e.total_page=1),e.pages=[];for(var n=1;n<=e.total_page;n++)e.pages.push(n)}),o.load(id_app,{condition:n,filter:e.filter,page:t,limit:e.limit,queryParams:m,onCondition:i.onCondition}).success(function(i){async.map(i,function(t,n){id_app?a.get(server_url+"/api/"+id_app+"/follow?q={id_object:'"+t._id+"',user_created:'"+e.current_user.email+"'}").success(function(e){e&&e.length>0?(t.followObject=e[0],t.follow_yn=1):t.follow_yn=0,n()}).error(function(e){t.follow_yn=0,n(e)}):n()},function(a){a&&console.log(a),d.list=i,g.setObject($,i),d.id_app=id_app,d.current_page=t,d.condition=n,d.filter=e.filter,d.filter_title=e.filter_title,e.current_page=t,e.list=i,e.renderCompleted=!0,r&&r(null,e.list),e.$emit("$dataChangeSuccess")})}).error(function(t){console.log(t),e.$emit("$dataChangeError"),r&&r(t)})})},d.list&&0!=d.list.length&&id_app&&d.id_app==id_app?(e.list=[],l.nextTick(function(){e.$emit("$dataChangeStart"),condition=d.condition,e.filter=d.filter,e.list=d.list,e.current_page=d.current_page,e.current_page||(e.current_page=1),o.load(id_app,{condition:condition,filter:e.filter,count:1,queryParams:m,onCondition:i.onCondition}).success(function(t){e.total_page=Math.round(t.rows_number/e.limit,0),e.total_page<t.rows_number/e.limit&&(e.total_page+=1),0==e.total_page&&(e.total_page=1),e.pages=[];for(var n=1;n<=e.total_page;n++)e.pages.push(n);e.$emit("$dataChangeSuccess"),e.renderCompleted=!0}).error(function(){e.$emit("$dataChangeError"),e.renderCompleted=!0})})):e.goToPage(1,null,function(t){t&&l.nextTick(function(){var t=g.getObject($);e.list&&0!=e.list.length||(e.list=t,e.current_page=1,e.total_page=1),e.renderCompleted=!0})}),e.update=function(t){e.$emit("$dataSaveStart"),o.update(id_app,t._id,t).success(function(){t.updated=!0,e.$emit("$dataSaveSuccess"),alert("Đã cập nhật thành công")}).error(function(t){e.$emit("$dataSaveError");var n=JSON.stringify(t);if(n.indexOf("Lỗi")<0){if(n.indexOf("duplicate")>=0)return n="Lỗi: Đã tồn tại",alert(n);if(n.indexOf("Not allowed")>=0)return n="Lỗi: Bạn không có quyền thực hiện thao tác này",alert(n)}n=JSON.parse(n),alert(angular.isArray(n)?n.join("\n"):n)})},e.add=function(){var t="/"+e.path+"/add";c.path(t)},e.edit=function(t){c.path("/"+e.path+"/edit/"+t)},e.view=function(t){c.path("/"+e.path+"/view/"+t)},e.openProfile=function(t){viewProfile(p,t)},e.searchKeyup=function(t){13==t.keyCode&&e.search()},e.search=function(t){e.renderCompleted&&e.goToPage(1,t)},e.changeFilter=function(t){e.findBy=null,e.filter=t.filter,e.filter_title=t.title,e.search()},e.changeFindBy=function(t){e.filter=null,e.findBy=t.findBy,e.filter_title=t.title,e.search()},e.location=c.url(),e.reverse=!0,e.order=function(t,n){e.list=h("orderBy")(e.list,t,n)},e.selectionAll=!1,e.$watch("selectionAll",function(t){e.list&&e.list.forEach(function(n){n.sel=t})}),e.isUnSelected=function(){if(!e.list)return!0;for(var t=0;t<e.list.length;t++){var n=e.list[t];if(n.sel&&1==n.sel)return!1}return!0},e.delete=function(t){t?confirm("Có chắc chắn xóa không?")&&o.delete(id_app,t).success(function(){e.list=_.reject(e.list,function(n){return n._id==t}),d.list=e.list}).error(function(t){var n;n=_.isObject(t)?JSON.stringify(t):t,alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")}):confirm("Có chắc chắn xóa những dòng đã chọn không?")&&async.map(e.list,function(t,n){if(t.sel&&1==t.sel){var a=t._id;o.delete(id_app,a).success(function(){e.list=_.reject(e.list,function(t){return t._id==a}),n(null,a)}).error(function(t){n(t)})}else n()},function(t){if(t){var n;n=_.isObject(t)?JSON.stringify(t):t,alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")}else d.list=e.list})},r.initHomeController&&r.initHomeController(n,e,a,o,c,d),id_app&&l.nextTick(function(){var n=server_url+"/api/"+id_app+"/rpt?q={ma_cn:'"+t.toUpperCase()+"'}";a.get(n).success(function(t){e.rpts=t}).error(function(t){console.log(t)})}),e.rptManagement=function(){var n="rpt?ma_cn="+t.toUpperCase();c.url(n)},e.print=function(n){e.list.forEach(function(e){if(e.sel){var a=server_url+"/api/"+id_app+"/"+t+"/excel/"+n+"?_id="+e._id+"&access_token="+l.token;u.open(a)}})},e.import=function(){var n="#"+t+"/import?t=1";if(r.initImport)r.initImport(e,n,function(t,n){if(t)return u.alert(t);var a=0,i=u.open(n,"Import","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=200");stop=s(function(){return"OK"==i.document.title?(e.search(),s.cancel(stop),stop=void 0,void i.close()):"ERROR"==i.document.title?(s.cancel(stop),void(stop=void 0)):(a+=500,void(a>3e5&&stop&&(s.cancel(stop),stop=void 0)))},500)});else{var a=0,i=u.open(n,"Import","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=200");stop=s(function(){return"OK"==i.document.title?(e.search(),s.cancel(stop),stop=void 0,void i.close()):"ERROR"==i.document.title?(s.cancel(stop),void(stop=void 0)):(a+=500,void(a>3e5&&stop&&(s.cancel(stop),stop=void 0)))},500)}},e.follow=function(n){1==n.follow_yn?a.delete(server_url+"/api/"+id_app+"/follow/"+n.followObject._id).success(function(){n.follow_yn=0}).error(function(t){t&&u.alert(t)}):(followObject={id_object:n._id,collection_name:t,id_app:id_app},a.post(server_url+"/api/"+id_app+"/follow",followObject).success(function(t){n.followObject=t,n.follow_yn=1}).error(function(t){t&&u.alert(t)}))},e.isLike=!1,id_app&&(a.get(server_url+"/api/"+id_app+"/like_module?q={module:'"+t+"',user_created:'"+v.email+"'}").success(function(t){t&&1==t.length&&(e.isLike=t[0].like)}).error(function(t){console.log(t)}),e.like=function(){var n=server_url+"/api/"+id_app+"/like_module";a.post(n,{id_app:id_app,module:t,like:!0}).success(function(t){t&&(e.isLike=!0)}).error(function(t){console.log(t)})},e.unlike=function(){var n=server_url+"/api/"+id_app+"/like_module";a.post(n,{id_app:id_app,module:t,like:!1}).success(function(t){t&&(e.isLike=!1)}).error(function(t){console.log(t)})}),e.$on("keydown",function(t,n){return 116==n.which?void e.search():n.ctrlKey&&77==n.which?void e.add():n.ctrlKey&&68==n.which?void e.delete():(n.ctrlKey&&65==n.which&&e.list&&e.list.forEach(function(t){t.sel=!0}),void(n.ctrlKey&&85==n.which&&e.list&&e.list.forEach(function(t){t.sel=!1})))}),e.options=function(){token=l.token,p.open({templateUrl:"templates/"+r.group+"/"+t+"/templates/options.html",controller:["$scope","$controller","$http","$modalInstance","$window",function(n,e,a,i){var o=server_url+"/api/"+id_app+"/options",r={};a.get(o+"?access_token="+token+"&q={id_func:'"+t+"'}").success(function(e){1==e.length?(r=e[0],n.options=r.option):(r.id_app=id_app,r.id_func=t)}).error(function(){console.log(o)}),n.save=function(){r.option=n.options,r._id?a.put(o+"/"+r._id+"?access_token="+token,r).success(function(){i.close()}).error(function(t){alert("Không thể cập nhật tùy chọn\n"+t.toString())}):a.post(o+"?access_token="+token,r).success(function(){i.close()}).error(function(t){alert("Không thể lưu tùy chọn\n"+t.toString())})},n.cancel=function(){i.dismiss("cancel")}}],size:"lg",resolve:{}})}}})}]),this.module.directive(t+"Form",[function(){return{restrict:"E",templateUrl:"templates/"+r.group+"/"+t+"/templates/form.html"}}]),this.module.controller(t+"ImportController",["$scope","$rootScope","$location","$routeParams",t+"Config","appInfo",function(n,e,a,i,o,c){c.info(t,function(t){if(!t){var i=e.token;e.hide_nav=!0,n.action=server_url+"/api/"+id_app+"/"+r.server_path+"/import/excel?access_token="+i,n.template="templates/templates/"+r.code+".xlsx";var o=a.search();o.values&&(n.action=n.action+"&values="+o.values),o.update&&(n.action=n.action+"&update="+o.update)}})}]),this.module.controller(t+"AddController",["$controller","$scope","$http",t,"$location",t+"Config","$rootScope","$modal","$window","appInfo",function(n,e,a,o,c,d,l,u,s,p){e.masterData={status:!0},e.data={status:!0,visible_to:0},e.$modal=u,e.$http=a,e.$window=s,r.defaultValues&&(_.extend(e.data,r.defaultValues),_.extend(e.masterData,r.defaultValues));var h=c.search();h&&(_.extend(e.data,h),_.extend(e.masterData,h)),r.init&&r.init(e,n),e.action="Thêm mới",p.info(t,function(t){if(!t){e.current_user=l.user,e.isDataLoaded=!0,angular.extend(e,d),i.onAdd&&l.nextTick(function(){i.onAdd(e,{$controller:n,$rootScope:l,$http:a,service:o,$location:c,config:d,$window:s,$modal:u})}),e.reset=function(){e.data=angular.copy(e.masterData)},e.cancel=function(){var t=c.search().redirect;t?"back"==t?s.history.back():c.url(t):c.url("/"+e.path)},e.isUnchanged=function(){return angular.equals(e.data,e.masterData)};var _=function(){e.$emit("$dataSaveStart"),o.create(id_app,e.data).success(function(t){e.masterData=t,d.list||(d.list=[]),d.list.push(e.masterData);var n=c.search().redirect;n?"back"==n?s.history.back():c.url(n):i.has_view?c.url("/"+e.path+"/view/"+t._id):c.path("/"+e.path),e.$emit("$dataSaveSuccess")}).error(function(t){e.$emit("$dataSaveError");var n=t;n.indexOf("Lỗi")<0&&(n.indexOf("duplicate")>=0?n="Lỗi: Đã tồn tại":n.indexOf("Not allowed")>=0&&(n="Lỗi: Bạn không có quyền thực hiện thao tác này")),alert(angular.isArray(n)?n.join("\n"):n)})};e.create=function(){i.onSave?i.onSave(e,e.data,{action:"CREATE",$controller:n,$rootScope:l,$http:a,service:o,$location:c,config:d,$window:s,$modal:u},function(t,n){return t?s.alert(t):void(n&&_())}):_()},e.$on("keydown",function(t,n){n.ctrlKey&&83==n.which&&e.create()}),r.initAddController&&r.initAddController(n,e,a,o,c,d)}})}]),this.quickadd=function(n,e,a){n.open({templateUrl:"templates/"+r.group+"/"+t+"/templates/dialog-quickadd.html",controller:["$scope","$controller","$http",t,"$location",t+"Config","$modalInstance","$window","$rootScope",function(t,o,c,d,l,u,s,p,h){if(t.masterData={status:!0},t.data={status:!0,visible_to:0},t.isDataLoaded=!0,t.$modal=n,t.$http=c,t.$window=p,t.action="Thêm mới",r.init&&r.init(t,o),r.defaultValues&&_.extend(t.data,r.defaultValues),a)for(var f in a)t.data[f]=a[f];var g=l.search();g&&(_.extend(t.data,g),_.extend(t.masterData,g)),angular.extend(t,u),r.initAddController&&r.initAddController(o,t,c,d,l,u),t.isUnchanged=function(){return angular.equals(t.data,t.masterData)},i.onAdd&&h.nextTick(function(){i.onAdd(t,{$controller:o,$rootScope:h,$http:c,service:d,$location:l,config:u,$window:p,$modal:n})});var m=function(){t.$emit("$dataSaveStart"),d.create(id_app,t.data).success(function(n){t.masterData=n,u.list||(u.list=[]),u.list.push(t.masterData),e&&e(t.masterData),s.close(),t.$emit("$dataSaveSuccess")}).error(function(n){t.$emit("$dataSaveError");var e=n;e.indexOf("Lỗi")<0&&(e.indexOf("duplicate")>=0?e="Lỗi: Đã tồn tại":e.indexOf("Not allowed")>=0&&(e="Lỗi: Bạn không có quyền thực hiện thao tác này")),alert(angular.isArray(e)?e.join("\n"):e)})};t.create=function(){i.onSave?i.onSave(t,t.data,{action:"CREATE",$controller:o,$rootScope:h,$http:c,service:d,$location:l,config:u,$window:p,$modal:n},function(t,n){return t?p.alert(t):void(n&&m())}):m()},t.cancel=function(){s.dismiss("cancel")}}],size:"lg",backdrop:"static",resolve:{}})},this.quickedit=function(n,e,a){n.open({templateUrl:"templates/"+r.group+"/"+t+"/templates/dialog-quickadd.html",controller:["$scope","$controller","$http",t,"$location",t+"Config","$modalInstance","$window","$routeParams","$timeout","$rootScope",function(t,o,c,d,l,u,s,p,h,f,g){t.data={},r.init&&r.init(t,o),g.nextTick(function(){d.get(id_app,e).success(function(m){if(!m)return p.alert("Đối tượng này không tồn tại\nid:"+e),void s.dismiss("cancel");t.masterData=m,_.extend(t.data,m),t.$modal=n,t.$http=c,t.$window=p,t.action="Sửa",r.loadItem&&r.loadItem(t,t.data),f(function(){t.isDataLoaded=!0},100),angular.extend(t,u),t.isUnchanged=function(){return angular.equals(t.data,t.masterData)},i.onEdit&&g.nextTick(function(){i.onEdit(t,{$controller:o,$rootScope:g,$http:c,service:d,$location:l,config:u,$window:p,$modal:n})});var v=function(){t.$emit("$dataSaveStart"),d.update(id_app,e,t.data).success(function(n){for(var e in n)t.masterData[e]=n[e];a&&a(t.masterData),s.close(),t.$emit("$dataSaveSuccess")}).error(function(n){t.$emit("$dataSaveError");var e=JSON.stringify(n);if(e.indexOf("Lỗi")<0){if(e.indexOf("duplicate")>=0)return e="Lỗi: Đã tồn tại",alert(e);if(e.indexOf("Not allowed")>=0)return e="Lỗi: Bạn không có quyền thực hiện thao tác này",alert(e)}e=JSON.parse(e),alert(angular.isArray(e)?e.join("\n"):e)})};t.create=function(){i.onSave?i.onSave(t,t.data,{action:"UPDATE",$controller:o,$rootScope:g,$http:c,service:d,$location:l,config:u,$window:p,$modal:n},function(t,n){return t?p.alert(t):void(n&&v())}):v()},t.cancel=function(){s.dismiss("cancel")},r.initEditController&&r.initEditController(o,t,c,d,l,h,u,f)}).error(function(t){alert(t.indexOf("Lỗi")>=0?t:"Không thể tìm thấy đối tượng này"),s.dismiss("cancel")})})}],size:"lg",backdrop:"static",resolve:{}})},this.module.controller(t+"EditController",["$controller","$scope","$http",t,"$location","$routeParams",t+"Config","$timeout","$rootScope","$modal","$window","appInfo",function(n,e,a,o,c,d,l,u,s,p,h,f){e.masterData=null,e.data={},e.$modal=p,e.$http=a,e.$window=h,e.action="Sửa",angular.extend(e,l),r.init&&r.init(e,n),f.info(t,function(t){if(!t){e.current_user=s.user,l.list&&(e.masterData=_.find(l.list,function(t){return t._id==d.id})),e.openProfile=function(t){viewProfile(p,t)},e.masterData?(e.data=angular.copy(e.masterData),r.loadItem&&r.loadItem(e,e.data),i.onEdit&&s.nextTick(function(){i.onEdit(e,{$controller:n,$http:a,service:o,$location:c,config:l,$window:h,$modal:p})}),u(function(){e.isDataLoaded=!0},100)):(e.masterData={},s.nextTick(function(){e.$emit("$dataChangeStart"),o.get(id_app,d.id).success(function(t){e.masterData=t,e.data=angular.copy(e.masterData),l.list||(l.list=[]),l.list.push(e.masterData),r.loadItem&&r.loadItem(e,e.data),i.onEdit&&s.nextTick(function(){i.onEdit(e,{$controller:n,$rootScope:s,$http:a,service:o,$location:c,config:l,$window:h,$modal:p})}),u(function(){e.isDataLoaded=!0,e.$emit("$dataChangeSuccess")},100)}).error(function(t){e.$emit("$dataChangeError"),alert(t.indexOf("Lỗi")>=0?t:"Không thể tìm thấy đối tượng này")})})),e.isUnchanged=function(){return angular.equals(e.data,e.masterData)},e.reset=function(){e.data=angular.copy(e.masterData)},e.cancel=function(){var t=c.search().redirect;t?"back"==t?h.history.back():c.url(t):c.url(i.has_view?"/"+e.path+"/view/"+e.data._id:"/"+e.path)},e.$on("keydown",function(t,n){n.ctrlKey&&83==n.which&&e.create()});var f=function(){e.$emit("$dataSaveStart"),o.update(id_app,d.id,e.data).success(function(t){for(var n in t)e.masterData[n]=t[n];var a=c.search().redirect;a?"back"==a?h.history.back():c.url(a):i.has_view?c.url("/"+e.path+"/view/"+t._id):c.path("/"+e.path),e.$emit("$dataSaveSuccess")}).error(function(t){e.$emit("$dataSaveError");var n=JSON.stringify(t);if(n.indexOf("Lỗi")<0){if(n.indexOf("duplicate")>=0)return n="Lỗi: Đã tồn tại",alert(n);if(n.indexOf("Not allowed")>=0)return n="Lỗi: Bạn không có quyền thực hiện thao tác này",alert(n)}n=JSON.parse(n),alert(angular.isArray(n)?n.join("\n"):n)})};e.create=function(){i.onSave?i.onSave(e,e.data,{action:"UPDATE",$controller:n,$rootScope:s,$http:a,service:o,$location:c,config:l,$window:h,$modal:p},function(t,n){return t?h.alert(t):void(n&&f())}):f()},r.initEditController&&r.initEditController(n,e,a,o,c,d,l,u)}})}]),this.module.controller(t+"ViewController",["$controller","$scope","$routeParams",t+"Config",t,"$rootScope","$location","$window","$http","$modal","appInfo","$localStorage","$interval",function(n,e,a,o,r,c,d,l,u,s,p,h,f){p.info(t,function(p){if(!p){e.code=t,e.location=d.url(),e.current_user=c.user,e.action="Xem",e.current_record=0,e.total_records=0,angular.extend(e,o);var g=function(){c.nextTick(function(){e.$emit("$dataChangeStart"),r.get(id_app,a.id).success(function(t){e.data=t,e.data.links=[],id_app&&u.get(server_url+"/api/"+id_app+"/follow?q={id_object:'"+t._id+"',user_created:'"+e.current_user.email+"'}").success(function(n){n&&n.length>0?(t.followObject=n[0],t.follow_yn=1):t.follow_yn=0}).error(function(){t.follow_yn=0}),i.onView&&i.onView(e,{$controller:n,$http:u,service:r,$location:d,config:o,$window:l,$modal:s,$rootScope:c,$localStorage:h,$interval:f}),e.$emit("$dataChangeSuccess")}).error(function(t){t&&alert(t),e.$emit("$dataChangeError"),d.url("/"+e.path)})})};if(e.list)for(var m=0;m<e.list.length;m++)if(e.list[m]._id==a.id){e.current_record=m,e.total_records=e.list.length-1,e.data=e.list[e.current_record],e.data.links=[],i.onView&&i.onView(e,{$controller:n,$http:u,service:r,$location:d,config:o,$window:l,$modal:s,$rootScope:c,$localStorage:h,$interval:f});break}e.data||g(),e.back=function(){var t=d.search().redirect;t?"back"==t?l.history.back():d.url(t):d.url("/"+e.path)},e.update=function(t,n){var a={};_.extend(a,e.data),t&&_.extend(a,t),r.update(id_app,e.data._id,a).success(function(t){_.extend(e.data,t),n&&n(null,t)}).error(function(t){n?n(t):t&&l.alert(t)})},e.edit=function(){d.url("/"+t+"/edit/"+a.id)},e.add=function(){var t="/"+e.path+"/add";d.path(t)},e.backRecord=function(){if(e.current_record>0){e.current_record=e.current_record-1;var n=e.list[e.current_record]._id;d.path(t+"/view/"+n)}},e.nextRecord=function(){if(e.list&&e.current_record<e.total_records){e.current_record=e.current_record+1;var n=e.list[e.current_record]._id;d.path(t+"/view/"+n)}},e.delete=function(t){confirm("Có chắc chắn xóa không?")&&r.delete(id_app,t).success(function(){o.list=_.reject(o.list,function(n){return n._id==t});var n=d.search().redirect;n?"back"==n?l.history.back():d.url(n):d.url("/"+e.path)}).error(function(t){var n;n=_.isObject(t)?JSON.stringify(t):t,alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")})},e.openProfile=function(t){viewProfile(s,t)},e.follow=function(){1==e.data.follow_yn?u.delete(server_url+"/api/"+id_app+"/follow/"+e.data.followObject._id).success(function(){e.data.follow_yn=0}).error(function(t){t&&l.alert(t)}):(followObject={id_object:e.data._id,collection_name:t,id_app:id_app},u.post(server_url+"/api/"+id_app+"/follow",followObject).success(function(t){e.data.followObject=t,e.data.follow_yn=1}).error(function(t){t&&l.alert(t)}))},e.$on("keydown",function(t,n){if(116==n.which)return void g();if(n.ctrlKey){if(69==n.which)return void e.edit();if(77==n.which)return void e.add()}}),e.addLink=function(n,a){var i={};i.id_a=e.data._id,i.collection_a=t,i.collection_b=n.collection_name,i.id_b=n._id;var o=server_url+"/api/"+id_app+"/link";u.post(o,i).success(function(t){_.extend(i,t),i.obj=n,i.collection_obj=n.collection_name,i.title=n[a],e.data.links.push(i)}).error(function(t){console.log(t);var o={id_a:i.id_a,id_b:i.id_b};u.get(server_url+"/api/"+id_app+"/link?q="+JSON.stringify(o)).success(function(t){t.length>0&&(_.extend(i,t[0]),i.obj=n,i.collection_obj=n.collection_name,i.title=n[a],e.data.links.push(i))}).error(function(t){console.error(t)})})}}})}]),this.module.config(["$routeProvider","$locationProvider",function(n){n.when("/"+t,{templateUrl:"templates/"+r.group+"/"+t+"/templates/list.html",controller:t+"HomeController"}).when("/"+t+"/add",{templateUrl:"templates/"+r.group+"/"+t+"/templates/edit.html",controller:t+"AddController"}).when("/"+t+"/json",{templateUrl:"templates/sys/json.html",controller:t+"JsonController"}).when("/"+t+"/import",{templateUrl:"templates/sys/import.html",controller:t+"ImportController"}).when("/"+t+"/edit/:id",{templateUrl:"templates/"+r.group+"/"+t+"/templates/edit.html",controller:t+"EditController"}).when("/"+t+"/view/:id",{templateUrl:"templates/"+r.group+"/"+t+"/templates/view.html",controller:t+"ViewController"})}]),this.initModule&&this.initModule(this.module)},baseRpt=function(t,n,e,a){this.rptId=t;var i=t+"Module";_.contains(modulesD,i)||modulesD.push(i),this.rptModuleName=i,this.module=angular.module(this.rptModuleName,["ngRoute"]);var o=this;a||(a={}),a.onInit&&(o.init=a.onInit),a.onAfterLoadData&&(o.afterLoadData=a.onAfterLoadData),a.onDefaultCondition&&(o.defaultCondition=a.onDefaultCondition),a.onPrepareCondition&&(o.prepareCondition=a.onPrepareCondition),this.getUrl=function(){var t;return t=0==a.require_id_app?server_url+"/public/"+n:server_url+"/api/"+id_app+"/"+n},this.module.factory(t+"Config",function(){return{}}),this.getData=function(t,n,e,a,i){var r=o.getUrl()+"?t=1";i&&i.$emit("$dataChangeStart"),e&&angular.forEach(e,function(t,n){angular.isDate(t)?t=JSON.stringify(t).replace(/\"/g,""):angular.isObject(t)&&(t=JSON.stringify(t)),r=r+"&"+n+"="+encodeURI(t)}),t.get(r).success(function(t){a(null,t),i&&i.$emit("$dataChangeSuccess")}).error(function(t){console.log(t),a(t),i&&i.$emit("$dataChangeError")})},this.module.controller(t+"Controller",["$scope","$http","$filter","$location",t+"Config","$controller","$rootScope","$window","appInfo",function(n,i,r,c,d,l,u,s,p){var h=c.search();if(!n.condition){if(n.condition={},o.defaultCondition&&o.defaultCondition(n.condition),_.isEqual(h,{})&&d.condition)for(var f in d.condition)c.search(f,d.condition[f]),h[f]=d.condition[f];_.extend(n.condition,h)}o.init&&o.init(n,i,r,c,d,l),(0==a.require_id_app||1==p.info(t))&&(n.title=e,d.id_app==id_app&&_.isEqual(h,d.condition)&&(n.data=d.data),n.data?(n.condition_show=!1,o.afterLoadData&&o.afterLoadData(n,n.data)):n.condition_show=!0,n.hideCondition=function(){n.condition_show=!n.condition_show},n.viewVoucher=function(t,n){if(t&&n){var e=t.toLowerCase()+"/edit/"+n+"?redirect=back";c.url(e)}},n.order=function(t,e){n.data=r("orderBy")(n.data,t,e)},n.getData=function(){a.onStartGetData?a.onStartGetData(n,function(t){t?alert(t):n.getDataFromServer()}):n.getDataFromServer()},n.getDataFromServer=function(){n.data=[];for(var t in n.condition){var e=n.condition[t];angular.isDate(e)&&(e=r("date")(e,"yyyy-MM-dd")),e&&""!=e&&c.search(t,e)}o.prepareCondition?o.prepareCondition(n.condition,r,function(t,e){t?n.error=t:o.getData(i,r,e,function(t,e){n.data=e,n.error=t,t||(n.condition_show=!1,d.condition=c.search(),d.data=e,d.id_app=id_app,o.afterLoadData&&o.afterLoadData(n,e))},n)}):o.getData(i,r,n.condition,function(t,e){n.data=e,n.error=t,t||(n.condition_show=!1,d.condition=c.search(),d.data=e,d.id_app=id_app,o.afterLoadData&&o.afterLoadData(n,e))},n)},n.print=function(){c.path("/"+t+"/print")},n.exportExcel=function(){var t=o.getUrl()+"/excel?access_token="+access_token;o.prepareCondition?o.prepareCondition(n.condition,r,function(e,a){e?n.error=e:(angular.forEach(a,function(n,e){angular.isDate(n)&&(n=r("date")(n,"yyyy-MM-dd")),angular.isObject(n)&&(n=JSON.stringify(n)),n&&(t=t+"&"+e+"="+encodeURI(n))}),s.open(t))}):(angular.forEach(n.condition,function(n,e){angular.isDate(n)&&(n=r("date")(n,"yyyy-MM-dd")),angular.isObject(n)&&(n=JSON.stringify(n)),n&&(t=t+"&"+e+"="+encodeURI(n))}),s.open(t))},a.onLoading&&a.onLoading(n,{$http:i,$filter:r,$location:c,$config:d,$controller:l}),n.condition.isDrillDown&&(delete n.condition.isDrillDown,n.getData()),n.isLike=!1,id_app&&(i.get(server_url+"/api/"+id_app+"/like_module?q={module:'"+t+"'}").success(function(t){t&&1==t.length&&(n.isLike=t[0].like)}).error(function(t){console.log(t)}),n.like=function(){var e=server_url+"/api/"+id_app+"/like_module";i.post(e,{id_app:id_app,module:t,like:!0}).success(function(t){t&&(n.isLike=!0)}).error(function(t){console.log(t)})},n.unlike=function(){var e=server_url+"/api/"+id_app+"/like_module";i.post(e,{id_app:id_app,module:t,like:!1}).success(function(t){t&&(n.isLike=!1)}).error(function(t){console.log(t)})}),n.$on("keydown",function(t,e){if(116==e.which)return void n.getData();if(e.ctrlKey){if(69==e.which)return void n.exportExcel();if(80==e.which)return void n.print()}}))}]),this.module.controller(t+"PrintController",["$controller","appInfo","$scope",t+"Config","$timeout","$location","$rootScope",function(n,a,i,r,c,d,l){a.info(t,function(a,u,s){a||(i.parameters={},i.condition=r.condition,i.title=e,i.data=r.data,i.appInfo=s,o.setParameters&&o.setParameters(i,n),i.print=function(){i.printing=!0,l.printing=!0,c(function(){window.print(),i.printing=!1,l.printing=!1},100)},i.back=function(){d.url("/"+t)},i.$on("keydown",function(t,n){return n.ctrlKey&&80==n.which?void i.print():void 0}))})}]),this.module.config(["$routeProvider","$locationProvider",function(n){n.when("/"+t,{templateUrl:"templates/reports/"+t+"/templates/browser.html",controller:t+"Controller",reloadOnSearch:!1}).when("/"+t+"/print",{templateUrl:"templates/reports/"+t+"/templates/print.html",controller:t+"PrintController",reloadOnSearch:!1})}])},dateTime2Date=function(t){return new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate()))},baseVoucher=function(t,n,e,a,i){var o=this;i||(i={}),i.group="vouchers",o.defaultCondition4Search=i.defaultCondition4Search,o.prepareCondition4Search=i.onPrepareCondition4Search,o.watchMaster=i.onWatchMaster,o.defaultValues4Detail=i.onDefaultValues4Detail,o.watchDetail=i.onWatchDetail;var r=i.onLoading;i.onLoading=function(n,e){r&&r(n,e),n.find=function(){e.$modal.open({templateUrl:"templates/vouchers/"+t+"/templates/find.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.vcondition={},o.defaultCondition4Search&&(t.vcondition=o.defaultCondition4Search),t.list=e.list,t.search=e.search,t.okFind=function(){o.defaultCondition4Search=t.vcondition,o.prepareCondition4Search?e.condition=o.prepareCondition4Search(t,t.vcondition):(e.condition={},_.extend(e.condition,t.vcondition)),t.search(),n.close()},t.cancelFind=function(){n.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return n
}}})}};var c=i.onEdit;i.onEdit=function(t,n){c&&c(t,n),t.data.details||(t.data.details=[]),t.round=0,t.$watch("data.ma_nt",function(n){n&&"VND"!=n&&(t.round=2)}),o.watchMaster&&o.watchMaster(t)};var d=i.onAdd;i.onAdd=function(t,n){d&&d(t,n),t.data.ty_gia=1,t.data.ma_nt="VND",t.data.ngay_ct=new Date,t.data.details=[],n.service.next(id_app,"so_ct").success(function(n){t.data.so_ct=n.so_ct}).error(function(t){console.log(t)}),t.round=0,t.$watch("data.ma_nt",function(n){n&&"VND"!=n&&(t.round=2)}),o.watchMaster&&o.watchMaster(t)},baseInput.call(this,t,n,e,a,i),o.module.directive(t+"DetailTable",function(){return{restrict:"E",scope:{ngMasterData:"="},templateUrl:"templates/vouchers/"+t+"/templates/detail-table.html",controller:["$scope","$modal","$timeout","$http","$window",function(n,e,a,i,r){n.status={isOpened:!1},n.$modal=e,n.$http=i,n.$window=r,n.isNotRowSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},n.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},n.addDetail=function(){var t=n.ngMasterData.details.length;n.dt_master=null,n.dt_current={line:t},o.defaultValues4Detail&&_.extend(n.dt_current,o.defaultValues4Detail),n.ngMasterData.details||(n.ngMasterData.details=[]),n.openDetail("lg")},n.editDetail=function(t){n.dt_master=_.find(n.ngMasterData.details,function(n){return n.line==t}),n.dt_current={},_.extend(n.dt_current,n.dt_master),n.openDetail("lg")},n.openDetail=function(i){var o=e.open({templateUrl:"templates/vouchers/"+t+"/templates/detail-edit.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.data=e.ngMasterData,t.status=e.status,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.data.details.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.dismiss("cancel")}}],size:i,resolve:{parentScope:function(){return n}}});o.opened.then(function(){a(function(){n.status.isOpened=!0},100)}),o.result.then(function(){n.status.isOpened=!1})}}],link:function(t){o.watchDetail&&o.watchDetail(t)}}})};baseVoucher.prototype=new baseInput;var baseService=function(t,n,e,a){var i={list:function(a,i,o,r,c,d,l,u,s){var p=n()+"?t=1";if(1==r&&(p+="&count=1"),c&&(p=p+"&page="+c.toString()),d&&(p=p+"&limit="+d.toString()),angular.isObject(i)){var h={};_.extend(h,i),l&&_.extend(h,l),s&&_.extend(h,s),u&&u(h,i);var f=JSON.stringify(h);p=p+"&q="+encodeURI(f)}else{var h={};i&&e&&0!=e.length?(h.$or=[],e.forEach(function(t){var n={};n[t]={$regex:i,$options:"i"},h.$or.push(n)})):l&&_.extend(h,l),s&&_.extend(h,s),u&&u(h,i),p=p+"&q="+encodeURI(JSON.stringify(h))}return o&&(p=p+"&fields="+o),t.get(p)},next:function(e,a){return t.get(n()+"/next/"+a)},get:function(e,a){return t.get(n()+"/"+a)},create:function(e,a){return t.post(n(),a)},update:function(e,a,i){return t.put(n()+"/"+a,i)},"delete":function(e,a){return t.delete(n()+"/"+a)},getSocai:function(e,a){return t.get(n()+"/socai/"+a)},getVsocai:function(e,a){return t.get(n()+"/vsocai/"+a)}};return i.load=function(t,n){return n?i.list(t,n.condition,n.fields,n.count,n.page,n.limit,n.queryParams,n.onCondition,n.filter):i.list(t)},a&&_.extend(i,a(t)),i},loginModule=angular.module("loginModule",["ngRoute"]);loginModule.controller("loginController",["$scope","$rootScope","api","$http","$location","user","Base64","$window","$interval","$localStorage",function(t,n,e,a,i,o,r,c,d,l){l.set("token",""),l.set("id_app",""),n.app_info=void 0,n.isLogined=!1,id_app=void 0,n.id_app=void 0,n.user=void 0,e.init(),t.data={},t.auth_google=function(){var t=c.open(server_url+"/auth/google","Google authentication","height=400,width=400"),a=d(function(){try{if(t.location.href&&t.location.href.indexOf("/auth/google/callback")&&t.document.body.innerHTML&&t.document.body.innerHTML.indexOf("access_token")>=0){var r=t.document.title;d.cancel(a),t.close(),l.set("token",r),e.init(r),o.getInfo(function(t){n.user=t,i.url("/app")})}}catch(c){console.log(c)}},500)},t.auth_facebook=function(){var t=c.open(server_url+"/auth/facebook","Facebook authentication","height=400,width=400"),a=d(function(){try{if(t.location.href&&t.location.href.indexOf("/auth/facebook/callback")&&t.document.body.innerHTML&&t.document.body.innerHTML.indexOf("access_token")>=0){var r=t.document.title;d.cancel(a),t.close(),l.set("token",r),e.init(r),o.getInfo(function(t){n.user=t,i.url("/app")})}}catch(c){}},500)},t.auth_local=function(){var c=server_url+"/auth/local",d="Basic "+r.encode(t.data.username+":"+t.data.password);a.get(c,{headers:{Authorization:d}}).success(function(t){l.set("token",t),e.init(t),o.getInfo(function(t){n.user=t,i.url("/app")})}).error(function(n){t.messageError=n})},t.signup=function(){i.url("/signup")}}]),loginModule.controller("signupController",["$scope","$rootScope","api","$http","$location","$localStorage",function(t,n,e,a,i,o){o.remove("token"),o.remove("id_app"),n.app_info=void 0,id_app=void 0,n.id_app=void 0,n.isLogined=!1,e.init(),t.data={},t.signup=function(){var n=server_url+"/signup";a.post(n,t.data).success(function(n){t.alertType="alert alert-success",t.messageError=n,t.data={}}).error(function(n){t.alertType="alert alert-danger",t.messageError=n})}}]),loginModule.factory("user",["$http","$localStorage","$rootScope","$location","socket","nodeWebkit",function(t,n,e,a,i,o){return{getInfo:function(n){e.user?n(null,e.user):t.get(server_url+"/api/user").success(function(t){var a=t.name.split(" ");t.last_name=a[a.length-1],e.error=void 0,e.user=t,i.on("connect",function(){i.emit("login",{token:t.token,email:t.email})}),i.emit("login",{token:t.token,email:t.email}),i.on("notify:count",function(t){e.notifies_count=t,t&&o.notification("Bạn có thông báo mới")}),i.on("message:count",function(t){e.messages_count=t,t&&o.notification("Bạn có tin nhắn mới")}),i.on("disconnect",function(){}),n(null,t)}).error(function(t){t||(t="Không thể kết nối với máy chủ"),e.error=t,e.user=void 0,n(t),a.url("login")})},getProfile:function(n,e){var a=server_url+"/api/profile?email="+n;t.get(a).success(function(t){e(null,t)}).error(function(t){e(t)})},getProfileByToken:function(n){var e=server_url+"/api/profile";t.get(e).success(function(t){n(null,t)}).error(function(t){n(t)})},updateProfile:function(n,e){var a=server_url+"/api/updateprofile";t.post(a,n).success(function(t){e(null,t)}).error(function(t){e(t)})},updatePassword:function(n,e){var a=server_url+"/api/changepassword";t.post(a,n).success(function(t){e(null,t)}).error(function(t){e(t)})},resetPassword:function(n,e){var a=server_url+"/resetpassword?email="+n;t.get(a).success(function(t){e(null,t)}).error(function(t){e(t)})},getNotifies:function(n){var e=server_url+"/api/notifies";t.get(e).success(function(t){n(null,t)}).error(function(t){n(t)})},getMessagesColleagues:function(n){var e=server_url+"/api/message/colleague/latest";t.get(e).success(function(t){n(null,t)}).error(function(t){n(t)})},logout:function(e){return n.get("token")?void t.get(server_url+"/api/user/logout").success(function(t){e(t)}).error(function(){e()}):e}}}]),loginModule.controller("uploadController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams",function(t,n,e,a,i,o,r,c){var d=c.folder;t.action=server_url+"/api/uploadfile?access_token="+e.get("token")+"&folder="+d}]),loginModule.controller("uploadExcelController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$routeParams",function(t,n,e){t.action=server_url+"/api/uploadexcel?access_token="+e.get("token")}]),loginModule.controller("profileController",["$scope","user","$localStorage","$rootScope","$location","app","$window","$interval","appInfo",function(t,n,e,a,i,o,r,c,d){d.info("profile",function(a){a||(t.access_token=e.get("token"),n.getProfileByToken(function(n,e){return n?(t.alertType="danger",t.messageError=n):(t.alertType="success",void(t.data=e))}),t.updateProfile=function(){n.updateProfile(t.data,function(n){return n?(t.alertType="danger",t.messageError=n):(t.alertType="success",void(t.messageError="Bạn đã cập nhật thành công!"))})},t.updatePassword=function(){n.updatePassword({oldPassword:t.oldPassword,newPassword:t.newPassword,reNewPassword:t.reNewPassword},function(n){return n?(t.alertTypeChangePass="danger",t.messageErrorChangePass=n):(t.alertTypeChangePass="success",void(t.messageErrorChangePass="Bạn đã thay đổi mật khẩu thành công!"))})})})}]),loginModule.controller("resetPasswordController",["$scope","user","$rootScope","$location","app",function(t,n){t.resetPassword=function(){n.resetPassword(t.email,function(n,e){n?(t.alertType="alert alert-danger",t.messageError=n):(t.alertType="alert alert-success",t.messageError=e)})}}]),loginModule.controller("logoutController",["$scope","$localStorage","api","$location","$rootScope","user","$window","$timeout",function(t,n,e,a,i,o,r,c){o.logout(function(){if(i.token=null,n.remove("token"),n.remove("id_app"),i.app_info=void 0,i.isLogined=!1,id_app=null,i.id_app=void 0,e.init(),a.url("/login"),i.user){var t;if("google"==i.user.server&&(t="https://mail.google.com/mail/u/0/?logout&hl=en"),"facebook"==i.user.server,i.user=void 0,t){var o=r.open(t,"Logout","height=400,width=400");c(function(){o.close()},3e3)}}})}]),loginModule.controller("downloadController",["$scope","$http",function(t,n){n.get(server_url+"/public/versioninfo").success(function(n){t.downloads=n})}]),loginModule.config(["$routeProvider","$locationProvider",function(t){t.when("/signup",{templateUrl:"templates/login/templates/signup.html",controller:"signupController"}).when("/resetpassword",{templateUrl:"templates/login/templates/resetpassword.html",controller:"resetPasswordController"}).when("/profile",{templateUrl:"templates/login/templates/profile.html",controller:"profileController"}).when("/login",{templateUrl:"templates/login/templates/login.html",controller:"loginController"}).when("/logout",{templateUrl:"templates/login/templates/callback.html",controller:"logoutController"}).when("/download",{templateUrl:"templates/login/templates/download.html",controller:"downloadController"}).when("/uploadfile/:folder",{templateUrl:"templates/login/templates/upload.html",controller:"uploadController"}).when("/uploadexcel",{templateUrl:"templates/login/templates/upload.html",controller:"uploadExcelController"})}]);var dashboardModule=angular.module("dashboardModule",["ngRoute"]);dashboardModule.controller("homeController",["$scope","$localStorage","user","$rootScope","$location","$timeout","$http","api","$window","$interval","appInfo",function(t,n,e,a,i,o,r,c,d,l,u){if("/download"!=i.url().toLowerCase()){if(i.url().indexOf("/~lg/")>=0){var s,_,p=i.url().split("/"),h="dashboard";if(p.length>=4&&(_=p[2],s=p[3],p.length>4&&(h=p[4])),_)return n.set("token",_),n.set("id_app",s),c.init(_),void e.getInfo(function(){i.url("/"+h)})}return n.get("token")?void(("/dashboard"==i.url()||"/"==i.url())&&u.info("/dashboard",function(t){return t?void i.url("/login"):void 0})):(i.url().toLowerCase().indexOf("/login")<0&&i.url().toLowerCase().indexOf("/logout")<0&&(a.w_redirect=i.url()),void i.url("/login"))}}]),dashboardModule.controller("dxdController",["$scope",function(){}]),dashboardModule.controller("adminController",["appInfo","$location",function(t,n){t.info("admin",function(t){return t?void n.url("/login"):void 0})}]),dashboardModule.config(["$routeProvider","$locationProvider","$httpProvider",function(t){t.when("/",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"}).when("/lg/:id_app",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"}).when("/dxd",{templateUrl:"templates/dashboard/templates/dxd.html",controller:"dxdController"}).when("/admin",{templateUrl:"templates/dashboard/templates/admin.html",controller:"adminController"}).when("/dashboard",{templateUrl:"templates/dashboard/templates/db1.html",controller:"homeController"})}]);var appModule=new baseInput("app","app",["name"],"Thông tin đơn vị, doanh nghiệp",{services:function(t){var n={active:function(n){return t.get(server_url+"/api/app/active/"+n)},notaccept:function(n){return t.get(server_url+"/api/app/notaccept/"+n)}};return n},onCondition:function(t){t.$or={create_db_sql:!1,create_db_sql:null}},onView:function(t,n){t.open=function(e){var a=e._id,i=e.active;i||n.service.active(a).success(function(){}).error(function(t){console.error("Không thể kích hoạt: ",t)}),id_app=a,n.$rootScope.app_info=_.find(t.list,function(t){return t._id==a}),n.$rootScope.id_app=a,n.$localStorage.set("id_app",a),n.$rootScope.w_redirect?(w_redirect=n.$rootScope.w_redirect,delete n.$rootScope.w_redirect,n.$location.url(w_redirect)):n.$location.url("/dashboard")},t.auth_google=function(){var e=n.$window.open(server_url+"/auth/google_drive","Google authentication","height=400,width=400"),a=n.$interval(function(){try{if(e.location.href&&e.location.href.indexOf("/auth/google/callback")&&e.document.body.innerHTML&&e.document.body.innerHTML.indexOf("access_token")>=0){var i=JSON.parse(e.document.title);t.update({google_drive_email:i.email,google_drive_token:i.access_token,google_drive_refresh_token:i.refresh_token},function(n){return n?alert(n):void(t.data.google_drive_refresh_token=access_token)}),n.$interval.cancel(a),e.close()}}catch(o){console.log(o)}},500)},t.delete_google_drive=function(){t.update({google_drive_email:"",google_drive_token:"",google_drive_refresh_token:""},function(n){return n?alert(n):void(t.data.google_drive_refresh_token="")})}},has_view:!0});appModule.defaultValues={ngay_dn:new Date(2015,0,1),ngay_ks:new Date(2015,0,1),ngay_ky1:new Date(2015,0,1)},appModule.module.controller("initApp",["$scope","$window","$interval","$http",function(t,n,e,a){a.get(server_url+"/public/province").success(function(n){t.province=n})}]),appModule.init=function(t,n){n("initApp",{$scope:t})},appModule.module.controller("baseAppHomeController",["$scope","$location","$localStorage","$rootScope","app","$window",function(t,n,e,a,i){t.open=function(o,r){r||i.active(o).success(function(){}).error(function(t){console.error("Không thể kích hoạt: ",t)}),id_app=o,a.app_info=_.find(t.list,function(t){return t._id==o}),a.id_app=o,e.set("id_app",o),a.w_redirect?(w_redirect=a.w_redirect,delete a.w_redirect,n.url(w_redirect)):n.url("/dashboard")}}]),appModule.initHomeController=function(t,n){t("baseAppHomeController",{$scope:n})};var initAddEditController=function(t,n){n.addParticipant=function(t){n.participant=void 0,n.data.participants||(n.data.participants=[]);var e=_.find(n.data.participants,function(n){return n.email==t.email_coll});return e?void alert(t.name+" đã tồn tại"):void n.data.participants.push({email:t.email_coll,name:t.name_coll,picture:t.picture_coll,admin:!1})},n.deleteParticipant=function(t){n.data.participants||(n.data.participants=[]),n.data.participants=_.reject(n.data.participants,function(n){return n.email==t})}};appModule.initAddController=function(t,n){initAddEditController(t,n)},appModule.initEditController=function(t,n){initAddEditController(t,n)},appModule.module.controller("appsController",["$scope","$rootScope","$routeParams","$http","user","$location","$modal","app","appInfo",function(t,n,e,a,i,o,r,c,d){d.info("app",function(n){if(!n){var i=e.email,o=server_url+"/api/app/apps/"+i;a.get(o).success(function(n){t.list=n}),t.email=i,t.openProfile=function(t){viewProfile(r,t)},t.addDays=function(t){r.open({templateUrl:"templates/lists/app/templates/add-days.html",controller:["$scope","$modalInstance","user","$location","$rootScope","app","$window",function(n,e,a,i,o,r,c){n.so_ngay=30,n.cancel=function(){e.dismiss("cancel")},n.save=function(){var a={};_.extend(a,t);var i=a.expire_date;i=!i||a.so_ngay_con_lai<=0?new Date:new Date(i),i.setDate(i.getDate()+n.so_ngay),a.expire_date=i,r.update(a._id,a._id,a).success(function(n){_.extend(t,n),e.dismiss("cancel")}).error(function(){c.alert("Không thể thêm ngày sử dụng cho công ty này")})}}],size:"lg"})}}})}]),appModule.module.controller("assignController",["$scope","$rootScope","$routeParams","$http","user","$location","app","appInfo",function(t,n,e,a,i,o,r,c){c.info("app",function(n){if(!n){var i=e.id_app,o=e.email;t.email=o,c.commands(i,function(n,e){if(n)return console.log(n);var r={email:o},c=server_url+"/api/"+i+"/right?q="+JSON.stringify(r);a.get(c).success(function(n){e.crm.input.forEach(function(t){t.module=t.module?t.module:t.path;var e=_.find(n,function(n){return n.module==t.module});if(e)for(var a in e)t[a]=e[a];t.id_app=i,t.email=o}),e.acc.forEach(function(t){var e=t.items;e.forEach(function(t){var e=t.items;e.forEach(function(t){t.module=t.module?t.module:t.path;var e=_.find(n,function(n){return n.module==t.module});if(e)for(var a in e)t[a]=e[a];t.id_app=i,t.email=o})})}),e.report.forEach(function(t){var e=t.items;e.forEach(function(t){t.module=t.module?t.module:t.path;var e=_.find(n,function(n){return n.module==t.module});if(e)for(var a in e)t[a]=e[a];t.id_app=i,t.email=o})}),t.commands=e,t.change=function(t){c=server_url+"/api/"+i+"/right";var n;t._id?(c=c+"/"+t._id,n=a.put(c,t)):n=a.post(c,t),n.success(function(n){for(var e in n)t[e]=n[e]}).error(function(n){console.log(t),alert(JSON.stringify(n))})},t.selectAllRight=function(n){n.add=n.sel,n.update=n.sel,n.delete=n.sel,n.view=n.sel,t.change(n)}}).error(function(){console.log(c)})})}})}]),appModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/assign/:id_app/:email",{templateUrl:"templates/lists/app/templates/assign.html",controller:"assignController"}).when("/apps/:email",{templateUrl:"templates/lists/app/templates/apps.html",controller:"appsController"})}]);var colleagueModule=new baseInput("colleague","colleague",["email","email_owner"],"Danh sách đồng nghiệp",{services:function(t){return{active:function(n){return t.get(server_url+"/api/colleague/active/"+n)},notaccept:function(n){return t.get(server_url+"/api/colleague/notaccept/"+n)}}}});colleagueModule.module.controller("basecolleagueHomeController",["$scope","$window","$rootScope","colleague","$modal",function(t,n,e,a,i){t.unLink=function(t){a.notaccept(t).success(function(){n.location.reload()}).error(function(){alert("Error")})},t.active=function(t){a.active(t).success(function(){n.location.reload()}).error(function(){alert("Error")})},t.sendMessage=function(t){messageModule.quickadd(i,function(){},{email_receiver:t})},t.openProfile=function(t){viewProfile(i,t)}}]),colleagueModule.initHomeController=function(t,n){t("basecolleagueHomeController",{$scope:n})},colleagueModule.initAddController=function(t,n){n.data.content="Hãy chấp nhận lời mời tham gia vào mạng lưới của tôi"};var notificationModule=new baseInput("notification","notification",["email_owner","email_sender","email_receiver","content","title"],"Thông báo",{onView:function(t,n){t.data.content=t.data.content.replace(server_url,""),t.data.read||n.service.update(id_app,t.data._id,{_id:t.data._id,read:!0}).success(function(){t.data.read=!0}).error(function(t){console.log(t)}),t.condition={read:!1},t.filter=function(){n.$rootScope.nextTick(function(){t.$emit("$dataChangeStart"),n.service.load(id_app,{condition:t.condition,limit:50}).success(function(n){t.notifications=n,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.filter(),t.viewNotification=function(n){t.data=n,t.notifications=_.reject(t.notifications,function(t){return t._id==n._id})},t.delete=function(e){confirm("Bạn có chắc chắn xóa ghi chú này không?")&&n.service.delete(id_app,e._id).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})}).error(function(t){alert(t)})},t.markRead=function(e){e.read=!0,n.service.update(id_app,e._id,{_id:e._id,read:!0}).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})}).error(function(t){alert(t)})}}});notificationModule.module.factory("notification",["$http",function(t){fields_find=["email_receiver","email_owner","email_sender","content","title"];var n={list:function(n,e,a,i,o,r){var c=server_url+"/api/notification?t=1";if(1==i&&(c+="&count=1"),o&&(c=c+"&page="+o.toString()),r&&(c=c+"&limit="+r.toString()),angular.isObject(e)){var d=JSON.stringify(e);c=c+"&q="+d}else if(e&&""!=e.trim()&&fields_find&&0!=fields_find.length){var l="";fields_find.forEach(function(t){l=""==l?t+"="+e:l+"&"+t+"="+e}),""!=l&&(c=c+"&"+l)}return a&&(c=c+"&fields="+a),t.get(c)},get:function(n,e){return t.get(server_url+"/api/notification/"+e)},create:function(n,e){return t.post(server_url+"/api/notification",e)},update:function(n,e,a){return t.put(server_url+"/api/notification/"+e,a)},"delete":function(n,e){return t.delete(server_url+"/api/notification/"+e)},active:function(n){return t.get(server_url+"/api/notification/active/"+n)},notaccept:function(n){return t.get(server_url+"/api/notification/notaccept/"+n)}};return n.load=function(t,e){return e?n.list(t,e.condition,e.fields,e.count,e.page,e.limit):n.list(t)},n}]),notificationModule.module.directive("dbNotify",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/notification/templates/db.html",controller:["$scope","notification","$rootScope","$location","$modal","socket","appInfo","nodeWebkit",function(t,n,e,a,i,o,r){r.info("notification",function(i){i||(t.notifications=[],t.now=new Date,t.token=e.token,t.server_url=server_url,t.app_info=e.app_info,t.condition={read:!1},t.filter=function(){e.nextTick(function(){t.$emit("$dataChangeStart"),n.load(id_app,{condition:t.condition,limit:10}).success(function(n){t.notifications=n,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.viewNotification=function(t){a.url("notification/view/"+t._id+"?redirect=dashboard")},t.delete=function(e){confirm("Bạn có chắc chắn xóa ghi chú này không?")&&n.delete(id_app,e._id).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})}).error(function(t){alert(t)})},t.markRead=function(e){e.read=!0,n.update(id_app,e._id,e).success(function(){t.notifications=_.reject(t.notifications,function(t){return t._id==e._id})}).error(function(t){alert(t)})},o.on("notify:new",function(e){n.get(id_app,e).success(function(n){var a=_.find(t.notifications,function(t){return t._id==e});a||(n.is_new=!0,t.notifications.push(n))}).error(function(t){console.error("Can't get notification\n"+t)})}),t.filter({}))})}],link:function(){}}});var messageModule=new baseInput("message","message",["email_owner","email_receiver","email_sender","content"],"Tin nhắn",{services:function(t){var n={list:function(n,e,a,i,o,r){var c=["email_owner","email_receiver","email_sender","content"],d=server_url+"/api/message/colleague/list?t=1";if(1==i&&(d+="&count=1"),o&&(d=d+"&page="+o.toString()),r&&(d=d+"&limit="+r.toString()),angular.isObject(e)){var l=JSON.stringify(e);d=d+"&q="+l}else if(e&&""!=e.trim()&&c&&0!=c.length){var u="";c.forEach(function(t){u=""==u?t+"="+e:u+"&"+t+"="+e}),""!=u&&(d=d+"&"+u)}return a&&(d=d+"&fields="+a),t.get(d)},chat:function(n,e){return t.get(server_url+"/api/message/chat/"+e)},get:function(n,e){return t.get(server_url+"/api/message/"+e)},create:function(n,e){return t.post(server_url+"/api/message",e)},update:function(n,e,a){return t.put(server_url+"/api/message/"+e,a)},"delete":function(n,e){return t.delete(server_url+"/api/message/"+e)}};return n.load=function(t,e){return e?n.list(t,e.condition,e.fields,e.count,e.page,e.limit):n.list(t)},n}});messageModule.module.controller("baseMessageChatController",["$scope","$location","$routeParams","$rootScope","message","$window","$modal","socket","user","appInfo",function(t,n,e,a,i,o,r,c,d,l){l.info("message",function(n){if(!n){var o=(a.user.email,e.email);d.getProfile(o,function(n,e){return n?alert(n):void(t.profile=e)}),c.on("message",function(n){t.profile&&(n.picture_sender=t.profile.picture,n.name_sender=t.profile.name),t.msgs.push(n)}),t.data={},t.data.email_receiver=o,i.chat(void 0,o).success(function(n){t.msgs=n}),t.send=function(){i.create(void 0,t.data).success(function(n){t.data.content="",t.msgs.push(n)}).error(function(t){alert(t)})},t.enter2send=function(n){13==n.keyCode&&t.send()},t.deleteMsg=function(n){confirm("Có chắc chắn xóa tin nhắn này không?")&&i.delete(null,n).success(function(){t.msgs=_.reject(t.msgs,function(t){return t._id==n})}).error(function(){alert("Không thể xóa tin  nhắn này")})},t.openProfile=function(t){messageModule.viewProfile(r,t)}}})}]),messageModule.module.controller("baseMessageHomeController",["$scope","$location","$routeParams","$rootScope","message","$window",function(t,n){t.chat=function(t){var e=t.email_coll;n.url("message/chat/"+e)}}]),messageModule.initHomeController=function(t,n){t("baseMessageHomeController",{$scope:n})},messageModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/message/chat/:email",{templateUrl:"templates/lists/message/templates/edit.html",controller:"baseMessageChatController"})}]);var usersmanagementModule=new baseInput("users","users",["email","name"],"Quản lý người dùng"),rptModule=new baseInput("rpt","rpt",["ma_cn","ten_mau_in"],"Quản lý mẫu in",{onAdd:function(t,n){var e=n.$location.search(),a=e.ma_cn;!e.redirect&&a&&n.$location.search("redirect","/rpt?ma_cn="+a)},onEdit:function(t,n){var e=t.data.ma_cn;n.$location.search().redirect||n.$location.search("redirect","/rpt?ma_cn="+e)}});rptModule.module.controller("initrpt",["$scope","$window","$interval",function(t,n,e){t.changeFile=function(){var a=n.open("#uploadexcel","Upload file","width=600,height=300"),i=e(function(){"success"==a.document.body.innerHTML&&(t.data.file_mau_in=a.document.title,a.close(),e.cancel(i))},100)}}]),rptModule.init=function(t,n){n("initrpt",{$scope:t})};var parameterModule=new baseInput("parameter","parameter",["name"],"Tham số mẫu in",{onAdd:function(t,n){var e=n.$location.search(),a=e.id_rpt;!e.redirect&&a&&n.$location.search("redirect","/parameter?id_rpt="+a),t.data.type="S"},onEdit:function(t,n){var e=t.data.id_rpt;n.$location.search().redirect||n.$location.search("redirect","/parameter?id_rpt="+e)},onLoading:function(t,n){var e=n.$location.search(),a=e.id_rpt;n.$http.get(server_url+"/api/"+id_app+"/rpt/"+a).success(function(n){n&&(t.sub_title=n.ten_mau_in)}).error(function(){})}}),commentModule=new baseInput("comment","comment",["content","title"],"Nhận xét, góp ý",{has_view:!0,onCondition:function(t){t.is_reply=!1,t.id_product=null},onView:function(t,n){var e=t.data;t.replies=[e];var a={is_reply:!0,id_topic:e._id};n.service.load(id_app,{condition:a}).success(function(n){n.forEach(function(n){t.replies.push(n)})}).error(function(t){console.log(t)}),t.reply=function(){var a={content:t.content,is_reply:!0,id_topic:e._id,title:e.title};n.service.create(id_app,a).success(function(n){t.replies.push(n),t.content=""}).error(function(t){console.log(t)})},t.quickedit=function(t){commentModule.quickedit(n.$modal,t._id,function(n){_.extend(t,n)})},t.deleteReply=function(e){confirm("Có chắc chắn xóa không?")&&n.service.delete(id_app,e._id).success(function(){t.replies=_.reject(t.replies,function(t){return e._id==t._id})}).error(function(t){var n;n=_.isObject(t)?JSON.stringify(t):t,alert(n.indexOf("Lỗi:")>=0?n:"Không thể xóa")})}}});commentModule.module.directive("comment",function(){return{restrict:"E",scope:{link:"=",user:"=",title:"@"},templateUrl:"templates/lists/comment/templates/directive.html",link:function(t,n,e){e.user||console.error("comment directive require 'user' attribute"),e.link||console.error("comment directive require 'link' attribute")},controller:["$scope","$http","$window","$modal","$rootScope","$location","appInfo",function(t,n,e,a,i,o,r){r.info("comment",function(r,c,d){r||(t.token=i.token,t.server_url=server_url,t.openProfile=function(t){viewProfile(a,t)},t.getMembers=function(){i.app_info&&i.app_info.participants&&(members=[],d=i.app_info,d.participants&&(members=_.pluck(d.participants,"email")),members.push(d.user_created),t.members=members)},t.deleteComment=function(a){e.confirm("Bạn có chắc chắn xóa nhận xét này không?")&&n.delete(server_url+"/api/comment/"+a._id).success(function(){t.comments=_.reject(t.comments,function(t){return t._id==a._id})}).error(function(t){t&&e.alert(t)})},t.editComment=function(t){commentModule.quickedit(a,t._id,function(n){_.extend(t,n)})},t.sendComment=function(a){t.title||(t.title="Comment");var i={id_product:t.idLink,title:t.title,content:a,user_created_obj:t.link.user_created,is_reply:!0};i.url_topic=o.absUrl(),t.link.attends&&(i.attends=t.link.attends),n.post(server_url+"/api/comment",i).success(function(n){t.content="",n&&(t.comments||(t.comments=[]),t.comments.push(n))}).error(function(t){t&&e.alert(t)})},t.load=function(){n.get(server_url+"/api/comment?q={id_product:'"+t.idLink+"'}").success(function(n){t.comments=n}).error(function(){})},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load(),t.getMembers())},!0))})}]}});var versioninfoModule=new baseInput("versioninfo","versioninfo",["os","app","title"],"Quản lý phiên bản các chương trình"),dmkhModule=new baseInput("dmkh","customer",["ma_kh","ten_kh","dia_chi","dien_thoai","fax","email"],"Khách hàng",{has_view:!0,onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$modal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{id_kh:t.data._id,ten_kh:t.data.ten_kh})}},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'CUSTOMER'}").success(function(n){t.groups=n})}),t.btn3_click=function(){var e=[];t.list.forEach(function(t){t.email&&t.sel&&e.push({name:t.ten_kh,address:t.email})}),e.length>0?n.$location.url("mailschedule/add?to="+JSON.stringify(e)+"&redirect="+n.$location.url()):alert("Bạn phải chọn ít nhất một liên lạc")},t.searchAVR=function(){if(t.renderCompleted){t.filter={};var n,e,a=new Date;if("d"==t.time&&(n=new Date,e=new Date),"w"==t.time)var i=a.getDate()-a.getDay()+1,n=new Date(a.setDate(i)),e=new Date(a.setDate(n.getDate()+6));if("m"==t.time&&(n=a,n.setDate(1),e=new Date(n.getFullYear(),n.getMonth()+1,0)),"3m"==t.time){var o=a.getMonth(),r=1;r=3>o?0:6>o?3:6>o?6:9,n=new Date(a.getFullYear(),r,1),e=new Date(a.getFullYear(),r+3,0)}"y"==t.time&&(n=new Date(a.getFullYear(),0,1),e=new Date(a.getFullYear(),11,31)),n&&e&&(n.setHours(0),n.setMinutes(0),n.setSeconds(0),e.setHours(23),e.setMinutes(59),e.setSeconds(0),t.filter.date_created={$gte:n,$lte:e}),t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_kh?t.filter.nh_kh=t.nh_kh:delete t.filter.nh_kh,t.advCondition.ten_kh?t.filter.$or=[{ten_kh:{$regex:t.advCondition.ten_kh,$options:"i"}},{ma_kh:{$regex:t.advCondition.ten_kh,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_kh,$options:"i"}},{email:{$regex:t.advCondition.ten_kh,$options:"i"}}]:delete t.filter.$or,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.advCondition.ma_so_thue?t.filter.ma_so_thue={$regex:t.advCondition.ma_so_thue,$options:"i"}:delete t.filter.ma_so_thue,t.search()}},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_kh=n._id,t.searchAVR()},t.reportByTime=function(n){t.time=n,t.searchAVR()}}}),lienheModule=new baseInput("lienhe","lienhe",["ten_lien_he","dia_chi","dien_thoai","fax","email"],"Danh bạ",{has_view:!0,onLoading:function(t,n){n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'CONTACT'}").success(function(n){t.groups=n})}),t.advCondition={},t.searchAVR=function(){t.renderCompleted&&(t.filter={},t.nh_lh?t.filter.nh_lh=t.nh_lh:delete t.filter.nh_lh,t.advCondition.ten_lien_he?t.filter.$or=[{ten_lien_he:{$regex:t.advCondition.ten_lien_he,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_lien_he,$options:"i"}},{email:{$regex:t.advCondition.ten_lien_he,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.search())
},t.searchGroup=function(n){t.nh_lh=n._id,t.searchAVR()},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.btn3_click=function(){var e=[];t.list.forEach(function(t){t.email&&t.sel&&e.push({name:t.ten_lien_he,address:t.email})}),e.length>0?n.$location.url("mailschedule/add?to="+JSON.stringify(e)+"&redirect="+n.$location.url()):alert("Bạn phải chọn ít nhất một liên lạc")}},onView:function(t,n){t.addCustomer=function(){dmkhModule.quickadd(n.$modal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).success(function(n){_.extend(t.data,n)}))})}}}),noteModule=new baseInput("note","note",["title"],"Ghi chú",{has_view:!0});noteModule.module.directive("note",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/note/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","note","appInfo","$rootScope",function(t,n,e,a,i,o,r,c){r.info("note",function(n){n||(t.server_url=server_url,t.token=c.token,t.addNote=function(){noteModule.quickadd(i,function(n){t.notes.push(n)},{id_link:t.idLink})},t.saveNote=function(n){t.$emit("$dataSaveStart");var e={content:n,id_link:t.idLink};o.create(id_app,e).success(function(n){t.notes.push(n),t.content="",t.$emit("$dataSaveSuccess")}).error(function(n){console.log(n),t.$emit("$dataSaveError")})},t.viewNote=function(t){e.url("/note/view/"+t._id+"?redirect="+e.url())},t.deleteNote=function(n){a.confirm("Bạn có chắc chắn xóa ghi chú này không?")&&o.delete(id_app,n._id).success(function(){t.notes=_.reject(t.notes,function(t){return t._id==n._id})}).error(function(t){t&&a.alert(t)})},t.editNote=function(t){noteModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.load=function(){o.load(id_app,{condition:{id_link:t.idLink}}).success(function(n){t.notes=n}).error(function(t){t&&a.alert(t)})},t.openProfile=function(t){viewProfile(i,t)},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load())},!0))})}],link:function(t,n,e){e.link||console.error("note directive require 'link' attribute")}}});var taskModule=new baseInput("task","task",["ten_cv","mieu_ta"],"Công việc",{has_view:!0,onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.attends=[t.data.phu_trach],t.data.start_date=new Date,t.data.repeat=0,t.data.priority=1,t.data.progress=0},onEdit:function(){},onView:function(t,n){t.data.attendInfos=[],t.data.attends&&t.data.attends.forEach(function(e){var a=_.find(n.$rootScope.members,function(t){return t.email==e});a&&t.data.attendInfos.push(a)}),t.complete=function(){t.data.progress=2,n.service.update(id_app,t.data._id,t.data).success(function(){}).error(function(t){t&&n.$window.alert(t)})},t.addContact=function(){lienheModule.quickadd(n.$modal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$modal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).success(function(n){_.extend(t.data,n)}))})},t.addProject=function(){dmdtModule.quickadd(n.$modal,function(e){e.collection_name="dmdt",t.addLink(e,"ten_dt"),t.data.id_dt||(t.data.id_dt=e._id,n.service.update(id_app,t.data._id,t.data).success(function(n){_.extend(t.data,n)}))})}},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'TASK'}").success(function(n){t.groups=n})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.priorities=[{value:1,text:"Ưu tiên cao",sel:!0},{value:2,text:"Ưu tiên trung bình",sel:!0},{value:3,text:"Ưu tiên thấp",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[],e=[];t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.priorities.forEach(function(t){t.sel&&e.push(t.value)}),t.filter.progress={$in:n},t.filter.priority={$in:e},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_cv?t.filter.nh_cv=t.nh_cv:delete t.filter.nh_cv;var a,i,o=new Date,r=t.time;if("d"==r&&(a=new Date,i=new Date),"w"==r)var c=o.getDate()-o.getDay()+1,a=new Date(o.setDate(c)),i=new Date(o.setDate(a.getDate()+6));if("m"==r&&(a=o,a.setDate(1),i=new Date(a.getFullYear(),a.getMonth()+1,0)),"3m"==r){var d=o.getMonth(),l=1;l=3>d?0:6>d?3:6>d?6:9,a=new Date(o.getFullYear(),l,1),i=new Date(o.getFullYear(),l+3,0)}"y"==r&&(a=new Date(o.getFullYear(),0,1),i=new Date(o.getFullYear(),11,31)),a&&i?(a.setHours(0),a.setMinutes(0),a.setSeconds(0),i.setHours(23),i.setMinutes(59),i.setSeconds(0),t.filter.start_date={$gte:a,$lte:i}):delete t.filter.start_date,t.advCondition.ten_cv?t.filter.$or=[{ten_cv:{$regex:t.advCondition.ten_cv,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_cv,$options:"i"}},{location:{$regex:t.advCondition.ten_cv,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.ten_dt?t.filter.ten_dt=t.advCondition.ten_dt:delete t.filter.ten_dt,t.advCondition.priority&&(t.filter.priority=t.advCondition.priority),t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.advCondition.start_date&&(t.filter.start_date={$gte:t.advCondition.start_date}),t.advCondition.due_date?t.filter.due_date={$lte:t.advCondition.due_date}:delete t.filter.due_date,t.search()}},t.reportByTime=function(n){t.time=n,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVG()},t.searchGroup=function(n){t.nh_cv=n._id,t.searchAVG()},t.$watch("priorities",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).success(function(n){_.extend(t,n)}).error(function(t){t&&alert(t)})},t.enter=function(n){13==n.keyCode&&t.searchAVG()}}});taskModule.module.directive("task",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/task/templates/directive.html",controller:["$scope","$http","$window","$location","$modal","appInfo",function($scope,$http,$window,$location,$modal,appInfo){appInfo.info("task",function(e,u,a){if(!e){$scope.server_url=server_url,$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="task:'ten_cv'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.list=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).success(function(n){_.extend(e,n),e.obj=t,e.title=t.title,$scope.list.push(e)}).error(function(){})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).success(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})}).error(function(){})},$scope.getItem=function(t,n,e){$scope.addLink(t,e)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),taskModule.quickadd($modal,function(t){t.collection_name="task",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="task/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$window.confirm("Bạn có chắc chắn xóa không?")&&$http.delete(server_url+"/api/"+id_app+"/task/"+t._id).success(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.edit=function(t){taskModule.quickedit($modal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("task directive require attributes:link,collection")}}}),taskModule.module.directive("dbTask",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/task/templates/db.html",controller:["$scope","task","$rootScope","$location","appInfo","socket","nodeWebkit",function(t,n,e,a,i,o,r){i.info("task",function(i){i||(t.token=e.token,t.server_url=server_url,t.now=new Date,t.options={my_job:!0,overdue:!1,progress_0:!0,progress_1:!0,progress_2:!1,progress_3:!0,progress_4:!0},t.getCondition=function(){if(t.condition={status:!0},t.options.my_job&&(t.condition.$or=[{phu_trach:e.user.email},{attends:e.user.email}]),t.options.overdue){var n=new Date;t.condition.due_date={$lt:n}}t.condition.progress={$in:[]},t.options.progress_0&&t.condition.progress.$in.push(0),t.options.progress_1&&t.condition.progress.$in.push(1),t.options.progress_2&&t.condition.progress.$in.push(2),t.options.progress_3&&t.condition.progress.$in.push(3),t.options.progress_4&&t.condition.progress.$in.push(4)},t.app_info=e.app_info,t.filter=function(e){async.nextTick(function(){t.$emit("$dataChangeStart"),t.getCondition(),e&&_.extend(t.condition,e),n.load(id_app,{condition:t.condition,limit:10}).success(function(n){t.dscv=n,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.complete=function(t){n.update(id_app,t._id,{progress:2}).success(function(n){_.extend(t,n)}).error(function(t){t&&alert(t)})},t.cancel=function(e){n.update(id_app,e._id,{status:!1}).success(function(){t.dscv&&(t.dscv=_.reject(t.dscv,function(t){return t._id==e._id}))}).error(function(t){t&&alert(t)})},t.viewTask=function(t){a.url("task/view/"+t._id)},t.$watch("options",function(n){n&&t.app_info&&t.filter({})},!0),o.on("task:new",function(e){t.dscv||(t.dscv=[]),n.get(id_app,e).success(function(n){var a=_.find(t.dscv,function(t){return t._id==e});a||(n.is_new=!0,r.notification("Bạn có công việc mới"),t.dscv.push(n))})}),t.filter({}))})}],link:function(){}}});var groupModule=new baseInput("group","group",["group_name"],"Nhóm"),fileModule=new baseInput("file","file",["mieu_ta","ten_file_goc"],"Quản lý tệp dữ liệu",{onLoading:function(t,n){addFile=function(){var e=n.$window.open("#file/addfile","Add File","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=300"),a=0;stop=n.$interval(function(){if("OK"==e.document.title){n.$interval.cancel(stop),stop=void 0;var i=JSON.parse(e.document.body.innerText);return t.list.push(i),void e.close()}return"ERROR"==e.document.title?(n.$interval.cancel(stop),stop=void 0,alert(e.document.body.innerText),void e.close()):(a+=500,void(a>3e5&&stop&&(n.$interval.cancel(stop),stop=void 0)))},500)}}});fileModule.module.controller("addFileController",["$scope","$localStorage","user","$rootScope","$location","app",function(t,n,e,a,i){a.hide_nav=!0,t.data={},_.extend(t.data,i.search()),t.action=server_url+"/api/"+n.get("id_app")+"/file?access_token="+n.get("token")}]),fileModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/file/addfile",{templateUrl:"templates/lists/file/templates/form-add-file.html",controller:"addFileController"})}]),fileModule.module.directive("fileUpload",function(){return{restrict:"A",scope:{list:"=",json:"="},controller:["$scope","$http","$localStorage","$rootScope",function(t,n,e){t.upload=function(a,i,o){t.$emit("$fileUploadStart"),o||(o={}),o.return="JSON",n({method:"POST",url:server_url+"/api/"+e.get("id_app")+"/file",headers:{"Content-Type":void 0},transformRequest:function(t){var n=new FormData;if(t.data)for(var e in t.data)n.append(e,t.data[e]);return n.append("file",t.fileRaw),n},data:{data:o,fileRaw:a}}).success(function(n){t.$emit("$fileUploadSuccess"),i(null,n)}).error(function(n){t.$emit("$fileUploadError"),i(n)})}}],link:function(t,n){n.bind("change",function(e){var a=e.target.files;async.map(a,function(n,e){t.upload(n,function(n,a){return n?e(n):(t.list||(t.list=[]),t.list.push(a),void e())},t.json)},function(t){return t?alert(t):void n.val("")})})}}}),fileModule.module.directive("imageUpload",function(){return{restrict:"A",scope:{model:"=",modelThumb:"=",json:"=",ngUploaded:"&",folder:"@"},controller:["$scope","$http","$localStorage",function(t,n){t.upload=function(e,a,i){t.$emit("$fileUploadStart"),i||(i={}),i.return="JSON",t.folder||(t.folder="products"),n({method:"POST",url:server_url+"/api/uploadfile?json=1&folder="+t.folder,headers:{"Content-Type":void 0},transformRequest:function(t){var n=new FormData;if(t.data)for(var e in t.data)n.append(e,t.data[e]);return n.append("file",t.fileRaw),n},data:{data:i,fileRaw:e}}).success(function(n){t.$emit("$fileUploadSuccess"),a(null,n)}).error(function(n){t.$emit("$fileUploadError"),a(n)})}}],link:function(t,n){n.bind("change",function(e){var a=e.target.files;async.map(a,function(n,e){t.upload(n,function(n,a){return n?e(n):(t.model=a.image,t.modelThumb=a.thumb,t.onUploaded&&t.onUploaded({$image:a.image,$thumb:a.thumb}),void e())},t.json)},function(t){return t?alert(t):void n.val("")})})}}}),fileModule.module.directive("file",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/file/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","$interval","appInfo","$rootScope",function(t,n,e,a,i,o,r,c){r.info("file",function(r){r||(t.token=c.token,t.id_app=id_app,t.server_url=server_url,t.addfile=function(){var n=a.open("#file/addfile?id_link="+t.link._id,"Add File","directories=no,titlebar=no,toolbar=no,location=no,status=no,menubar=no,scrollbars=no,resizable=no,width=500,height=300"),e=0;stop=o(function(){if("OK"==n.document.title){o.cancel(stop),stop=void 0;var a=JSON.parse(n.document.body.innerText);return t.files.push(a),void n.close()}return"ERROR"==n.document.title?(o.cancel(stop),stop=void 0,alert(n.document.body.innerText),void n.close()):(e+=500,void(e>3e5&&stop&&(o.cancel(stop),stop=void 0)))},500)},t.deletefile=function(e){a.confirm("Bạn có chắc chắn xóa file này không?")&&n.delete(server_url+"/api/"+id_app+"/file/"+e._id).success(function(){t.files=_.reject(t.files,function(t){return t._id==e._id})}).error(function(t){t&&a.alert(t)})},t.load=function(){n.get(server_url+"/api/"+id_app+"/file?q={id_link:'"+t.idLink+"'}").success(function(n){t.files=n}).error(function(t){t&&a.alert(t)})},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load(),t.dataLink={id_link:t.idLink,collection_link:t.link.collection_name},t.dataLink.url_topic=server_url+"/#"+e.url(),t.dataLink.title_topic=c.title_view)},!0),t.openProfile=function(t){viewProfile(i,t)})})}],link:function(t,n,e){e.link||console.error("comment directive require 'link' attribute")}}});var mailaccountModule=new baseInput("mailaccount","mailaccount",["username","fullname"],"Tài khoản email",{has_view:!1,onAdd:function(t){t.data.smtp={ssl:!0,port:465},t.data.imap={tls:!0,port:993},t.$watch("data.username",function(n){if(n&&n.indexOf("@")>0&&n.indexOf(".")>0){var e=n.split("@")[1];t.data.smtp.host="smtp."+e,t.data.imap.host="imap."+e}})}});mailaccountModule.module.directive("mailAccount",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailaccount/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","mailaccount","appInfo","socket",function(t,n,e,a,i,o,r,c){r.info("mailbox",function(n){n||(t.server_url=server_url,t.addmailaccount=function(){mailaccountModule.quickadd(i,function(n){t.mailaccounts.push(n)},{id_link:t.idLink})},t.viewmailaccount=function(t){e.url("/mailaccount/view/"+t._id+"?redirect="+e.url())},t.connect=function(t){t.status_code=9,t.status_string="Đang xử lý",t.status=!0,o.update(id_app,t._id,t).success(function(){})},t.disconnect=function(t){t.status_code=9,t.status_string="Đang xử lý",t.status=!1,o.update(id_app,t._id,{status:!1,status_code:0,status_string:"Không kết nối"}).success(function(){})},t.deletemailaccount=function(n){a.confirm("Bạn có chắc chắn xóa tài khoản này không?")&&o.delete(id_app,n._id).success(function(){t.mailaccounts=_.reject(t.mailaccounts,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})},t.editmailaccount=function(t){mailaccountModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.load=function(){o.load(id_app,{condition:{id_link:t.idLink}}).success(function(n){t.mailaccounts=n}).error(function(t){a.alert(t)})},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.load())},!0),c.on("email:disconnected",function(n){if(console.log("ngat ket noi"),t.mailaccounts){var e=_.find(t.mailaccounts,function(t){return t._id==n});e&&(e.error=null,e.status_code=0,e.status_string="Đã ngắt kết nối")}}),c.on("email:connected",function(n){if(console.log("ket noi"),t.mailaccounts){var e=_.find(t.mailaccounts,function(t){return t._id==n});e&&(e.error=null,e.status_code=1,e.status_string="Đang kết nối")}}),c.on("email:error",function(n){if(t.mailaccounts){var e=_.find(t.mailaccounts,function(t){return t._id==n});e&&(e.error=null,e.status_code=-1,e.status_string="Không thể kết nối với máy chủ mail")}}))})}],link:function(t,n,e){e.link||console.error("mail-account directive require 'link' attribute")}}});var mailbox_tab_current="received";mailaccountModule.module.controller("mailboxController",["$scope","$rootScope","$location","$modal","appInfo",function(t,n,e,a,i){i.info("mailbox",function(n,e){n||(t.current_user=e,t.add=function(){mailscheduleModule.quickadd(a,function(n){t.mailScheduleAdded=n,t.selectTab("schedule")})},t.selectTab=function(n){mailbox_tab_current=n,t.tab_active_schedule="schedule"==mailbox_tab_current,t.tab_active_account="account"==mailbox_tab_current,t.tab_active_template="template"==mailbox_tab_current,t.tab_active_received="received"==mailbox_tab_current,t.tab_active_sent="sent"==mailbox_tab_current,t.tab_active_schedule||t.tab_active_account||t.tab_active_template||t.tab_active_sent||(t.tab_active_received=!0)},t.selectTab(mailbox_tab_current))})}]),mailaccountModule.module.config(["$routeProvider","$locationProvider",function(t){t.when("/mailbox",{templateUrl:"templates/lists/mailaccount/templates/mailbox.html",controller:"mailboxController"})}]);var mailreceivedModule=new baseInput("mailreceived","mailreceived",["subject","small_text"],"Email đã nhận",{has_view:!0,onView:function(t,n){var e={_id:t.data._id,read:!0};n.service.update(id_app,t.data._id,e).success(function(n){_.extend(t.data,n)}).error(function(t){n.$window.alert(t)}),t.createTask=function(){taskModule.quickadd(n.$modal,function(n){n.collection_name="task",t.addLink(n,"ten_cv")},{ten_cv:t.data.subject,mieu_ta:t.data.mail.html})},t.createContact=function(){lienheModule.quickadd(n.$modal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{ten_lien_he:t.data.from[0].name,email:t.data.from[0].address})},t.createCustomer=function(){dmkhModule.quickadd(n.$modal,function(n){n.collection_name="dmkh",t.addLink(n,"ten_kh")},{ten_kh:t.data.from[0].name,email:t.data.from[0].address})},t.reply=function(){var e=t.data.from,a=(t.data.to,"Trả lời: "+t.data.subject),i=t.data.mail.html.toString(),o="<div><br/>--lúc "+t.data.date_created.toLocaleString()+" <b>"+t.data.from[0].name+"&lt;"+t.data.from[0].address+"&gt; </b> đã viết--<br/></div><blockquote>"+i+"</blockquote>";mailscheduleModule.quickadd(n.$modal,function(){},{to:e,subject:a,use_template:!1,mail:{html:o},send_type:0,repeat:0})}}}),mailreceived_current_page=1;mailreceivedModule.module.directive("mailReceived",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailreceived/templates/directive.html",controller:["$scope","$rootScope","$http","$location","$window","$modal","mailreceived","socket","appInfo",function(t,n,e,a,i,o,r,c,d){d.info("mailreceived",function(n){n||(t.server_url=server_url,t.location=a.url(),t.current_page=mailreceived_current_page,t.pageChanged=function(n){t.current_page=n,mailreceived_current_page=n},t.condition={txtsearch:"",account_id:""},t.viewmailreceived=function(t){a.url("/mailreceived/view/"+t._id+"?redirect="+a.url())},t.deletemailreceived=function(n){i.confirm("Bạn có chắc chắn xóa email này không?")&&r.delete(id_app,n._id).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==n._id})}).error(function(t){i.alert(t)})},t.service=r,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,read,account_id,attachments",t.search=function(){var n={};t.condition.account_id&&(n.account_id=t.condition.account_id),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailreceiveds){t.isSelectAll=!t.isSelectAll;for(var n=0;n<t.mailreceiveds.length;n++){var e=t.mailreceiveds[n];e.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailreceiveds)return!1;for(var n=0;n<t.mailreceiveds.length;n++){var e=t.mailreceiveds[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailreceiveds&&i.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var n=_.filter(t.mailreceiveds,function(t){return t.sel});n.forEach(function(n){r.delete(id_app,n._id).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==n._id})}).error(function(t){i.alert(t)})})}},t.linkSelected=function(){i.alert("Chức năng này đang được xây dựng")},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search())},!0))})}],link:function(t,n,e){e.link||console.error("mail-received directive require 'link' attribute")}}}),mailreceivedModule.module.directive("dbInbox",function(){return{restrict:"E",scope:{},templateUrl:"templates/lists/mailreceived/templates/db.html",controller:["$scope","mailreceived","$rootScope","$location","$modal","socket","appInfo","nodeWebkit",function(t,n,e,a,i,o,r,c){r.info("mailreceived",function(r){r||(t.now=new Date,t.app_info=e.app_info,t.condition={read:null},t.filter=function(){e.nextTick(function(){t.$emit("$dataChangeStart"),n.load(id_app,{condition:t.condition,limit:10}).success(function(n){t.mailreceiveds=n,t.$emit("$dataChangeSuccess")}).error(function(){t.$emit("$dataChangeError")})})},t.viewMail=function(t){a.url("mailreceived/view/"+t._id+"?redirect=dashboard")},t.delete=function(e){confirm("Bạn có chắc chắn xóa email này không?")&&n.delete(id_app,e._id).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==e._id})}).error(function(t){alert(t)})},t.markRead=function(e){n.update(id_app,e._id,{_id:e._id,read:!0}).success(function(){t.mailreceiveds=_.reject(t.mailreceiveds,function(t){return t._id==e._id})}).error(function(t){alert(t)})},t.createTask=function(n){taskModule.quickadd(i,function(n){n.collection_name="task",t.addLink(n,"ten_cv")},{ten_cv:n.subject,mieu_ta:n.mail.html})},t.createContact=function(n){lienheModule.quickadd(i,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{ten_lien_he:n.from[0].name,email:n.from[0].address})},t.getEmail=function(e){t.mailreceiveds||(t.mailreceiveds=[]),n.load(id_app,{condition:{_id:e}}).success(function(n){if(1==n.length){n[0].is_new=!0;var a=_.find(t.mailreceiveds,function(t){return t._id==e});a||(t.mailreceiveds.push(n[0]),c.notification("Bạn có email mới"))}}).error(function(t){$window.alert(t)})},o.on("email",function(n){t.getEmail(n)}),t.filter({}))})}],link:function(){}}});var mailsentModule=new baseInput("mailsent","mailsent",["subject","small_text"],"Email đã gửi",{has_view:!0,onAdd:function($scope,options){$scope.data.to=$scope.data.to?eval($scope.data.to):[],$scope.data.html="",$scope.selectContact=function(t){var n={id:t._id,name:t.ten_lien_he,address:t.email},e=_.find($scope.data.to,function(t){return t.id==n.id});e||$scope.data.to.push(n),$scope.ten_lien_he="",$scope.email=""},$scope.removeContact=function(t){$scope.data.to=_.reject($scope.data.to,function(n){return _.isEqual(t,n)})},$scope.selectTemplate=function(t){t&&t.mail&&($scope.data.subject=t.subject,$scope.data.mail.html=t.mail.html)},$scope.title="Soạn email"},onEdit:function(t){t.data.to||(t.data.to=[]),t.selectContact=function(n){var e={id:n._id,name:n.ten_lien_he,address:n.email},a=_.find(t.data.to,function(t){return t.id==e.id});a||t.data.to.push(e),t.ten_lien_he="",t.email=""},t.removeContact=function(n){t.data.to=_.reject(t.data.to,function(t){return _.isEqual(n,t)})},t.selectTemplate=function(n){n&&n.mail&&(t.data.subject=n.subject,t.data.mail.html=n.mail.html)},t.title="Soạn email"},onSave:function(t,n,e,a){e.$modal.open({templateUrl:"templates/lists/mailsent/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailsent","$location","mailsentConfig","$modalInstance","$window","$routeParams","$timeout","$rootScope",function(t,e,i,o,r,c,d){t.data=n,t.save=function(){a(null,n),d.close()},t.cancel=function(){a(),d.dismiss("cancel")}}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}});mailsentModule.defaultValues={mail:{text:"",html:""},repeat:0,schedule:new Date,send_type:0};var mailsent_current_page=1;mailsentModule.module.directive("mailSent",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailsent/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","mailsent","socket","appInfo",function(t,n,e,a,i,o,r,c){c.info("mailSent",function(n){n||(t.server_url=server_url,t.location=e.url(),t.condition={txtsearch:"",account_id:""},t.current_page=mailsent_current_page,t.pageChanged=function(n){t.current_page=n,mailsent_current_page=n},t.viewmailsent=function(t){e.url("/mailsent/view/"+t._id+"?redirect="+e.url())},t.deletemailsent=function(n){a.confirm("Bạn có chắc chắn xóa email này không?")&&o.delete(id_app,n._id).success(function(){t.mailsents=_.reject(t.mailsents,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})},t.service=o,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,sent,schedule,account_id,repeat,attachments",t.getEmail=function(n,e){o.load(id_app,{condition:{_id:n},fields:t.fields}).success(function(t){1==t.length&&e(t[0])}).error(function(t){a.alert(t)})},t.search=function(){var n={};t.condition.account_id&&(n.account_id=t.condition.account_id),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailsents){t.isSelectAll=!t.isSelectAll;for(var n=0;n<t.mailsents.length;n++){var e=t.mailsents[n];e.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailsents)return!1;for(var n=0;n<t.mailsents.length;n++){var e=t.mailsents[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailsents&&a.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var n=_.filter(t.mailsents,function(t){return t.sel});n.forEach(function(n){o.delete(id_app,n._id).success(function(){t.mailsents=_.reject(t.mailsents,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})})}},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search(),r.on("email_sent",function(n){t.condition.txtsearch||t.getEmail(n,function(n){t.mailsents||(t.mailsents=[]),t.condition.account_id&&t.condition.account_id!=n.account_id||t.mailsents.push(n)})}))},!0))})}],link:function(t,n,e){e.link||console.error("mail-sent directive require 'link' attribute")}}});var mailscheduleModule=new baseInput("mailschedule","mailschedule",["subject","small_text"],"Email chờ gửi",{has_view:!0,onAdd:function($scope,options){$scope.data.to=$scope.data.to?eval($scope.data.to):[],$scope.data.html="",$scope.selectContact=function(t){var n={id:t._id,name:t.ten_lien_he,address:t.email},e=_.find($scope.data.to,function(t){return t.id==n.id});e||$scope.data.to.push(n),$scope.ten_lien_he="",$scope.email=""},$scope.removeContact=function(t){$scope.data.to=_.reject($scope.data.to,function(n){return _.isEqual(t,n)})},$scope.selectTemplate=function(t){t&&t.mail&&($scope.data.subject=t.subject,$scope.data.mail.html=t.mail.html)},$scope.title="Soạn email"},onEdit:function(t){t.data.to||(t.data.to=[]),t.selectContact=function(n){var e={id:n._id,name:n.ten_lien_he,address:n.email},a=_.find(t.data.to,function(t){return t.id==e.id});a||t.data.to.push(e),t.ten_lien_he="",t.email=""},t.removeContact=function(n){t.data.to=_.reject(t.data.to,function(t){return _.isEqual(n,t)})},t.selectTemplate=function(n){n&&n.mail&&(t.data.subject=n.subject,t.data.mail.html=n.mail.html)},t.title="Soạn email"},onSave:function(t,n,e,a){e.$modal.open({templateUrl:"templates/lists/mailschedule/templates/dialog-beforsave.html",controller:["$scope","$controller","$http","mailschedule","$location","mailscheduleConfig","$modalInstance","$window","$routeParams","$timeout","$rootScope",function(t,e,i,o,r,c,d){t.data=n,t.save=function(){a(null,n),d.close()},t.cancel=function(){a(),d.dismiss("cancel")},t.send_types=[{id:0,name:"Ngay bây giờ"},{id:1,name:"Chọn một thời gian cụ thể"}],t.repeats=[{id:0,name:"Không lặp lại"},{id:1,name:"Hàng ngày"},{id:2,name:"Hàng tháng"},{id:3,name:"Hàng quý"},{id:4,name:"Hàng năm"}]}],size:"sm",backdrop:"static",resolve:{parentScope:function(){return t}}})}});mailscheduleModule.defaultValues={mail:{text:"",html:""},repeat:0,schedule:new Date,send_type:0},mailscheduleModule.module.directive("mailSchedule",function(){return{restrict:"E",scope:{link:"=",mailScheduleAdded:"="},templateUrl:"templates/lists/mailschedule/templates/schedule.html",controller:["$scope","$http","$location","$window","$modal","mailschedule","socket","appInfo",function(t,n,e,a,i,o,r,c){c.info("mailSchedule",function(n){n||(t.server_url=server_url,t.condition={txtsearch:"",account_id:""},t.viewmailschedule=function(t){e.url("/mailschedule/view/"+t._id+"?redirect="+e.url())},t.deletemailschedule=function(n){a.confirm("Bạn có chắc chắn xóa email này không?")&&o.delete(id_app,n._id).success(function(){t.mailschedules=_.reject(t.mailschedules,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})},t.service=o,t.limit=20,t.fields="subject,from,to,user_created,date_created,small_text,sent,schedule,account_id,repeat,error,nextRunAt",t.getEmail=function(n,e){o.load(id_app,{condition:{_id:n},fields:t.fields}).success(function(t){1==t.length&&e(t[0])}).error(function(t){a.alert(t)})},t.search=function(){var n={};t.condition.account_id&&(n.account_id=t.condition.account_id),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({from:{$elemMatch:{address:{$regex:t.condition.txtsearch,$options:"i"}}}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailschedules){t.isSelectAll=!t.isSelectAll;for(var n=0;n<t.mailschedules.length;n++){var e=t.mailschedules[n];e.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailschedules)return!1;for(var n=0;n<t.mailschedules.length;n++){var e=t.mailschedules[n];
if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailschedules&&a.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var n=_.filter(t.mailschedules,function(t){return t.sel});n.forEach(function(n){o.delete(id_app,n._id).success(function(){t.mailschedules=_.reject(t.mailschedules,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})})}},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.editmailschedule=function(t){mailscheduleModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search(),r.on("email_schedule",function(n){t.condition.txtsearch||t.getEmail(n,function(n){t.mailschedules||(t.mailschedules=[]),t.condition.account_id&&t.condition.account_id!=n.account_id||t.mailschedules.push(n)})}))},!0))})}],link:function(t,n,e){e.link||console.error("mail-schedule directive require 'link' attribute"),t.$watch("mailScheduleAdded",function(n){n&&(t.mailschedules||(t.mailschedules=[]),t.mailschedules.push(n))},!0)}}});var mailtemplateModule=new baseInput("mailtemplate","mailtemplate",["subject","name","small_text"],"Email mẫu",{onAdd:function(t){t.data.html=""}});mailtemplateModule.defaultValues={mail:{text:"",html:""}},mailtemplateModule.module.directive("mailTemplate",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/mailtemplate/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","mailtemplate","appInfo",function(t,n,e,a,i,o,r){r.info("mailTemplate",function(n){n||(t.server_url=server_url,t.condition={txtsearch:"",nhom:""},t.viewmailtemplate=function(t){e.url("/mailtemplate/view/"+t._id+"?redirect="+e.url())},t.deletemailtemplate=function(n){a.confirm("Bạn có chắc chắn xóa email này không?")&&o.delete(id_app,n._id).success(function(){t.mailtemplates=_.reject(t.mailtemplates,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})},t.service=o,t.limit=20,t.fields="name,subject,user_created,date_created,small_text,nhom",t.search=function(){var n={};t.condition.nhom&&(n.nhom=t.condition.nhom),t.condition.txtsearch&&(n.$or=[{subject:{$regex:t.condition.txtsearch,$options:"i"}}],n.$or.push({name:{$regex:t.condition.txtsearch,$options:"i"}}),n.$or.push({"mail.text":{$regex:t.condition.txtsearch,$options:"i"}})),t.query=n,t.start=!0},t.searchKeyup=function(n){13==n.keyCode&&t.search()},t.isSelectAll=!1,t.selectAll=function(){if(t.mailtemplates){t.isSelectAll=!t.isSelectAll;for(var n=0;n<t.mailtemplates.length;n++){var e=t.mailtemplates[n];e.sel=t.isSelectAll}}},t.isSelected=function(){if(!t.mailtemplates)return!1;for(var n=0;n<t.mailtemplates.length;n++){var e=t.mailtemplates[n];if(e.sel&&1==e.sel)return!0}return!1},t.deleteSelected=function(){if(t.mailtemplates&&a.confirm("Bạn có chắc chắn xóa những email đã chọn không?")){var n=_.filter(t.mailtemplates,function(t){return t.sel});n.forEach(function(n){o.delete(id_app,n._id).success(function(){t.mailtemplates=_.reject(t.mailtemplates,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})})}},t.linkSelected=function(){a.alert("Chức năng này đang được xây dựng")},t.editmailtemplate=function(t){mailtemplateModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.add=function(){mailtemplateModule.quickadd(i,function(n){t.mailtemplates||(t.mailtemplates=[]),t.mailtemplates.push(n)})},t.$watch("link",function(n){n&&(t.idLink=t.link.email,t.search())},!0))})}],link:function(t,n,e){e.link||console.error("mail-template directive require 'link' attribute")}}});var contractModule=new baseInput("contract","contract",["so_hd","ten_hd"],"Hợp đồng",{has_view:!0,onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.progress=0},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'CONTRACT'}").success(function(n){t.groups=n})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[];t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.progress={$in:n},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_hd?t.filter.nh_hd=t.nh_hd:delete t.filter.nh_hd;var e,a,i=new Date,o=t.time;if("d"==o&&(e=new Date,a=new Date),"w"==o)var r=i.getDate()-i.getDay()+1,e=new Date(i.setDate(r)),a=new Date(i.setDate(e.getDate()+6));if("m"==o&&(e=i,e.setDate(1),a=new Date(e.getFullYear(),e.getMonth()+1,0)),"3m"==o){var c=i.getMonth(),d=1;d=3>c?0:6>c?3:6>c?6:9,e=new Date(i.getFullYear(),d,1),a=new Date(i.getFullYear(),d+3,0)}"y"==o&&(e=new Date(i.getFullYear(),0,1),a=new Date(i.getFullYear(),11,31)),e&&a?(e.setHours(0),e.setMinutes(0),e.setSeconds(0),a.setHours(23),a.setMinutes(59),a.setSeconds(0),t.filter.ngay_hd={$gte:e,$lte:a}):delete t.filter.ngay_hd,t.advCondition.ten_hd?t.filter.$or=[{ten_hd:{$regex:t.advCondition.ten_hd,$options:"i"}},{so_hd:{$regex:t.advCondition.ten_hd,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.advCondition.ngay_hd&&(t.filter.ngay_hd=t.advCondition.ngay_hd),t.advCondition.ngay_nt&&(t.filter.ngay_nt=t.advCondition.ngay_nt),t.search()}},t.enter=function(n){13==n.keyCode&&t.searchAVG()},t.reportByTime=function(n){t.time=n,t.searchAVG()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVG()},t.searchGroup=function(n){t.nh_hd=n._id,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).success(function(n){_.extend(t,n)}).error(function(t){t&&alert(t)})}},onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$modal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$modal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).success(function(n){_.extend(t.data,n)}))})}}});contractModule.defaultValues={ngay_hd:new Date,ma_nt:"VND"},contractModule.module.directive("contract",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/contract/templates/directive.html",controller:["$scope","$http","$window","$location","$modal","appInfo",function($scope,$http,$window,$location,$modal,appInfo){appInfo.info("contract",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="contract:'ten_hd'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.list=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).success(function(n){_.extend(e,n),e.obj=t,e.title=t.title,$scope.list.push(e)}).error(function(){})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).success(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})}).error(function(){})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),contractModule.quickadd($modal,function(t){t.collection_name="contract",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="contract/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$window.confirm("Bạn có chắc chắn xóa không?")&&$http.delete(server_url+"/api/"+id_app+"/contract/"+t._id).success(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.edit=function(t){contractModule.quickedit($modal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("contract directive require attributes:link,collection")}}});var warrantyModule=new baseInput("warranty","warranty",["mieu_ta"],"Bảo hành",{has_view:!1});warrantyModule.defaultValues={unit_time:2,ma_nt:"VND",reminder_yn:!0,start_date:new Date},warrantyModule.module.directive("warranty",function(){return{restrict:"E",scope:{link:"="},templateUrl:"templates/lists/warranty/templates/directive.html",controller:["$scope","$http","$location","$window","$modal","warranty","appInfo",function(t,n,e,a,i,o,r){r.info("warranty",function(n){n||(t.addwarranty=function(){warrantyModule.quickadd(i,function(n){t.warrantys.push(n)},{id_hd:t.idLink})},t.viewwarranty=function(t){e.url("/warranty/view/"+t._id+"?redirect="+e.url())},t.deletewarranty=function(n){a.confirm("Bạn có chắc chắn xóa bảo hành này không?")&&o.delete(id_app,n._id).success(function(){t.warrantys=_.reject(t.warrantys,function(t){return t._id==n._id})}).error(function(t){a.alert(t)})},t.editwarranty=function(t){warrantyModule.quickedit(i,t._id,function(n){_.extend(t,n)})},t.load=function(){o.load(id_app,{condition:{id_hd:t.idLink}}).success(function(n){t.warrantys=n}).error(function(t){a.alert(t)})},t.$watch("link",function(n){n&&(t.idLink=t.link._id,t.load())},!0))})}],link:function(t,n,e){e.link||console.error("warranty directive require 'link' attribute")}}});var dmnvModule=new baseInput("dmnv","dmnv",["ma_nv","ten_nv","dia_chi","dien_thoai","fax","email"],"Nhân viên",{has_view:!0,onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$modal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")},{id_nv:t.data._id,ten_nv:t.data.ten_nv})}},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'DMNV'}").success(function(n){t.groups=n})}),t.btn3_click=function(){var e=[];t.list.forEach(function(t){t.email&&t.sel&&e.push({name:t.ten_nv,address:t.email})}),e.length>0?n.$location.url("mailschedule/add?to="+JSON.stringify(e)+"&redirect="+n.$location.url()):alert("Bạn phải chọn ít nhất một nhân viên")},t.searchAVR=function(){t.renderCompleted&&(t.filter={},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_nv?t.filter.nh_nv=t.nh_nv:delete t.filter.nh_nv,t.advCondition.ten_nv?t.filter.$or=[{ten_nv:{$regex:t.advCondition.ten_nv,$options:"i"}},{ma_nv:{$regex:t.advCondition.ten_nv,$options:"i"}},{dien_thoai:{$regex:t.advCondition.ten_nv,$options:"i"}},{email:{$regex:t.advCondition.ten_nv,$options:"i"}}]:delete t.filter.$or,t.advCondition.dien_thoai?t.filter.dien_thoai={$regex:t.advCondition.dien_thoai,$options:"i"}:delete t.filter.dien_thoai,t.advCondition.email?t.filter.email={$regex:t.advCondition.email,$options:"i"}:delete t.filter.email,t.advCondition.dia_chi?t.filter.dia_chi={$regex:t.advCondition.dia_chi,$options:"i"}:delete t.filter.dia_chi,t.search())},t.enter=function(n){13==n.keyCode&&t.searchAVR()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVR()},t.searchGroup=function(n){t.nh_nv=n._id,t.searchAVR()},t.reportByTime=function(n){t.time=n,t.searchAVR()}}}),dvcsModule=new baseInput("dvcs","dvcs",["ten_dvcs"],"Danh mục đơn vị cơ sở"),dmtcModule=new baseInput("dmtc","tc",["ma_tc","ten_tc"],"Danh mục tính chất thuế"),dmdvtModule=new baseInput("dmdvt","dmdvt",["ma_dvt","ten_dvt"],"Danh mục đơn vị tính"),dmvtModule=new baseInput("dmvt","dmvt",["ma_vt","ten_vt"],"Danh mục vật tư, hàng hóa",{has_view:!0,onLoading:function(t,n){n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/dmnvt").success(function(n){t.groups=n})}),t.searchGroup=function(n){t.ma_nvt=n._id;var e=t.filter;e||(e={}),t.ma_nvt?e.ma_nvt=t.ma_nvt:delete e.ma_nvt,t.changeFilter({filter:e})},t.searchType=function(n){t.type_filter=n;var e=t.filter;e||(e={}),delete e.hot,delete e.bestseller,delete e.banner_small,delete e.banner_large,n&&(e[n]=!0),t.changeFilter({filter:e})}}});dmvtModule.defaultValues={gia_xuat:"1",tk_vt:"1561"},dmvtModule.init=function(t){t.updatePrice=function(n){n.gia_ban_le&&n.ty_le_ck&&(n.tien_ck=Math.round(n.gia_ban_le*n.ty_le_ck,0)),t.update(n)},t.$watch("data.ty_le_ck",function(){t.isDataLoaded&&t.data.gia_ban_le&&t.data.ty_le_ck&&(t.data.tien_ck=Math.round(t.data.ty_le_ck*t.data.gia_ban_le/100,0))}),t.$watch("data.gia_ban_le",function(){t.isDataLoaded&&t.data.gia_ban_le&&t.data.ty_le_ck&&(t.data.tien_ck=Math.round(t.data.ty_le_ck*t.data.gia_ban_le/100,0))})};var dmnvtModule=new baseInput("dmnvt","dmnvt",["ten_nvt"],"Danh mục nhóm sản phẩm"),dmkhoModule=new baseInput("dmkho","dmkho",["ma_kho","ten_kho"],"Danh mục kho"),dmvatModule=new baseInput("dmvat","vat",["ma_thue","ten_thue","tk_thue_no","tk_thue_co"],"Danh mục thuế GTGT");dmvatModule.defaultValues={thue_suat:0};var dmntModule=new baseInput("dmnt","currency",["ma_nt","ten_nt"],"Danh mục ngoại tệ"),dmtkModule=new baseInput("dmtk","account",["tk","ten_tk","tk_me","ma_nt"],"Danh mục tài khoản",{has_view:!0});dmtkModule.defaultValues={ma_nt:"VND"};var dmkcModule=new baseInput("dmkc","dmkc",["tk_no","tk_co","ten_bt"],"Khai báo bút toán kết chuyển cuối kỳ");dmkcModule.defaultValues={loai_kc:"1",stt:1};var dmcpmhModule=new baseInput("dmcpmh","dmcpmh",["ma_cp","ten_cp"],"Danh mục chi phí mua hàng"),cdtkModule=new baseInput("cdtk","cdtk",["tk","ma_dvcs"],"Số dư đầu kỳ tài khoản");cdtkModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_no1=t.data.du_no00,t.data.du_co00=0,t.data.du_co1=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_co1=t.data.du_co00,t.data.du_no00=0,t.data.du_no1=0)})},cdtkModule.defaultValues={du_no00:0,du_no1:0,du_co00:0,du_co1:0};var cdkhModule=new baseInput("cdkh","cdkh",["tk","ma_kh","ma_dvcs"],"Số dư đầu kỳ công nợ khách hàng");cdkhModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_no1=t.data.du_no00,t.data.du_co00=0,t.data.du_co1=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_co1=t.data.du_co00,t.data.du_no00=0,t.data.du_no1=0)})},cdkhModule.defaultValues={du_no00:0,du_no1:0,du_co00:0,du_co1:0};var cdvtModule=new baseInput("cdvt","cdvt",["ma_vt","ma_kho","ma_dvcs"],"Số dư đầu kỳ vật tư");cdvtModule.defaultValues={ton00:0,du00:0,du_nt00:0};var cddtModule=new baseInput("cddt","cddt",["tk","ma_dvcs","ma_dt"],"Số dư đầu kỳ vụ việc");cddtModule.init=function(t){t.$watch("data.du_no00",function(){t.isDataLoaded&&(t.data.du_co00=0,t.data.du_co_nt00=0)}),t.$watch("data.du_no_nt00",function(){t.isDataLoaded&&(t.data.du_co00=0,t.data.du_co_nt00=0)}),t.$watch("data.du_co00",function(){t.isDataLoaded&&(t.data.du_no00=0,t.data.du_no_nt00=0)}),t.$watch("data.du_co_nt00",function(){t.isDataLoaded&&(t.data.du_no00=0,t.data.du_no_nt00=0)})},cddtModule.defaultValues={du_no00:0,du_co00:0,du_no_nt00:0,du_co_nt:0};var dmphiModule=new baseInput("dmphi","dmphi",["ma_phi","ten_phi"],"Danh mục phí"),dmqct_input=function(t,n){t.modules=[],n.$http.get(server_url+"/api/modules").then(function(n){n.data.forEach(function(n){!n.type||"V"!=n.type&&"L"!=n.type||t.modules.push(n)})})},dmqctModule=new baseInput("dmqct","dmqct",["ma_ct","ten_qct"],"Danh mục quyển chứng từ",{onAdd:function(t,n){dmqct_input(t,n),t.data.field="so_ct",t.data.den_so=999999},onEdit:dmqct_input}),ptthanhtoanModule=new baseInput("ptthanhtoan","ptthanhtoan",["ten"],"Danh mục phương thức thanh toán");angular.module("vatvaoModule",[]).directive("ngVatvao",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",tkDuThue:"=",tTienNt:"=",tTien:"=",tenVt:"=",maKh:"="},templateUrl:"templates/vouchers/vatvao/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout",function(t,n,e,a,i){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.ngMasterData&&(t.dt_current.ngay_hd=t.ngMasterData.ngay_ct,t.tkDuThue&&(t.dt_current.tk_du_thue=t.tkDuThue),t.tTienNt&&(t.dt_current.t_tien_nt=t.tTienNt),t.tTien&&(t.dt_current.t_tien=t.tTien),t.tenVt&&(t.dt_current.ten_vt=t.tenVt),t.maKh&&(t.dt_current.ma_kh=t.maKh,e.list(id_app,{ma_kh:t.maKh}).success(function(n){1==n.length&&(t.dt_current.ten_kh=n[0].ten_kh,t.dt_current.dia_chi=n[0].dia_chi,t.dt_current.ma_so_thue=n[0].ma_so_thue)}))),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/vatvao/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.dismiss("cancel")}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.thue_suat",function(){t.status.isOpened&&(t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_thue_nt",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien_nt",function(){t.status.isOpened&&(t.dt_current.t_tien=t.dt_current.t_tien_nt*t.ngMasterData.ty_gia,t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_tien*t.dt_current.thue_suat/100)})}}}]),angular.module("vatraModule",[]).directive("ngVatra",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",tkDuThue:"=",tTienNt:"=",tTien:"=",tenVt:"=",maKh:"="},templateUrl:"templates/vouchers/vatra/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout",function(t,n,e,a,i){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.ngMasterData&&(t.dt_current.ngay_hd=t.ngMasterData.ngay_ct,t.tkDuThue&&(t.dt_current.tk_du_thue=t.tkDuThue),t.tTienNt&&(t.dt_current.t_tien_nt=t.tTienNt),t.tTien&&(t.dt_current.t_tien=t.tTien),t.tenVt&&(t.dt_current.ten_vt=t.tenVt),t.maKh&&(t.dt_current.ma_kh=t.maKh,e.list(id_app,{ma_kh:t.maKh}).success(function(n){1==n.length&&(t.dt_current.ten_kh=n[0].ten_kh,t.dt_current.dia_chi=n[0].dia_chi,t.dt_current.ma_so_thue=n[0].ma_so_thue)}))),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/vatra/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.dismiss("cancel")}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.thue_suat",function(){t.status.isOpened&&(t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_thue_nt",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien_nt",function(){t.status.isOpened&&(t.dt_current.t_tien=t.dt_current.t_tien_nt*t.ngMasterData.ty_gia,t.dt_current.t_thue_nt=t.dt_current.t_tien_nt*t.dt_current.thue_suat/100,t.dt_current.t_thue=t.dt_current.t_thue_nt*t.ngMasterData.ty_gia)}),t.$watch("dt_current.t_tien",function(){t.status.isOpened&&(t.dt_current.t_thue=t.dt_current.t_tien*t.dt_current.thue_suat/100)})}}}]),angular.module("tdttcoModule",[]).directive("ngTdttco",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"="},templateUrl:"templates/vouchers/tdttco/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout","$http",function(t,n,e,a,i,o){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.getInvoice=function(){if(!t.ngMasterData.ma_kh)return alert("Phải nhập một khách hàng trước khi lấy hóa đơn");var n=server_url+"/api/"+id_app+"/getinvoice2pay?ma_kh="+t.ngMasterData.ma_kh;t.ngMasterData._id&&(n=n+"&id_ct="+t.ngMasterData._id),o.get(n).success(function(n){t.ngData=n,0==t.ngData.length&&alert("Không có hóa đơn nào cần chi cho khách hàng này")}).error(function(t){alert("Không thể lấy được thông tin hóa đơn"),console.log(t)})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=n,t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/tdttco/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.dismiss("cancel")}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_nt",function(){t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2)))}),t.$watch("dt_current.tien",function(){t.status.isOpened&&0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2))})}}}]),angular.module("tdttnoModule",[]).directive("ngTdttno",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"="},templateUrl:"templates/vouchers/tdttno/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout","$http",function(t,n,e,a,i,o){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.getInvoice=function(){if(!t.ngMasterData.ma_kh)return alert("Phải nhập một khách hàng trước khi lấy hóa đơn");var n=server_url+"/api/"+id_app+"/getinvoice2receive?ma_kh="+t.ngMasterData.ma_kh;t.ngMasterData._id&&(n=n+"&id_ct="+t.ngMasterData._id),o.get(n).success(function(n){t.ngData=n,0==t.ngData.length&&alert("Không có hóa đơn nào cần thu cho khách hàng này")}).error(function(t){alert("Không thể lấy được thông tin hóa đơn"),console.log(t)})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=n,t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/tdttno/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.dismiss("cancel")}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_nt",function(){t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2)))}),t.$watch("dt_current.tien",function(){t.status.isOpened&&0!=t.dt_current.ty_gia_hd&&"VND"!=t.dt_current.ty_gia_hd&&(t.dt_current.thanh_toan_qd=Math.round(t.dt_current.tien/t.dt_current.ty_gia_hd,2))})}}}]),angular.module("ctcpmhModule",[]).directive("ngCtcpmh",[function(){return{restrict:"E",scope:{ngData:"=",ngMasterData:"=",allocate:"&"},templateUrl:"templates/vouchers/ctcpmh/templates/table.html",controller:["$scope","$modal","dmkh","dmvat","$timeout",function(t,n,e,a,i){t.status={isOpened:!1},t.isNotRowwSelected=function(t){return 0==_.filter(t,function(t){return 1==t.sel}).length},t.deleteRow=function(t){var n=_.reject(t,function(t){return 1==t.sel});t.length=0;var e=0;n.forEach(function(n){n.line=e,t.push(n),e++})},t.addDetail=function(){t.ngData||(t.ngData=[]);var n=t.ngData.length;t.dt_master=null,t.dt_current={line:n},t.ngData||(t.ngData=[]),t.openDetail("lg")},t.editDetail=function(n){t.dt_master=_.find(t.ngData,function(t){return t.line==n}),t.dt_current={},_.extend(t.dt_current,t.dt_master),t.openDetail("lg")},t.openDetail=function(e){var a=n.open({templateUrl:"templates/vouchers/ctcpmh/templates/edit.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.ngData=e.ngData,t.dt_master=e.dt_master,t.dt_current=e.dt_current,t.ngMasterData=e.ngMasterData,t.status=e.status,t.updateDetail=function(){t.dt_master||(t.dt_master={},t.ngData.push(t.dt_master));for(var e in t.dt_current)t.dt_master[e]=t.dt_current[e];n.close()},t.cancelDetail=function(){n.dismiss("cancel")}}],size:e,resolve:{parentScope:function(){return t.status.isOpened=!1,t}}});a.opened.then(function(){i(function(){t.status.isOpened=!0},100)}),a.result.then(function(){t.status.isOpened=!1})}}],link:function(t){t.$watch("dt_current.tien_cp_nt",function(){t.status.isOpened&&(t.dt_current.tien_cp=t.dt_current.tien_cp_nt*t.ngMasterData.ty_gia)})}}}]);var pktModule=new baseVoucher("pkt","pkt",[],"Phiếu kế toán");pktModule.defaultValues={vatvaos:[],vatras:[]},pktModule.defaultValues4Detail={tien_nt:0,tien:0},pktModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pktModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pktModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(n*t.ngMasterData.ty_gia,0))})},pktModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}),angular.forEach(t.data.vatras,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}))})};var pkcModule=new baseVoucher("pkc","pkc",[],"Phiếu kết chuyển cuối kỳ");pkcModule.defaultValues={},pkcModule.defaultValues4Detail={tien_nt:0,tien:0},pkcModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkcModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkcModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(n*t.ngMasterData.ty_gia,0))}),t.dmkc=function(){t.$window.open("#dmkc","Khai báo kết chuyển cuối kỳ","width=800,height=400")},t.createKC=function(){_.isDate(t.ngMasterData.ngay_ct)||(t.ngMasterData.ngay_ct=new Date(t.ngMasterData.ngay_ct)),t.ngMasterData.details=[];var n=server_url+"/api/"+id_app+"/rp-getdk4pkc?id_ct="+t.ngMasterData._id;n+="&thang="+t.ngMasterData.ngay_ct.getMonth().toString(),n+="&nam="+t.ngMasterData.ngay_ct.getFullYear().toString(),t.ngMasterData.kc_dvcs&&(n=n+"&ma_dvcs="+t.ngMasterData.ma_dvcs),t.$http.get(n).success(function(n){t.messageError=void 0,t.ngMasterData.details=n}).error(function(n){t.alertType="alert alert-danger",t.messageError=n})}},pkcModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0)})})};var pn1Module=new baseVoucher("pn1","pn1",[],"Phiếu nhập mua hàng trong nước");pn1Module.defaultValues={vatvaos:[],tk_co:"1111",ten_tk_co:"Tiền mặt"},pn1Module.defaultValues4Detail={sl_nhap:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,tien_phi_nt:0,tien_phi:0,tien_nhap_nt:0,tien_nhap:0},pn1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn1Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nt=Math.round(t.dt_current.gia_von_nt*t.dt_current.sl_nhap,t.round))
}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_von*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.tien_phi_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_phi=Math.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_phi",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)})},pn1Module.watchMaster=function(t){t.allocate=function(n){for(var e=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][n];if(0!=i)for(var o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=Math.round(t.data.details[o][n]/i*e,t.round),t.data.details[o].tien_phi=Math.round(t.data.details[o][n]/i*a,0),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi;alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*n,0),t.tien_hang=Math.round(t.tien_hang_nt*n,0),t.tien_phi=Math.round(t.tien_phi_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_nhap=Math.round(t.tien_nhap_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}),angular.forEach(t.data.ctcpmhs,function(t){t.tien_cp=Math.round(t.tien_cp_nt*n,0)}))})};var pn2Module=new baseVoucher("pn2","pn2",[],"Phiếu mua dịch vụ");pn2Module.defaultValues={vatvaos:[]},pn2Module.defaultValues4Detail={tien_nt:0,tien:0},pn2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn2Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0))})},pn2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0)})})};var pn3Module=new baseVoucher("pn3","pn3",[],"Phiếu nhập chi phí mua hàng");pn3Module.defaultValues={vatvaos:[]},pn3Module.defaultValues4Detail={tien_ck_nt:0,tien_ck:0},pn3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn3Module.watchDetail=function(t){t.$watch("dt_current.tien_phi_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_phi=Math.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0))}),t.getPN=function(){t.$modal.open({templateUrl:"templates/vouchers/pn3/templates/form-select-invoice.html",controller:["$scope","$modalInstance","parentScope","$filter",function(n,e,a,i){n.condition={tu_ngay:new Date,den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.masters=[],n.details=[],n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id=t});n.details=e.details},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url+"/api/"+id_app+"/getpn2fee?";e=e+"tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),t.$http.get(e).success(function(t){n.masters=t}).error(function(t){n.masters=[],alert(t)})},n.ok=function(){a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return t}}})}},pn3Module.watchMaster=function(t){t.allocate=function(n){for(var e=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][n];if(0!=i)for(var o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=Math.round(t.data.details[o][n]/i*e,t.round),t.data.details[o].tien_phi=Math.round(t.data.details[o][n]/i*a,0),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi;alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_phi=Math.round(t.tien_phi_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}),angular.forEach(t.data.ctcpmhs,function(t){t.tien_cp=Math.round(t.tien_cp_nt*n,0)}))})};var pn5Module=new baseVoucher("pn5","pn5",[],"Phiếu xuất trả lại nhà cung cấp");pn5Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},pn5Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},pn5Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn5Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn5Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_xuat_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))}),t.getInvoice=function(){t.$modal.open({templateUrl:"templates/vouchers/pn5/templates/form-select-invoice.html",controller:["$scope","$modalInstance","parentScope","$filter",function(n,e,a,i){n.condition={tu_ngay:new Date,den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.masters=[],n.details=[],n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id=t});n.details=e.details},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url+"/api/"+id_app+"/getpn2return?ma_kh="+n.ngMasterData.ma_kh;e=e+"&tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),n.ngMasterData._id&&(e=e+"&id_ct="+n.ngMasterData._id),t.$http.get(e).success(function(t){n.masters=t}).error(function(t){n.masters=[],alert(t)})},n.ok=function(){a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return t}}})}},pn5Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_hang=Math.round(t.tien_hang_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_xuat=Math.round(t.tien_xuat_nt*n,0)}),t.data.t_thue=Math.round(t.data.t_thue_nt*n,0))}),t.$watch("data.thue_suat",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_hang_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_hang",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien_hang-t.data.t_ck)*t.data.thue_suat/100,0))})};var pn9Module=new baseVoucher("pn9","pn9",[],"Phiếu nhập khẩu");pn9Module.defaultValues={vatvaos:[]},pn9Module.defaultValues4Detail={sl_nhap:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,tien_hang_nt:0,tien_hang:0,tien_ck_nt:0,tien_ck:0,tien_von_nk_nt:0,tien_von_nk:0,tien_hang_nk_nt:0,tien_hang_nk:0,thue_suat_nk:0,tien_thue_nk_nt:0,tien_thue_nk:0,tien_phi_nt:0,tien_phi:0,tien_nhap_nt:0,tien_nhap:0},pn9Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pn9Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pn9Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nk_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nk_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nt=Math.round(t.dt_current.gia_von_nt*t.dt_current.sl_nhap,t.round),t.dt_current.gia_von_nk_nt=t.dt_current.gia_von_nt)}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_von*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.gia_von_nk_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von_nk=Math.round(t.dt_current.gia_von_nk_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_hang_nk_nt=Math.round(t.dt_current.gia_von_nk_nt*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.gia_von_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nk=Math.round(t.dt_current.gia_von_nk*t.dt_current.sl_nhap,t.round))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt+t.dt_current.tien_thue_nk_nt)}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi+t.dt_current.tien_thue_nk)}),t.$watch("dt_current.tien_hang_nk_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nk=Math.round(t.dt_current.tien_hang_nk_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_thue_nk_nt=Math.round(t.dt_current.tien_hang_nk_nt*t.dt_current.thue_suat_nk/100,t.round))}),t.$watch("dt_current.tien_hang_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_thue_nk=Math.round(t.dt_current.tien_hang_nk*t.dt_current.thue_suat_nk/100,0))}),t.$watch("dt_current.thue_suat_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_thue_nk_nt=Math.round(t.dt_current.tien_hang_nk*t.dt_current.thue_suat_nk/100,t.round))}),t.$watch("dt_current.tien_thue_nk_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_thue_nk=Math.round(t.dt_current.tien_thue_nk_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt+t.dt_current.tien_thue_nk_nt)}),t.$watch("dt_current.tien_thue_nk",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi+t.dt_current.tien_thue_nk)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)}),t.$watch("dt_current.tien_phi_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_phi=Math.round(t.dt_current.tien_phi_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt+t.dt_current.tien_phi_nt)}),t.$watch("dt_current.tien_phi",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=t.dt_current.tien_hang-t.dt_current.tien_ck+t.dt_current.tien_phi)})},pn9Module.watchMaster=function(t){t.allocate=function(n){for(var e=t.data.t_cp_cpb_nt,a=t.data.t_cp_cpb,i=0,o=0;o<t.data.details.length;o++)i+=t.data.details[o][n];if(0!=i)for(var o=0;o<t.data.details.length;o++)t.data.details[o].tien_phi_nt=Math.round(t.data.details[o][n]/i*e,t.round),t.data.details[o].tien_phi=Math.round(t.data.details[o][n]/i*a,0),t.data.details[o].tien_nhap_nt=t.data.details[o].tien_hang_nt-t.data.details[o].tien_ck_nt+t.data.details[o].tien_phi_nt,t.data.details[o].tien_nhap=t.data.details[o].tien_hang-t.data.details[o].tien_ck+t.data.details[o].tien_phi;alert("Chương trình đã thực hiện xong")},t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*n,0),t.tien_hang=Math.round(t.tien_hang_nt*n,0),t.tien_phi=Math.round(t.tien_phi_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_nhap=Math.round(t.tien_nhap_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}),angular.forEach(t.data.ctcpmhs,function(t){t.tien_cp=Math.round(t.tien_cp_nt*n,0)}))})};var pnkModule=new baseVoucher("pnk","pnk",[],"Phiếu nhập kho nội bộ");pnkModule.defaultValues={},pnkModule.defaultValues4Detail={sl_nhap:0,pn_gia_tb:!0,gia_von_nt:0,gia_von:0,tien_nhap_nt:0,tien_nhap:0},pnkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pnkModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pnkModule.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_nhap_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=Math.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,0))})},pnkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*n,0),t.tien_nhap=Math.round(t.tien_nhap_nt*n,0)})})};var pxkModule=new baseVoucher("pxk","pxk",[],"Phiếu xuất kho nội bộ");pxkModule.defaultValues={},pxkModule.defaultValues4Detail={sl_xuat:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pxkModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pxkModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pxkModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))})},pxkModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*n,0),t.tien_xuat=Math.round(t.tien_xuat_nt*n,0)})})};var pxcModule=new baseVoucher("pxc","pxc",[],"Phiếu xuất điều chuyển kho");pxcModule.defaultValues={},pxcModule.defaultValues4Detail={sl_xuat:0,px_gia_dd:!1,gia_von_nt:0,gia_von:0,tien_xuat_nt:0,tien_xuat:0},pxcModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pxcModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pxcModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round))}),t.$watch("dt_current.gia_von",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von,0))}),t.$watch("dt_current.tien_xuat_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat=Math.round(t.dt_current.tien_xuat_nt*t.ngMasterData.ty_gia,0))})},pxcModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.gia_von=Math.round(t.gia_von_nt*n,0),t.tien_xuat=Math.round(t.tien_xuat_nt*n,0)})})};var pc1Module=new baseVoucher("pc1","pc1",[],"Phiếu chi tiền",{onEdit:function(t){t.select(t.data.tdttcos&&t.data.tdttcos.length>0?"chi_hd":"chi_kh")},onInit:function(t){t.select_chi_kh=!0,t.select_chi_hd=!1,t.select_vat_vao=!1,t.select=function(n){t.select_chi_kh="chi_kh"==n,t.select_chi_hd="chi_hd"==n,t.select_vat_vao="vat_vao"==n}}});pc1Module.defaultValues={vatvaos:[],ma_gd:"1"},pc1Module.defaultValues4Detail={tien_nt:0,tien:0},pc1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pc1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pc1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(n*t.ngMasterData.ty_gia,0))})},pc1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}),angular.forEach(t.data.vatras,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}))})};var pt1Module=new baseVoucher("pt1","pt1",[],"Phiếu thu tiền",{onEdit:function(t){t.select(t.data.tdttnos&&t.data.tdttnos.length>0?"thu_hd":"thu_kh")},onInit:function(t){t.select_thu_kh=!0,t.select_thu_hd=!1,t.select=function(n){t.select_thu_kh="thu_kh"==n,t.select_thu_hd="thu_hd"==n}}});pt1Module.defaultValues={ma_gd:"1"},pt1Module.defaultValues4Detail={tien_nt:0,tien:0},pt1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pt1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pt1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(n*t.ngMasterData.ty_gia,0))})},pt1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}),angular.forEach(t.data.vatras,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}))})};var hd2Module=new baseVoucher("hd2","hd2",[],"Hóa đơn bán hàng");hd2Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},hd2Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},hd2Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd2Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd2Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))})},hd2Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_hang_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_xuat=t.tien_xuat_nt}),t.data.t_thue=Math.round(t.data.t_thue_nt*n,0))}),t.$watch("data.thue_suat",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))})};var hd1Module=new baseVoucher("hd1","hd1",[],"Hóa đơn bán dịch vụ");hd1Module.defaultValues={t_thue_nt:0,t_thue:0,thue_suat:0},hd1Module.defaultValues4Detail={ty_le_ck:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0},hd1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd1Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd1Module.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))})},hd1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_hang_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0)}),t.data.t_thue=Math.round(t.data.t_thue_nt*n,0))}),t.$watch("data.thue_suat",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.t_tien",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))})};var hd3Module=new baseVoucher("hd3","hd3",[],"Phiếu nhập hàng bán bị trả lại");hd3Module.defaultValues={vatvaos:[]},hd3Module.defaultValues4Detail={sl_nhap:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_nhap_nt:0,tien_nhap:0},hd3Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},hd3Module.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},hd3Module.watchDetail=function(t){t.$watch("dt_current.sl_nhap",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,0))
}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_ban=Math.round(t.dt_current.gia_ban_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_ban,0))}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=Math.round(t.dt_current.gia_von_nt,0),t.dt_current.tien_nhap_nt=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_nhap=Math.round(t.dt_current.sl_nhap*t.dt_current.gia_von_nt,0))}),t.$watch("dt_current.tien_nhap_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_nhap=Math.round(t.dt_current.tien_nhap_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(t.dt_current.tien_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien*t.dt_current.ty_le_ck/100,0))}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0))}),t.getInvoice=function(){t.$modal.open({templateUrl:"templates/vouchers/hd3/templates/form-select-invoice.html",controller:["$scope","$modalInstance","parentScope","$filter",function(n,e,a,i){n.condition={tu_ngay:new Date,den_ngay:new Date},n.ngData=a.ngData,n.dt_current=a.dt_current,n.ngMasterData=a.ngMasterData,n.masters=[],n.details=[],n.invoiceClick=function(t){n.details=[];var e=_.find(n.masters,function(n){return n._id=t});n.details=e.details},n.loadInvoice=function(){n.masters=[],n.details=[];var e=server_url+"/api/"+id_app+"/getinvoice2return?ma_kh="+n.ngMasterData.ma_kh;n.ngMasterData._id&&(e=e+"&id_ct="+n.ngMasterData._id),e=e+"&tu_ngay="+i("date")(n.condition.tu_ngay,"yyyy-MM-dd"),e=e+"&den_ngay="+i("date")(n.condition.den_ngay,"yyyy-MM-dd"),n.condition.so_ct&&(e=e+"&so_ct="+n.condition.so_ct),n.condition.so_hd&&(e=e+"&so_hd="+n.condition.so_hd),t.$http.get(e).success(function(t){n.masters=t}).error(function(t){n.masters=[],alert(t)})},n.ok=function(){a.ngMasterData.details=[];var t=0;n.masters.forEach(function(n){n.sel&&n.details.forEach(function(n){n.sel&&(n.line=t,a.ngMasterData.details.push(n),t++)})}),e.close()},n.cancel=function(){e.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return t}}})}},hd3Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_nhap=Math.round(t.tien_nhap_nt*n,0)}),angular.forEach(t.data.vatvaos,function(t){t.t_tien=Math.round(t.t_tien_nt*n,0),t.t_thue=Math.round(t.t_thue_nt*n,0)}))})};var pblModule=new baseVoucher("pbl","pbl",[],"Phiếu bán lẻ");pblModule.defaultValues={ty_le_ck_hd:0,tien_ck_hd:0},pblModule.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_von_nt:0,gia_von:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,px_gia_dd:!1,tien_xuat_nt:0,tien_xuat:0},pblModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:""},pblModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pblModule.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,0))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)})},pblModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_hang=Math.round(t.tien_hang_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_xuat=t.tien_xuat_nt}),t.data.t_thue=Math.round(t.data.t_thue_nt*n,0))}),t.$watch("data.t_tien_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.ty_le_ck_hd",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.tien_ck_hd=Math.round((t.data.t_tien_nt-t.data.t_ck_nt)*t.data.ty_le_ck_hd/100,0))}),t.$watch("data.t_tien",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))}),t.$watch("data.tien_thu",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.con_no=t.data.t_tt-t.data.tien_thu)})};var so1Module=new baseVoucher("so1","so1",[],"Đơn đặt hàng");so1Module.defaultValues={ty_le_ck_hd:0,tien_ck_hd:0,trang_thai:"1"},so1Module.defaultValues4Detail={sl_xuat:0,ty_le_ck:0,gia_ban_nt:0,gia_ban:0,tien_nt:0,tien:0,tien_ck_nt:0,tien_ck:0,tien_xuat_nt:0,tien_xuat:0,gia_von_nt:0,gia_von:0,px_gia_dd:!1},so1Module.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:"",ma_kh:"",trang_thai:""},so1Module.prepareCondition4Search=function(t){var n={so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ma_kh:{$regex:t.vcondition.ma_kh,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}};return""!=t.vcondition.trang_thai&&(n.trang_thai=t.vcondition.trang_thai),n},so1Module.watchDetail=function(t){t.$watch("dt_current.sl_xuat",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.gia_ban_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_ban_nt,t.round))}),t.$watch("dt_current.gia_ban",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_hang=Math.round(t.dt_current.gia_ban*t.dt_current.sl_xuat,0))}),t.$watch("dt_current.tien_hang_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt,t.dt_current.tien_hang=Math.round(t.dt_current.tien_hang_nt*t.ngMasterData.ty_gia,0))}),t.$watch("dt_current.tien_hang",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_hang*t.dt_current.ty_le_ck/100,0),t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)}),t.$watch("dt_current.gia_von_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.gia_von=t.dt_current.gia_von_nt,t.dt_current.tien_xuat_nt=Math.round(t.dt_current.sl_xuat*t.dt_current.gia_von_nt,t.round),t.dt_current.tien_xuat=t.dt_current.tien_xuat_nt)}),t.$watch("dt_current.ty_le_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck_nt=Math.round(t.dt_current.tien_hang_nt*t.dt_current.ty_le_ck/100,t.round))}),t.$watch("dt_current.tien_ck_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien_ck=Math.round(t.dt_current.tien_ck_nt*t.ngMasterData.ty_gia,0),t.dt_current.tien_nt=t.dt_current.tien_hang_nt-t.dt_current.tien_ck_nt)}),t.$watch("dt_current.tien_ck",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=t.dt_current.tien_hang-t.dt_current.tien_ck)})},so1Module.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(angular.forEach(t.data.details,function(t){t.tien_hang=Math.round(t.tien_hang_nt*n,0),t.tien_ck=Math.round(t.tien_ck_nt*n,0),t.tien_xuat=t.tien_xuat_nt}),t.data.t_thue=Math.round(t.data.t_thue_nt*n,0))}),t.$watch("data.t_tien_hang_nt",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue_nt=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.thue_suat/100,t.round),t.data.t_thue=Math.round(t.data.t_thue_nt*t.data.ty_gia,0))}),t.$watch("data.ty_le_ck_hd",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.tien_ck_hd=Math.round((t.data.t_tien_hang_nt-t.data.t_ck_nt)*t.data.ty_le_ck_hd/100,0))}),t.$watch("data.t_tien",function(n){t.data&&void 0!=n&&t.isDataLoaded&&(t.data.t_thue=Math.round((t.data.t_tien-t.data.t_ck)*t.data.thue_suat/100,0))})},so1Module.module.directive("saleOrder",function(){return{restrict:"E",scope:{},templateUrl:"templates/vouchers/so1/templates/db.html",controller:["$scope","so1","$rootScope","$interval","$location","appInfo",function(t,n,e,a,i,o){o.info("so1",function(o){o||(t.now=new Date,t.app_info=e.app_info,t.editOrder=function(t){i.url("/so1/edit/"+t)},t.condition={trang_thai:{$in:["1","2"]}},t.filter=function(a){e.nextTick(function(){a&&_.extend(t.condition,a),n.load(id_app,{condition:t.condition,limit:10}).success(function(n){t.orders=n})})},t.filter(),t.intv&&(a.cancel(t.intv),t.intv=void 0),t.intv=a(t.filter,3e5))})}],link:function(){}}});var module=angular.module("searchModule",["ngRoute"]);module.controller("searchController",["$scope","$rootScope","$location","$http","$routeParams","dmkh","dmvt","dmtk","lienhe","task","contract","dmdt","$window","$localStorage","appInfo",function(t,n,e,a,i,o,r,c,d,l,u,s,_,p,h){h.info("SEARCH",function(h){if(!h){t.viewProduct=function(t){_.open("#dmvt/view/"+t+"?redirect="+e.url())},t.viewCustomer=function(t){_.open("#dmkh/view/"+t+"?redirect="+e.url())},t.viewAccount=function(t){_.open("#dmtk/view/"+t+"?redirect="+e.url())},t.viewContact=function(t){_.open("#lienhe/view/"+t+"?redirect="+e.url())},t.viewTask=function(t){_.open("#task/view/"+t+"?redirect="+e.url())},t.viewContract=function(t){_.open("#contract/view/"+t+"?redirect="+e.url())},t.viewProject=function(t){_.open("#dmdt/view/"+t+"?redirect="+e.url())},t.viewVoucher=function(t,n){if(t&&n){var e="#/"+t.toLowerCase()+"/edit/"+n;_.open(e)}},t.word=i.word,n.searchword=t.word,t.functions=[];var f=t.word.toLowerCase();n.commands&&(n.commands.acc.forEach(function(n){n.items.forEach(function(n){n.items.forEach(function(n){n.visiable&&"dxd"!=n.path&&n.header.toLowerCase().indexOf(f)>=0&&t.functions.push(n)})})}),n.commands.crm.input.forEach(function(n){n.visiable&&"dxd"!=n.path&&n.header.toLowerCase().indexOf(f)>=0&&t.functions.push(n)})),o.list(id_app,t.word,null,null,1,50).success(function(n){t.customers=n;var e=[];n.forEach(function(t){e.push(t.ma_kh)}),c.list(id_app,t.word,null,null,1,50).success(function(n){t.accounts=n;var i=[];n.forEach(function(t){i.push(t.tk)});var o=p.get("token"),r={$or:[]};r.$or.push({dien_giai:{$regex:t.word,$options:"i"}}),r.$or.push({so_ct:{$regex:t.word,$options:"i"}}),r.$or.push({ma_ct:{$regex:t.word,$options:"i"}}),r.$or.push({ma_kh:{$regex:t.word,$options:"i"}}),r.$or.push({tk_no:{$regex:t.word,$options:"i"}}),r.$or.push({tk_co:{$regex:t.word,$options:"i"}}),e.length>0&&(r.$or.push({ma_kh_no:{$in:e}}),r.$or.push({ma_kh_co:{$in:e}})),i.length>0&&(r.$or.push({tk_no:{$in:i}}),r.$or.push({tk_co:{$in:i}}));var c=server_url+"/api/"+id_app+"/bkct?access_token="+o+"&q="+JSON.stringify(r);a.get(c).success(function(n){t.vouchers=n})})}).error(function(){}),r.list(id_app,t.word,null,null,1,50).success(function(n){t.products=n}).error(function(){}),d.list(id_app,t.word,null,null,1,50).success(function(n){t.contacts=n}).error(function(){}),u.list(id_app,t.word,null,null,1,50).success(function(n){t.contracts=n}).error(function(){}),s.list(id_app,t.word,null,null,1,50).success(function(n){t.projects=n}).error(function(){}),l.list(id_app,t.word,null,null,1,50).success(function(n){t.dscv=n}).error(function(){})}})}]),module.config(["$routeProvider","$locationProvider",function(t){t.when("/search/:word",{templateUrl:"templates/reports/search/templates/browser.html",controller:"searchController"})}]);var rptBkct=new baseRpt("bkct","bkct","Bảng kê chứng từ");rptBkct.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptBkct.module.directive("bkctView",function(){return{restrict:"E",templateUrl:"templates/reports/bkct/templates/view.html"}}),rptBkct.module.directive("bkct",function(){return{restrict:"E",scope:{condition:"@",run:"="},templateUrl:"templates/reports/bkct/templates/view.html",controller:["$scope","$http","$filter","$location",function($scope,$http,$filter,$location){$scope.getData=function(){$scope.data=[];var condition=eval("({"+$scope.condition+"})");rptBkct.getData($http,$filter,condition,function(t,n){t?console.log(t):$scope.data=n})},$scope.viewVoucher=function(t,n){if(t&&n){var e=t.toLowerCase()+"/edit/"+n+"?redirect=back";$location.url(e)}},$scope.order=function(t,n){$scope.data=$filter("orderBy")($scope.data,t,n)}}],link:function(t){t.$watch("run",function(){t.run&&t.getData()})}}});var rptScttk=new baseRpt("scttk","scttk","Sổ chi tiết tài khoản");rptScttk.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptScttk.afterLoadData=function(t){t.title="Sổ chi tiết tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptScttk=new baseRpt("socaitk","socaitk","Sổ cái tài khoản");rptScttk.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptScttk.afterLoadData=function(t){t.title="Sổ cái tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptsochut=new baseRpt("sochut","sochut","Sổ chữ T tài khoản",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.tk_du){var i="/bkct?tk="+t.condition.tk;i=i+"&tk_du="+n.tk_du,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptsochut.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsochut.afterLoadData=function(t){t.title="Sổ chữ T tài khoản: "+t.condition.tk+" - "+t.condition.ten_tk};var rptCdpstk=new baseRpt("cdpstk","cdpstk","Cân đối phát sinh tài khoản",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.tk&&""!=n.tk){var i="/scttk?tk="+n.tk;i=i+"&ten_tk="+n.ten_tk,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptCdpstk.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptCdpstk.useExcelTemplate=!0;var rptsonkc=new baseRpt("sonkc","sonkc","Sổ nhật ký chung");rptsonkc.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsonktt=new baseRpt("sonktt","sonktt","Nhật ký thu tiền");rptsonktt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk_no="111,112"};var rptsonkct=new baseRpt("sonkct","sonkct","Nhật ký chi tiền");rptsonkct.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.tk_co="111,112"};var rptsonkmh=new baseRpt("sonkmh","sonkmh","Nhật ký mua hàng");rptsonkmh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsonkbh=new baseRpt("sonkbh","sonkbh","Nhật ký bán hàng");rptsonkbh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptsctcnkh=new baseRpt("sctcnkh","sctcnkh","Sổ chi tiết công nợ khách hàng");rptsctcnkh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsctcnkh.afterLoadData=function(t){t.title="Sổ chi tiết công nợ khách hàng: "+t.condition.ma_kh+" - "+t.condition.ten_kh},rptsctcnkh.useExcelTemplate=!0;var rptcdpskh=new baseRpt("cdpskh","cdpskh","Cân đối phát sinh theo khách hàng",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_kh){var i="/sctcnkh?tk="+t.condition.tk;i=i+"&ten_tk="+t.condition.ten_tk,i=i+"&ma_kh="+n.ma_kh,i=i+"&ten_kh="+n.ten_kh,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptcdpskh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptcdpskh.useExcelTemplate=!0;var rptsctdt=new baseRpt("sctdt","sctdt","Sổ chi tiết vụ việc, dự án");rptsctdt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsctdt.afterLoadData=function(t){t.title="Sổ chi tiết vụ việc, dự án: "+t.condition.ma_dt+" - "+t.condition.ten_dt},rptsctdt.useExcelTemplate=!0;var rptcdpsdt=new baseRpt("cdpsdt","cdpsdt","Cân đối phát sinh theo vụ việc",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_dt){var i="/sctdt?tk="+t.condition.tk;i=i+"&ten_tk="+t.condition.ten_tk,i=i+"&ma_dt="+n.ma_dt,i=i+"&ten_dt="+n.ten_dt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptcdpsdt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptcdpsdt.useExcelTemplate=!0;var rptbkvatvao=new baseRpt("bkvatvao","bkvatvao","BẢNG KÊ HOÁ ĐƠN, CHỨNG TỪ HÀNG HOÁ, DỊCH VỤ MUA VÀO");rptbkvatvao.init=function(t){t.sorts=[{ma:"ngay_hd",text:"Ngày hóa đơn"},{ma:"ngay_ct",text:"Ngày chứng từ"}]},rptbkvatvao.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.sort="ngay_hd"},rptbkvatvao.setParameters=function(t){t.tong_tien_nt=0,t.tong_thue_nt=0,t.data.forEach(function(n){n.t_tien_nt&&5==n.sysorder&&(t.tong_tien_nt+=n.t_tien_nt),n.t_thue_nt&&5==n.sysorder&&(t.tong_thue_nt+=n.t_thue_nt)})};var rptbkvatra=new baseRpt("bkvatra","bkvatra","BẢNG KÊ HOÁ ĐƠN, CHỨNG TỪ HÀNG HOÁ, DỊCH VỤ BÁN RA");rptbkvatra.init=function(t){t.sorts=[{ma:"ngay_hd",text:"Ngày hóa đơn"},{ma:"ngay_ct",text:"Ngày chứng từ"}]},rptbkvatra.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.sort="ngay_hd"},rptbkvatra.setParameters=function(t){t.tong_tien_nt=0,t.tong_thue_nt=0,t.data.forEach(function(n){n.t_tien_nt&&5==n.sysorder&&(t.tong_tien_nt+=n.t_tien_nt),n.t_thue_nt&&5==n.sysorder&&(t.tong_thue_nt+=n.t_thue_nt)})};var kbmtkgtgtModule=new baseInput("kbmtkgtgt","kbmtkgtgt",["ma_so","chi_tieu"],"Khai báo mẫu tờ khai thuế GTGT");kbmtkgtgtModule.defaultValues={cach_tinh:"2",bang_du_lieu:"vatvao",phan_loai:"1",print:!0,kieu_gia_tri:"0"};var rpttkgtgt=new baseRpt("tkgtgt","tkgtgt","Tờ khai thuế GTGT");rpttkgtgt.defaultCondition=function(t){var n=new Date;t.tu_thang=n.getMonth()+1,t.den_thang=n.getMonth()+1,t.nam=n.getFullYear()};var rptBcdkt=new baseRpt("bcdkt","bcdkt","Bảng cân đối kế toán");rptBcdkt.defaultCondition=function(t){var n=new Date;t.den_ngay=n};var kbmbcdktModule=new baseInput("kbmbcdkt","kbmbcdkt",["ma_so","chi_tieu"],"Khai báo mẫu bảng cân đối kế toán");kbmbcdktModule.defaultValues={cach_tinh:"2",phan_loai:"1"};var kbmkqhdkdModule=new baseInput("kbmkqhdkd","kbmkqhdkd",["ma_so","chi_tieu"],"Khai báo mẫu kết quả hoạt động kinh doanh");kbmkqhdkdModule.defaultValues={cach_tinh:"2"};var rptkqhdkd=new baseRpt("kqhdkd","kqhdkd","Kết quả hoạt động kinh doanh");rptkqhdkd.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var kbmlcttttModule=new baseInput("kbmlctttt","kbmlctttt",["ma_so","chi_tieu"],"Khai báo mẫu báo cáo lưu chuyển tiền tệ phương pháp trực tiếp");kbmlcttttModule.defaultValues={cach_tinh:"1",phan_loai:"1"};var rptlctttt=new baseRpt("lctttt","lctttt","Lưu chuyển tiền tệ phương pháp trực tiếp");rptlctttt.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var kbmlcttgtModule=new baseInput("kbmlcttgt","kbmlcttgt",["ma_so","chi_tieu"],"Khai báo mẫu báo cáo lưu chuyển tiền tệ phương pháp gián tiếp");kbmlcttgtModule.defaultValues={cach_tinh:"1",phan_loai:"1"};var rptlcttgt=new baseRpt("lcttgt","lcttgt","Lưu chuyển tiền tệ phương pháp gián tiếp");rptlcttgt.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var rptThnxt=new baseRpt("thnxt","thnxt","Tổng hợp nhập xuất tồn",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt){var i="/sctvt?ma_kho="+t.condition.ma_kho;i=i+"&ma_vt="+n.ma_vt,i=i+"&ten_vt="+n.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptThnxt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n,t.ma_kho="",t.ma_vt=""};var rptsctvt=new baseRpt("sctvt","sctvt","Sổ chi tiết vật tư");rptsctvt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptsctvt.afterLoadData=function(t){t.title="Sổ chi tiết vật tư: "+t.condition.ma_vt+" - "+t.condition.ten_vt};var rpttinhgiatb=new baseRpt("tinhgiatb","tinhgiatb","Tính giá trung bình");rpttinhgiatb.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString())},rpttinhgiatb.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.tu_thang=(n.getMonth()+1).toString(),t.den_thang=(n.getMonth()+1).toString()};var rptpttct=new baseRpt("pttct","pttct","Phân tích theo chỉ tiêu");rptpttct.defaultCondition=function(t){var n=new Date,e=n.getFullYear(),a=n.getMonth(),i=n.getDate();t.tu_ngay=new Date(e,a,1),t.den_ngay=n,t.tu_ngay_kt=new Date(e-1,a,1),t.den_ngay_kt=new Date(e-1,a,i)};var rptformModule=new baseInput("rptform","rptform",["rptform_name","rptform_type"],"Mẫu báo cáo theo chỉ tiêu"),kbmpttctModule=new baseInput("kbmpttct","kbmpttct",["ma_so","chi_tieu"],"Khai báo mẫu phân tích theo chỉ tiêu");kbmpttctModule.defaultValues={cach_tinh:"2"};var rptdtbanletheongay=new baseRpt("dtbanletheongay","dtbanletheongay","Doanh thu bán lẻ theo ngày",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){var i=new Date(n.ngay_ct);if(_.isDate(i)){var o="/ctbanle?ma_ct=PBL,SO1&";o=o+"tu_ngay="+e("date")(i,"yyyy-MM-dd"),o=o+"&den_ngay="+e("date")(i,"yyyy-MM-dd"),o=o+"&ma_dvcs="+t.condition.ma_dvcs,o+="&isDrillDown=true",a.url(o)}}}});rptdtbanletheongay.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheothang=new baseRpt("dtbanletheothang","dtbanletheothang","Doanh thu bán lẻ theo tháng",{onLoading:function(t,n){for(var e=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)e.push(i.toString());t.nams=e;var o=n.$filter,r=n.$location;t.drilldown=function(n){var e=Number(n.thang),a=Number(t.condition.nam);if(e>0&&12>=e){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"tu_ngay="+o("date")(new Date(a,e-1,1),"yyyy-MM-dd"),i=i+"&den_ngay="+o("date")(new Date(a,e,0),"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",r.url(i)}}}});rptdtbanletheothang.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString()};var rptdtbanletheoquy=new baseRpt("dtbanletheoquy","dtbanletheoquy","Doanh thu bán lẻ theo quý",{onLoading:function(t,n){for(var e=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)e.push(i.toString());t.nams=e;var o=n.$filter,r=n.$location;t.drilldown=function(n){var e=Number(n.quy);if(e>0&&5>e){var a=3*e,i=a-2,c=Number(t.condition.nam),d="/ctbanle?ma_ct=PBL,SO1&";d=d+"tu_ngay="+o("date")(new Date(c,i-1,1),"yyyy-MM-dd"),d=d+"&den_ngay="+o("date")(new Date(c,a,0),"yyyy-MM-dd"),d=d+"&ma_dvcs="+t.condition.ma_dvcs,d+="&isDrillDown=true",r.url(d)}}}});rptdtbanletheoquy.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString()};var rptdtbanletheonam=new baseRpt("dtbanletheonam","dtbanletheonam","Doanh thu bán lẻ theo năm",{onLoading:function(t,n){for(var e=[],a=(new Date).getFullYear(),i=a-10;a+10>i;i++)e.push(i.toString());t.nams=e;var o=n.$filter,r=n.$location;t.drilldown=function(n){var e=Number(n.nam);if(e>=t.condition.tu_nam&&e<=t.condition.den_nam){var a="/ctbanle?ma_ct=PBL,SO1&";a=a+"tu_ngay="+o("date")(new Date(e,0,1),"yyyy-MM-dd"),a=a+"&den_ngay="+o("date")(new Date(e,12,0),"yyyy-MM-dd"),a=a+"&ma_dvcs="+t.condition.ma_dvcs,a+="&isDrillDown=true",r.url(a)}}}});rptdtbanletheonam.defaultCondition=function(t){var n=new Date;t.tu_nam=(n.getFullYear()-1).toString(),t.den_nam=n.getFullYear().toString()};var rptdtbanletheovt=new baseRpt("dtbanletheovt","dtbanletheovt","Doanh thu bán lẻ theo sản phẩm",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt){var i="/ctbanle?ma_ct=PBL,SO1&";i=i+"ma_vt="+n.ma_vt,i=i+"&ten_vt="+n.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptdtbanletheovt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheokh=new baseRpt("dtbanletheokh","dtbanletheokh","Doanh thu bán lẻ theo khách hàng",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_kh){var i="/ctbanle?ma_ct=PBL,SO1&ma_kh="+n.ma_kh;i=i+"&ten_kh="+n.ten_kh,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptdtbanletheokh.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptdtbanletheonv=new baseRpt("dtbanletheonv","dtbanletheonv","Doanh thu bán lẻ theo nhân viên",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.user_created){var i="/ctbanle?ma_ct=PBL,SO1&user_created="+n.user_created;i=i+"&name="+n.name,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rptdtbanletheonv.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptctbanle=new baseRpt("ctbanle","ctbanle","Chi tiết bán hàng");rptctbanle.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpthangbanbitralai=new baseRpt("hangbanbitralai","hangbanbitralai","Tổng hợp hàng bán bị trả lại",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt){var i="/cthangbanbitralai?";i=i+"ma_vt="+n.ma_vt,i=i+"&ten_vt="+n.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpthangbanbitralai.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptcthangbanbitralai=new baseRpt("cthangbanbitralai","cthangbanbitralai","Chi tiết hàng bán bị trả lại");rptcthangbanbitralai.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpttonghopbanhang=new baseRpt("tonghopbanhang","tonghopbanhang","Tổng hợp bán hàng",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt){var i="/ctbanle?";i=i+"ma_vt="+n.ma_vt,i=i+"&ten_vt="+n.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpttonghopbanhang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptchitietthutientheohoadon=new baseRpt("chitietthutientheohoadon","chitietthutientheohoadon","Chi tiết thu tiền theo hóa đơn",{onLoading:function(t,n){n.$filter,n.$location}});rptchitietthutientheohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptchitietthutientheohoadon.useExcelTemplate=!0;var rptchitietchitientheohoadon=new baseRpt("chitietchitientheohoadon","chitietchitientheohoadon","Chi tiết chi tiền theo hóa đơn",{onLoading:function(t,n){n.$filter,n.$location}});rptchitietchitientheohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rptchitietchitientheohoadon.useExcelTemplate=!0;var rpthoadonbanhantheohantt=new baseRpt("hoadonbanhangtheohantt","hoadonbanhangtheohantt","Hóa đơn bán hàng theo hạn thanh toan",{onLoading:function(t,n){n.$filter,n.$location
}});rpthoadonbanhantheohantt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rpthoadonbanhantheohantt.useExcelTemplate=!0;var rptphanbothutienchohoadon=new baseRpt("phanbothutienchohoadon","phanbothutienchohoadon","Phân bổ tiền thu cho các hóa đơn",{onLoading:function(t,n){n.$filter,n.$location;t.select=function(e){t.current_pt=e,t.data.forEach(function(t){t.selected=!1}),e.selected=!0,t.invoices=[];var a=server_url+"/api/"+id_app+"/phanbothutienchohoadon/invoices?id_ct="+e._id+"&ma_kh="+e.ma_kh;n.$http.get(a).success(function(n){t.invoices=n}).error(function(){alert("Không thể lấy hóa đơn của khách hàng này")})},t.tinhthanhtoanqd=function(n){n.thanh_toan_qd=Math.round(n.tien_nt_alloc*t.current_pt.ty_gia/n.ty_gia_hd,2)},t.phanbotudong=function(){var e=0,a=t.current_pt.t_tien_nt;t.invoices.forEach(function(n){n.tien_nt_bk=n.tien_nt,n.con_lai_nt<a?(n.tien_nt_alloc=n.con_lai_nt,n.tien_nt=n.con_lai_nt):(n.tien_nt_alloc=a,n.tien_nt=a),n.tien=n.tien_nt_alloc*t.current_pt.ty_gia,n.thanh_toan_qd=Math.round(n.tien/n.ty_gia_hd,2),e+=n.tien_nt_alloc,a-=n.tien_nt_alloc,n.id_ct=t.current_pt._id,n.ngay_ct=t.current_pt.ngay_ct,n.so_ct=t.current_pt.so_ct,n.ma_ct="PT1",n.ma_nt=t.current_pt.ma_nt,n.ty_gia=t.current_pt.ty_gia,n.status=t.current_pt.status,n.tk_no=t.current_pt.tk_no});var i=server_url+"/api/"+id_app+"/phanbothutienchohoadon/save";n.$http.post(i,t.invoices).success(function(){t.current_pt.da_phan_bo_nt=e,t.current_pt.con_lai_nt=a}).error(function(n){t.invoices.forEach(function(t){t.tien_nt=t.tien_nt_bk}),alert("Không thể lưu phân bổ này\n"+n)})},t.allocate4invoice=function(e){if(e.tien_nt_alloc>e.con_lai_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền còn phải thu");if(e.tien_nt_alloc>t.current_pt.con_lai_nt+e.tien_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền chưa phân bổ của phiếu thu hiện tại");e.id_ct=t.current_pt._id,e.ngay_ct=t.current_pt.ngay_ct,e.so_ct=t.current_pt.so_ct,e.ma_ct="PT1",e.ma_nt=t.current_pt.ma_nt,e.ty_gia=t.current_pt.ty_gia,e.status=t.current_pt.status,e.tk_no=t.current_pt.tk_no,e.tien_nt_bk=e.tien_nt,e.tien_nt=e.tien_nt_alloc,e.tien=e.tien_nt_alloc*e.ty_gia;var a=server_url+"/api/"+id_app+"/phanbothutienchohoadon/save";n.$http.post(a,[e]).success(function(){t.current_pt.da_phan_bo_nt=t.current_pt.da_phan_bo_nt+(e.tien_nt-e.tien_nt_bk),t.current_pt.con_lai_nt=t.current_pt.t_tien_nt-t.current_pt.da_phan_bo_nt}).error(function(t){e.tien_nt=e.tien_nt_bk,alert("Không thể lưu phân bổ này\n"+t)})}},onStartGetData:function(t,n){t.invoices=[],n()}});rptphanbothutienchohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptctmuahang=new baseRpt("ctmuahang","ctmuahang","Chi tiết mua hàng");rptctmuahang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpttonghopmuahang=new baseRpt("tonghopmuahang","tonghopmuahang","Tổng hợp mua hàng",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt){var i="/ctmuahang?";i=i+"ma_vt="+n.ma_vt,i=i+"&ten_vt="+n.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpttonghopmuahang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rpttonghoptralaihang=new baseRpt("tonghoptralaihang","tonghoptralaihang","Tổng hợp trả lại nhà cung cấp",{onLoading:function(t,n){var e=n.$filter,a=n.$location;t.drilldown=function(n){if(n.ma_vt){var i="/cttralaihang?";i=i+"ma_vt="+n.ma_vt,i=i+"&ten_vt="+n.ten_vt,i=i+"&tu_ngay="+e("date")(t.condition.tu_ngay,"yyyy-MM-dd"),i=i+"&den_ngay="+e("date")(t.condition.den_ngay,"yyyy-MM-dd"),i=i+"&ma_dvcs="+t.condition.ma_dvcs,i+="&isDrillDown=true",a.url(i)}}}});rpttonghoptralaihang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var rptcttralaihang=new baseRpt("cttralaihang","cttralaihang","Chi tiết trả lại nhà cung cấp");rptcttralaihang.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(Date.UTC(n.getFullYear(),n.getMonth(),1)),t.den_ngay=n};var rpthoadonbanhantheohantt=new baseRpt("hoadonmuahangtheohantt","hoadonmuahangtheohantt","Hóa đơn mua hàng theo hạn thanh toan",{onLoading:function(t,n){n.$filter,n.$location}});rpthoadonbanhantheohantt.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n},rpthoadonbanhantheohantt.useExcelTemplate=!0;var rptphanbochitienchohoadon=new baseRpt("phanbochitienchohoadon","phanbochitienchohoadon","Phân bổ tiền chi cho các hóa đơn",{onLoading:function(t,n){n.$filter,n.$location;t.select=function(e){t.current_pt=e,t.data.forEach(function(t){t.selected=!1}),e.selected=!0,t.invoices=[];var a=server_url+"/api/"+id_app+"/phanbochitienchohoadon/invoices?id_ct="+e._id+"&ma_kh="+e.ma_kh;n.$http.get(a).success(function(n){t.invoices=n}).error(function(){alert("Không thể lấy hóa đơn của khách hàng này")})},t.tinhthanhtoanqd=function(n){n.thanh_toan_qd=Math.round(n.tien_nt_alloc*t.current_pt.ty_gia/n.ty_gia_hd,2)},t.phanbotudong=function(){var e=0,a=t.current_pt.t_tien_nt;t.invoices.forEach(function(n){n.tien_nt_bk=n.tien_nt,n.con_lai_nt<a?(n.tien_nt_alloc=n.con_lai_nt,n.tien_nt=n.con_lai_nt):(n.tien_nt_alloc=a,n.tien_nt=a),n.tien=n.tien_nt_alloc*t.current_pt.ty_gia,n.thanh_toan_qd=Math.round(n.tien/n.ty_gia_hd,2),e+=n.tien_nt_alloc,a-=n.tien_nt_alloc,n.id_ct=t.current_pt._id,n.ngay_ct=t.current_pt.ngay_ct,n.so_ct=t.current_pt.so_ct,n.ma_ct="PC1",n.ma_nt=t.current_pt.ma_nt,n.ty_gia=t.current_pt.ty_gia,n.status=t.current_pt.status,n.tk_co=t.current_pt.tk_co});var i=server_url+"/api/"+id_app+"/phanbochitienchohoadon/save";n.$http.post(i,t.invoices).success(function(){t.current_pt.da_phan_bo_nt=e,t.current_pt.con_lai_nt=a}).error(function(n){t.invoices.forEach(function(t){t.tien_nt=t.tien_nt_bk}),alert("Không thể lưu phân bổ này\n"+n)})},t.allocate4invoice=function(e){if(e.tien_nt_alloc>e.con_lai_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền còn phải chi");if(e.tien_nt_alloc>t.current_pt.con_lai_nt+e.tien_nt)return void alert("Số tiền phân bổ cho hóa đơn này lớn hơn số tiền chưa phân bổ của phiếu chi hiện tại");e.id_ct=t.current_pt._id,e.ngay_ct=t.current_pt.ngay_ct,e.so_ct=t.current_pt.so_ct,e.ma_ct="PC1",e.ma_nt=t.current_pt.ma_nt,e.ty_gia=t.current_pt.ty_gia,e.status=t.current_pt.status,e.tk_co=t.current_pt.tk_co,e.tien_nt_bk=e.tien_nt,e.tien_nt=e.tien_nt_alloc,e.tien=e.tien_nt_alloc*e.ty_gia;var a=server_url+"/api/"+id_app+"/phanbochitienchohoadon/save";n.$http.post(a,[e]).success(function(){t.current_pt.da_phan_bo_nt=t.current_pt.da_phan_bo_nt+(e.tien_nt-e.tien_nt_bk),t.current_pt.con_lai_nt=t.current_pt.t_tien_nt-t.current_pt.da_phan_bo_nt}).error(function(t){e.tien_nt=e.tien_nt_bk,alert("Không thể lưu phân bổ này\n"+t)})}},onStartGetData:function(t,n){t.invoices=[],n()}});rptphanbochitienchohoadon.defaultCondition=function(t){var n=new Date;t.tu_ngay=new Date(n.getFullYear(),n.getMonth(),1),t.den_ngay=n};var dmbpModule=new baseInput("dmbp","dmbp",["ma_bp","ten_bp"],"Danh mục bộ phận"),dmdtModule=new baseInput("dmdt","dmdt",["ma_dt","ten_dt"],"Vụ việc, dự án, công trình",{has_view:!0,onAdd:function(t,n){t.data.phu_trach=n.$rootScope.user.email,t.data.progress=0},onLoading:function(t,n){t.advCondition={},n.$rootScope.nextTick(function(){n.$http.get(server_url+"/api/"+id_app+"/group?q={group_type:'PROJECT'}").success(function(n){t.groups=n})}),t.progresses=[{value:0,text:"Chưa thực hiện",sel:!0},{value:1,text:"Đang thực hiện",sel:!0},{value:2,text:"Hoàn thành",sel:!0},{value:3,text:"Tạm dừng",sel:!0},{value:4,text:"Đang chờ",sel:!0}],t.searchAVG=function(){if(t.renderCompleted){t.filter||(t.filter={});var n=[];t.progresses.forEach(function(t){t.sel&&n.push(t.value)}),t.filter.progress={$in:n},t.phu_trach?t.filter.phu_trach=t.phu_trach:delete t.filter.phu_trach,t.nh_dt?t.filter.nh_dt=t.nh_dt:delete t.filter.nh_dt;var e,a,i=new Date,o=t.time;if("d"==o&&(e=new Date,a=new Date),"w"==o)var r=i.getDate()-i.getDay()+1,e=new Date(i.setDate(r)),a=new Date(i.setDate(e.getDate()+6));if("m"==o&&(e=i,e.setDate(1),a=new Date(e.getFullYear(),e.getMonth()+1,0)),"3m"==o){var c=i.getMonth(),d=1;d=3>c?0:6>c?3:6>c?6:9,e=new Date(i.getFullYear(),d,1),a=new Date(i.getFullYear(),d+3,0)}"y"==o&&(e=new Date(i.getFullYear(),0,1),a=new Date(i.getFullYear(),11,31)),e&&a?(e.setHours(0),e.setMinutes(0),e.setSeconds(0),a.setHours(23),a.setMinutes(59),a.setSeconds(0),t.filter.date_created={$gte:e,$lte:a}):delete t.filter.date_created,t.advCondition.ten_dt?t.filter.$or=[{ten_dt:{$regex:t.advCondition.ten_dt,$options:"i"}},{ma_dt:{$regex:t.advCondition.ten_dt,$options:"i"}},{mieu_ta:{$regex:t.advCondition.ten_dt,$options:"i"}}]:delete t.filter.$or,t.advCondition.ten_kh?t.filter.ten_kh=t.advCondition.ten_kh:delete t.filter.ten_kh,t.advCondition.progress&&(t.filter.progress=t.advCondition.progress),t.search()}},t.reportByTime=function(n){t.time=n,t.searchAVG()},t.searchPhuTrach=function(n){t.phu_trach=n.email,t.searchAVG()},t.searchGroup=function(n){t.nh_dt=n._id,t.searchAVG()},t.$watch("progresses",function(){t.filter_title="Lọc dữ liệu",t.searchAVG()},!0),t.changeProgress=function(t,e){var a={};_.extend(a,t),a.progress=e,n.service.update(id_app,a._id,a).success(function(n){_.extend(t,n)}).error(function(t){t&&alert(t)})},t.enter=function(n){13==n.keyCode&&t.searchAVG()}},onView:function(t,n){t.addContact=function(){lienheModule.quickadd(n.$modal,function(n){n.collection_name="lienhe",t.addLink(n,"ten_lien_he")})},t.addCustomer=function(){dmkhModule.quickadd(n.$modal,function(e){e.collection_name="dmkh",t.addLink(e,"ten_kh"),t.data.id_kh||(t.data.id_kh=e._id,n.service.update(id_app,t.data._id,t.data).success(function(n){_.extend(t.data,n)}))})}}});dmdtModule.module.directive("dmdt",function(){return{restrict:"E",scope:{link:"=",collection:"@",defaultValues:"@"},templateUrl:"templates/lists/dmdt/templates/directive.html",controller:["$scope","$http","$window","$location","$modal","appInfo",function($scope,$http,$window,$location,$modal,appInfo){appInfo.info("dmdt",function(e,u,appinfo){if(!e){$scope.textSearch="",$scope.location=$location.url(),$scope.collectionsLink="dmdt:'ten_dt'";var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink);$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.list=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(r){var module_name=r.collection_obj+"Module",module=eval("("+module_name+")");return module.title},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="",$scope.list||($scope.list=[]);var n=_.find($scope.list,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).success(function(n){_.extend(e,n),e.obj=t,e.title=t.title,$scope.list.push(e)}).error(function(t){t&&$window.alert(t)})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).success(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.getItem=function(t){$scope.addLink(t)},$scope.add=function(){var defaultValues={};$scope.defaultValues&&(defaultValues=eval("({"+$scope.defaultValues+"})")),dmdtModule.quickadd($modal,function(t){t.collection_name="dmdt",$scope.addLink(t)},defaultValues)},$scope.view=function(t){var n="dmdt/view/"+t._id+"?redirect="+$location.url();$location.url(n)},$scope.delete=function(t){$window.confirm("Bạn có chắc chắn xóa không?")&&$http.delete(server_url+"/api/"+id_app+"/dmdt/"+t._id).success(function(){$scope.list=_.reject($scope.list,function(n){return n._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.edit=function(t){dmdtModule.quickedit($modal,t._id,function(n){_.extend(t,n)})},$scope.$watch("link",function(t){t&&$scope.load()},!0)}})}],link:function(t,n,e){e.link&&e.collection||console.error("dmdt directive require attributes:link,collection")}}});var dmloaitsModule=new baseInput("dmloaits","dmloaits",["ma_loai_ts","ten_loai_ts"],"Danh mục loại tài sản"),dmtanggiamtsModule=new baseInput("dmtanggiamts","dmtanggiamts",["ma_tang_giam_ts","ten_tang_giam_ts"],"Danh mục tăng giảm tài sản");dmtanggiamtsModule.defaultValues={kieu:"1"};var dmnguonvonModule=new baseInput("dmnguonvon","dmnguonvon",["ma_nguon_von","ten_nguon_von"],"Danh mục nguồn vốn"),qtsModule=new baseVoucher("qts","qts",["so_the_ts","ten_ts"],"Khai báo tài sản cố định");qtsModule.defaultValues={so_ky_kh:0,lam_tron_kh:0,ngay_tang:new Date,pp_tinh_kh:"1",ma_gd:"1"},qtsModule.defaultValues4Detail={nguyen_gia:0,gia_tri_da_kh:0,gia_tri_con_lai:0,gia_tri_kh_ky:0,tinh_kh_gia_tri_con_lai:!0},qtsModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",ten_ts:"",so_the_ts:""},qtsModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},so_the_ts:{$regex:t.vcondition.so_the_ts,$options:"i"},ten_ts:{$regex:t.vcondition.ten_ts,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},qtsModule.watchDetail=function(t){t.$watch("dt_current.nguyen_gia",function(n,e){n&&n!=e&&(t.dt_current.gia_tri_con_lai=t.dt_current.nguyen_gia-t.dt_current.gia_tri_da_kh,t.ngMasterData.tinh_kh_gia_tri_con_lai||(t.dt_current.gia_tri_kh_ky=Math.round(t.dt_current.nguyen_gia/t.ngMasterData.so_ky_kh,0)))}),t.$watch("dt_current.gia_tri_da_kh",function(n,e){n&&n!=e&&(t.dt_current.gia_tri_con_lai=t.dt_current.nguyen_gia-t.dt_current.gia_tri_da_kh)}),t.$watch("dt_current.gia_tri_con_lai",function(n,e){n&&n!=e&&0!=t.ngMasterData.so_ky_kh&&t.ngMasterData.tinh_kh_gia_tri_con_lai&&(t.dt_current.gia_tri_kh_ky=Math.round(t.dt_current.gia_tri_con_lai/t.ngMasterData.so_ky_kh,0))})},qtsModule.watchMaster=function(t){t.$watch("data.tinh_kh_gia_tri_con_lai",function(n){t.data.details.forEach(n?function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=Math.round(n.gia_tri_con_lai/t.data.so_ky_kh,0))}:function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=Math.round(n.nguyen_gia/t.data.so_ky_kh,0))})}),t.$watch("data.so_ky_kh",function(n){n&&t.data.details.forEach(t.data.tinh_kh_gia_tri_con_lai?function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=Math.round(n.gia_tri_con_lai/t.data.so_ky_kh,0))}:function(n){0!=t.data.so_ky_kh&&(n.gia_tri_kh_ky=Math.round(n.nguyen_gia/t.data.so_ky_kh,0))})})};var calc_qtsdieuchinh=function(t){t.$watch("data.nguyen_gia",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_con_lai=t.data.nguyen_gia-t.data.gia_tri_da_kh)}),t.$watch("data.gia_tri_da_kh",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_con_lai=t.data.nguyen_gia-t.data.gia_tri_da_kh)}),t.$watch("data.gia_tri_con_lai",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_kh_ky=0!=t.data.so_ky_kh?Math.round(t.data.gia_tri_con_lai/t.data.so_ky_kh,0):0)}),t.$watch("data.so_ky_kh",function(n){void 0!=n&&null!=n&&(t.data.gia_tri_kh_ky=0!=t.data.so_ky_kh?Math.round(t.data.gia_tri_con_lai/t.data.so_ky_kh,0):0)})},qtsdieuchinhModule=new baseInput("qtsdieuchinh","qtsdieuchinh",["so_the_ts","so_ct"],"Điều chỉnh giá trị tài sản",{onAdd:function(t){calc_qtsdieuchinh(t)},onEdit:function(t){calc_qtsdieuchinh(t)}});qtsdieuchinhModule.defaultValues={so_ky_kh:0,ky:(new Date).getMonth()+1,nam:(new Date).getFullYear(),ngay_ct:new Date,ngay_ct:new Date,nguyen_gia:0,gia_tri_da_kh:0,gia_tri_con_lai:0,gia_tri_kh_ky:0};var rpttinhkhauhaots=new baseRpt("tinhkhauhaots","tinhkhauhaots","Tính khấu hao tài sản");rpttinhkhauhaots.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString())},rpttinhkhauhaots.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.thang=(n.getMonth()+1).toString(),t.tinh_kh_theo_ngay=!0};var hspbtsModule=new baseInput("hspbts","hspbts",["so_the_ts","ma_bp"],"Khai báo hệ số phân bổ tài sản");hspbtsModule.loading=function(t){var n=(new Date).getFullYear();t.nams=[];for(var e=n-10;n+10>e;e++)t.nams.push(e);t.condition={nam:n,thang:(new Date).getMonth()+1}},hspbtsModule.defaultValues={he_so:0,thang:(new Date).getMonth()+1,nam:(new Date).getFullYear()},hspbtsModule.init=function(t){t.thangs=[1,2,3,4,5,6,7,8,9,10,11,12],t.nams=[];for(var n=new Date,e=n.getFullYear()-10;e<n.getFullYear()+10;e++)t.nams.push(e)};var dckhauhaotsModule=new baseInput("dckhauhaots","dckhauhaots",["so_the_ts"],"Điều chỉnh khấu hao tài sản");dckhauhaotsModule.loading=function(t){var n=(new Date).getFullYear();t.nams=[];for(var e=n-10;n+10>e;e++)t.nams.push(e);t.condition={nam:n,thang:(new Date).getMonth()+1}};var pkhModule=new baseVoucher("pkh","pkh",[],"Phiếu khấu hao tài sản");pkhModule.defaultValues={},pkhModule.defaultValues4Detail={tien_nt:0,tien:0},pkhModule.defaultCondition4Search={tu_ngay:new Date,den_ngay:new Date,so_ct:"",dien_giai:""},pkhModule.prepareCondition4Search=function(t){return{so_ct:{$regex:t.vcondition.so_ct,$options:"i"},dien_giai:{$regex:t.vcondition.dien_giai,$options:"i"},ngay_ct:{$gte:dateTime2Date(t.vcondition.tu_ngay),$lte:dateTime2Date(t.vcondition.den_ngay)}}},pkhModule.watchDetail=function(t){t.$watch("dt_current.tien_nt",function(n){void 0!=n&&t.status.isOpened&&(t.dt_current.tien=Math.round(n*t.ngMasterData.ty_gia,0))}),t.createBT=function(){_.isDate(t.ngMasterData.ngay_ct)||(t.ngMasterData.ngay_ct=new Date(t.ngMasterData.ngay_ct)),t.ngMasterData.details=[];var n=server_url+"/api/"+id_app+"/getkhauhao?id_ct="+t.ngMasterData._id;n+="&thang="+t.ngMasterData.ngay_ct.getMonth().toString(),n+="&nam="+t.ngMasterData.ngay_ct.getFullYear().toString(),t.ngMasterData.kc_dvcs&&(n=n+"&ma_dvcs="+t.ngMasterData.ma_dvcs),t.$http.get(n).success(function(n){t.messageError=void 0,t.ngMasterData.details=n}).error(function(n){t.alertType="alert alert-danger",t.messageError=n})}},pkhModule.watchMaster=function(t){t.$watch("data.ty_gia",function(n){t.data&&void 0!=n&&t.isDataLoaded&&angular.forEach(t.data.details,function(t){t.tien=Math.round(t.tien_nt*n,0)})})};var rptbangtinhkhauhao=new baseRpt("bangtinhkhauhao","bangtinhkhauhao","Bảng tính khấu hao");rptbangtinhkhauhao.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptbangtinhkhauhao.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.thang=(n.getMonth()+1).toString(),t.ma_gd="1"};var rptsotaisan=new baseRpt("sotaisan","sotaisan","Sổ tài sản");rptsotaisan.init=function(t){t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptsotaisan.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.ma_gd="1"};var rptchitiettaisan=new baseRpt("chitiettaisan","chitiettaisan","Sổ Chi tiết tài sản");rptchitiettaisan.init=function(t){t.thangs=["1","2","3","4","5","6","7","8","9","10","11","12"],t.nams=[];for(var n=(new Date).getFullYear()-10;n<(new Date).getFullYear()+10;n++)t.nams.push(n.toString());t.gds=[{ma_gd:"",ten:"Cả hai"},{ma_gd:"1",ten:"Tài sản"},{ma_gd:"2",ten:"Công cụ, dụng cụ"}]},rptchitiettaisan.defaultCondition=function(t){var n=new Date;t.nam=n.getFullYear().toString(),t.ma_gd="1",t.thang=n.getMonth()+1};var id_app,access_token,paths_not_require_id_app=["code","app","colleague","notification","message","profile","users","comment","versioninfo","admin"],accApp=angular.module("accApp",modulesD);accApp.config(["$provide","$httpProvider",function(t,n){var e=function(t){var n,e;window.getSelection?(n=window.getSelection(),n.getRangeAt&&n.rangeCount&&(e=n.getRangeAt(0),e.deleteContents(),e.insertNode(document.createTextNode(t)))):document.selection&&document.selection.createRange&&(document.selection.createRange().text=t)};t.decorator("taOptions",["taRegisterTool","$delegate",function(t,n){return t("insertName",{buttontext:"Tên",action:function(){return e("{{receiver.name}}")}}),t("insertAddress",{buttontext:"Email",action:function(){return e("{{receiver.address}}")}}),n.toolbar[1].push("insertName"),n.toolbar[1].push("insertAddress"),n}]),t.factory("myHttpInterceptor",["$q","$rootScope","$location",function(t,n,e){return{request:function(t){return t},requestError:function(n){return t.reject(n)},response:function(t){return t},responseEror:function(a){return 401===a.status?(n.isLogined=!1,e.url("/login")):(0==a.status||500==a.status)&&n.error("Không kết nối được với máy chủ"),t.reject(a)}}}]),n.interceptors.push("myHttpInterceptor")}]),accApp.constant("_",window._),accApp.constant("async",window.async),accApp.factory("api",["$http","$localStorage","$rootScope",function(t,n,e){return{init:function(a){a||(a=n.get("token")),a?(e.isLogined=!0,e.token=a):e.isLogined=!1,access_token=a,t.defaults.headers.common["X-Access-Token"]=a}}}]),accApp.run(["$rootScope","api","$window","user","app","$location","$http","appInfo","$timeout",function(t,n,e,a,i,o,r,c,d){t.isLogined=!1;var l=1,u=4,s="WINDOWS";if(t.program_name="ỨNG DỤNG QUẢN LÝ",t.program_version=l+"."+u,c.asDesktop()){var p=server_url+"/public/versioninfo?q={os:'"+s+"',app:'UDQL'}";r.get(p).success(function(t){if(t.length>0){var n=t[0];(l<n.major||l===n.major&&u<n.minor)&&confirm("Có một bản cập nhật cho chương trình này. Bạn có muốn tải về không?")&&e.open(n.url)}})}t.online=!0,e.addEventListener("offline",function(){t.$apply(function(){t.online=!1})},!1),e.addEventListener("online",function(){t.$apply(function(){t.online=!0})},!1),t.nextTick=function(t){d(t,0)},t.server_url=server_url,t.$watch("app_info",function(n){n&&(t.getTask(),t.crm_input_visible=!1,t.crm_report_visible=!1,t.acc_visible=!1,t.commands={},c.commands(t.id_app),t.members=[{email:t.app_info.user_created,name:t.app_info.user_created.split("@")[0]}],t.app_info.participants.forEach(function(n){t.members.push({email:n.email,name:n.name})}))},!0),t.$watch(function(){return o.path()},function(n){if(n=n.toLowerCase().split("/"),n.length<=1||"dashboard"==n[1]||""==n[1])t.menuActive="DASHBOARD";else{if(t.commands){var e=_.find(t.commands.modules,function(t){return t.path==n[1]});e&&(t.menuActive=e.group)}("login"==n[1]||"logout"==n[1])&&(t.messages_count=0,t.notifies_count=0,t.task_count=0)}}),t.$watch("commands",function(n){if(n){var e=o.path().toLowerCase().split("/");if(e.length<=1)t.menuActive="DASHBOARD";else{var a=_.find(t.commands.modules,function(t){return t.path==e[1]});a&&(t.menuActive=a.group)}}},!0),t.openPath=function(n,e){t.menuActive=e,o.url(n)},t.searchword="",t.searchAllKeyup=function(t,n){13===t.keyCode&&n&&o.url("search/"+n)},n.init(),Metronic.init(),Layout.init()}]),accApp.directive("format",["$filter",function(t){return{require:"?ngModel",scope:{ngModel:"="},controller:["$scope",function(t){t.$watch("ngModel",function(n){void 0==n&&(t.ngModel=0)})}],link:function(n,e,a,i){i&&(i.$formatters.unshift(function(){return(void 0==i.$modelValue||""==i.$modelValue)&&(i.$modelValue=0),t(a.format)(i.$modelValue)}),i.$parsers.unshift(function(n){(void 0==n||""==n)&&(n="0");var a=n.replace(/[^\d|\-+|,+]/g,""),i=a.replace(/,/g,"."),o=t("number")(i);a.indexOf(",")==a.length-1&&(o+=","),e.val(o);var r=Number(i);return void 0==r&&(r=0),r}))}}}]),accApp.directive("ngData",function(){return{controller:["$scope",function(){}]}}),accApp.directive("ngSum",function(){return{scope:{ngSum:"@",ngData:"=",ngModel:"="},link:function(t){t.$watch("ngData",function(n){var e=0;n&&angular.forEach(n,function(n){var a=Number(n[t.ngSum]);e+=a}),t.ngModel=e},!0)}}}),accApp.directive("ngDatepicker",["$window",function(){return{restrict:"E",require:"^ngModel",scope:{ngModel:"=",ngChange:"&"},templateUrl:"templates/sys/ng-datepicker.html",controller:["$scope","$filter",function(t){t.$watch("ngModel",function(n,e){n&&!_.isDate(n)&&(t.ngModel=new Date(n)),t.ngChange&&n!=e&&t.ngChange()})}],link:function(){}}}]),accApp.directive("ngRequiredCn",["dmtk",function(t){var n=!1,e=function(t,e){1!=n||e.$viewValue&&""!=e.$viewValue?e.$setValidity("ngRequiredCn",!0):e.$setValidity("ngRequiredCn",!1)};return{restrict:"A",require:"?ngModel",link:function(a,i,o,r){a.$watch(o.ngRequiredCn,function(i){i?a.tks?(n=_.filter(a.tks,function(t){return t.tk==i&&t.tk_cn}).length>0,e(a,r)):t.list(id_app,{tk:i,tk_cn:!0},"tk_cn").success(function(t){n=0==t.length?!1:!0,e(a,r)}):(n=!1,e(a,r))}),a.$watch(o.ngModel,function(){e(a,r)})}}}]),accApp.directive("ngRequiredQ",[function(){return{restrict:"A",require:"?ngModel",link:function(t,n,e,a){t.$watch(e.ngRequiredQ,function(t){t?a.$setValidity("ngRequired",!1):a.$setValidity("ngRequired",!0)})}}}]),accApp.directive("topMenu",[function(){return{restrict:"E",templateUrl:"templates/sys/top-menu.html",controller:["$scope","$rootScope","colleague","$window","user","app","$location","$http","appInfo","$timeout",function(t,n,e,a,i,o,r,c){n.notifies_count=0,n.messages_count=0,n.task_count=0,n.getMessages=function(t){n.msgs=[{content:"Đang lấy dữ liệu..."}],i.getMessagesColleagues(function(e,a){e?(n.messages_count=0,n.msgs=[{content:"Không thể lấy dữ liệu từ server"}]):(n.msgs=a,n.messages_count=a.length,t&&t(a))})},n.getInvitations=function(t){n.notifies={notifications:[{content:"Đang lấy dữ liệu..."}]},i.getNotifies(function(e,a){e?(n.notifies_count=0,n.notifies={notifications:[{content:"Không thể lấy dữ liệu từ server"}]}):(n.notifies=a,n.notifies_count=a.colls.length+a.apps.length+a.notifications.length,t&&t(a))})},n.getTask=function(){n.tasks=[{ten_cv:"Đang lấy dữ liệu..."}];var t=new Date,e={progress:{$ne:2},start_date:{$lt:t},status:!0,phu_trach:n.user.email};c.get(server_url+"/api/"+id_app+"/task?fields=ten_cv,percent,progress,priority&q="+JSON.stringify(e)).success(function(t){n.tasks=t,n.task_count=t.length}).error(function(){n.tasks=[{ten_cv:"Không thể lấy dữ liệu từ server"}]})},n.acceptInvitor=function(t,n){"colleague"==t&&e.active(n).success(function(){(0==r.url().indexOf("/colleague")||0==r.url().indexOf("colleague"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")}),"app"==t&&o.active(n).success(function(){(0==r.url().indexOf("/app")||0==r.url().indexOf("app"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")})},n.notAcceptInvitor=function(t,n){"colleague"==t&&e.notaccept(n).success(function(){(0==r.url().indexOf("/colleague")||0==r.url().indexOf("colleague"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")}),"app"==t&&o.notaccept(n).success(function(){(0==r.url().indexOf("/app")||0==r.url().indexOf("app"))&&a.location.reload()}).error(function(){alert("Không thể thực hiện thao tác này")})}}]}}]),accApp.directive("horizantalMenu",[function(){return{restrict:"E",templateUrl:"templates/sys/horizantal-menu.html"}}]),accApp.directive("appHeader",[function(){return{restrict:"E",templateUrl:"templates/sys/app-header.html"}}]),accApp.directive("ngPage",[function(){return{restrict:"E",templateUrl:"templates/sys/ng-page.html"}}]),accApp.directive("ngPageFx",[function(){return{restrict:"E",scope:{service:"=",list:"=",condition:"=",start:"=",pageChanged:"&"},templateUrl:"templates/sys/ng-page.html",controller:["$scope","$http","$rootScope",function(t,n,e){t.current_page=1,t.getPages=function(){t.service.load(id_app,{condition:t.condition,count:1}).success(function(n){t.total_page=Math.round(n.rows_number/t.limit,0),t.total_page<n.rows_number/t.limit&&(t.total_page+=1),0==t.total_page&&(t.total_page=1),t.pages=[];for(var e=1;e<=t.total_page;e++)t.pages.push(e)})},t.goToPage=function(a){a||(a=1),e.nextTick(function(){t.$emit("$dataChangeStart"),t.service.load(id_app,{condition:t.condition,page:a,limit:t.limit,fields:t.fields}).success(function(e){async.map(e,function(e,a){t.emailCurrentUser?n.get(server_url+"/api/follow?q={id_object:'"+e._id+"',user_created:'"+t.emailCurrentUser+"'}").success(function(t){t&&t.length>0?(e.followObject=t[0],e.follow_yn=1):e.follow_yn=0,a()}).error(function(t){e.follow_yn=0,a(t)}):a()},function(n){n&&console.log(n),t.$emit("$dataChangeSuccess"),t.current_page=a,t.pageChanged({$page:a}),t.list=e})}).error(function(){t.$emit("$dataChangeError")})})}}],link:function(t,n,e){t.total_page=1,t.pages=[1],e.hasOwnProperty("emailCurrentUser")&&(t.emailCurrentUser=e.emailCurrentUser),t.fields=e.hasOwnProperty("fields")?e.fields:"",e.hasOwnProperty("limit")&&(t.limit=e.limit),t.current_page=e.hasOwnProperty("currentPage")?Number(e.currentPage):1,t.limit||(t.limit=20),t.$watch("start",function(n){n&&(t.getPages(),t.goToPage(t.current_page),t.start=null)})}}}]),accApp.directive("stplistheader",["$location",function($location){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/list-header.html",link:function(scope,elem,attrs,contr){scope.boxSearch=attrs.hasOwnProperty("boxSearch")?attrs.boxSearch:!0,attrs.hasOwnProperty("btnadd")?(btnAdd=eval("({"+attrs.btnadd+"})"),void 0==btnAdd.show&&(btnAdd.show=!0),void 0==btnAdd.text&&(btnAdd.text="Mới"),scope.add_show=btnAdd.show,scope.add_text=btnAdd.text):(scope.add_show=!0,scope.add_text="Mới"),attrs.btndelete?(btnDelete=eval("({"+attrs.btndelete+"})"),void 0==btnDelete.show&&(btnDelete.show=!0),void 0==btnDelete.text&&(btnDelete.text="Xóa"),scope.delete_show=btnDelete.show,scope.delete_text=btnDelete.text):(scope.delete_text="Xóa",scope.delete_show=!0),attrs.btn1&&(btn1=eval("({"+attrs.btn1+"})"),scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn3_click=btn1.click)),attrs.btn2&&(btn2=eval("({"+attrs.btn2+"})"),scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)),attrs.btn3&&(btn3=eval("({"+attrs.btn3+"})"),scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)),attrs.btn4&&(btn4=eval("({"+attrs.btn4+"})"),scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)),attrs.btn5&&(btn5=eval("({"+attrs.btn5+"})"),scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)),attrs.btnimport&&(btnimport=eval("({"+attrs.btnimport+"})"),scope.import_show=!0,scope.import_text="Nhập từ Excel")}}}]),accApp.directive("listViewHeader",["$location",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/list-view-header.html",controller:["$scope","$rootScope",function(t,n){t.$watch("data",function(e){e&&(t.title_view=e[t.headerTitleField],n.title_view=t.title_view)})}],link:function(t,n,e){t.headerTitleField=e.headerTitle}}}]),accApp.directive("stpvoucherheader",function(){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/voucher-header.html",link:function(scope,elem,attrs,control){attrs.btn1&&(btn1=eval("({"+attrs.btn1+"})"),scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)),attrs.btn2&&(btn2=eval("({"+attrs.btn2+"})"),scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)),attrs.btn3&&(btn3=eval("({"+attrs.btn3+"})"),scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)),attrs.btn4&&(btn4=eval("({"+attrs.btn4+"})"),scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)),attrs.btn5&&(btn5=eval("({"+attrs.btn5+"})"),scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)),attrs.options&&(options=eval("({"+attrs.options+"})"),scope.options_show=!0,scope.options_text=options.text)
}}}),accApp.directive("headerFormInput",function(){return{restrict:"E",templateUrl:"templates/sys/header-form-input.html",link:function(t,n,e){e.saveText&&(t.save_text=e.saveText),e.cancelText&&(t.cancel_text=e.cancelText)}}}),accApp.directive("headerDialogSelect",function(){return{restrict:"E",templateUrl:"templates/sys/header-dialog-select.html",link:function(t,n,e){t.title=e.hasOwnProperty("title")?e.title:"Danh sách",t.placeholder=e.hasOwnProperty("placeholder")?e.placeholder:"Gõ từ cần tìm..."}}}),accApp.directive("footerFormInput",function(){return{restrict:"E",templateUrl:"templates/sys/footer-form-input.html",link:function(t,n,e){e.saveText&&(t.save_text=e.saveText),e.cancelText&&(t.cancel_text=e.cancelText)}}}),accApp.directive("rptHeader",["$location",function($location){return{restrict:"E",transclude:!0,templateUrl:"templates/sys/rpt-header.html",link:function(scope,elem,attrs,controller){attrs.kbm&&(scope.kbm_yn=!0,scope.openKbm=function(){$location.url(attrs.kbm)}),scope.btnok_text="Xem",scope.btnok_show=!0,attrs.btnok&&(btnok=eval("({"+attrs.btnok+"})"),btnok.text&&(scope.btnok_text=btnok.text),btnok.show&&(scope.btnok_show=btnok.show)),attrs.btn1&&(btn1=eval("({"+attrs.btn1+"})"),scope.btn1_show=!0,scope.btn1_text=btn1.text,scope.btn1_title=btn1.title,_.isFunction(btn1.click)&&(scope.btn1_click=btn1.click)),attrs.btn2&&(btn2=eval("({"+attrs.btn2+"})"),scope.btn2_show=!0,scope.btn2_text=btn2.text,scope.btn2_title=btn2.title,_.isFunction(btn2.click)&&(scope.btn2_click=btn2.click)),attrs.btn3&&(btn3=eval("({"+attrs.btn3+"})"),scope.btn3_show=!0,scope.btn3_text=btn3.text,scope.btn3_title=btn3.title,_.isFunction(btn3.click)&&(scope.btn3_click=btn3.click)),attrs.btn4&&(btn4=eval("({"+attrs.btn4+"})"),scope.btn4_show=!0,scope.btn4_text=btn4.text,scope.btn4_title=btn4.title,_.isFunction(btn4.click)&&(scope.btn4_click=btn4.click)),attrs.btn5&&(btn5=eval("({"+attrs.btn5+"})"),scope.btn5_show=!0,scope.btn5_text=btn5.text,scope.btn5_title=btn5.title,_.isFunction(btn5.click)&&(scope.btn5_click=btn5.click)),attrs.btnprint?(btnprint=eval("({"+attrs.btnprint+"})"),void 0==btnprint.show&&(btnprint.show=!0),scope.btnprint_show=btnprint.show):scope.btnprint_show=!0,attrs.btnexcel?(btnexcel=eval("({"+attrs.btnexcel+"})"),void 0==btnexcel.show&&(btnexcel.show=!0),scope.btnexcel_show=btnexcel.show):scope.btnexcel_show=!0}}}]),accApp.directive("navbarPrint",function(){return{restrict:"E",templateUrl:"templates/sys/navbar-print.html"}}),accApp.directive("ngTypeahead",["$http",function($http){return{restrict:"E",scope:{ngModel:"=",ngDisabled:"=",ngShow:"=",label:"=",onSelect:"&",fieldModel:"@",module:"@",conditionData:"="},template:function(t,n){var e="<span class='input-group'>";return e+="<input type='text'",e+=" ng-blur='blur()' ng-change='label=undefined' typeahead-on-select = 'getItem($item, $model, $label)'",n.hasOwnProperty("ngRequired")&&(e=e+" ng-required='"+n.ngRequired+"'"),n.hasOwnProperty("ngDisabled")&&(e+=" ng-disabled='ngDisabled'"),n.hasOwnProperty("ngShow")&&(e+=" ng-show='ngShow'"),e=n.hasOwnProperty("group")?e+"typeahead-min-length='3' typeahead-template-url='templates/"+n.group+"/"+n.module+"/templates/typeahead.html' ":e+"typeahead-min-length='3' typeahead-template-url='templates/lists/"+n.module+"/templates/typeahead.html' ",n.hasOwnProperty("placeholder")&&(e=e+" placeholder='"+n.placeholder+"' "),e+=" ng-model='ngModel'",e=e+" typeahead='item."+n.fieldModel+" as item."+n.fieldModel+" for item in getList($viewValue,10)' class='form-control'>",(void 0==n.showButtonList||1==n.showButtonList)&&(e+="<span class='btn input-group-addon'  ng-click='showList()'",n.hasOwnProperty("ngDisabled")&&(e+=" ng-disabled='ngDisabled'"),e+="><i class='fa fa-list'></i></span>"),e+="</span>"},controller:["$scope","$modal","$window","$interval",function($scope,$modal,$window,$interval){var module=eval("("+$scope.module+"Module)");$scope.pathService=module.server_path,$scope.fieldsSearch=module.fields_find;var list=function(t,n,e,a){if(_.contains(paths_not_require_id_app,$scope.pathService))var i=server_url+"/api/"+$scope.pathService+"?t=1";else var i=server_url+"/api/"+t+"/"+$scope.pathService+"?t=1";if(a&&(i=i+"&limit="+a),n)if(angular.isObject(n)){var o=JSON.stringify(n);i=i+"&q="+o}else i=i+"&"+n;return!e&&$scope.fields&&(e=$scope.fields),e&&(i=i+"&fields="+e),$http.get(i)};$scope.prepareCondition=function(value){var condition={};return $scope.condition&&_.extend(condition,$scope.condition),condition.$or=[],$scope.fieldsSearch.forEach(function(field){f=eval(0==field.toLowerCase().indexOf("tk")?"({"+field+":{$regex:'^"+value+"',$options:'i'}})":"({"+field+":{$regex:'"+value+"',$options:'i'}})"),condition.$or.push(f)}),condition},$scope.getList=function(t,n,e){var a=$scope.prepareCondition(t);return list(id_app,a,null,n).then(function(t){var n=t.data;return e&&e(n),n})},$scope.getItem=function(t){$scope.fieldLabel&&($scope.label=t[$scope.fieldLabel]),$scope.onSelect&&$scope.onSelect({$item:t})},$scope.blur=function(){if($scope.ngModel&&!$scope.label&&$scope.fieldLabel){var condition=eval("({"+$scope.fieldModel+":'"+$scope.ngModel+"'})");list(id_app,condition,$scope.fieldLabel).success(function(t){1==t.length?$scope.label=t[0][$scope.fieldLabel]:$scope.ngModel=void 0})}},$scope.showList=function(){$modal.open({templateUrl:"templates/"+$scope.group+"/"+$scope.module+"/templates/dialog-select.html",controller:["$scope","$modalInstance","parentScope",function(t,n,e){t.getList=function(n,a){e.getList(n,a,function(n){t.items=n})},t.keyup=function(n,e){13==n.keyCode&&e&&t.getList(e)},t.select=function(t){e.ngModel=t[e.fieldModel],e.fieldLabel&&(e.label=t[e.fieldLabel]),e.onSelect&&e.onSelect({$item:t}),n.close()},t.cancel=function(){n.dismiss("cancel")},t.openList=function(){var t="#/"+e.module;$window.open(t,"Danh mục","width="+$window.innerWidth.toString()+",height=400"),n.dismiss("cancel")},t.quickadd=function(){module.quickadd($modal,function(t){e.ngModel=t[e.fieldModel],e.fieldLabel&&(e.label=t[e.fieldLabel])},e.defaultValues),n.dismiss("cancel")},t.getList("",10)}],size:"lg",resolve:{parentScope:function(){return $scope}}})}}],link:function(scope,elem,attrs,controller){var conditionData={};scope.conditionData&&(conditionData=scope.conditionData),attrs.hasOwnProperty("condition")&&(scope.condition=eval("({"+attrs.condition+"})")),attrs.hasOwnProperty("fields")&&(scope.fields=attrs.fields),attrs.hasOwnProperty("fieldLabel")&&(scope.fieldLabel=attrs.fieldLabel),scope.defaultValues=attrs.hasOwnProperty("defaultValues")?eval("({"+attrs.defaultValues+"})"):{},scope.group=attrs.hasOwnProperty("group")?attrs.group:"lists",scope.$watch("ngModel",function(){scope.ngModel||(scope.label="")})}}}]),accApp.factory("$cache_lists",function(){return{}}),accApp.directive("ngSelector",["$http","$cache_lists",function($http,$cache){return{restrict:"E",scope:{ngModel:"=",ngChange:"&",onSelect:"&",ngDisabled:"=",module:"@",fields:"@",fieldModel:"@",fieldLabel:"@",conditionData:"="},template:function(elem,attrs){var html="";if(attrs.hasOwnProperty("button")){var button=eval("({"+attrs.button+"})");button.class||(button.class="btn btn-default"),button.text||(button.text="..."),html=html+"<a class='"+button.class+"'  ng-click='showList()'>"+button.text+"</a>"}else html="<span>",(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(html="<span class='input-group'>"),html+="<select ng-model='ngModel' ng-disabled ='ngDisabled'  ",html=attrs.hasOwnProperty("options")?html+' ng-options="'+attrs.options+'"':attrs.hasOwnProperty("showCode")?html+' ng-options="item.'+attrs.fieldModel+" as item."+attrs.fieldModel+" + ' - ' +  item."+attrs.fieldLabel+'  for item in items" ':html+' ng-options="item.'+attrs.fieldModel+" as item."+attrs.fieldLabel+'  for item in items" ',attrs.hasOwnProperty("multiple")&&(html+=" multiple"),html+=" class='form-control'></select>",(void 0==attrs.showButtonList||1==attrs.showButtonList)&&(html+="<span class='btn input-group-addon'  ng-click='showList()'",attrs.hasOwnProperty("ngDisabled")&&(html+=" ng-disabled='ngDisabled'"),html+="><i class='fa fa-list'></i></span>"),html+="</span>";return html},controller:["$scope","$modal","$window","$interval",function($scope,$modal,$window,$interval){var module=eval("("+$scope.module+"Module)");$scope.pathService=module.server_path,$scope.fieldsSearch=module.fields_find,$scope.$watch("ngModel",function(t){if(t&&$scope.items){var n=_.find($scope.items,function(n){return n[$scope.fieldModel]==t});$scope.ngChange({$item:n}),$scope.onSelect&&$scope.onSelect({$item:n})}else $scope.ngChange({$item:null})}),$scope.list=function(t,n,e,a){if(_.contains(paths_not_require_id_app,$scope.pathService))var i=server_url+"/api/"+$scope.pathService+"?t=1";else var i=server_url+"/api/"+t+"/"+$scope.pathService+"?t=1";if(a&&(i=i+"&limit="+a),n)if(angular.isObject(n)){var o=JSON.stringify(n);i=i+"&q="+o}else i=i+"&"+n;return!e&&$scope.fields&&(e=$scope.fields),e&&(i=i+"&fields="+e),$http.get(i)},$scope.refresh=function(){var condition={status:!0};$scope.condition&&_.extend(condition,$scope.condition),$scope.list(id_app,condition).success(function(data){if(!$scope.condition){var key=$scope.module+"_"+id_app;$cache[key]=data}if($scope.items=[],$scope.emptyYn){var empty_item=eval("({"+$scope.fieldModel+":'',"+$scope.fieldLabel+":'"+$scope.headerText+"'})");$scope.items.push(empty_item)}angular.forEach(data,function(t){$scope.items.push(t)}),!$scope.ngModel&&$scope.items.length>0&&($scope.ngModel=$scope.items[0][$scope.fieldModel])})},$scope.showList=function(){var modalInstance=$modal.open({templateUrl:"templates/"+$scope.group+"/"+$scope.module+"/templates/dialog-select.html",controller:["$scope","$modalInstance","parentScope",function($scope,$modalInstance,parentScope){$scope.getList=function(value,limit){var condition={};parentScope.condition&&_.extend(condition,parentScope.condition),condition.$or=[],parentScope.fieldsSearch.forEach(function(field){var f=eval("({"+field+":{$regex:'"+value+"',$options:'i'}})");condition.$or.push(f)}),parentScope.list(id_app,condition,null,limit).then(function(t){$scope.items=t.data})},$scope.keyup=function(t,n){13==t.keyCode&&n&&$scope.getList(n)},$scope.getList("",10),$scope.select=function(t){parentScope.ngModel=parentScope.multiple?[t[parentScope.fieldModel]]:t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.onSelect&&parentScope.onSelect({$item:t}),$modalInstance.close()},$scope.cancel=function(){$modalInstance.dismiss("cancel")},$scope.openList=function(){var t="#/"+parentScope.module,n=$window.open(t,"Danh mục","width="+$window.innerWidth.toString()+",height=400"),e=$interval(function(){n.closed&&(parentScope.refresh(),$interval.stop(e))},100);$modalInstance.dismiss("cancel")},$scope.quickadd=function(){module.quickadd($modal,function(t){parentScope.items.push(t),parentScope.ngModel=parentScope.multiple?[t[parentScope.fieldModel]]:t[parentScope.fieldModel],parentScope.fieldLabel&&(parentScope.label=t[parentScope.fieldLabel]),parentScope.onSelect&&parentScope.onSelect({$item:t});var n=parentScope.module+"_"+id_app;$cache[n]&&$cache[n].push(t)},parentScope.defaultValues),$modalInstance.dismiss("cancel")}}],size:"lg",resolve:{parentScope:function(){return $scope}}})},$scope.getList=function(){var key=$scope.module+"_"+id_app;if($cache[key]&&!$scope.condition&&$scope.cache){var data=$cache[key];if($scope.items=[],$scope.emptyYn){var empty_item=eval("({"+$scope.fieldModel+":'',"+$scope.fieldLabel+":'"+$scope.headerText+"'})");$scope.items.push(empty_item)}angular.forEach(data,function(t){$scope.items.push(t)}),!$scope.ngModel&&$scope.items.length>0&&($scope.ngModel=$scope.items[0][$scope.fieldModel])}else $scope.refresh()}}],link:function(scope,elem,attrs){var conditionData={};scope.conditionData&&(conditionData=scope.conditionData),attrs.hasOwnProperty("condition")&&(scope.condition=eval("({"+attrs.condition+"})")),scope.cache=attrs.hasOwnProperty("cache")?attrs.cache:!1,scope.headerText=attrs.hasOwnProperty("headerText")?attrs.headerText:"--",attrs.hasOwnProperty("multiple")&&(scope.multiple=attrs.multiple),scope.defaultValues=attrs.hasOwnProperty("defaultValues")?eval("({"+attrs.defaultValues+"})"):{},scope.group=attrs.hasOwnProperty("group")?attrs.group:"lists",scope.emptyYn=attrs.hasOwnProperty("ngRequired")||attrs.hasOwnProperty("required")?!1:!0,scope.getList()}}}]),accApp.directive("stpLink",function(){return{restrict:"E",scope:{link:"=",collection:"@",collectionsLink:"@"},templateUrl:"templates/sys/link.html",controller:["$scope","$http","$window","$location",function($scope,$http,$window,$location){$scope.textSearch="",$scope.location=$location.url();var collectionsLink=eval("({"+$scope.collectionsLink+"})"),collections=_.keys(collectionsLink),collectionsTitle={};collections.forEach(function(c){var module_name=c+"Module",module=eval("("+module_name+")");collectionsTitle[c]=module.title}),$scope.collectionsTitleString=_.values(collectionsTitle).join(),$scope.load=function(){var t=server_url+"/api/"+id_app+"/linkslist?_id="+$scope.link._id+"&collections="+collections.join();$http.get(t).success(function(t){$scope.link.links=t}).error(function(t){t&&$window.alert(t)})},$scope.getHeaderCollection=function(t){return collectionsTitle[t.collection_obj]},$scope.search=function(t){var n=server_url+"/api/"+id_app+"/search?collections="+$scope.collectionsLink+"&value="+t;return $http.get(n).then(function(t){var n=t.data;return n})},$scope.addLink=function(t){$scope.textSearch="";var n=_.find($scope.link.links,function(n){return n.obj._id==t._id});if(!n){var e={};e.id_a=$scope.link._id,e.collection_a=$scope.collection,e.collection_b=t.collection_name,e.collection_obj=t.collection_name,e.id_b=t._id;var a=server_url+"/api/"+id_app+"/link";$http.post(a,e).success(function(n){_.extend(e,n),e.obj=t,e.title=t.title,$scope.link.links.push(e)}).error(function(t){t&&$window.alert(t)})}},$scope.unLink=function(t){var n=server_url+"/api/"+id_app+"/link/"+t._id;$http.delete(n).success(function(){$scope.link.links=_.reject($scope.link.links,function(n){return n._id==t._id})}).error(function(t){t&&$window.alert(t)})},$scope.getItem=function(t,n,e){$scope.addLink(t,e)}}],link:function(t,n,e){e.link&&e.collection&&e.collectionsLink||console.error("stp-link directive require attributes:link,collection,collection-link"),t.$watch("link",function(n){n&&(t.link.links||(t.link.links=[]),t.load())})}}}),accApp.directive("ngGetInfo",["$http",function($http){return{restrict:"A",scope:{conditionValue:"=",runWhenConditionChanged:"=",ngModel:"="},controller:["$scope",function(t){var n=function(n,e,a){var i=server_url+"/api/"+n+"/"+t.pathService+"?t=1";if(e)if(angular.isObject(e)){var o=JSON.stringify(e);i=i+"&q="+o}else i=i+"&"+e;return a&&(i=i+"&fields="+a),$http.get(i)};t.getValue=function(e){var a={};for(var i in t.condition){var o=t.condition[i];a[i]="???"==o?t.conditionValue:o}n(id_app,a,t.fieldInfo).success(function(n){1==n.length&&e(n[0][t.fieldInfo])})}}],link:function(scope,elem,attrs){var ngGetInfo=eval("({"+attrs.ngGetInfo+"})");scope.fieldInfo=ngGetInfo.fieldInfo;var module=eval("("+ngGetInfo.module+"Module)");scope.pathService=module.server_path,scope.condition=ngGetInfo.condition,attrs.hasOwnProperty("runWhenConditionChanged")||(scope.runWhenConditionChanged=!0),scope.$watch("conditionValue",function(t){return scope.runWhenConditionChanged?t?void(scope.fieldInfo&&scope.getValue(function(t){scope.ngModel=t})):void(scope.ngModel=null):void 0})}}}]),accApp.directive("history",function(){return{restrict:"E",scope:{link:"=",module:"@",actions:"@"},templateUrl:"templates/sys/history.html",controller:["$scope","$http","$modal",function($scope,$http,$modal){var module=eval("("+$scope.module+"Module)");$scope.getHistory=function(){var t=server_url+"/api/"+id_app+"/"+module.server_path+"/history/"+$scope.link._id;$scope.actions&&(t=t+"?actions="+$scope.actions),$http.get(t).success(function(t){t.forEach(function(t){t.action_text="GET"==t.action?"Đã xem":"UPDATE"==t.action?"Đã cập nhật":"ADD"==t.action?"Đã tạo":t.action}),$scope.history=t}).error(function(t){console.error(t)})},$scope.openProfile=function(t){viewProfile($modal,t)}}],link:function(t){t.$watch("link",function(n){n&&t.getHistory()})}}}),accApp.directive("parseHtml",function(){return{restrict:"A",scope:{parseHtml:"="},link:function(t,n){t.$watch("parseHtml",function(t){if(t){var e=/<[a-z][\s\S]*>/i.test(t);n.html(e?t:t.replace(/\n/g,"<br/>"))}})}}}),accApp.directive("parseText",function(){return{restrict:"A",scope:{parseText:"=",limit:"@"},link:function(t,n){t.$watch("parseText",function(e){if(e){var a,i=/<[a-z][\s\S]*>/i.test(e);i?(n.html(e),a=n.text()):a=e,t.limit&&a.length>Number(t.limit)&&(a=a.substring(0,t.limit)+"..."),n.text(a)}})}}}),accApp.directive("textcomplete",["Textcomplete",function(t){return{restrict:"EA",scope:{members:"=",message:"="},template:"<textarea class=\"form-control\" rows=\"5\" ng-model='message' type='text'></textarea>",link:function(n,e){n.$watch("members",function(a){if(a&&a.length>0){var i=n.members,o=e.find("textarea"),r=new t(o,[{match:/(^|\s)@(\w*)$/,search:function(t,n){n($.map(i,function(n){return 0===n.toLowerCase().indexOf(t.toLowerCase())?n:null}))},index:2,replace:function(t){return"$1@"+t+" "}}]);$(r).on({"textComplete:select":function(t,e){n.$apply(function(){n.message=e})},"textComplete:show":function(){$(this).data("autocompleting",!0)},"textComplete:hide":function(){$(this).data("autocompleting",!1)}})}})}}}]),accApp.directive("routeLoader",function(){return{restrict:"EA",link:function(t,n){function e(){n.css("display","none")}var a=n.css("display");t.$on("$routeChangeStart",function(){n.css("display",a)}),t.$on("$routeChangeSuccess",e),t.$on("$routeChangeError",e),e()}}}),accApp.directive("serverLoader",function(){return{restrict:"EA",link:function(t,n){function e(){n.css("display","none")}var a=n.css("display");t.$on("$dataChangeStart",function(){t.serverAction="Đang tải dữ liệu",n.css("display",a)}),t.$on("$dataSaveStart",function(){t.serverAction="Đang lưu dữ liệu",n.css("display",a)}),t.$on("$dataChangeSuccess",e),t.$on("$dataChangeError",e),t.$on("$dataSaveSuccess",e),t.$on("$dataSaveError",e),e()}}}),accApp.directive("fileUploadProgress",function(){return{restrict:"EA",link:function(t,n){function e(){n.css("display","none")}var a=n.css("display");t.$on("$fileUploadStart",function(){t.serverAction="Đang tải dữ liệu",n.css("display",a)}),t.$on("$fileUploadSuccess",e),t.$on("$fileUploadError",e),e()}}}),accApp.directive("follow",function(){return{restrict:"E",scope:{collectionsFollow:"@"},templateUrl:"templates/sys/follow.html",controller:["$scope","$rootScope","$http","appInfo",function(t,n,e,a){t.load=function(){a.info("follow",function(n,a,i){if(t.follows=[],!n&&i._id){if(!t.collectionsFollow||!i)return;var o=server_url+"/api/"+i._id+"/follow?q={user_created:'"+a.email+"'}&collections="+t.collectionsFollow;e.get(o).success(function(n){t.follows=n})}})}}],link:function(t){t.load()}}}),accApp.directive("like",function(){return{restrict:"E",scope:{},templateUrl:"templates/sys/like.html",controller:["$scope","$rootScope","$http","appInfo",function(t,n,e,a){t.load=function(){a.info("like_module",function(n,a,i){if(t.likes=[],!n&&i._id){var o=server_url+"/api/"+i._id+"/like_module?q={user_created:'"+a.email+"',like:true}";e.get(o).success(function(n){t.likes=n})}})}}],link:function(t){t.load()}}}),accApp.directive("shortcut",["$document","$rootScope",function(t,n){return{restrict:"A",link:function(){t.bind("keydown",function(t){(t.ctrlKey&&(65==t.which||77==t.which||78==t.which||68==t.which||69==t.which||80==t.which||85==t.which||83==t.which)||116==t.which)&&t.preventDefault(),n.$apply(function(){n.$broadcast("keydown",t)})})}}}]);